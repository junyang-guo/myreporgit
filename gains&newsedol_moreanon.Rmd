---
title: "gains&newsedol_moreanon"
author: "Junyang"
date: "20/01/2021"
output: html_document
---

```{r setup, include=FALSE}
# rm(list = ls())
gc()
library(data.table)
library(ggplot2)
library(stargazer)
library(lfe)
library(fixest)
library(gridExtra)
library(grid)
library(DescTools) # used for winsurizing
library(zoo) # used for na.locf
library(broom)
memory.limit()
Sys.setenv(LANG="en")
Sys.setlocale("LC_TIME","us")
#load("G:/rank/intermdiate_data/dt_portfolio_moreanon/portfolios_return.RData")
#load("G:/rank/intermdiate_data/dt_portfolio_moreanon/portfolio_stock_composition.RData")
```


```{r}
load("G:/rank/intermdiate_data/dt_portfolio_moreanon/portfolios_return.RData")
load("G:/rank/intermdiate_data/dt_portfolio_moreanon/portfolio_stock_composition.RData")
```

# number of holding analysis

```{r}
composition2 <- portfolio_stock_composition[net.posit.port>0]
static <- fread("F:/stock split/intermediate_data/260118_isins_sedols_recovered_static.csv")
static <- static[,c("Barclays_SEDOL","DS_STOCK_TYPE","DS_CURRENCY_CODE")] #ds_static_data
setnames(static,"Barclays_SEDOL","sedol")
composition2 <- merge(composition2, static,by="sedol",all.x = TRUE)
nrow(composition2) #  37013430
nrow(composition2[DS_STOCK_TYPE == "EQ"]) # 31613761
nrow(composition2[DS_STOCK_TYPE == "EQ" & DS_CURRENCY_CODE == "GBP"]) #30341556
composition2 <- composition2[DS_STOCK_TYPE == "EQ" & DS_CURRENCY_CODE == "GBP"]
composition2 <- composition2[anon %in% unique(check_for_run$anon)]
composition2[,no.in.portfolio:=.N,by=c("anon","date_formated")]
composition2[,first_date:=min(date_formated),by=anon]
first_composition <- composition2[date_formated==first_date]
first_composition <- first_composition[,.SD[1],by=anon]
first_composition <- first_composition[,.N,by=no.in.portfolio][order(no.in.portfolio)]
first_composition[,prop:=N/length(unique(check_for_run$anon))]
first_composition2 <- composition2[date_formated==first_date]
first_composition2 <- first_composition2[,.SD[1],by=anon]
first_composition2 <- first_composition2[,.(anon, first_date)]
no.holdings.smmry <- CJ(anon=unique(composition2$anon), date_formated=unique(portfolio_stock_composition$date_formated))
no.holdings.smmry <- merge(no.holdings.smmry, first_composition2, by="anon",all.x=TRUE)
nrow(no.holdings.smmry[is.na(first_date)])
no.holdings.smmry <- no.holdings.smmry[date_formated>=first_date]
composition3 <- composition2[,.(anon, date_formated, no.in.portfolio)]
composition3 <- composition3[,.SD[1],by=c("anon","date_formated")]
no.holdings.smmry <- merge(no.holdings.smmry, composition3, by=c("anon","date_formated"), all.x=TRUE)
gc()
zeroholdings <- copy(portfolio_stock_composition)
zeroholdings[,net.port:=sum(abs(net.posit.port)),by=c("anon","date_formated")]
zeroholdings <- zeroholdings[net.port==0]
zeroholdings <- zeroholdings[,.SD[1],by=c("anon","date_formated")]
zeroholdings <- zeroholdings[,.(anon, date_formated)]
zeroholdings[,no.in.portfolio:=0]
no.holdings.smmry <- merge(no.holdings.smmry, zeroholdings, by=c("anon","date_formated"), all.x=TRUE)
no.holdings.smmry[,no.in.portfolio:=no.in.portfolio.x]
no.holdings.smmry[is.na(no.in.portfolio),no.in.portfolio:=no.in.portfolio.y]
no.holdings.smmry <- no.holdings.smmry[order(anon, date_formated)]
no.holdings.smmry[,no.in.portfolio:=na.locf(no.in.portfolio, na.rm = FALSE),by=anon]
no.holdings.smmry[,n_days := as.numeric(date_formated-first_date+1)]

plot.no.holdings.smmry <- no.holdings.smmry[,.(mean.noinport=mean(no.in.portfolio),
                                               sd.noinport=mean(no.in.portfolio),
                                               N=.N),by=n_days]
plot.no.holdings.smmry[,upper_ci:=mean.noinport+1.96*sd.noinport/sqrt(N)]
plot.no.holdings.smmry[,lower_ci:=mean.noinport-1.96*sd.noinport/sqrt(N)]



pd <- position_dodge(0.09) # move them .05 to the left and right
(plot.no <- ggplot(plot.no.holdings.smmry[n_days<=1500], aes(x=n_days, y=mean.noinport))+
       geom_ribbon(aes(ymin=lower_ci, ymax=upper_ci),alpha = .3, linetype=0) +
       geom_line(position=pd) +
  xlab("Number of days since opening accounts") + ylab("Number of stocks"))
ggsave(plot.no, file="G:/rank/new_ind/codes/codes with more anon dataset/noinportfolio.png",width = 7.29, height = 4.5)


# 100 working day
no.holdings.100 <- no.holdings.smmry[n_days==100]
no.holdings.100[,no.in.portfolio.x:=NULL]
no.holdings.100[,no.in.portfolio.y:=NULL]
nrow(no.holdings.100) # 11241
nrow(no.holdings.100[no.in.portfolio>0]) # 10552

composition3 <- merge(portfolio_stock_composition, static,by="sedol",all.x = TRUE)
nrow(composition3) #  44838660
nrow(composition3[DS_STOCK_TYPE == "EQ"]) # 37877288
nrow(composition3[DS_STOCK_TYPE == "EQ" & DS_CURRENCY_CODE == "GBP"]) #36162049
composition3 <- composition3[DS_STOCK_TYPE == "EQ" & DS_CURRENCY_CODE == "GBP"]
composition3 <- composition3[anon %in% unique(no.holdings.100$anon)]
anondate_port <- composition3[,.SD[1],by=c("anon", "date_formated")]
anondate_port <- anondate_port[,.(anon, date_formated)]


check <- no.holdings.100[1:200]
setnames(anondate_port,"date_formated","dateport")
check <- merge(check, anondate_port, by="anon", all.x=TRUE)
check <- check[dateport<=date_formated]
check[,maxdateport:=max(dateport),by=anon]
check <- check[dateport==maxdateport]

no.holdings.100 <- merge(no.holdings.100, anondate_port, by="anon", all.x=TRUE)
no.holdings.100 <- no.holdings.100[dateport<=date_formated]
no.holdings.100[,maxdateport:=max(dateport),by=anon]
no.holdings.100 <- no.holdings.100[dateport==maxdateport]
nrow(no.holdings.100) # 11241

composition4 <- copy(composition3)
setnames(composition4, "date_formated", "maxdateport")
holdings.100 <- merge(no.holdings.100, composition4, by=c("anon","maxdateport"),
                      all.x=TRUE)
holdings.100[,upp_lag:=NULL]
holdings.100[,rsp:=NULL]
holdings.100[,quantity:=NULL]
holdings.100[,net_cost:=NULL]
holdings.100[,buy:=NULL]
holdings.100[,buyday:=NULL]


load("G:/rank/raw_data_not_confidential/0704ds/extended_price_150421.RData")  # <----------- from 
check <- pp_ext[,.N,by=sedol][order(N)]
pp_ext <- pp_ext[!(sedol%in%check[1:10]$sedol)]
pp_ext[,sedol:=unlist(lapply(sedol, function(x){leading_zero(x=x, n=7)}))]
pp_ext <- pp_ext[order(sedol,date_formated)]
pp_ext <- pp_ext[,.SD[1],by=c("sedol","date_formated")]
pp_ext <- pp_ext[,.(sedol, date_formated, upp )]
pp_ext <- pp_ext[order(sedol,date_formated)]
pp_ext[,upp_1:=c(NA, upp[-.N]),by=sedol]

holdings.100 <- merge(holdings.100, pp_ext, by=c("sedol", "date_formated"), all.x=TRUE)
holdings.100[,rsp:=(upp_1-qwapp.port)/qwapp.port]
holdings.100[,net.posit.pre:=ifelse(date_formated==maxdateport,net.posit.port.pre1day,net.posit.port)]
holdings.100 <- holdings.100[!(net.posit.pre==0)]
holdings.100[,posirsp:=ifelse(rsp>0,1,0)]
holdings.100[,winprop:=mean(posirsp),by=c("anon","date_formated")]
holdings.100[,holding_value:=net.posit.pre*upp_1]
holdings.100[,port_value:=sum(holding_value),by=c("anon","date_formated")]
holdings.100[,rsp_p:=net.posit.pre*(upp_1-qwapp.port)/qwapp.port]
holdings.100[,rsp_p_port:=sum(rsp_p),by=c("anon","date_formated")]
holdings.100[,rsp_port:=rsp_p_port/port_value]
holdings.100 <- holdings.100[,.SD[1],by=anon]
holdings.100 <- holdings.100[,.(anon, winprop, rsp_port)]
setnames(holdings.100, c("winprop", "rsp_port"), c("winprop_100", "rsp_port_100"))
no.holdings.100 <- merge(no.holdings.100, holdings.100, by="anon", all.x=TRUE)
no.holdings.100 <- no.holdings.100[!(no.in.portfolio==0)]
no.holdings.100 <- no.holdings.100[!(is.na(winprop_100))]
no.holdings.100[,med_winp_100:=median(winprop_100)]
no.holdings.100[,med_rsp_100:=median(rsp_port_100)]
no.holdings.100 <- no.holdings.100[,.(anon, winprop_100,
                                      rsp_port_100, med_winp_100,med_rsp_100)]

no.holdings.smmry2 <- merge(no.holdings.smmry, no.holdings.100, by="anon", all.x=TRUE)
no.holdings.smmry2[, higher_100:=ifelse(winprop_100>=med_winp_100,"better winprop","worse winprop")]
plot.no.holdings.smmry2 <- no.holdings.smmry2[,.(mean.noinport=mean(no.in.portfolio),
                                               sd.noinport=mean(no.in.portfolio),
                                               N=.N),by=c("n_days","higher_100")]
plot.no.holdings.smmry2[,upper_ci:=mean.noinport+1.96*sd.noinport/sqrt(N)]
plot.no.holdings.smmry2[,lower_ci:=mean.noinport-1.96*sd.noinport/sqrt(N)]



pd <- position_dodge(0.09) # move them .05 to the left and right
(plot.no.2 <- ggplot(plot.no.holdings.smmry2[n_days<=1500 & !(is.na(higher_100))], 
                     aes(x=n_days, y=mean.noinport, color=higher_100))+
    geom_ribbon(aes(ymin=lower_ci, ymax=upper_ci),alpha = .3, linetype=0) +
       geom_line(position=pd) +
  xlab("Number of days since opening accounts") + ylab("Number of stocks"))
ggsave(plot.no.2, file="G:/rank/new_ind/codes/codes with more anon dataset/noinportfolio100.png",width = 7.29, height = 4.5)


# 250 working day
no.holdings.250 <- no.holdings.smmry[n_days==250]
no.holdings.250[,no.in.portfolio.x:=NULL]
no.holdings.250[,no.in.portfolio.y:=NULL]
nrow(no.holdings.250) # 11241
nrow(no.holdings.250[no.in.portfolio>0]) # 10552

no.holdings.250 <- merge(no.holdings.250, anondate_port, by="anon", all.x=TRUE)
no.holdings.250 <- no.holdings.250[dateport<=date_formated]
no.holdings.250[,maxdateport:=max(dateport),by=anon]
no.holdings.250 <- no.holdings.250[dateport==maxdateport]
nrow(no.holdings.250) # 11241
holdings.250 <- merge(no.holdings.250, composition4, by=c("anon","maxdateport"),
                      all.x=TRUE)
holdings.250[,upp_lag:=NULL]
holdings.250[,rsp:=NULL]
holdings.250[,quantity:=NULL]
holdings.250[,net_cost:=NULL]
holdings.250[,buy:=NULL]
holdings.250[,buyday:=NULL]

holdings.250 <- merge(holdings.250, pp_ext, by=c("sedol", "date_formated"), all.x=TRUE)
holdings.250[,rsp:=(upp_1-qwapp.port)/qwapp.port]
holdings.250[,net.posit.pre:=ifelse(date_formated==maxdateport,net.posit.port.pre1day,net.posit.port)]
holdings.250 <- holdings.250[!(net.posit.pre==0)]
holdings.250[,posirsp:=ifelse(rsp>0,1,0)]
holdings.250[,winprop:=mean(posirsp),by=c("anon","date_formated")]
holdings.250[,holding_value:=net.posit.pre*upp_1]
holdings.250[,port_value:=sum(holding_value),by=c("anon","date_formated")]
holdings.250[,rsp_p:=net.posit.pre*(upp_1-qwapp.port)/qwapp.port]
holdings.250[,rsp_p_port:=sum(rsp_p),by=c("anon","date_formated")]
holdings.250[,rsp_port:=rsp_p_port/port_value]
holdings.250 <- holdings.250[,.SD[1],by=anon]
holdings.250 <- holdings.250[,.(anon, winprop, rsp_port)]
setnames(holdings.250, c("winprop", "rsp_port"), c("winprop_250", "rsp_port_250"))
no.holdings.250 <- merge(no.holdings.250, holdings.250, by="anon", all.x=TRUE)
no.holdings.250 <- no.holdings.250[!(no.in.portfolio==0)]
no.holdings.250 <- no.holdings.250[!(is.na(winprop_250))]
no.holdings.250[,med_winp_250:=median(winprop_250)]
no.holdings.250[,med_rsp_250:=median(rsp_port_250)]
no.holdings.250 <- no.holdings.250[,.(anon, winprop_250,
                                      rsp_port_250, med_winp_250,med_rsp_250)]

no.holdings.smmry3 <- merge(no.holdings.smmry, no.holdings.250, by="anon", all.x=TRUE)
no.holdings.smmry3[, higher_250:=ifelse(winprop_250>=med_winp_250,"better winprop","worse winprop")]
plot.no.holdings.smmry3 <- no.holdings.smmry3[,.(mean.noinport=mean(no.in.portfolio),
                                               sd.noinport=mean(no.in.portfolio),
                                               N=.N),by=c("n_days","higher_250")]
plot.no.holdings.smmry3[,upper_ci:=mean.noinport+1.96*sd.noinport/sqrt(N)]
plot.no.holdings.smmry3[,lower_ci:=mean.noinport-1.96*sd.noinport/sqrt(N)]



pd <- position_dodge(0.09) # move them .05 to the left and right
(plot.no.3 <- ggplot(plot.no.holdings.smmry3[n_days<=1500 & !(is.na(higher_250))], 
                     aes(x=n_days, y=mean.noinport, color=higher_250))+
    geom_ribbon(aes(ymin=lower_ci, ymax=upper_ci),alpha = .3, linetype=0) +
       geom_line(position=pd) +
  xlab("Number of days since opening accounts") + ylab("Number of stocks"))
ggsave(plot.no.3, file="G:/rank/new_ind/codes/codes with more anon dataset/noinportfolio250.png",width = 7.29, height = 4.5)
```

# load buys data

```{r}

transaction <-fread("F:/stock split/merged_from_python.csv")

setnames(transaction, c("V1","V2","V3","V4","V5","V6","V7","V8","V9","V10"),
         c("date","transaction_time","transaction_type","narative","sedol",
           "cost","quantity","unit_price","commission","account"))

split <- fread("F:/stock split/intermediate_data/split.csv")

transaction[,date:=as.Date(date)]

all_dates <- as.data.table(x=unique(transaction$date))
setnames(all_dates,"V1","date_formated")
all_dates <- all_dates[order(date_formated)]
all_dates[,date_index:=seq(1,nrow(all_dates))]


split$datadate <- as.Date(split$datadate) # split data from compustat


static <- fread("F:/stock split/intermediate_data/260118_isins_sedols_recovered_static.csv")
static <- static[,c("Barclays_SEDOL","DS_STOCK_TYPE","DS_CURRENCY_CODE")] #ds_static_data



setnames(transaction,"sedol","Barclays_SEDOL")
transaction <- merge(transaction, static,by="Barclays_SEDOL",all.x = TRUE)
extract_anon_id <- function(x)
{
  unlist(strsplit(unlist(strsplit(x, split="_"))[2] , split=".c"))[1]
}

transaction[,anon:=unlist(lapply(account, extract_anon_id))]
transaction[,anon:=as.numeric(anon)]
transaction <- transaction[order(account,date,transaction_time)]
transaction[,ntrades:=seq_len(.N), by = account]

#Hiro's way to identify automatic trading (for buying)
transaction_buy <- transaction[narative=="BUY"] # all buy stransactions
transaction_buy <- transaction_buy[DS_STOCK_TYPE == "EQ"]
transaction_buy <- transaction_buy[DS_CURRENCY_CODE == "GBP"]
automatic_buy <- transaction_buy[,.N,by=c("Barclays_SEDOL","date","unit_price","transaction_time"
)][order(-N)]
ex1 <- automatic_buy[N>=124 & transaction_time>810 & transaction_time<1630]
ex3 <- automatic_buy[transaction_time<800 | transaction_time>1640]

ex1 <- rbind(ex1,ex3)
ex1 <- ex1[,N:=NULL]                     
ex1 <- ex1[,mark:=1]

#Hiro's way to identify automatic trading (for selling)
transaction_sell <- transaction[narative=="SELL"] # all buy stransactions
transaction_sell <- transaction_sell[DS_STOCK_TYPE == "EQ"]
transaction_sell <- transaction_sell[DS_CURRENCY_CODE == "GBP"]
automatic_sell <- transaction_sell[,.N,by=c("Barclays_SEDOL","date","unit_price",
                                            "transaction_time")][order(-N)]
ex2 <- automatic_sell[N>=29 & transaction_time>810 & transaction_time<1630]
ex4 <- automatic_sell[transaction_time<800 | transaction_time>1640]

ex2 <- rbind(ex2,ex4)
ex2 <- ex2[,N:=NULL]                     
ex2 <- ex2[,mark:=1]

#(finally! delete those automatic trades! for buy)
transaction_buy <- merge(transaction_buy,ex1,by=c("Barclays_SEDOL","date","unit_price","transaction_time"),all.x=TRUE)

sum(transaction_buy$mark,na.rm=TRUE)/length(transaction_buy$mark)

transaction_buy <- transaction_buy[is.na(mark)==TRUE]
transaction_buy <- transaction_buy[,mark:=NULL]

#(finally! delete those automatic trades! for sell)
transaction_sell <- merge(transaction_sell,ex2,by=c("Barclays_SEDOL","date","unit_price","transaction_time"),all.x=TRUE)

sum(is.na(transaction_sell$mark)==FALSE)/length(transaction_sell$mark)

transaction_sell <- transaction_sell[is.na(mark)==TRUE]
transaction_sell <- transaction_sell[,mark:=NULL]

rm(transaction)
transaction <- rbind(transaction_buy, transaction_sell)


setnames(transaction,"date","port_date")

transaction[,c("account", "DS_STOCK_TYPE", "DS_CURRENCY_CODE"):=NULL]
#filter out multiple transactions on the same stock on the same day from the same anon
check <- transaction[,.N,by=c("Barclays_SEDOL","port_date","anon")]
transaction <- merge(transaction, check, by=c("Barclays_SEDOL","port_date","anon"), all.x=TRUE)
multiple <- transaction[N>1]
transaction <- transaction[N==1]
transaction[,N:=NULL]
transaction[,net_cost:=quantity*unit_price]
transaction[transaction_type=="S",quantity:=-quantity]
transaction[transaction_type=="S",net_cost:=-net_cost]
multiple[transaction_type=="S",quantity:=-quantity]
multiple[,quantity_daily:=sum(quantity), by=c("Barclays_SEDOL","port_date","anon")]
multiple[,net_cost:=quantity*unit_price]
multiple[,net_cost_daily:=sum(net_cost), by=c("Barclays_SEDOL","port_date","anon")]
multiple[,c("N","quantity","net_cost"):=NULL]
multiple <- multiple[,.SD[.N], by=c("Barclays_SEDOL","port_date","anon")]
setnames(multiple, c("quantity_daily","net_cost_daily"), c("quantity","net_cost"))
multiple[quantity>0,transaction_type:="B"]
multiple[quantity<0,transaction_type:="S"]
transaction <- rbind(transaction,multiple)
transaction[,sells:=ifelse(transaction_type=="S",1,0)]
transaction[,sellday:=sum(sells),by=c("port_date","anon")]
transaction[,c("transaction_type", "narative", "cost"):=NULL]

account_date_change <- transaction[,.(sum_change=sum(net_cost)), by=c("anon", "port_date")]

transaction_buy <- transaction[net_cost>0]

transaction_sell <- transaction[net_cost<=0]
selldayamount <- transaction_sell[,.(sum_sell_pounds=sum(net_cost)),by=c("anon","port_date")]


##########################################################

setnames(transaction,"Barclays_SEDOL","sedol")
setnames(transaction,"port_date","date_formated")
transaction <- merge(transaction, portfolios_return, by=c("anon", "date_formated"), all.x=TRUE)
transaction <- merge(transaction, portfolio_stock_composition, by=c("sedol", "anon", "date_formated"), all.x=TRUE)

##########################################################

stock <- fread("G:/rank/raw_data_not_confidential/310518_prices.csv")
static <- fread("D:/industry+tri/static.csv")


##########################################################

head(stock)
stock <- stock[,.SD[1],by=c("DS_SEDOL_CODE", "Barclays_SEDOL")]
stock <- stock[,.(Barclays_SEDOL,DS_SEDOL_CODE,DS_COMPANY_NAME,DS_LOCAL_CODE,DS_GEOGRAPHY_GROUP_NAME)]



setnames(static,c("SEDOL CODE", "GENERAL INDUSTRY CLASSIFICATIO", "INDUSTRY_GROUP_1", "ICB CODE", "INDUSTRY_GROUP_2", "SIC CODE 1", "SIC CODE 2",
                  "INDUSTRY_GROUP_3", "BETA_1", "BETA_2"),c("DS_SEDOL_CODE", "GENERAL_INDUSTRY_CLASSIFICATIO", "INDUSTRY_GROUP_1", "ICB_CODE", "INDUSTRY_GROUP_2",
                                                            "SIC_CODE_1", "SIC_CODE_2", "INDUSTRY_GROUP_3", "BETA_1", "BETA_2"))
static <- static[,.(DS_SEDOL_CODE, GENERAL_INDUSTRY_CLASSIFICATIO, INDUSTRY_GROUP_1, ICB_CODE, INDUSTRY_GROUP_2,
                    SIC_CODE_1, SIC_CODE_2, INDUSTRY_GROUP_3, BETA_1,BETA_2)]

static <- merge(static,stock,by="DS_SEDOL_CODE",all.x=TRUE)
static <- static[,.SD[1],by=Barclays_SEDOL]
setnames(static,"Barclays_SEDOL","sedol")
gc()
transaction <- merge(transaction, static, by="sedol", all.x=TRUE)


transaction[,uk_comp:=ifelse(DS_GEOGRAPHY_GROUP_NAME=="UNITED KINGDOM",1,0)]
transaction[is.na(DS_GEOGRAPHY_GROUP_NAME),uk_comp:=0]
transaction[,unreliable_sic:=ifelse(is.na(SIC_CODE_1),1,0)]
transaction[,SIC_CODE_1_3digits:=floor(SIC_CODE_1/10)]
transaction[,SIC_CODE_1_2digits:=floor(SIC_CODE_1/100)]
transaction[,SIC_division:=ifelse(SIC_CODE_1<1000,"Agriculture, Forestry and Fishing",
                                      ifelse(SIC_CODE_1>=1000&SIC_CODE_1<=1499,"MINING",
                                             ifelse(SIC_CODE_1>=1500&SIC_CODE_1<=1799,"Construction",
                                                    ifelse(SIC_CODE_1>=1800&SIC_CODE_1<=1999,"not used",
                                                           ifelse(SIC_CODE_1>=2000&SIC_CODE_1<=3999,"Manufacturing",
                                                               ifelse(SIC_CODE_1>=4000&SIC_CODE_1<=4999,"Transportation, Communication, Electric, Gas and Sanitary service",
                                                                     ifelse(SIC_CODE_1>=5000&SIC_CODE_1<=5199,"Wholesale Trade",
                                                                        ifelse(SIC_CODE_1>=5200&SIC_CODE_1<=5999,"Retail Trade",
                                                                           ifelse(SIC_CODE_1>=6000&SIC_CODE_1<=6799, "Finance, Insurance and Real Estate",
                                                                              ifelse(SIC_CODE_1>=7000&SIC_CODE_1<=8999, "Service",
                                                                                 ifelse(SIC_CODE_1>=9100 & SIC_CODE_1<=9729, "Public Administration","Unknown")))))))))))]


transaction[,anon_sedol:=paste0(anon,sedol)]
transaction <- transaction[order(anon_sedol,date_formated)]
transaction[,lag_date:=c(NA, date_formated[-.N]),by=anon_sedol]
transaction[,lag_date:=as.Date(lag_date,origin="1970-01-01")]
transaction[,length_lasttrade:=date_formated-lag_date]

######################
transaction_buy <- transaction[net_cost>0]

transaction_buy[,anon_sic_division:=paste0(anon,SIC_division)]
transaction_buy <- transaction_buy[order(anon_sic_division,date_formated)]
transaction_buy[,id_anon_sic_division:=seq_len(.N), by = anon_sic_division]
transaction_buy[is.na(SIC_CODE_1),id_anon_sic_division:=0]
transaction_buy[,anon_sic_division:=NULL]
transaction_buy[,anon_sic_2digits:=paste0(anon,SIC_CODE_1_2digits)]
transaction_buy <- transaction_buy[order(anon_sic_2digits,date_formated)]
transaction_buy[,id_anon_sic_2digits:=seq_len(.N), by = anon_sic_2digits]
transaction_buy[is.na(SIC_CODE_1),id_anon_sic_2digits:=0]
transaction_buy[,anon_sic_2digits:=NULL]

transaction_buy <- transaction_buy[order(anon,date_formated)]
transaction_buy[,buy_seq:=seq_len(.N), by = anon]
min(transaction_buy$date_formated)

```


# trading frequency followingf
```{r}


```{r}
transaction_buy_run <- transaction_buy[date_formated>=as.Date("2013-04-02")]
nrow(transaction_buy_run) # 492442
transaction_buy_run <- transaction_buy_run[!(buy_seq==1)]
nrow(transaction_buy_run) # 448066
transaction_buy_run[,new_stock:=ifelse((quantity==net.posit.port) & (is.na(length_lasttrade)|length_lasttrade>365), 1, 0)]
transaction_buy_run[is.na(new_stock),new_stock:=1]
transaction_buy_run[,new_sic_industry:=ifelse((new_stock==1 & id_anon_sic_division==1),1,0)]
transaction_buy_run[,new_sic_2digits:=ifelse((new_stock==1 & id_anon_sic_2digits==1),1,0)]
transaction_buy_run[,anon_date:=paste0(anon,date_formated)]
transaction_buy_run[,sedol_date:=paste0(sedol,date_formated)]
#####################
```


```{r}
anons <- fread("G:/rank/codes/building up portfolios/141220trial portfolios more anon/account_no_negative_from_trading.csv")
length(unique(transaction[net_cost>0]$anon)) # 118475
transaction_buy_2 <- transaction[net_cost>0]
transaction_buy_run_sub <- transaction_buy_2[ anon %in%anons$accounts]
length(unique(transaction_buy_run_sub$anon)) # 45019
transaction_buy_run_sub <- transaction_buy_run_sub[order(anon,date_formated)]
transaction_buy_run_sub[,id_anon:=seq_len(.N), by = anon]
transaction_buy_run_sub[,num.buys:=.N, by = anon]
length(unique(transaction_buy_run_sub[num.buys>=3]$anon)) # 28987
transaction_buy_run_sub[,half.num.buys:=num.buys/2]
transaction_buy_run_sub[,anon_sic_division:=paste0(anon,SIC_division)]
transaction_buy_run_sub <- transaction_buy_run_sub[order(anon_sic_division,date_formated)]
transaction_buy_run_sub[,id_anon_sic_division:=seq_len(.N), by = anon_sic_division]
transaction_buy_run_sub[is.na(SIC_CODE_1),id_anon_sic_division:=0]
transaction_buy_run_sub[,anon_sic_division:=NULL]
transaction_buy_run_sub[,anon_sic_2digits:=paste0(anon,SIC_CODE_1_2digits)]
transaction_buy_run_sub <- transaction_buy_run_sub[order(anon_sic_2digits,date_formated)]
transaction_buy_run_sub[,id_anon_sic_2digits:=seq_len(.N), by = anon_sic_2digits]
transaction_buy_run_sub[is.na(SIC_CODE_1),id_anon_sic_2digits:=0]
transaction_buy_run_sub[,anon_sic_2digits:=NULL]

transaction_buy_run_sub[,icb_industry:=floor(ICB_CODE/1000)]
transaction_buy_run_sub[,anon_icb_industry:=paste0(anon,icb_industry)]
transaction_buy_run_sub <- transaction_buy_run_sub[order(anon_icb_industry,date_formated)]
transaction_buy_run_sub[,id_anon_icb_industry:=seq_len(.N), by = anon_icb_industry]
transaction_buy_run_sub[is.na(ICB_CODE),id_anon_icb_industry:=0]
transaction_buy_run_sub[,anon_icb_industry:=NULL]

transaction_buy_run_sub[,icb_supersector:=floor(ICB_CODE/100)]
transaction_buy_run_sub[icb_supersector==89,icb_supersector:=85]
transaction_buy_run_sub[,anon_icb_supersector:=paste0(anon,icb_supersector)]
transaction_buy_run_sub <- transaction_buy_run_sub[order(anon_icb_supersector,date_formated)]
transaction_buy_run_sub[,id_anon_icb_supersector:=seq_len(.N), by = anon_icb_supersector]
transaction_buy_run_sub[is.na(ICB_CODE),id_anon_icb_supersector:=0]
transaction_buy_run_sub[,anon_icb_supersector:=NULL]

transaction_buy_run_sub <- transaction_buy_run_sub[order(anon_sedol,date_formated)]
transaction_buy_run_sub[,stock_seq:=seq_len(.N), by = anon_sedol]
transaction_buy_run_sub[,new_stock:=ifelse(stock_seq==1,1,0)]
transaction_buy_run_sub[is.na(new_stock),new_stock:=1]
# transaction_buy_run_sub[,anon_date:=paste0(anon,date_formated)]
# transaction_buy_run_sub <- transaction_buy_run_sub[order(anon,date_formated,transaction_time)]
# transaction_buy_run_sub[,anon_date_seq:=seq_len(.N), by = anon_date]
# transaction_buy_run_sub[,anon_date_n:=.N, by = anon_date]
# transaction_buy_run_sub[,cum_new_buy:=cumsum(new_stock),by=anon]
# transaction_buy_run_sub[,cum_new_buy_2:=ifelse(anon_date_n==anon_date_seq,cum_new_buy,NA)]
# transaction_buy_run_sub[,cum_new_buy_3:=c(0, cum_new_buy_2[-.N]),by=anon]

# transaction_buy_run_sub[,cum_new_buy_4:=na.locf(cum_new_buy_3, na.rm = FALSE)]
# transaction_buy_run_sub[,c("anon_date","anon_date_seq","anon_date_n","cum_new_buy","cum_new_buy_2","cum_new_buy_3"):=NULL]
# setnames(transaction_buy_run_sub,"cum_new_buy_4","cum_new_buy")

# transaction_buy_run_sub[,buy_seq:=seq_len(.N), by = anon]
# transaction_buy_run_sub <- transaction_buy_run_sub[!(buy_seq==1)]
transaction_buy_run_sub[,new_sic_industry:=ifelse((new_stock==1 & id_anon_sic_division==1),1,0)]
transaction_buy_run_sub[,new_sic_2digits:=ifelse((new_stock==1 & id_anon_sic_2digits==1),1,0)]

transaction_buy_run_sub[,new_icb_industry:=ifelse((new_stock==1 & id_anon_icb_industry==1),1,0)]
  
transaction_buy_run_sub <- transaction_buy_run_sub[order(anon,date_formated,transaction_time)]
transaction_buy_run_sub[,anon_date:=paste0(anon,date_formated)]
transaction_buy_run_sub[,anon_date_seq:=seq_len(.N), by = anon_date]
transaction_buy_run_sub[,anon_date_n:=.N, by = anon_date]
transaction_buy_run_sub[,cum_new_icb_industry:=cumsum(new_icb_industry),by=anon]
transaction_buy_run_sub[,cum_new_icb_industry_2:=ifelse(anon_date_n==anon_date_seq,cum_new_icb_industry,NA)]
transaction_buy_run_sub[,cum_new_icb_industry_3:=c(0, cum_new_icb_industry_2[-.N]),by=anon]
transaction_buy_run_sub[,cum_new_icb_industry_4:=na.locf(cum_new_icb_industry_3, na.rm = FALSE)]
transaction_buy_run_sub[,c("anon_date","anon_date_seq","anon_date_n","cum_new_icb_industry","cum_new_icb_industry_2","cum_new_icb_industry_3"):=NULL]
setnames(transaction_buy_run_sub,"cum_new_icb_industry_4","cum_new_icb_industry")

transaction_buy_run_sub[,new_icb_supersector:=ifelse((new_stock==1 & id_anon_icb_supersector==1),1,0)]
transaction_buy_run_sub[,sedol_date:=paste0(sedol,date_formated)]

transaction_buy_run_sub <- transaction_buy_run_sub[order(anon,date_formated,transaction_time)]
transaction_buy_run_sub[,anon_date:=paste0(anon,date_formated)]
transaction_buy_run_sub[,anon_date_seq:=seq_len(.N), by = anon_date]
transaction_buy_run_sub[,anon_date_n:=.N, by = anon_date]
transaction_buy_run_sub[,cum_new_icb_supersector:=cumsum(new_icb_supersector),by=anon]
transaction_buy_run_sub[,cum_new_icb_supersector_2:=ifelse(anon_date_n==anon_date_seq,cum_new_icb_supersector,NA)]
transaction_buy_run_sub[,cum_new_icb_supersector_3:=c(0, cum_new_icb_supersector_2[-.N]),by=anon]
transaction_buy_run_sub[,cum_new_icb_supersector_4:=na.locf(cum_new_icb_supersector_3, na.rm = FALSE)]
transaction_buy_run_sub[,c("anon_date","anon_date_seq","anon_date_n","cum_new_icb_supersector","cum_new_icb_supersector_2","cum_new_icb_supersector_3"):=NULL]
setnames(transaction_buy_run_sub,"cum_new_icb_supersector_4","cum_new_icb_supersector")
```




```{r}

# look at sample size of different samples
nrow(transaction_buy_run[(no.in.portfolio>=5) & !(is.na(winning_prop))]) 
# 29557
   length(unique(transaction_buy_run[(no.in.portfolio>=5) & !(is.na(winning_prop))]$anon)) 
   # 4295
nrow(transaction_buy_run_sub[(no.in.portfolio>=5) & !(is.na(winning_prop))]) 
# 28579
   length(unique(transaction_buy_run_sub[(no.in.portfolio>=5) & !(is.na(winning_prop))]$anon))
   # 4132
   
nrow(transaction_buy_run[(no.in.portfolio>=5) & !(is.na(portf_return_1week_weight))]) 
# 109981
   length(unique(transaction_buy_run[(no.in.portfolio>=5) & !(is.na(portf_return_1week_weight))]$anon)) 
   # 17240
nrow(transaction_buy_run[(no.in.portfolio>=3) & !(is.na(portf_return_1week_weight))]) 
# 171226
   length(unique(transaction_buy_run[(no.in.portfolio>=3) & !(is.na(portf_return_1week_weight))]$anon)) 
   # 26952
nrow(transaction_buy_run[!(is.na(portf_return_1week_weight))]) 
# 274914
   length(unique(transaction_buy_run[!(is.na(portf_return_1week_weight))]$anon)) 
   # 39794
nrow(transaction_buy_run_sub[(no.in.portfolio>=5) & !(is.na(portf_return_1week_weight))]) 
# 63624
   length(unique(transaction_buy_run_sub[(no.in.portfolio>=5) & !(is.na(portf_return_1week_weight))]$anon)) 
   # 7948
nrow(transaction_buy_run_sub[(no.in.portfolio>=3) & !(is.na(portf_return_1week_weight))]) 
# 100561
   length(unique(transaction_buy_run_sub[(no.in.portfolio>=3) & !(is.na(portf_return_1week_weight))]$anon)) 
   # 13322
nrow(transaction_buy_run_sub[ !(is.na(portf_return_1week_weight))]) 
# 169990
   length(unique(transaction_buy_run_sub[ !(is.na(portf_return_1week_weight))]$anon)) 
   # 21389
  
   
nrow(transaction_buy_run[(no.in.portfolio>=5) & !(is.na(portf_return_1month_weight))]) 
# 90497
   length(unique(transaction_buy_run[(no.in.portfolio>=5) & !(is.na(portf_return_1month_weight))]$anon)) 
   # 15929
nrow(transaction_buy_run[(no.in.portfolio>=3) & !(is.na(portf_return_1month_weight))]) 
# 144562
   length(unique(transaction_buy_run[(no.in.portfolio>=3) & !(is.na(portf_return_1month_weight))]$anon)) 
   # 25319
nrow(transaction_buy_run[!(is.na(portf_return_1month_weight))]) 
# 240543
   length(unique(transaction_buy_run[!(is.na(portf_return_1month_weight))]$anon)) 
   # 38373

   
nrow(transaction_buy_run_sub[(no.in.portfolio>=5) & !(is.na(portf_return_1month_weight))]) 
# 56469
   length(unique(transaction_buy_run_sub[(no.in.portfolio>=5) & !(is.na(portf_return_1month_weight))]$anon)) 
   # 7640
nrow(transaction_buy_run_sub[(no.in.portfolio>=3) & !(is.na(portf_return_1month_weight))]) 
# 90681
   length(unique(transaction_buy_run_sub[(no.in.portfolio>=3) & !(is.na(portf_return_1month_weight))]$anon)) 
   # 12844
nrow(transaction_buy_run_sub[ !(is.na(portf_return_1month_weight))]) 
# 156471
   length(unique(transaction_buy_run_sub[ !(is.na(portf_return_1month_weight))]$anon)) 
   # 20967
   
```



```{r}

anon <- fread("D:/raw_data_September_2016/warwick_version--portfolios_201204-201604--id_mapping--with_customer_level_attributes_v2.csv")
check_for_run <- transaction_buy_run_sub[no.in.portfolio>=0 & !(is.na(winning_prop)) & !(is.na(rsp_portf_size)) & !(is.na(portf_return_1day_weight)) & !(is.na(portf_return_3day_weight))& !(is.na(portf_return_1week_weight))  & !(is.na(portf_return_2week_weight))]
anon <- anon[anon_id %in% unique(check_for_run$anon)]
anon[,open_date:=as.Date(open_date)]
anon[close_date=="",close_date:="2016-08-31"]
anon[,close_date:=as.Date(close_date)]
anon[,account_length:=as.numeric(close_date-open_date)]
anon <- anon[order(anon_id,-account_length)]
anon <- anon[,.SD[1],by=anon_id]
anon[,age:=2012-dob]

area_code <- fread("G:/rank/socio-economic/NSPL_AUG_2011.csv")
setnames(area_code,c("PCD","PCD2","PCDS","DOINTR","DOTERM","USERTYPE","OSEAST1M","OSNRTH1M","OSGRDIND","OACODE","CTY","LAUA","WARD","HLTHAU", "HRO", "CTRY", "GOR", "PCON", "EER", "TECLEC", "TTWA", "PCT", "NUTS", "PARK", "SOA1", "SOA2","DZONE1","DZONE2","SOA1NI", "URINDEW", "URINDSC", "URINDNI", "OAC"))
area_code[, postcode:=substring(PCD,1,2)]

# median house price

house_price <- fread("G:/rank/socio-economic/median_house_price.csv",header = TRUE)
house_price <- house_price[,.(LAUA, Mar_2011, Jun_2011, Sep_2011, Dec_2011)]
area_code <- merge(area_code,house_price,by="LAUA",all.x=TRUE)

area_code_house_price <- area_code[!is.na(Dec_2011)]
area_code_house_price <- area_code_house_price[,.(mean_house_price=mean(Dec_2011),
                                                  median_house_price=median(Dec_2011)),
                                               by=postcode]


#weekly_pay
pay <- fread("G:/rank/socio-economic/weekly_pay.csv",header = TRUE)
pay[,median_pay:=as.numeric(median_pay)]
area_code <- merge(area_code,pay,by="LAUA",all.x=TRUE)

area_code_pay <- area_code[!is.na(median_pay)]
area_code_pay <- area_code_pay[,.(mean_weeklypay=mean(median_pay),
                                  median_weeklypay=median(median_pay)),
                               by=postcode]


anon <- merge(anon,area_code_house_price,by="postcode",all.x=TRUE)
anon <- merge(anon,area_code_pay,by="postcode",all.x=TRUE)


buy_times <- transaction_buy[,.N,by=anon]
setnames(buy_times,"N","num.buys")
transaction_sell <- transaction[net_cost<0]
sell_times <- transaction_sell[,.N,by=anon]
setnames(sell_times,"N","num.sells")

setnames(anon,"anon_id","anon")
anon <- merge(anon, buy_times, by="anon",all.x=TRUE)
anon <- merge(anon, sell_times, by="anon",all.x=TRUE)
anon[is.na(num.sells), num.sells:=0]
anon[,trade_freq:=(num.buys+num.sells)*30/account_length]

# calculate log-in frequency for each person

log_in <- fread("D:/wa/merged_logins.csv")
log_in[,date:=substring(V1,1,10)]
log_in[,date:=as.Date(date,format="%d/%m/%Y")]
log_in[,anon_inter:=substring(V3,6,nchar(V3))]
log_in[,anon:=substring(anon_inter,1,(nchar(anon_inter)-4))]
log_in[,anon:=as.numeric(anon)]

setnames(log_in, c("V2","date"), c("log_in_times","port_date"))
log_in_freq <- log_in[,.(log_in_freq=sum(log_in_times)),by=anon]
log_in_days <- log_in[,.(log_in_days=.N),by=anon]
anon <- merge(anon, log_in_freq, by="anon",all.x=TRUE)
anon <- merge(anon, log_in_days, by="anon",all.x=TRUE)
anon[,login_freq:=log_in_days*30/account_length]
# merge in portfolio value

load("G:/rank/intermdiate_data/dt_portfolio_moreanon/portfolio_value.RData")
anon <- merge(anon, portfolio_value_1, by="anon", all.x=TRUE)

```


```{r} 
nrow(transaction_buy_run_sub) #411678
length(unique(transaction_buy_run_sub$anon)) #34950
nrow(transaction_buy_run_sub[num.buys>=3]) #405715
length(unique(transaction_buy_run_sub[num.buys>=3]$anon)) #28987
nrow(transaction_buy_run_sub[num.buys>=3 & no.in.portfolio>=0]) #181667
length(unique(transaction_buy_run_sub[no.in.portfolio>=0]$anon)) #21682
length(unique(transaction_buy_run_sub[num.buys>=3 & no.in.portfolio>=0]$anon)) #21682
nrow(transaction_buy_run_sub[no.in.portfolio>=0 & !(is.na(winning_prop))]) #108805
length(unique(transaction_buy_run_sub[no.in.portfolio>=0 & !(is.na(winning_prop))]$anon)) #15419
nrow(transaction_buy_run_sub[no.in.portfolio>=0 & !(is.na(winning_prop)) & !(is.na(rsp_portf_size)) ]) #108805
nrow(transaction_buy_run_sub[no.in.portfolio>=0 & !(is.na(winning_prop)) & !(is.na(rsp_portf_size)) & !(is.na(portf_return_1day_weight))]) #108804
nrow(transaction_buy_run_sub[no.in.portfolio>=0 & !(is.na(winning_prop)) & !(is.na(rsp_portf_size)) & !(is.na(portf_return_1day_weight))& !(is.na(portf_return_3day_weight))]) #108764
nrow(transaction_buy_run_sub[no.in.portfolio>=0 & !(is.na(winning_prop)) & !(is.na(rsp_portf_size)) & !(is.na(portf_return_1day_weight))& !(is.na(portf_return_3day_weight))& !(is.na(portf_return_1week_weight))]) #108763
nrow(transaction_buy_run_sub[no.in.portfolio>=0 & !(is.na(winning_prop)) & !(is.na(rsp_portf_size)) & !(is.na(portf_return_1day_weight))& !(is.na(portf_return_3day_weight))& !(is.na(portf_return_1week_weight))& !(is.na(portf_return_2week_weight))]) #108763


check_for_run <- transaction_buy_run_sub[no.in.portfolio>=0 & !(is.na(winning_prop)) & !(is.na(rsp_portf_size)) & !(is.na(portf_return_1day_weight)) & !(is.na(portf_return_3day_weight))& !(is.na(portf_return_1week_weight))  & !(is.na(portf_return_2week_weight)) & !(is.na(port_value_change_last_buy))]

check_for_run[,rsp_portf_size_2:= rsp_portf_p/(portfolio_value-rsp_portf_p)]

nrow(check_for_run) #108763
length(unique(check_for_run$anon))  #15417

check_for_run <- merge(check_for_run, anon, by="anon", all.x=TRUE)
check_for_run <- check_for_run[!(is.na(age)) & !(is.na(postcode)) & !(is.na(gender)) & !(is.na(mean_house_price)) & portfolio_value>0]

nrow(check_for_run) #103125
length(unique(check_for_run$anon))  #14553

check_for_run[,ntrades2:=min(ntrades),by=c("anon","date_formated")]
check_for_run[,length_account:=as.numeric(date_formated-open_date)]
check_for_run[,ntrades_freq:=((ntrades2-1)/length_account)*30]
check_for_run[,log_ntrades_freq:=log(ntrades_freq)]
quantile(check_for_run$no.in.portfolio,seq(0,1,0.1))
check_for_run[,no.in.portfolio.group:=as.character(no.in.portfolio)]
check_for_run[no.in.portfolio>=5,no.in.portfolio.group:=">=5"]
check_for_run[,no.in.portfolio.group:=factor(no.in.portfolio.group, levels= c("1", "2", "3", "4",">=5"))]

check_for_run[,new_stock_cost:=new_stock*net_cost]
check_for_run[,old_stock:=-(new_stock-1)]
check_for_run[,old_stock_cost:=old_stock*net_cost]
```

# plot for newbuy/topup distribution over winprop
```{r}
check_for_run2 <- copy(check_for_run)
check_for_run2[,wp_group1:=cut(winning_prop,breaks = seq(0,1,0.2),include.lowest = TRUE)]
check_for_run2[,buy_prop:=net_cost/portfolio_value]
check_for_run2[,buy_prop_win:=Winsorize(buy_prop, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run2[,net_cost_win:=Winsorize(net_cost, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run3 <- check_for_run2[,.(meannetcost=mean(net_cost_win),
                                    sdnetcost=sd(net_cost_win),
                                    meanbuyprop=mean(buy_prop_win),
                                    sdbuyprop=sd(buy_prop_win),
                                    N=.N), by=c("wp_group1","new_stock",
                                                "no.in.portfolio.group")]
check_for_run3[,upper_ci:=meanbuyprop+1.96*sdbuyprop/sqrt(N)]
check_for_run3[,lower_ci:=meanbuyprop-1.96*sdbuyprop/sqrt(N)]
check_for_run3[,Category:=ifelse(new_stock==1, "New Purchase", "Top Up")]
check_for_run3[, Category:= factor(Category, levels = c("Top Up", "New Purchase"))]
(value_prop <- ggplot(check_for_run3, aes(x=wp_group1, y=meanbuyprop, fill=Category))+
  geom_bar(position="dodge", stat="identity")+ facet_wrap(~ no.in.portfolio.group)+
  geom_errorbar(aes(ymin=lower_ci, ymax=upper_ci), width=.2,position=position_dodge(.9))+
  scale_x_discrete(guide = guide_axis(angle = 45))+
  xlab("Winning Proportion") + ylab("Buy Amount (in Pounds)/Portfolio Value"))

ggsave(value_prop, file="G:/rank/new_ind/codes/codes with more anon dataset/value_prop.png",width = 7.29, height = 4.5)

check_for_run3[,upper_ci:=meannetcost+1.96*sdnetcost/sqrt(N)]
check_for_run3[,lower_ci:=meannetcost-1.96*sdnetcost/sqrt(N)]


(value <- ggplot(check_for_run3, aes(x=wp_group1, y=meannetcost, fill=Category))+
  geom_bar(position="dodge", stat="identity")+ facet_wrap(~ no.in.portfolio.group)+
  geom_errorbar(aes(ymin=lower_ci, ymax=upper_ci), width=.2,position=position_dodge(.9))+
  scale_x_discrete(guide = guide_axis(angle = 45))+
  xlab("Winning Proportion") + ylab("Buy Amount (in Pounds)"))

ggsave(value, file="G:/rank/new_ind/codes/codes with more anon dataset/value_winprop.png",width = 7.29, height = 4.5)



```


# what information is used in buys?

```{r}

###################################### adding extra price information into the dataset

leading_zero <- function(x, n)
{
  x <- as.character(x)
  str <- unlist(strsplit(x, split=""))
  if(length(str)<n)
  {
    add <- as.character(rep(0, (n-length(str)) ))
    x <- paste(c(add, str), collapse="")
  }
  return(x)
} 
pp <- fread("G:/rank/raw_data_not_confidential/datastream_20180601.csv")  # <----------- from "cleaning_datastream_20180601.R"
nrow(pp)                  #12194006
length(unique(pp[,sedol]))#11932
length(unique(pp[,isin])) #11836
nrow(pp[is.na(upp)])      #818  (previosly upp==0)
nrow(pp[upp==""])         #0
nrow(pp[upp==0])          #0
pp[,sedol:=unlist(lapply(sedol, function(x){leading_zero(x=x, n=7)}))]
pound <- unique(pp[currency=="GBP", currency])
pp[,date:=as.Date(date, "%Y-%m-%d")]
psub <- unique(pp, by="sedol")
psub <- psub[,.(sedol, DS_STOCK_TYPE, DS_SECURITY_TYPE, DS_SECURITY_TYPE_CODE, DS_GEOGRAPHY_GROUP_NAME)]
nrow(psub)#11932
check_pp <- pp[1:50]
pp[,date_formated:=date]
pp <- pp[order(sedol,date_formated)]

rm(psub)

nrow(pp[is.na(app) & is.na(upp) & is.na(opp)]) # 0

stockstartday <- pp[,.(stockstartdate=min(date_formated)),by=sedol]
# stockstartcheck <- transaction[,.(stockstartdate2=min(date_formated)),by=sedol]
# stockstartcheck2 <- merge(stockstartday, stockstartcheck, by="sedol", all.x=TRUE)

rm(pp)
gc()
```

## calculate returns for buys

```{R}

ftse_return <- fread("G:/rank/new_ind/non_confidential_data/ftseallshare.csv")
ftse_return[,date_formated:=as.Date(Date,format="%d-%b-%y")]
setnames(ftse_return,"Close Price","index")
ftse_return <- ftse_return[,.(date_formated, index)]
ftse_return[,index:=as.numeric(index)]
ftse_return<-ftse_return[order(date_formated)]
ftse_return[,index_lead1:=shift(index, n=1L, fill=NA, type='lead')]
ftse_return[,ftse_ret_fw1day:=(index_lead1-index)/index]
ftse_return <- ftse_return[,.(date_formated, ftse_ret_fw1day)]

##################################### adding extra price information into the dataset

leading_zero <- function(x, n)
{
  x <- as.character(x)
  str <- unlist(strsplit(x, split=""))
  if(length(str)<n)
  {
    add <- as.character(rep(0, (n-length(str)) ))
    x <- paste(c(add, str), collapse="")
  }
  return(x)
} 
load("G:/rank/raw_data_not_confidential/0704ds/extended_price_150421.RData")  # <----------- from 

check <- pp_ext[,.N,by=sedol][order(N)]
pp_ext <- pp_ext[!(sedol%in%check[1:10]$sedol)]
pp_ext[,sedol:=unlist(lapply(sedol, function(x){leading_zero(x=x, n=7)}))]
pp_ext <- pp_ext[order(sedol,date_formated)]

pp_ext <- pp_ext[,.(sedol, date_formated, app )]
pp_ext <- pp_ext[,.SD[1],by=c("sedol","date_formated")]
pp_ext <- pp_ext[date_formated>=as.Date("2011-11-30")]
pp_ext <- merge(pp_ext, ftse_return, by="date_formated", all.x=TRUE)
pp_ext <- pp_ext[order(sedol,date_formated)]

pp_ext[,app_lag1:=c(rep(NA,1), app[1:(.N-1)]),by=sedol]
pp_ext[,app_lag2:=c(rep(NA,2), app[1:(.N-2)]),by=sedol]
pp_ext[,app_lead1:=shift(app, n=1L, fill=NA, type='lead'),by=sedol]
pp_ext[,return_1_pa:=(app_lag1-app_lag2)/app_lag2]
pp_ext[,return_1_fw:=(app_lead1-app)/app]

# return_5_fw
for (i in 1:4){
  name1 <- paste0("return_1_fw_",i)
  pp_ext[,eval(name1):=shift(return_1_fw, n=i, fill=NA, type='lead'),by=sedol]
  name2 <- paste0("ftsereturn_1_fw_",i)
  pp_ext[,eval(name2):=shift(ftse_ret_fw1day, n=i, fill=NA, type='lead'),by=sedol]
}
pp_ext[,na_return_1_fw:=ifelse(is.na(return_1_fw),1,0)]
for (i in 1:4){
  name1 <- paste0("return_1_fw_",i)
  name2 <- paste0("na_return_1_fw_",i)
  pp_ext[,eval(name2):=ifelse(is.na(get(name1)),1,0)]
}
pp_ext[,na_return_5_fw:=na_return_1_fw+na_return_1_fw_1+
           na_return_1_fw_2+na_return_1_fw_3+na_return_1_fw_4]
for (i in 1:4){
  name1 <- paste0("return_1_fw_",i)
  name2 <- paste0("ftsereturn_1_fw_",i)
  pp_ext[,eval(name1):=ifelse(is.na(get(name1)),get(name2),get(name1))]
  pp_ext[,eval(name1):=ifelse(is.na(get(name1)),0,get(name1))]
}
pp_ext[,return_5_fw:=(return_1_fw+1)*(return_1_fw_1+1)*
           (return_1_fw_2+1)*(return_1_fw_3+1)*(return_1_fw_4+1)-1]
for (i in 1:4){
  name1 <- paste0("return_1_fw_",i)
  name2 <- paste0("na_return_1_fw_",i)
  name3 <- paste0("ftsereturn_1_fw_",i)
  pp_ext[,eval(name1):=NULL]
  pp_ext[,eval(name2):=NULL]
  pp_ext[,eval(name3):=NULL]
}

gc()

# return_10_fw getting ready to automat the rest
pp_ext <- pp_ext[order(sedol,date_formated)]
gc()
for (i in (5*2-5):(5*2-1)){
  name1 <- paste0("return_1_fw_",i)
  pp_ext[,eval(name1):=shift(return_1_fw, n=i, fill=NA, type='lead'),by=sedol]
  name2 <- paste0("ftsereturn_1_fw_",i)
  pp_ext[,eval(name2):=shift(ftse_ret_fw1day, n=i, fill=NA, type='lead'),by=sedol]
}

for (i in (5*2-5):(5*2-1)){
  name1 <- paste0("return_1_fw_",i)
  name3 <- paste0("na_return_1_fw_",i)
  pp_ext[,eval(name3):=ifelse(is.na(get(name1)),1,0)]
}

 name3 <- paste0("na_return_",5*2,"_fw")
 name4 <- paste0("na_return_1_fw_",5*2-5)
 name5 <- paste0("na_return_1_fw_",5*2-4)
 name6 <- paste0("na_return_1_fw_",5*2-3)
 name7 <- paste0("na_return_1_fw_",5*2-2)
 name8 <- paste0("na_return_1_fw_",5*2-1)
 name9 <- paste0("na_return_",5*2-5,"_fw")
pp_ext[,eval(name3):=get(name4)+get(name5)+
           get(name6)+get(name7)+get(name8)+get(name9)]
for (i in (5*2-5):(5*2-1)){
  name1 <- paste0("return_1_fw_",i)
  name2 <- paste0("ftsereturn_1_fw_",i)
  pp_ext[,eval(name1):=ifelse(is.na(get(name1)),get(name2),get(name1))]
  pp_ext[,eval(name1):=ifelse(is.na(get(name1)),0,get(name1))]
}
name9 <- paste0("return_",5*2,"_fw")
name10 <- paste0("return_1_fw_",5*2-5)
name11 <- paste0("return_1_fw_",5*2-4)
name12 <- paste0("return_1_fw_",5*2-3)
name13 <- paste0("return_1_fw_",5*2-2)
name14 <- paste0("return_1_fw_",5*2-1)
name15 <- paste0("return_",5*2-5,"_fw")
pp_ext[,eval(name9):=(get(name10)+1)*(get(name11)+1)*
           (get(name12)+1)*(get(name13)+1)*
           (get(name14)+1)*(get(name15)+1)-1]
for (i in (5*2-5):(5*2-1)){
  name1 <- paste0("return_1_fw_",i)
  name2 <- paste0("na_return_1_fw_",i)
  name3 <- paste0("ftsereturn_1_fw_",i)
  pp_ext[,eval(name1):=NULL]
  pp_ext[,eval(name2):=NULL]
  pp_ext[,eval(name3):=NULL]
}

gc()

# automate the rest
for (j in 3:50){
for (i in (5*j-5):(5*j-1)){
  name1 <- paste0("return_1_fw_",i)
  pp_ext[,eval(name1):=shift(return_1_fw, n=i, fill=NA, type='lead'),by=sedol]
  name2 <- paste0("ftsereturn_1_fw_",i)
  pp_ext[,eval(name2):=shift(ftse_ret_fw1day, n=i, fill=NA, type='lead'),by=sedol]
}

for (i in (5*j-5):(5*j-1)){
  name1 <- paste0("return_1_fw_",i)
  name3 <- paste0("na_return_1_fw_",i)
  pp_ext[,eval(name3):=ifelse(is.na(get(name1)),1,0)]
}

 name3 <- paste0("na_return_",5*j,"_fw")
 name4 <- paste0("na_return_1_fw_",5*j-5)
 name5 <- paste0("na_return_1_fw_",5*j-4)
 name6 <- paste0("na_return_1_fw_",5*j-3)
 name7 <- paste0("na_return_1_fw_",5*j-2)
 name8 <- paste0("na_return_1_fw_",5*j-1)
 name9 <- paste0("na_return_",5*j-5,"_fw")
pp_ext[,eval(name3):=get(name4)+get(name5)+
           get(name6)+get(name7)+get(name8)+get(name9)]
for (i in (5*j-5):(5*j-1)){
  name1 <- paste0("return_1_fw_",i)
  name2 <- paste0("ftsereturn_1_fw_",i)
  pp_ext[,eval(name1):=ifelse(is.na(get(name1)),get(name2),get(name1))]
  pp_ext[,eval(name1):=ifelse(is.na(get(name1)),0,get(name1))]
}
name9 <- paste0("return_",5*j,"_fw")
name10 <- paste0("return_1_fw_",5*j-5)
name11 <- paste0("return_1_fw_",5*j-4)
name12 <- paste0("return_1_fw_",5*j-3)
name13 <- paste0("return_1_fw_",5*j-2)
name14 <- paste0("return_1_fw_",5*j-1)
name15 <- paste0("return_",5*j-5,"_fw")
pp_ext[,eval(name9):=(get(name10)+1)*(get(name11)+1)*
           (get(name12)+1)*(get(name13)+1)*
           (get(name14)+1)*(get(name15)+1)-1]
for (i in (5*j-5):(5*j-1)){
  name1 <- paste0("return_1_fw_",i)
  name2 <- paste0("na_return_1_fw_",i)
  name3 <- paste0("ftsereturn_1_fw_",i)
  pp_ext[,eval(name1):=NULL]
  pp_ext[,eval(name2):=NULL]
  pp_ext[,eval(name3):=NULL]
}
gc()
print(j)
}
# nrow(pp_ext) # 15647358
nrow(pp_ext[sedol %in% unique(composition2$sedol)]) # 2711528
pp_ext <- pp_ext[sedol %in% unique(composition2$sedol)] # 2711528
gc()
save(pp_ext, file="G:/rank/new_ind/intermediate_data/pp_ext_futret.RData")



pp_ext2 <- pp_ext[,.(date_formated, sedol, app, ftse_ret_fw1day, return_1_fw)]
pp_ext2[, adjret_1_fw:=return_1_fw-ftse_ret_fw1day]
pp_ext2 <- pp_ext2[order(sedol, date_formated)]
# return_5_fw
for (i in 1:4){
  name1 <- paste0("adjret_1_fw_",i)
  pp_ext2[,eval(name1):=shift(adjret_1_fw, n=i, fill=NA, type='lead'),by=sedol]
}
pp_ext2[,na_adjret_1_fw:=ifelse(is.na(adjret_1_fw),1,0)]
for (i in 1:4){
  name1 <- paste0("adjret_1_fw_",i)
  name2 <- paste0("na_adjret_1_fw_",i)
  pp_ext2[,eval(name2):=ifelse(is.na(get(name1)),1,0)]
}
pp_ext2[,na_adjret_5_fw:=na_adjret_1_fw+na_adjret_1_fw_1+
           na_adjret_1_fw_2+na_adjret_1_fw_3+na_adjret_1_fw_4]
for (i in 1:4){
  name1 <- paste0("adjret_1_fw_",i)
  pp_ext2[,eval(name1):=ifelse(is.na(get(name1)),0,get(name1))]
}
pp_ext2[,adjret_5_fw:=(adjret_1_fw+1)*(adjret_1_fw_1+1)*
           (adjret_1_fw_2+1)*(adjret_1_fw_3+1)*(adjret_1_fw_4+1)-1]
for (i in 1:4){
  name1 <- paste0("adjret_1_fw_",i)
  name2 <- paste0("na_adjret_1_fw_",i)
  pp_ext2[,eval(name1):=NULL]
  pp_ext2[,eval(name2):=NULL]
}

gc()

# return_10_fw getting ready to automat the rest
pp_ext2 <- pp_ext2[order(sedol,date_formated)]
gc()
for (i in (5*2-5):(5*2-1)){
  name1 <- paste0("adjret_1_fw_",i)
  pp_ext2[,eval(name1):=shift(adjret_1_fw, n=i, fill=NA, type='lead'),by=sedol]
}

for (i in (5*2-5):(5*2-1)){
  name1 <- paste0("adjret_1_fw_",i)
  name3 <- paste0("na_adjret_1_fw_",i)
  pp_ext2[,eval(name3):=ifelse(is.na(get(name1)),1,0)]
}

 name3 <- paste0("na_adjret_",5*2,"_fw")
 name4 <- paste0("na_adjret_1_fw_",5*2-5)
 name5 <- paste0("na_adjret_1_fw_",5*2-4)
 name6 <- paste0("na_adjret_1_fw_",5*2-3)
 name7 <- paste0("na_adjret_1_fw_",5*2-2)
 name8 <- paste0("na_adjret_1_fw_",5*2-1)
 name9 <- paste0("na_adjret_",5*2-5,"_fw")
pp_ext2[,eval(name3):=get(name4)+get(name5)+
           get(name6)+get(name7)+get(name8)+get(name9)]
for (i in (5*2-5):(5*2-1)){
  name1 <- paste0("adjret_1_fw_",i)
  pp_ext2[,eval(name1):=ifelse(is.na(get(name1)),0,get(name1))]
}
name9 <- paste0("adjret_",5*2,"_fw")
name10 <- paste0("adjret_1_fw_",5*2-5)
name11 <- paste0("adjret_1_fw_",5*2-4)
name12 <- paste0("adjret_1_fw_",5*2-3)
name13 <- paste0("adjret_1_fw_",5*2-2)
name14 <- paste0("adjret_1_fw_",5*2-1)
name15 <- paste0("adjret_",5*2-5,"_fw")
pp_ext2[,eval(name9):=(get(name10)+1)*(get(name11)+1)*
           (get(name12)+1)*(get(name13)+1)*
           (get(name14)+1)*(get(name15)+1)-1]
for (i in (5*2-5):(5*2-1)){
  name1 <- paste0("adjret_1_fw_",i)
  name2 <- paste0("na_adjret_1_fw_",i)
  pp_ext2[,eval(name1):=NULL]
  pp_ext2[,eval(name2):=NULL]
}

gc()

# automate the rest
for (j in 3:50){
for (i in (5*j-5):(5*j-1)){
  name1 <- paste0("adjret_1_fw_",i)
  pp_ext2[,eval(name1):=shift(adjret_1_fw, n=i, fill=NA, type='lead'),by=sedol]
}

for (i in (5*j-5):(5*j-1)){
  name1 <- paste0("adjret_1_fw_",i)
  name3 <- paste0("na_adjret_1_fw_",i)
  pp_ext2[,eval(name3):=ifelse(is.na(get(name1)),1,0)]
}

 name3 <- paste0("na_adjret_",5*j,"_fw")
 name4 <- paste0("na_adjret_1_fw_",5*j-5)
 name5 <- paste0("na_adjret_1_fw_",5*j-4)
 name6 <- paste0("na_adjret_1_fw_",5*j-3)
 name7 <- paste0("na_adjret_1_fw_",5*j-2)
 name8 <- paste0("na_adjret_1_fw_",5*j-1)
 name9 <- paste0("na_adjret_",5*j-5,"_fw")
pp_ext2[,eval(name3):=get(name4)+get(name5)+
           get(name6)+get(name7)+get(name8)+get(name9)]
for (i in (5*j-5):(5*j-1)){
  name1 <- paste0("adjret_1_fw_",i)
  pp_ext2[,eval(name1):=ifelse(is.na(get(name1)),0,get(name1))]
}
name9 <- paste0("adjret_",5*j,"_fw")
name10 <- paste0("adjret_1_fw_",5*j-5)
name11 <- paste0("adjret_1_fw_",5*j-4)
name12 <- paste0("adjret_1_fw_",5*j-3)
name13 <- paste0("adjret_1_fw_",5*j-2)
name14 <- paste0("adjret_1_fw_",5*j-1)
name15 <- paste0("adjret_",5*j-5,"_fw")
pp_ext2[,eval(name9):=(get(name10)+1)*(get(name11)+1)*
           (get(name12)+1)*(get(name13)+1)*
           (get(name14)+1)*(get(name15)+1)-1]
for (i in (5*j-5):(5*j-1)){
  name1 <- paste0("adjret_1_fw_",i)
  name2 <- paste0("na_adjret_1_fw_",i)
  pp_ext2[,eval(name1):=NULL]
  pp_ext2[,eval(name2):=NULL]
}
gc()
print(j)
}
nrow(pp_ext2) # 15668977
nrow(pp_ext2[sedol %in% unique(composition2$sedol)]) # 2711528
pp_ext2 <- pp_ext2[sedol %in% unique(composition2$sedol)]
save(pp_ext2, file="G:/rank/new_ind/intermediate_data/pp_ext_futadjret.RData")
```

# regression for return difference
```{r}
load("G:/rank/new_ind/intermediate_data/pp_ext_futret.RData")
load("G:/rank/new_ind/intermediate_data/pp_ext_futadjret.RData")
check_for_run2 <- merge(check_for_run, pp_ext2, by=c("sedol", "date_formated"),
                        all.x=TRUE)

nrow(check_for_run2) # 103125
nrow(check_for_run2[na_adjret_250_fw<=20]) # 100217
check_for_run2 <- check_for_run2[na_adjret_250_fw<=20]
check_for_run2[, adjret_250_fw:=Winsorize(adjret_250_fw, probs = c(0.01,0.99),na.rm=TRUE)]
# nrow(check_for_run2[is.finite(adjret_250_fw)]) # 100204
# check_for_run2 <- check_for_run2[is.finite(adjret_250_fw)]
faret1 <- felm(adjret_250_fw~new_stock|0|0|anon+date_formated, data=check_for_run2)
faret2 <- felm(adjret_250_fw~winning_prop|0|0|anon+date_formated, data=check_for_run2)
faret3 <- felm(adjret_250_fw~new_stock+winning_prop|0|0|anon+date_formated, data=check_for_run2)
faret4 <- felm(adjret_250_fw~new_stock+winning_prop|anon|0|anon+date_formated, data=check_for_run2)
faret5 <- felm(adjret_250_fw~new_stock+winning_prop|anon+date_formated|0|anon+date_formated, data=check_for_run2)

faret6 <- felm(adjret_250_fw~new_stock|sedol|0|anon+date_formated, data=check_for_run2)


stargazer(faret1, faret2, faret3, faret4, faret5, faret6, type="latex",   dep.var.labels=c("A New Stock"), star.cutoffs = c(0.05, 0.01, 0.005))

faret7 <- felm(adjret_250_fw~new_stock*winning_prop|anon+date_formated|0|anon+date_formated, data=check_for_run2)

```

# regression for return difference 2
```{r}
check_for_run3 <- merge(check_for_run, pp_ext, by=c("sedol", "date_formated"),
                        all.x=TRUE)

nrow(check_for_run3) # 100217
nrow(check_for_run3[na_return_250_fw<=20]) # 100217
check_for_run3 <- check_for_run3[na_return_250_fw<=20]
nrow(check_for_run3[is.finite(return_250_fw)]) # 100204
#check_for_run3 <- check_for_run3[is.finite(return_250_fw)]
check_for_run3[, return_250_fw:=Winsorize(return_250_fw, probs = c(0.01,0.99),na.rm=TRUE)]
faret12 <- felm(return_250_fw~new_stock|0|0|anon+date_formated, data=check_for_run3)
faret22 <- felm(return_250_fw~winning_prop|0|0|anon+date_formated, data=check_for_run3)
faret32 <- felm(return_250_fw~new_stock+winning_prop|0|0|anon+date_formated, data=check_for_run3)
faret42 <- felm(return_250_fw~new_stock+winning_prop|anon|0|anon+date_formated, data=check_for_run3)
faret52 <- felm(return_250_fw~new_stock+winning_prop|anon+date_formated|0|anon+date_formated, data=check_for_run3)

faret62 <- felm(return_250_fw~new_stock|sedol|0|anon+date_formated, data=check_for_run3)


stargazer(faret12, faret22, faret32, faret42, faret52, faret62, type="latex",   dep.var.labels=c("A New Stock"), star.cutoffs = c(0.05, 0.01, 0.005))

faret72 <- felm(return_250_fw~new_stock*winning_prop|anon+date_formated|0|anon+date_formated, data=check_for_run3)

```

# return plot for buys and unchanged, adj returns
```{r}
check_for_run_fw <- merge(check_for_run, pp_ext2, by=c("sedol", "date_formated"), all.x=TRUE)
check_for_run_fw[,order:=new_stock]
check_for_run_fw[new_icb_industry==1,order:=2]
check_for_run_fw[,order:=as.factor(order)]

check_for_run_fw[,order2:=0]
check_for_run_fw[new_stock==1,order2:=2]
check_for_run_fw[net.posit.port.pre1day==0&new_stock==0,order2:=1]
check_for_run_fw[,order2:=as.factor(order2)]


for (i in 1:50){
  name1 <- paste0("return_",i*5,"_fw")
  name2 <- paste0("adjret_",i*5,"_fw")
  check_for_run_fw[,eval(name1):=Winsorize(get(name2), probs = c(0.01,0.99),na.rm=TRUE)]
}

for (i in 1:50){
  name1 <- paste0("return_",i*5,"_fw")
  name2 <- paste0("na_adjret_",i*5,"_fw")
  check_for_run_fw[,eval(name1):=ifelse(get(name2)>i*5/12, NA, get(name1))]
}

for (i in 1:50){
  name1 <- paste0("return_",i*5,"_fw")
  name2 <- paste0("Nna_return_",i*5,"_fw")
  check_for_run_fw[,eval(name2):=ifelse(is.na(get(name1)), 0, 1)]
}
check_for_run_fw[,wp_group:=cut(winning_prop,breaks = seq(0,1,0.25),include.lowest = TRUE)]

```


```{r}
check_for_run_fw_plot <- check_for_run_fw[,.(
mean_return_0=0,sd_0=0, N_0=1,
mean_return_5=mean(return_5_fw,na.rm=TRUE),sd_5=sd(return_5_fw,na.rm=TRUE), N_5=sum(Nna_return_5_fw),
mean_return_10=mean(return_10_fw,na.rm=TRUE),sd_10=sd(return_10_fw,na.rm=TRUE), N_10=sum(Nna_return_10_fw),
mean_return_15=mean(return_15_fw,na.rm=TRUE),sd_15=sd(return_15_fw,na.rm=TRUE), N_15=sum(Nna_return_15_fw),
mean_return_20=mean(return_20_fw,na.rm=TRUE),sd_20=sd(return_20_fw,na.rm=TRUE), N_20=sum(Nna_return_20_fw),
mean_return_25=mean(return_25_fw,na.rm=TRUE),sd_25=sd(return_25_fw,na.rm=TRUE), N_25=sum(Nna_return_25_fw),
mean_return_30=mean(return_30_fw,na.rm=TRUE),sd_30=sd(return_30_fw,na.rm=TRUE), N_30=sum(Nna_return_30_fw),
mean_return_35=mean(return_35_fw,na.rm=TRUE),sd_35=sd(return_35_fw,na.rm=TRUE), N_35=sum(Nna_return_35_fw),
mean_return_40=mean(return_40_fw,na.rm=TRUE),sd_40=sd(return_40_fw,na.rm=TRUE), N_40=sum(Nna_return_40_fw),
mean_return_45=mean(return_45_fw,na.rm=TRUE),sd_45=sd(return_45_fw,na.rm=TRUE), N_45=sum(Nna_return_45_fw),
mean_return_50=mean(return_50_fw,na.rm=TRUE),sd_50=sd(return_50_fw,na.rm=TRUE), N_50=sum(Nna_return_50_fw),
mean_return_55=mean(return_55_fw,na.rm=TRUE),sd_55=sd(return_55_fw,na.rm=TRUE), N_55=sum(Nna_return_55_fw),
mean_return_60=mean(return_60_fw,na.rm=TRUE),sd_60=sd(return_60_fw,na.rm=TRUE), N_60=sum(Nna_return_60_fw),
mean_return_65=mean(return_65_fw,na.rm=TRUE),sd_65=sd(return_65_fw,na.rm=TRUE), N_65=sum(Nna_return_65_fw),
mean_return_70=mean(return_70_fw,na.rm=TRUE),sd_70=sd(return_70_fw,na.rm=TRUE), N_70=sum(Nna_return_70_fw),
mean_return_75=mean(return_75_fw,na.rm=TRUE),sd_75=sd(return_75_fw,na.rm=TRUE), N_75=sum(Nna_return_75_fw),
mean_return_80=mean(return_80_fw,na.rm=TRUE),sd_80=sd(return_80_fw,na.rm=TRUE), N_80=sum(Nna_return_80_fw),
mean_return_85=mean(return_85_fw,na.rm=TRUE),sd_85=sd(return_85_fw,na.rm=TRUE), N_85=sum(Nna_return_85_fw),
mean_return_90=mean(return_90_fw,na.rm=TRUE),sd_90=sd(return_90_fw,na.rm=TRUE), N_90=sum(Nna_return_90_fw),
mean_return_95=mean(return_95_fw,na.rm=TRUE),sd_95=sd(return_95_fw,na.rm=TRUE), N_95=sum(Nna_return_95_fw),
mean_return_100=mean(return_100_fw,na.rm=TRUE),sd_100=sd(return_100_fw,na.rm=TRUE), N_100=sum(Nna_return_100_fw),
mean_return_105=mean(return_105_fw,na.rm=TRUE),sd_105=sd(return_105_fw,na.rm=TRUE), N_105=sum(Nna_return_105_fw),
mean_return_110=mean(return_110_fw,na.rm=TRUE),sd_110=sd(return_110_fw,na.rm=TRUE), N_110=sum(Nna_return_110_fw),
mean_return_115=mean(return_115_fw,na.rm=TRUE),sd_115=sd(return_115_fw,na.rm=TRUE), N_115=sum(Nna_return_115_fw),
mean_return_120=mean(return_120_fw,na.rm=TRUE),sd_120=sd(return_120_fw,na.rm=TRUE), N_120=sum(Nna_return_120_fw),
mean_return_125=mean(return_125_fw,na.rm=TRUE),sd_125=sd(return_125_fw,na.rm=TRUE), N_125=sum(Nna_return_125_fw),
mean_return_130=mean(return_130_fw,na.rm=TRUE),sd_130=sd(return_130_fw,na.rm=TRUE), N_130=sum(Nna_return_130_fw),
mean_return_135=mean(return_135_fw,na.rm=TRUE),sd_135=sd(return_135_fw,na.rm=TRUE), N_135=sum(Nna_return_135_fw),
mean_return_140=mean(return_140_fw,na.rm=TRUE),sd_140=sd(return_140_fw,na.rm=TRUE), N_140=sum(Nna_return_140_fw),
mean_return_145=mean(return_145_fw,na.rm=TRUE),sd_145=sd(return_145_fw,na.rm=TRUE), N_145=sum(Nna_return_145_fw),
mean_return_150=mean(return_150_fw,na.rm=TRUE),sd_150=sd(return_150_fw,na.rm=TRUE), N_150=sum(Nna_return_150_fw),
mean_return_155=mean(return_155_fw,na.rm=TRUE),sd_155=sd(return_155_fw,na.rm=TRUE), N_155=sum(Nna_return_155_fw),
mean_return_160=mean(return_160_fw,na.rm=TRUE),sd_160=sd(return_160_fw,na.rm=TRUE), N_160=sum(Nna_return_160_fw),
mean_return_165=mean(return_165_fw,na.rm=TRUE),sd_165=sd(return_165_fw,na.rm=TRUE), N_165=sum(Nna_return_165_fw),
mean_return_170=mean(return_170_fw,na.rm=TRUE),sd_170=sd(return_170_fw,na.rm=TRUE), N_170=sum(Nna_return_170_fw),
mean_return_175=mean(return_175_fw,na.rm=TRUE),sd_175=sd(return_175_fw,na.rm=TRUE), N_175=sum(Nna_return_175_fw),
mean_return_180=mean(return_180_fw,na.rm=TRUE),sd_180=sd(return_180_fw,na.rm=TRUE), N_180=sum(Nna_return_180_fw),
mean_return_185=mean(return_185_fw,na.rm=TRUE),sd_185=sd(return_185_fw,na.rm=TRUE), N_185=sum(Nna_return_185_fw),
mean_return_190=mean(return_190_fw,na.rm=TRUE),sd_190=sd(return_190_fw,na.rm=TRUE), N_190=sum(Nna_return_190_fw),
mean_return_195=mean(return_195_fw,na.rm=TRUE),sd_195=sd(return_195_fw,na.rm=TRUE), N_195=sum(Nna_return_195_fw),
mean_return_200=mean(return_200_fw,na.rm=TRUE),sd_200=sd(return_200_fw,na.rm=TRUE), N_200=sum(Nna_return_200_fw),
mean_return_205=mean(return_205_fw,na.rm=TRUE),sd_205=sd(return_205_fw,na.rm=TRUE), N_205=sum(Nna_return_205_fw),
mean_return_210=mean(return_210_fw,na.rm=TRUE),sd_210=sd(return_210_fw,na.rm=TRUE), N_210=sum(Nna_return_210_fw),
mean_return_215=mean(return_215_fw,na.rm=TRUE),sd_215=sd(return_215_fw,na.rm=TRUE), N_215=sum(Nna_return_215_fw),
mean_return_220=mean(return_220_fw,na.rm=TRUE),sd_220=sd(return_220_fw,na.rm=TRUE), N_220=sum(Nna_return_220_fw),
mean_return_225=mean(return_225_fw,na.rm=TRUE),sd_225=sd(return_225_fw,na.rm=TRUE), N_225=sum(Nna_return_225_fw),
mean_return_230=mean(return_230_fw,na.rm=TRUE),sd_230=sd(return_230_fw,na.rm=TRUE), N_230=sum(Nna_return_230_fw),
mean_return_235=mean(return_235_fw,na.rm=TRUE),sd_235=sd(return_235_fw,na.rm=TRUE), N_235=sum(Nna_return_235_fw),
mean_return_240=mean(return_240_fw,na.rm=TRUE),sd_240=sd(return_240_fw,na.rm=TRUE), N_240=sum(Nna_return_240_fw),
mean_return_245=mean(return_245_fw,na.rm=TRUE),sd_245=sd(return_245_fw,na.rm=TRUE), N_245=sum(Nna_return_245_fw),
mean_return_250=mean(return_250_fw,na.rm=TRUE),sd_250=sd(return_250_fw,na.rm=TRUE), N_250=sum(Nna_return_250_fw)
), by="new_stock"]



check_for_run_fw_plot_a <- melt(check_for_run_fw_plot, id.vars="new_stock")
check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a[grepl("sd",variable)]
setnames(check_for_run_fw_plot_a_1, "value", "sd")
#check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a_1[,.(sd=mean(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_1[,days:=rep(seq(0,250,5),each=2)]
check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a[grepl("mean",variable)]
setnames(check_for_run_fw_plot_a_2, "value", "mean")
#check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a_2[,.(mean=mean(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_2[,days:=rep(seq(0,250,5),each=2)]
check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a[grepl("N",variable)]
setnames(check_for_run_fw_plot_a_3, "value", "N")
#check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a_3[,.(N=min(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_3[,days:=rep(seq(0,250,5),each=2)]
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a_1, check_for_run_fw_plot_a_2, by=c("new_stock","days"), all.x=TRUE)
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a, check_for_run_fw_plot_a_3, by=c("new_stock","days"), all.x=TRUE)
check_for_run_fw_plot_a[,upper_ci:=mean+1.96*sd/sqrt(N)]
check_for_run_fw_plot_a[,lower_ci:=mean-1.96*sd/sqrt(N)]
check_for_run_fw_plot_a[,Category:="Purchase - invested stock"]
check_for_run_fw_plot_a[new_stock==1,Category:="New purchase"]
#check_for_run_fw_plot_a[order==2,Category:="New purchase - new industry"]
check_for_run_fw_plot_a$Category <- factor(check_for_run_fw_plot_a$Category, levels = c("Purchase - invested stock", "New purchase"))
#check_for_run_fw_plot[,type2:=paste(type,wp_group)]

# check_for_run_fw_plot$type2 <- factor(check_for_run_fw_plot$type2, levels = c("top up after positive rsp","top up after negative rsp", "new buy-invested industry after positive rsp", "new buy-invested industry after negative rsp", "new buy-new industry after positive rsp", "new buy-new industry after negative rsp"))

pd <- position_dodge(0.09) # move them .05 to the left and right



(adjbuy <- ggplot(check_for_run_fw_plot_a,aes(x=days,y=mean,color=Category))+
       geom_ribbon(aes(ymin=lower_ci, ymax=upper_ci),alpha = .3, linetype=0) +
       geom_line(position=pd) +  xlab("Number of Working Days After the Purchase") + ylab("Adj Return Since Purchase") )


```


```{r}
transaction2 <- transaction[,.(sedol, anon, date_formated, quantity, net_cost)]
portfolio_stock_composition <- merge(portfolio_stock_composition, transaction2, 
                                     by=c("anon","date_formated","sedol"), all.x=TRUE)
portfolio_stock_composition[,buy:=ifelse(net_cost>0,1,0)]
portfolio_stock_composition[is.na(buy), buy:=0]
portfolio_stock_composition[,buyday:=sum(buy), by=c("anon","date_formated")]
portfolio_buyday <- portfolio_stock_composition[buyday>0]

portfolio_unchange_buyday <- portfolio_buyday[is.na(net_cost)]
portfolio_unchange_buyday <- portfolio_unchange_buyday[anon %in% unique(check_for_run$anon)]

portfolio_unchange_buyday <- merge(portfolio_unchange_buyday, pp_ext2, by=c("sedol", "date_formated"), all.x=TRUE)

```
```{r}
for (i in 1:50){
  name1 <- paste0("return_",i*5,"_fw")
  name2 <- paste0("adjret_",i*5,"_fw")
  portfolio_unchange_buyday[,eval(name1):=Winsorize(get(name2), probs = c(0.01,0.99),na.rm=TRUE)]
}

for (i in 1:50){
  name1 <- paste0("return_",i*5,"_fw")
  name2 <- paste0("na_adjret_",i*5,"_fw")
  portfolio_unchange_buyday[,eval(name1):=ifelse(get(name2)>i*5/12, NA, get(name1))]
}

for (i in 1:50){
  name1 <- paste0("return_",i*5,"_fw")
  name2 <- paste0("Nna_return_",i*5,"_fw")
  portfolio_unchange_buyday[,eval(name2):=ifelse(is.na(get(name1)), 0, 1)]
}

```
```{r}
portfolio_unchange_buyday2 <- merge(portfolio_unchange_buyday, portfolios_return, 
                                   by=c("date_formated", "anon"))
portfolio_unchange_buyday2 <- portfolio_unchange_buyday2[!(is.na(winning_prop))]
portfolio_unchange_buyday2 <- portfolio_unchange_buyday2[anon %in% unique(check_for_run_fw$anon)]
portfolio_unchange_buyday_plot <- portfolio_unchange_buyday2[,.(
mean_return_0=0,sd_0=0, N_0=1,
mean_return_5=mean(return_5_fw,na.rm=TRUE),sd_5=sd(return_5_fw,na.rm=TRUE), N_5=sum(Nna_return_5_fw),
mean_return_10=mean(return_10_fw,na.rm=TRUE),sd_10=sd(return_10_fw,na.rm=TRUE), N_10=sum(Nna_return_10_fw),
mean_return_15=mean(return_15_fw,na.rm=TRUE),sd_15=sd(return_15_fw,na.rm=TRUE), N_15=sum(Nna_return_15_fw),
mean_return_20=mean(return_20_fw,na.rm=TRUE),sd_20=sd(return_20_fw,na.rm=TRUE), N_20=sum(Nna_return_20_fw),
mean_return_25=mean(return_25_fw,na.rm=TRUE),sd_25=sd(return_25_fw,na.rm=TRUE), N_25=sum(Nna_return_25_fw),
mean_return_30=mean(return_30_fw,na.rm=TRUE),sd_30=sd(return_30_fw,na.rm=TRUE), N_30=sum(Nna_return_30_fw),
mean_return_35=mean(return_35_fw,na.rm=TRUE),sd_35=sd(return_35_fw,na.rm=TRUE), N_35=sum(Nna_return_35_fw),
mean_return_40=mean(return_40_fw,na.rm=TRUE),sd_40=sd(return_40_fw,na.rm=TRUE), N_40=sum(Nna_return_40_fw),
mean_return_45=mean(return_45_fw,na.rm=TRUE),sd_45=sd(return_45_fw,na.rm=TRUE), N_45=sum(Nna_return_45_fw),
mean_return_50=mean(return_50_fw,na.rm=TRUE),sd_50=sd(return_50_fw,na.rm=TRUE), N_50=sum(Nna_return_50_fw),
mean_return_55=mean(return_55_fw,na.rm=TRUE),sd_55=sd(return_55_fw,na.rm=TRUE), N_55=sum(Nna_return_55_fw),
mean_return_60=mean(return_60_fw,na.rm=TRUE),sd_60=sd(return_60_fw,na.rm=TRUE), N_60=sum(Nna_return_60_fw),
mean_return_65=mean(return_65_fw,na.rm=TRUE),sd_65=sd(return_65_fw,na.rm=TRUE), N_65=sum(Nna_return_65_fw),
mean_return_70=mean(return_70_fw,na.rm=TRUE),sd_70=sd(return_70_fw,na.rm=TRUE), N_70=sum(Nna_return_70_fw),
mean_return_75=mean(return_75_fw,na.rm=TRUE),sd_75=sd(return_75_fw,na.rm=TRUE), N_75=sum(Nna_return_75_fw),
mean_return_80=mean(return_80_fw,na.rm=TRUE),sd_80=sd(return_80_fw,na.rm=TRUE), N_80=sum(Nna_return_80_fw),
mean_return_85=mean(return_85_fw,na.rm=TRUE),sd_85=sd(return_85_fw,na.rm=TRUE), N_85=sum(Nna_return_85_fw),
mean_return_90=mean(return_90_fw,na.rm=TRUE),sd_90=sd(return_90_fw,na.rm=TRUE), N_90=sum(Nna_return_90_fw),
mean_return_95=mean(return_95_fw,na.rm=TRUE),sd_95=sd(return_95_fw,na.rm=TRUE), N_95=sum(Nna_return_95_fw),
mean_return_100=mean(return_100_fw,na.rm=TRUE),sd_100=sd(return_100_fw,na.rm=TRUE), N_100=sum(Nna_return_100_fw),
mean_return_105=mean(return_105_fw,na.rm=TRUE),sd_105=sd(return_105_fw,na.rm=TRUE), N_105=sum(Nna_return_105_fw),
mean_return_110=mean(return_110_fw,na.rm=TRUE),sd_110=sd(return_110_fw,na.rm=TRUE), N_110=sum(Nna_return_110_fw),
mean_return_115=mean(return_115_fw,na.rm=TRUE),sd_115=sd(return_115_fw,na.rm=TRUE), N_115=sum(Nna_return_115_fw),
mean_return_120=mean(return_120_fw,na.rm=TRUE),sd_120=sd(return_120_fw,na.rm=TRUE), N_120=sum(Nna_return_120_fw),
mean_return_125=mean(return_125_fw,na.rm=TRUE),sd_125=sd(return_125_fw,na.rm=TRUE), N_125=sum(Nna_return_125_fw),
mean_return_130=mean(return_130_fw,na.rm=TRUE),sd_130=sd(return_130_fw,na.rm=TRUE), N_130=sum(Nna_return_130_fw),
mean_return_135=mean(return_135_fw,na.rm=TRUE),sd_135=sd(return_135_fw,na.rm=TRUE), N_135=sum(Nna_return_135_fw),
mean_return_140=mean(return_140_fw,na.rm=TRUE),sd_140=sd(return_140_fw,na.rm=TRUE), N_140=sum(Nna_return_140_fw),
mean_return_145=mean(return_145_fw,na.rm=TRUE),sd_145=sd(return_145_fw,na.rm=TRUE), N_145=sum(Nna_return_145_fw),
mean_return_150=mean(return_150_fw,na.rm=TRUE),sd_150=sd(return_150_fw,na.rm=TRUE), N_150=sum(Nna_return_150_fw),
mean_return_155=mean(return_155_fw,na.rm=TRUE),sd_155=sd(return_155_fw,na.rm=TRUE), N_155=sum(Nna_return_155_fw),
mean_return_160=mean(return_160_fw,na.rm=TRUE),sd_160=sd(return_160_fw,na.rm=TRUE), N_160=sum(Nna_return_160_fw),
mean_return_165=mean(return_165_fw,na.rm=TRUE),sd_165=sd(return_165_fw,na.rm=TRUE), N_165=sum(Nna_return_165_fw),
mean_return_170=mean(return_170_fw,na.rm=TRUE),sd_170=sd(return_170_fw,na.rm=TRUE), N_170=sum(Nna_return_170_fw),
mean_return_175=mean(return_175_fw,na.rm=TRUE),sd_175=sd(return_175_fw,na.rm=TRUE), N_175=sum(Nna_return_175_fw),
mean_return_180=mean(return_180_fw,na.rm=TRUE),sd_180=sd(return_180_fw,na.rm=TRUE), N_180=sum(Nna_return_180_fw),
mean_return_185=mean(return_185_fw,na.rm=TRUE),sd_185=sd(return_185_fw,na.rm=TRUE), N_185=sum(Nna_return_185_fw),
mean_return_190=mean(return_190_fw,na.rm=TRUE),sd_190=sd(return_190_fw,na.rm=TRUE), N_190=sum(Nna_return_190_fw),
mean_return_195=mean(return_195_fw,na.rm=TRUE),sd_195=sd(return_195_fw,na.rm=TRUE), N_195=sum(Nna_return_195_fw),
mean_return_200=mean(return_200_fw,na.rm=TRUE),sd_200=sd(return_200_fw,na.rm=TRUE), N_200=sum(Nna_return_200_fw),
mean_return_205=mean(return_205_fw,na.rm=TRUE),sd_205=sd(return_205_fw,na.rm=TRUE), N_205=sum(Nna_return_205_fw),
mean_return_210=mean(return_210_fw,na.rm=TRUE),sd_210=sd(return_210_fw,na.rm=TRUE), N_210=sum(Nna_return_210_fw),
mean_return_215=mean(return_215_fw,na.rm=TRUE),sd_215=sd(return_215_fw,na.rm=TRUE), N_215=sum(Nna_return_215_fw),
mean_return_220=mean(return_220_fw,na.rm=TRUE),sd_220=sd(return_220_fw,na.rm=TRUE), N_220=sum(Nna_return_220_fw),
mean_return_225=mean(return_225_fw,na.rm=TRUE),sd_225=sd(return_225_fw,na.rm=TRUE), N_225=sum(Nna_return_225_fw),
mean_return_230=mean(return_230_fw,na.rm=TRUE),sd_230=sd(return_230_fw,na.rm=TRUE), N_230=sum(Nna_return_230_fw),
mean_return_235=mean(return_235_fw,na.rm=TRUE),sd_235=sd(return_235_fw,na.rm=TRUE), N_235=sum(Nna_return_235_fw),
mean_return_240=mean(return_240_fw,na.rm=TRUE),sd_240=sd(return_240_fw,na.rm=TRUE), N_240=sum(Nna_return_240_fw),
mean_return_245=mean(return_245_fw,na.rm=TRUE),sd_245=sd(return_245_fw,na.rm=TRUE), N_245=sum(Nna_return_245_fw),
mean_return_250=mean(return_250_fw,na.rm=TRUE),sd_250=sd(return_250_fw,na.rm=TRUE), N_250=sum(Nna_return_250_fw)
)]



portfolio_unchange_buyday_plot <- t(portfolio_unchange_buyday_plot)
rnames <- row.names(portfolio_unchange_buyday_plot)
portfolio_unchange_buyday_plot <- as.data.table(portfolio_unchange_buyday_plot)
portfolio_unchange_buyday_plot[,variable:=rnames]
setnames(portfolio_unchange_buyday_plot,"V1","value")
#check_for_run_fw_plot_a <- melt(check_for_run_fw_plot, id.vars="new_stock")
portfolio_unchange_buyday_plot_a_1 <- portfolio_unchange_buyday_plot[grepl("sd",variable)]
setnames(portfolio_unchange_buyday_plot_a_1, "value", "sd")
#check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a_1[,.(sd=mean(value,na.rm=TRUE)),by=c("order", "variable")]
portfolio_unchange_buyday_plot_a_1[,days:=rep(seq(0,250,5),each=1)]
portfolio_unchange_buyday_plot_a_2 <-portfolio_unchange_buyday_plot[grepl("mean",variable)]
setnames(portfolio_unchange_buyday_plot_a_2, "value", "mean")
#check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a_2[,.(mean=mean(value,na.rm=TRUE)),by=c("order", "variable")]
portfolio_unchange_buyday_plot_a_2[,days:=rep(seq(0,250,5),each=1)]
portfolio_unchange_buyday_plot_a_3 <-portfolio_unchange_buyday_plot[grepl("N",variable)]
setnames(portfolio_unchange_buyday_plot_a_3, "value", "N")
#check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a_3[,.(N=min(value,na.rm=TRUE)),by=c("order", "variable")]
portfolio_unchange_buyday_plot_a_3[,days:=rep(seq(0,250,5),each=1)]
portfolio_unchange_buyday_plot_a <- merge(portfolio_unchange_buyday_plot_a_1, portfolio_unchange_buyday_plot_a_2, by="days", all.x=TRUE)
portfolio_unchange_buyday_plot_a <- merge(portfolio_unchange_buyday_plot_a, portfolio_unchange_buyday_plot_a_3, by="days", all.x=TRUE)
portfolio_unchange_buyday_plot_a[,upper_ci:=mean+1.96*sd/sqrt(N)]
portfolio_unchange_buyday_plot_a[,lower_ci:=mean-1.96*sd/sqrt(N)]

pd <- position_dodge(0.09) # move them .05 to the left and right
portfolio_unchange_buyday_plot_a[,Category:="Untouched Stocks"]
portfolio_unchange_buyday_plot_a[,new_stock:=NA]
check_for_run_fw_plot_b <- rbind(check_for_run_fw_plot_a, portfolio_unchange_buyday_plot_a)


(adjbuyall <- ggplot(check_for_run_fw_plot_b,aes(x=days,y=mean, color=Category))+
       geom_ribbon(aes(ymin=lower_ci, ymax=upper_ci),alpha = .3, linetype=0) +
       geom_line(position=pd) +  
    xlab("Number of Working Days After the Purchase") + ylab("Adj Return Since Purchase") )
ggsave(adjbuyall, file="G:/rank/new_ind/codes/codes with more anon dataset/adjret_threegroups.png",width = 7.29, height = 4.5)
```


# return plot for buys and unchanged, unadj returns
```{r}
check_for_run_fw <- merge(check_for_run, pp_ext, by=c("sedol", "date_formated"), all.x=TRUE)
check_for_run_fw[,order:=new_stock]
check_for_run_fw[new_icb_industry==1,order:=2]
check_for_run_fw[,order:=as.factor(order)]

check_for_run_fw[,order2:=0]
check_for_run_fw[new_stock==1,order2:=2]
check_for_run_fw[net.posit.port.pre1day==0&new_stock==0,order2:=1]
check_for_run_fw[,order2:=as.factor(order2)]


for (i in 1:50){
  name1 <- paste0("return_",i*5,"_fw")
  name2 <- paste0("return_",i*5,"_fw")
  check_for_run_fw[,eval(name1):=Winsorize(get(name2), probs = c(0.01,0.99),na.rm=TRUE)]
}

for (i in 1:50){
  name1 <- paste0("return_",i*5,"_fw")
  name2 <- paste0("na_return_",i*5,"_fw")
  check_for_run_fw[,eval(name1):=ifelse(get(name2)>i*5/12, NA, get(name1))]
}

for (i in 1:50){
  name1 <- paste0("return_",i*5,"_fw")
  name2 <- paste0("Nna_return_",i*5,"_fw")
  check_for_run_fw[,eval(name2):=ifelse(is.na(get(name1)), 0, 1)]
}
check_for_run_fw[,wp_group:=cut(winning_prop,breaks = seq(0,1,0.25),include.lowest = TRUE)]

```


```{r}
check_for_run_fw_plot <- check_for_run_fw[,.(
mean_return_0=0,sd_0=0, N_0=1,
mean_return_5=mean(return_5_fw,na.rm=TRUE),sd_5=sd(return_5_fw,na.rm=TRUE), N_5=sum(Nna_return_5_fw),
mean_return_10=mean(return_10_fw,na.rm=TRUE),sd_10=sd(return_10_fw,na.rm=TRUE), N_10=sum(Nna_return_10_fw),
mean_return_15=mean(return_15_fw,na.rm=TRUE),sd_15=sd(return_15_fw,na.rm=TRUE), N_15=sum(Nna_return_15_fw),
mean_return_20=mean(return_20_fw,na.rm=TRUE),sd_20=sd(return_20_fw,na.rm=TRUE), N_20=sum(Nna_return_20_fw),
mean_return_25=mean(return_25_fw,na.rm=TRUE),sd_25=sd(return_25_fw,na.rm=TRUE), N_25=sum(Nna_return_25_fw),
mean_return_30=mean(return_30_fw,na.rm=TRUE),sd_30=sd(return_30_fw,na.rm=TRUE), N_30=sum(Nna_return_30_fw),
mean_return_35=mean(return_35_fw,na.rm=TRUE),sd_35=sd(return_35_fw,na.rm=TRUE), N_35=sum(Nna_return_35_fw),
mean_return_40=mean(return_40_fw,na.rm=TRUE),sd_40=sd(return_40_fw,na.rm=TRUE), N_40=sum(Nna_return_40_fw),
mean_return_45=mean(return_45_fw,na.rm=TRUE),sd_45=sd(return_45_fw,na.rm=TRUE), N_45=sum(Nna_return_45_fw),
mean_return_50=mean(return_50_fw,na.rm=TRUE),sd_50=sd(return_50_fw,na.rm=TRUE), N_50=sum(Nna_return_50_fw),
mean_return_55=mean(return_55_fw,na.rm=TRUE),sd_55=sd(return_55_fw,na.rm=TRUE), N_55=sum(Nna_return_55_fw),
mean_return_60=mean(return_60_fw,na.rm=TRUE),sd_60=sd(return_60_fw,na.rm=TRUE), N_60=sum(Nna_return_60_fw),
mean_return_65=mean(return_65_fw,na.rm=TRUE),sd_65=sd(return_65_fw,na.rm=TRUE), N_65=sum(Nna_return_65_fw),
mean_return_70=mean(return_70_fw,na.rm=TRUE),sd_70=sd(return_70_fw,na.rm=TRUE), N_70=sum(Nna_return_70_fw),
mean_return_75=mean(return_75_fw,na.rm=TRUE),sd_75=sd(return_75_fw,na.rm=TRUE), N_75=sum(Nna_return_75_fw),
mean_return_80=mean(return_80_fw,na.rm=TRUE),sd_80=sd(return_80_fw,na.rm=TRUE), N_80=sum(Nna_return_80_fw),
mean_return_85=mean(return_85_fw,na.rm=TRUE),sd_85=sd(return_85_fw,na.rm=TRUE), N_85=sum(Nna_return_85_fw),
mean_return_90=mean(return_90_fw,na.rm=TRUE),sd_90=sd(return_90_fw,na.rm=TRUE), N_90=sum(Nna_return_90_fw),
mean_return_95=mean(return_95_fw,na.rm=TRUE),sd_95=sd(return_95_fw,na.rm=TRUE), N_95=sum(Nna_return_95_fw),
mean_return_100=mean(return_100_fw,na.rm=TRUE),sd_100=sd(return_100_fw,na.rm=TRUE), N_100=sum(Nna_return_100_fw),
mean_return_105=mean(return_105_fw,na.rm=TRUE),sd_105=sd(return_105_fw,na.rm=TRUE), N_105=sum(Nna_return_105_fw),
mean_return_110=mean(return_110_fw,na.rm=TRUE),sd_110=sd(return_110_fw,na.rm=TRUE), N_110=sum(Nna_return_110_fw),
mean_return_115=mean(return_115_fw,na.rm=TRUE),sd_115=sd(return_115_fw,na.rm=TRUE), N_115=sum(Nna_return_115_fw),
mean_return_120=mean(return_120_fw,na.rm=TRUE),sd_120=sd(return_120_fw,na.rm=TRUE), N_120=sum(Nna_return_120_fw),
mean_return_125=mean(return_125_fw,na.rm=TRUE),sd_125=sd(return_125_fw,na.rm=TRUE), N_125=sum(Nna_return_125_fw),
mean_return_130=mean(return_130_fw,na.rm=TRUE),sd_130=sd(return_130_fw,na.rm=TRUE), N_130=sum(Nna_return_130_fw),
mean_return_135=mean(return_135_fw,na.rm=TRUE),sd_135=sd(return_135_fw,na.rm=TRUE), N_135=sum(Nna_return_135_fw),
mean_return_140=mean(return_140_fw,na.rm=TRUE),sd_140=sd(return_140_fw,na.rm=TRUE), N_140=sum(Nna_return_140_fw),
mean_return_145=mean(return_145_fw,na.rm=TRUE),sd_145=sd(return_145_fw,na.rm=TRUE), N_145=sum(Nna_return_145_fw),
mean_return_150=mean(return_150_fw,na.rm=TRUE),sd_150=sd(return_150_fw,na.rm=TRUE), N_150=sum(Nna_return_150_fw),
mean_return_155=mean(return_155_fw,na.rm=TRUE),sd_155=sd(return_155_fw,na.rm=TRUE), N_155=sum(Nna_return_155_fw),
mean_return_160=mean(return_160_fw,na.rm=TRUE),sd_160=sd(return_160_fw,na.rm=TRUE), N_160=sum(Nna_return_160_fw),
mean_return_165=mean(return_165_fw,na.rm=TRUE),sd_165=sd(return_165_fw,na.rm=TRUE), N_165=sum(Nna_return_165_fw),
mean_return_170=mean(return_170_fw,na.rm=TRUE),sd_170=sd(return_170_fw,na.rm=TRUE), N_170=sum(Nna_return_170_fw),
mean_return_175=mean(return_175_fw,na.rm=TRUE),sd_175=sd(return_175_fw,na.rm=TRUE), N_175=sum(Nna_return_175_fw),
mean_return_180=mean(return_180_fw,na.rm=TRUE),sd_180=sd(return_180_fw,na.rm=TRUE), N_180=sum(Nna_return_180_fw),
mean_return_185=mean(return_185_fw,na.rm=TRUE),sd_185=sd(return_185_fw,na.rm=TRUE), N_185=sum(Nna_return_185_fw),
mean_return_190=mean(return_190_fw,na.rm=TRUE),sd_190=sd(return_190_fw,na.rm=TRUE), N_190=sum(Nna_return_190_fw),
mean_return_195=mean(return_195_fw,na.rm=TRUE),sd_195=sd(return_195_fw,na.rm=TRUE), N_195=sum(Nna_return_195_fw),
mean_return_200=mean(return_200_fw,na.rm=TRUE),sd_200=sd(return_200_fw,na.rm=TRUE), N_200=sum(Nna_return_200_fw),
mean_return_205=mean(return_205_fw,na.rm=TRUE),sd_205=sd(return_205_fw,na.rm=TRUE), N_205=sum(Nna_return_205_fw),
mean_return_210=mean(return_210_fw,na.rm=TRUE),sd_210=sd(return_210_fw,na.rm=TRUE), N_210=sum(Nna_return_210_fw),
mean_return_215=mean(return_215_fw,na.rm=TRUE),sd_215=sd(return_215_fw,na.rm=TRUE), N_215=sum(Nna_return_215_fw),
mean_return_220=mean(return_220_fw,na.rm=TRUE),sd_220=sd(return_220_fw,na.rm=TRUE), N_220=sum(Nna_return_220_fw),
mean_return_225=mean(return_225_fw,na.rm=TRUE),sd_225=sd(return_225_fw,na.rm=TRUE), N_225=sum(Nna_return_225_fw),
mean_return_230=mean(return_230_fw,na.rm=TRUE),sd_230=sd(return_230_fw,na.rm=TRUE), N_230=sum(Nna_return_230_fw),
mean_return_235=mean(return_235_fw,na.rm=TRUE),sd_235=sd(return_235_fw,na.rm=TRUE), N_235=sum(Nna_return_235_fw),
mean_return_240=mean(return_240_fw,na.rm=TRUE),sd_240=sd(return_240_fw,na.rm=TRUE), N_240=sum(Nna_return_240_fw),
mean_return_245=mean(return_245_fw,na.rm=TRUE),sd_245=sd(return_245_fw,na.rm=TRUE), N_245=sum(Nna_return_245_fw),
mean_return_250=mean(return_250_fw,na.rm=TRUE),sd_250=sd(return_250_fw,na.rm=TRUE), N_250=sum(Nna_return_250_fw)
), by="new_stock"]



check_for_run_fw_plot_a <- melt(check_for_run_fw_plot, id.vars="new_stock")
check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a[grepl("sd",variable)]
setnames(check_for_run_fw_plot_a_1, "value", "sd")
#check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a_1[,.(sd=mean(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_1[,days:=rep(seq(0,250,5),each=2)]
check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a[grepl("mean",variable)]
setnames(check_for_run_fw_plot_a_2, "value", "mean")
#check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a_2[,.(mean=mean(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_2[,days:=rep(seq(0,250,5),each=2)]
check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a[grepl("N",variable)]
setnames(check_for_run_fw_plot_a_3, "value", "N")
#check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a_3[,.(N=min(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_3[,days:=rep(seq(0,250,5),each=2)]
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a_1, check_for_run_fw_plot_a_2, by=c("new_stock","days"), all.x=TRUE)
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a, check_for_run_fw_plot_a_3, by=c("new_stock","days"), all.x=TRUE)
check_for_run_fw_plot_a[,upper_ci:=mean+1.96*sd/sqrt(N)]
check_for_run_fw_plot_a[,lower_ci:=mean-1.96*sd/sqrt(N)]
check_for_run_fw_plot_a[,Category:="Purchase - invested stock"]
check_for_run_fw_plot_a[new_stock==1,Category:="New purchase"]
#check_for_run_fw_plot_a[order==2,Category:="New purchase - new industry"]
check_for_run_fw_plot_a$Category <- factor(check_for_run_fw_plot_a$Category, levels = c("Purchase - invested stock", "New purchase"))
#check_for_run_fw_plot[,type2:=paste(type,wp_group)]

# check_for_run_fw_plot$type2 <- factor(check_for_run_fw_plot$type2, levels = c("top up after positive rsp","top up after negative rsp", "new buy-invested industry after positive rsp", "new buy-invested industry after negative rsp", "new buy-new industry after positive rsp", "new buy-new industry after negative rsp"))

pd <- position_dodge(0.09) # move them .05 to the left and right



(unadjbuy <- ggplot(check_for_run_fw_plot_a,aes(x=days,y=mean,color=Category))+
       geom_ribbon(aes(ymin=lower_ci, ymax=upper_ci),alpha = .3, linetype=0) +
       geom_line(position=pd) +  xlab("Number of Working Days After the Purchase") + ylab("Adj Return Since Purchase") )


```


```{r}
#transaction2 <- transaction[,.(sedol, anon, date_formated, quantity, net_cost)]
#portfolio_stock_composition <- merge(portfolio_stock_composition, transaction2, 
#                                     by=c("anon","date_formated","sedol"), all.x=TRUE)
#portfolio_stock_composition[,buy:=ifelse(net_cost>0,1,0)]
#portfolio_stock_composition[is.na(buy), buy:=0]
#portfolio_stock_composition[,buyday:=sum(buy), by=c("anon","date_formated")]
portfolio_buyday <- portfolio_stock_composition[buyday>0]

portfolio_unchange_buyday <- portfolio_buyday[is.na(net_cost)]
portfolio_unchange_buyday <- portfolio_unchange_buyday[anon %in% unique(check_for_run$anon)]

portfolio_unchange_buyday <- merge(portfolio_unchange_buyday, pp_ext, by=c("sedol", "date_formated"), all.x=TRUE)

```
```{r}
for (i in 1:50){
  name1 <- paste0("return_",i*5,"_fw")
  name2 <- paste0("return_",i*5,"_fw")
  portfolio_unchange_buyday[,eval(name1):=Winsorize(get(name2), probs = c(0.01,0.99),na.rm=TRUE)]
}

for (i in 1:50){
  name1 <- paste0("return_",i*5,"_fw")
  name2 <- paste0("na_return_",i*5,"_fw")
  portfolio_unchange_buyday[,eval(name1):=ifelse(get(name2)>i*5/12, NA, get(name1))]
}

for (i in 1:50){
  name1 <- paste0("return_",i*5,"_fw")
  name2 <- paste0("Nna_return_",i*5,"_fw")
  portfolio_unchange_buyday[,eval(name2):=ifelse(is.na(get(name1)), 0, 1)]
}

```
```{r}
portfolio_unchange_buyday2 <- merge(portfolio_unchange_buyday, portfolios_return, 
                                   by=c("date_formated", "anon"))
portfolio_unchange_buyday2 <- portfolio_unchange_buyday2[!(is.na(winning_prop))]
portfolio_unchange_buyday2 <- portfolio_unchange_buyday2[anon %in% unique(check_for_run_fw$anon)]
portfolio_unchange_buyday_plot <- portfolio_unchange_buyday2[,.(
mean_return_0=0,sd_0=0, N_0=1,
mean_return_5=mean(return_5_fw,na.rm=TRUE),sd_5=sd(return_5_fw,na.rm=TRUE), N_5=sum(Nna_return_5_fw),
mean_return_10=mean(return_10_fw,na.rm=TRUE),sd_10=sd(return_10_fw,na.rm=TRUE), N_10=sum(Nna_return_10_fw),
mean_return_15=mean(return_15_fw,na.rm=TRUE),sd_15=sd(return_15_fw,na.rm=TRUE), N_15=sum(Nna_return_15_fw),
mean_return_20=mean(return_20_fw,na.rm=TRUE),sd_20=sd(return_20_fw,na.rm=TRUE), N_20=sum(Nna_return_20_fw),
mean_return_25=mean(return_25_fw,na.rm=TRUE),sd_25=sd(return_25_fw,na.rm=TRUE), N_25=sum(Nna_return_25_fw),
mean_return_30=mean(return_30_fw,na.rm=TRUE),sd_30=sd(return_30_fw,na.rm=TRUE), N_30=sum(Nna_return_30_fw),
mean_return_35=mean(return_35_fw,na.rm=TRUE),sd_35=sd(return_35_fw,na.rm=TRUE), N_35=sum(Nna_return_35_fw),
mean_return_40=mean(return_40_fw,na.rm=TRUE),sd_40=sd(return_40_fw,na.rm=TRUE), N_40=sum(Nna_return_40_fw),
mean_return_45=mean(return_45_fw,na.rm=TRUE),sd_45=sd(return_45_fw,na.rm=TRUE), N_45=sum(Nna_return_45_fw),
mean_return_50=mean(return_50_fw,na.rm=TRUE),sd_50=sd(return_50_fw,na.rm=TRUE), N_50=sum(Nna_return_50_fw),
mean_return_55=mean(return_55_fw,na.rm=TRUE),sd_55=sd(return_55_fw,na.rm=TRUE), N_55=sum(Nna_return_55_fw),
mean_return_60=mean(return_60_fw,na.rm=TRUE),sd_60=sd(return_60_fw,na.rm=TRUE), N_60=sum(Nna_return_60_fw),
mean_return_65=mean(return_65_fw,na.rm=TRUE),sd_65=sd(return_65_fw,na.rm=TRUE), N_65=sum(Nna_return_65_fw),
mean_return_70=mean(return_70_fw,na.rm=TRUE),sd_70=sd(return_70_fw,na.rm=TRUE), N_70=sum(Nna_return_70_fw),
mean_return_75=mean(return_75_fw,na.rm=TRUE),sd_75=sd(return_75_fw,na.rm=TRUE), N_75=sum(Nna_return_75_fw),
mean_return_80=mean(return_80_fw,na.rm=TRUE),sd_80=sd(return_80_fw,na.rm=TRUE), N_80=sum(Nna_return_80_fw),
mean_return_85=mean(return_85_fw,na.rm=TRUE),sd_85=sd(return_85_fw,na.rm=TRUE), N_85=sum(Nna_return_85_fw),
mean_return_90=mean(return_90_fw,na.rm=TRUE),sd_90=sd(return_90_fw,na.rm=TRUE), N_90=sum(Nna_return_90_fw),
mean_return_95=mean(return_95_fw,na.rm=TRUE),sd_95=sd(return_95_fw,na.rm=TRUE), N_95=sum(Nna_return_95_fw),
mean_return_100=mean(return_100_fw,na.rm=TRUE),sd_100=sd(return_100_fw,na.rm=TRUE), N_100=sum(Nna_return_100_fw),
mean_return_105=mean(return_105_fw,na.rm=TRUE),sd_105=sd(return_105_fw,na.rm=TRUE), N_105=sum(Nna_return_105_fw),
mean_return_110=mean(return_110_fw,na.rm=TRUE),sd_110=sd(return_110_fw,na.rm=TRUE), N_110=sum(Nna_return_110_fw),
mean_return_115=mean(return_115_fw,na.rm=TRUE),sd_115=sd(return_115_fw,na.rm=TRUE), N_115=sum(Nna_return_115_fw),
mean_return_120=mean(return_120_fw,na.rm=TRUE),sd_120=sd(return_120_fw,na.rm=TRUE), N_120=sum(Nna_return_120_fw),
mean_return_125=mean(return_125_fw,na.rm=TRUE),sd_125=sd(return_125_fw,na.rm=TRUE), N_125=sum(Nna_return_125_fw),
mean_return_130=mean(return_130_fw,na.rm=TRUE),sd_130=sd(return_130_fw,na.rm=TRUE), N_130=sum(Nna_return_130_fw),
mean_return_135=mean(return_135_fw,na.rm=TRUE),sd_135=sd(return_135_fw,na.rm=TRUE), N_135=sum(Nna_return_135_fw),
mean_return_140=mean(return_140_fw,na.rm=TRUE),sd_140=sd(return_140_fw,na.rm=TRUE), N_140=sum(Nna_return_140_fw),
mean_return_145=mean(return_145_fw,na.rm=TRUE),sd_145=sd(return_145_fw,na.rm=TRUE), N_145=sum(Nna_return_145_fw),
mean_return_150=mean(return_150_fw,na.rm=TRUE),sd_150=sd(return_150_fw,na.rm=TRUE), N_150=sum(Nna_return_150_fw),
mean_return_155=mean(return_155_fw,na.rm=TRUE),sd_155=sd(return_155_fw,na.rm=TRUE), N_155=sum(Nna_return_155_fw),
mean_return_160=mean(return_160_fw,na.rm=TRUE),sd_160=sd(return_160_fw,na.rm=TRUE), N_160=sum(Nna_return_160_fw),
mean_return_165=mean(return_165_fw,na.rm=TRUE),sd_165=sd(return_165_fw,na.rm=TRUE), N_165=sum(Nna_return_165_fw),
mean_return_170=mean(return_170_fw,na.rm=TRUE),sd_170=sd(return_170_fw,na.rm=TRUE), N_170=sum(Nna_return_170_fw),
mean_return_175=mean(return_175_fw,na.rm=TRUE),sd_175=sd(return_175_fw,na.rm=TRUE), N_175=sum(Nna_return_175_fw),
mean_return_180=mean(return_180_fw,na.rm=TRUE),sd_180=sd(return_180_fw,na.rm=TRUE), N_180=sum(Nna_return_180_fw),
mean_return_185=mean(return_185_fw,na.rm=TRUE),sd_185=sd(return_185_fw,na.rm=TRUE), N_185=sum(Nna_return_185_fw),
mean_return_190=mean(return_190_fw,na.rm=TRUE),sd_190=sd(return_190_fw,na.rm=TRUE), N_190=sum(Nna_return_190_fw),
mean_return_195=mean(return_195_fw,na.rm=TRUE),sd_195=sd(return_195_fw,na.rm=TRUE), N_195=sum(Nna_return_195_fw),
mean_return_200=mean(return_200_fw,na.rm=TRUE),sd_200=sd(return_200_fw,na.rm=TRUE), N_200=sum(Nna_return_200_fw),
mean_return_205=mean(return_205_fw,na.rm=TRUE),sd_205=sd(return_205_fw,na.rm=TRUE), N_205=sum(Nna_return_205_fw),
mean_return_210=mean(return_210_fw,na.rm=TRUE),sd_210=sd(return_210_fw,na.rm=TRUE), N_210=sum(Nna_return_210_fw),
mean_return_215=mean(return_215_fw,na.rm=TRUE),sd_215=sd(return_215_fw,na.rm=TRUE), N_215=sum(Nna_return_215_fw),
mean_return_220=mean(return_220_fw,na.rm=TRUE),sd_220=sd(return_220_fw,na.rm=TRUE), N_220=sum(Nna_return_220_fw),
mean_return_225=mean(return_225_fw,na.rm=TRUE),sd_225=sd(return_225_fw,na.rm=TRUE), N_225=sum(Nna_return_225_fw),
mean_return_230=mean(return_230_fw,na.rm=TRUE),sd_230=sd(return_230_fw,na.rm=TRUE), N_230=sum(Nna_return_230_fw),
mean_return_235=mean(return_235_fw,na.rm=TRUE),sd_235=sd(return_235_fw,na.rm=TRUE), N_235=sum(Nna_return_235_fw),
mean_return_240=mean(return_240_fw,na.rm=TRUE),sd_240=sd(return_240_fw,na.rm=TRUE), N_240=sum(Nna_return_240_fw),
mean_return_245=mean(return_245_fw,na.rm=TRUE),sd_245=sd(return_245_fw,na.rm=TRUE), N_245=sum(Nna_return_245_fw),
mean_return_250=mean(return_250_fw,na.rm=TRUE),sd_250=sd(return_250_fw,na.rm=TRUE), N_250=sum(Nna_return_250_fw)
)]



portfolio_unchange_buyday_plot <- t(portfolio_unchange_buyday_plot)
rnames <- row.names(portfolio_unchange_buyday_plot)
portfolio_unchange_buyday_plot <- as.data.table(portfolio_unchange_buyday_plot)
portfolio_unchange_buyday_plot[,variable:=rnames]
setnames(portfolio_unchange_buyday_plot,"V1","value")
#check_for_run_fw_plot_a <- melt(check_for_run_fw_plot, id.vars="new_stock")
portfolio_unchange_buyday_plot_a_1 <- portfolio_unchange_buyday_plot[grepl("sd",variable)]
setnames(portfolio_unchange_buyday_plot_a_1, "value", "sd")
#check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a_1[,.(sd=mean(value,na.rm=TRUE)),by=c("order", "variable")]
portfolio_unchange_buyday_plot_a_1[,days:=rep(seq(0,250,5),each=1)]
portfolio_unchange_buyday_plot_a_2 <-portfolio_unchange_buyday_plot[grepl("mean",variable)]
setnames(portfolio_unchange_buyday_plot_a_2, "value", "mean")
#check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a_2[,.(mean=mean(value,na.rm=TRUE)),by=c("order", "variable")]
portfolio_unchange_buyday_plot_a_2[,days:=rep(seq(0,250,5),each=1)]
portfolio_unchange_buyday_plot_a_3 <-portfolio_unchange_buyday_plot[grepl("N",variable)]
setnames(portfolio_unchange_buyday_plot_a_3, "value", "N")
#check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a_3[,.(N=min(value,na.rm=TRUE)),by=c("order", "variable")]
portfolio_unchange_buyday_plot_a_3[,days:=rep(seq(0,250,5),each=1)]
portfolio_unchange_buyday_plot_a <- merge(portfolio_unchange_buyday_plot_a_1, portfolio_unchange_buyday_plot_a_2, by="days", all.x=TRUE)
portfolio_unchange_buyday_plot_a <- merge(portfolio_unchange_buyday_plot_a, portfolio_unchange_buyday_plot_a_3, by="days", all.x=TRUE)
portfolio_unchange_buyday_plot_a[,upper_ci:=mean+1.96*sd/sqrt(N)]
portfolio_unchange_buyday_plot_a[,lower_ci:=mean-1.96*sd/sqrt(N)]

pd <- position_dodge(0.09) # move them .05 to the left and right
portfolio_unchange_buyday_plot_a[,Category:="Untouched Stocks"]
portfolio_unchange_buyday_plot_a[,new_stock:=NA]
check_for_run_fw_plot_b <- rbind(check_for_run_fw_plot_a, portfolio_unchange_buyday_plot_a)


(unadjbuyall <- ggplot(check_for_run_fw_plot_b,aes(x=days,y=mean, color=Category))+
       geom_ribbon(aes(ymin=lower_ci, ymax=upper_ci),alpha = .3, linetype=0) +
       geom_line(position=pd) +  
    xlab("Number of Working Days After the Purchase") + ylab("Return Since Purchase") )
ggsave(unadjbuyall, file="G:/rank/new_ind/codes/codes with more anon dataset/unadjret_threegroups.png",width = 7.29, height = 4.5)
```




```{r}
buys_info1 <- transaction_buy_run_sub[,CJ(sedol=unique(sedol), date_formated=unique(date_formated)),
                                  by=.(anon)][order(anon, date_formated, sedol),]

# all accounts that have non-negative holdings

# delete observations created with the dates after the stock exists
buys_info1 <- merge(buys_info1, stockstartday, by="sedol", all.x=TRUE)
nrow(buys_info1[date_formated<stockstartdate]) # 143085
buys_info1 <- buys_info1[date_formated>=stockstartdate]
buys_info1 <- buys_info1[sedol %in% unique(pp_ext$sedol)]

length(unique(buys_info1$anon)) # 45,017
nrow(buys_info1) # 6,578,090



anon_newbuy <- unique(check_for_run$anon)
length(unique(anon_newbuy)) # 14,553
nrow(buys_info1[anon %in% anon_newbuy]) # 3,574,529
length(unique(buys_info1[anon %in% anon_newbuy]$anon)) # 14,553

buys <- transaction_buy_run_sub[,.(anon, date_formated, sedol, new_stock)]
buys[,buy:=1]
buys_info1 <- merge(buys_info1, buys, by=c("anon","date_formated","sedol"), all.x=TRUE)
buys_info1 <- buys_info1[order(anon, date_formated, sedol)]
buys_info1[is.na(buy), buy:=0]
buys_info1[,topup:=0]
buys_info1[is.na(new_stock), new_stock:=0]
buys_info1[new_stock==0&buy==1,topup:=1]
buys_info1[,stock_date:=paste0(sedol, date_formated)]
buys_info1[,anon_date:=paste0(anon, date_formated)]
buys_info1[,N_anondate:=.N,by=anon_date]
buys_info1[,N_stockdate:=.N,by=stock_date]
buys_info1[,week:=strftime(date_formated, format = "%Y-%V")]
buys_info1[,stock_week:=paste0(sedol, week)]

buys_info1[, mean_buy_stockdate:=mean(buy),
           by=stock_date]
buys_info1[, mean_buy_stockweek:=mean(buy),
           by=stock_week]
buys_info1[, mean_buy_anondate:=mean(buy),
           by=anon_date]

(pdenstockdatesample11 <- ggplot(buys_info1, aes(x=mean_buy_stockdate)) + 
    geom_histogram(aes(y=..density..),      
                   binwidth=.05,
                   colour="black", fill="white") +
    geom_density(alpha=.2, fill="#FF6666"))  
ggsave(pdenstockdatesample11, file="G:/rank/new_ind/codes/codes with more anon dataset/buy_info/pdenstockdatesample11.png",width = 8, height = 6)
(pdenstockweeksample11 <- ggplot(buys_info1, 
                                  aes(x=mean_buy_stockweek)) + 
    geom_histogram(aes(y=..density..),      
                   binwidth=.05,
                   colour="black", fill="white") +
    geom_density(alpha=.2, fill="#FF6666"))  
ggsave(pdenstockweeksample11, file="G:/rank/new_ind/codes/codes with more anon dataset/buy_info/pdenstockweeksample11.png",width = 8, height = 6)
(pdenanondatesample11 <- ggplot(buys_info1, 
                                  aes(x=mean_buy_anondate)) + 
    geom_histogram(aes(y=..density..),      
                   binwidth=.05,
                   colour="black", fill="white") +
    geom_density(alpha=.2, fill="#FF6666"))  
ggsave(pdenanondatesample11, file="G:/rank/new_ind/codes/codes with more anon dataset/buy_info/pdenanondatesample11.png",width = 8, height = 6)


library(fixest)

f1 <- feols(new_stock~1|stock_date,data=buys_info1)

# Adj. R2: 0.021559
# R2: 1-(1-Adj. R2)/((6578092-1)/(6578092-1037844-1))= 0.1759304

f2 <- feols(topup~1|stock_date,data=buys_info1)

# Adj. R2: -0.021717
# R2: 1-(1-Adj. R2)/((6578092-1)/(6578092-1037844-1))= 0.1394822

f3 <- feols(new_stock~1|stock_date,data=buys_info1[!(topup==1)])

# Adj. R2: 0.031446
# R2: 1-(1-Adj. R2)/((6371397-1)/(6371397-1034900-1))= 0.1887673

f4 <- feols(topup~1|stock_date,data=buys_info1[!(new_stock==1)])

# Adj. R2: -0.009805
# R2: 1-(1-Adj. R2)/((6328248-1)/(6328248-1030930-1))= 0.1547016

f5 <- feols(new_stock~1|anon_date,data=buys_info1[!(topup==1)])
# Adj. R2: 0.192629
# R2: 1-(1-Adj. R2)/((6371395-1)/(6371395-340921-1))= 0.2358299
f6 <- feols(topup~1|anon_date,data=buys_info1[!(new_stock==1)])
# Adj. R2: 0.118059
# R2: 1-(1-Adj. R2)/((6328248-1)/(6328248-340921-1))= 0.1655717
f7 <- feols(new_stock~1|anon_date+stock_date,data=buys_info1[!(topup==1)])
# Adj. R2: 0.209091
# R2: 1-(1-Adj. R2)/((6371395-1)/(6371395-340921-1034898-1))= 0.3798774
f8 <- feols(topup~1|anon_date+stock_date,data=buys_info1[!(new_stock==1)])
# Adj. R2: 0.094324
# R2: 1-(1-Adj. R2)/((6328248-1)/(6328248-335900-1030930-1))= 0.2899398
f9 <- feols(new_stock~1|anon_date+stock_week,data=buys_info1[!(topup==1)])
# Adj. R2: 0.217319
# R2: 1-(1-Adj. R2)/((6371395-1)/(6371395-340921-270742-1))= 0.2924575
f10 <- feols(topup~1|anon_date+stock_week,data=buys_info1[!(new_stock==1)])
# Adj. R2: 0.135308
# R2: 1-(1-Adj. R2)/((6328248-1)/(6328248-335900-269972-1))= 0.2180944

```

# return plot
```{r}
ret_buys_info1 <- merge(buys_info1, pp_ext, by=c("sedol","date_formated"), all.x=TRUE)
for (i in 1:50){
  name1 <- paste0("na_return_",i*5,"_fw")
  name2 <- paste0("return_",i*5,"_fw")
  ret_buys_info1[get(name1)>=i*0.5, eval(name2):=NA]
  print(i)
}
nrow(ret_buys_info1[is.na(return_5_fw)])/nrow(ret_buys_info1)
nrow(ret_buys_info1[is.na(return_5_fw)])/nrow(ret_buys_info1)

for (i in 1:50){
  name1 <- paste0("return_",i*5,"_fw")
  name2 <- paste0("nad_return_",i*5,"_fw")
  ret_buys_info1[, eval(name2):=ifelse(is.na(get(name1)),0,1)]
  print(i)
}

for (i in 1:50){
  name1 <- paste0("return_",i*5,"_fww")
  name2 <- paste0("return_",i*5,"_fw")
  ret_buys_info1[, eval(name1):=Winsorize(get(name2), probs = c(0.01,0.99),na.rm=TRUE)]
  print(i)
}

ret_buys_info1[,category:="Not Trade"]
ret_buys_info1[topup==1,category:="Top Up"]
ret_buys_info1[new_stock==1,category:="New Stock"]


ret_plot <- ret_buys_info1[,.(mean_return_0=0,sd_0=0, N_0=1,
mean_return_5=mean(return_5_fww,na.rm=TRUE),sd_5=sd(return_5_fww,na.rm=TRUE), N_5=sum(nad_return_5_fw),
mean_return_10=mean(return_10_fww,na.rm=TRUE),sd_10=sd(return_10_fww,na.rm=TRUE), N_10=sum(nad_return_10_fw),
mean_return_15=mean(return_15_fww,na.rm=TRUE),sd_15=sd(return_15_fww,na.rm=TRUE), N_15=sum(nad_return_15_fw),
mean_return_20=mean(return_20_fww,na.rm=TRUE),sd_20=sd(return_20_fww,na.rm=TRUE), N_20=sum(nad_return_20_fw),
mean_return_25=mean(return_25_fww,na.rm=TRUE),sd_25=sd(return_25_fww,na.rm=TRUE), N_25=sum(nad_return_25_fw),
mean_return_30=mean(return_30_fww,na.rm=TRUE),sd_30=sd(return_30_fww,na.rm=TRUE), N_30=sum(nad_return_30_fw),
mean_return_35=mean(return_35_fww,na.rm=TRUE),sd_35=sd(return_35_fww,na.rm=TRUE), N_35=sum(nad_return_35_fw),
mean_return_40=mean(return_40_fww,na.rm=TRUE),sd_40=sd(return_40_fww,na.rm=TRUE), N_40=sum(nad_return_40_fw),
mean_return_45=mean(return_45_fww,na.rm=TRUE),sd_45=sd(return_45_fww,na.rm=TRUE), N_45=sum(nad_return_45_fw),
mean_return_50=mean(return_50_fww,na.rm=TRUE),sd_50=sd(return_50_fww,na.rm=TRUE), N_50=sum(nad_return_50_fw),
mean_return_55=mean(return_55_fww,na.rm=TRUE),sd_55=sd(return_55_fww,na.rm=TRUE), N_55=sum(nad_return_55_fw),
mean_return_60=mean(return_60_fww,na.rm=TRUE),sd_60=sd(return_60_fww,na.rm=TRUE), N_60=sum(nad_return_60_fw),
mean_return_65=mean(return_65_fww,na.rm=TRUE),sd_65=sd(return_65_fww,na.rm=TRUE), N_65=sum(nad_return_65_fw),
mean_return_70=mean(return_70_fww,na.rm=TRUE),sd_70=sd(return_70_fww,na.rm=TRUE), N_70=sum(nad_return_70_fw),
mean_return_75=mean(return_75_fww,na.rm=TRUE),sd_75=sd(return_75_fww,na.rm=TRUE), N_75=sum(nad_return_75_fw),
mean_return_80=mean(return_80_fww,na.rm=TRUE),sd_80=sd(return_80_fww,na.rm=TRUE), N_80=sum(nad_return_80_fw),
mean_return_85=mean(return_85_fww,na.rm=TRUE),sd_85=sd(return_85_fww,na.rm=TRUE), N_85=sum(nad_return_85_fw),
mean_return_90=mean(return_90_fww,na.rm=TRUE),sd_90=sd(return_90_fww,na.rm=TRUE), N_90=sum(nad_return_90_fw),
mean_return_95=mean(return_95_fww,na.rm=TRUE),sd_95=sd(return_95_fww,na.rm=TRUE), N_95=sum(nad_return_95_fw),
mean_return_100=mean(return_100_fww,na.rm=TRUE),sd_100=sd(return_100_fww,na.rm=TRUE), N_100=sum(nad_return_100_fw),
mean_return_105=mean(return_105_fww,na.rm=TRUE),sd_105=sd(return_105_fww,na.rm=TRUE), N_105=sum(nad_return_105_fw),
mean_return_110=mean(return_110_fww,na.rm=TRUE),sd_110=sd(return_110_fww,na.rm=TRUE), N_110=sum(nad_return_110_fw),
mean_return_115=mean(return_115_fww,na.rm=TRUE),sd_115=sd(return_115_fww,na.rm=TRUE), N_115=sum(nad_return_115_fw),
mean_return_120=mean(return_120_fww,na.rm=TRUE),sd_120=sd(return_120_fww,na.rm=TRUE), N_120=sum(nad_return_120_fw),
mean_return_125=mean(return_125_fww,na.rm=TRUE),sd_125=sd(return_125_fww,na.rm=TRUE), N_125=sum(nad_return_125_fw),
mean_return_130=mean(return_130_fww,na.rm=TRUE),sd_130=sd(return_130_fww,na.rm=TRUE), N_130=sum(nad_return_130_fw),
mean_return_135=mean(return_135_fww,na.rm=TRUE),sd_135=sd(return_135_fww,na.rm=TRUE), N_135=sum(nad_return_135_fw),
mean_return_140=mean(return_140_fww,na.rm=TRUE),sd_140=sd(return_140_fww,na.rm=TRUE), N_140=sum(nad_return_140_fw),
mean_return_145=mean(return_145_fww,na.rm=TRUE),sd_145=sd(return_145_fww,na.rm=TRUE), N_145=sum(nad_return_145_fw),
mean_return_150=mean(return_150_fww,na.rm=TRUE),sd_150=sd(return_150_fww,na.rm=TRUE), N_150=sum(nad_return_150_fw),
mean_return_155=mean(return_155_fww,na.rm=TRUE),sd_155=sd(return_155_fww,na.rm=TRUE), N_155=sum(nad_return_155_fw),
mean_return_160=mean(return_160_fww,na.rm=TRUE),sd_160=sd(return_160_fww,na.rm=TRUE), N_160=sum(nad_return_160_fw),
mean_return_165=mean(return_165_fww,na.rm=TRUE),sd_165=sd(return_165_fww,na.rm=TRUE), N_165=sum(nad_return_165_fw),
mean_return_170=mean(return_170_fww,na.rm=TRUE),sd_170=sd(return_170_fww,na.rm=TRUE), N_170=sum(nad_return_170_fw),
mean_return_175=mean(return_175_fww,na.rm=TRUE),sd_175=sd(return_175_fww,na.rm=TRUE), N_175=sum(nad_return_175_fw),
mean_return_180=mean(return_180_fww,na.rm=TRUE),sd_180=sd(return_180_fww,na.rm=TRUE), N_180=sum(nad_return_180_fw),
mean_return_185=mean(return_185_fww,na.rm=TRUE),sd_185=sd(return_185_fww,na.rm=TRUE), N_185=sum(nad_return_185_fw),
mean_return_190=mean(return_190_fww,na.rm=TRUE),sd_190=sd(return_190_fww,na.rm=TRUE), N_190=sum(nad_return_190_fw),
mean_return_195=mean(return_195_fww,na.rm=TRUE),sd_195=sd(return_195_fww,na.rm=TRUE), N_195=sum(nad_return_195_fw),
mean_return_200=mean(return_200_fww,na.rm=TRUE),sd_200=sd(return_200_fww,na.rm=TRUE), N_200=sum(nad_return_200_fw),
mean_return_205=mean(return_205_fww,na.rm=TRUE),sd_205=sd(return_205_fww,na.rm=TRUE), N_205=sum(nad_return_205_fw),
mean_return_210=mean(return_210_fww,na.rm=TRUE),sd_210=sd(return_210_fww,na.rm=TRUE), N_210=sum(nad_return_210_fw),
mean_return_215=mean(return_215_fww,na.rm=TRUE),sd_215=sd(return_215_fww,na.rm=TRUE), N_215=sum(nad_return_215_fw),
mean_return_220=mean(return_220_fww,na.rm=TRUE),sd_220=sd(return_220_fww,na.rm=TRUE), N_220=sum(nad_return_220_fw),
mean_return_225=mean(return_225_fww,na.rm=TRUE),sd_225=sd(return_225_fww,na.rm=TRUE), N_225=sum(nad_return_225_fw),
mean_return_230=mean(return_230_fww,na.rm=TRUE),sd_230=sd(return_230_fww,na.rm=TRUE), N_230=sum(nad_return_230_fw),
mean_return_235=mean(return_235_fww,na.rm=TRUE),sd_235=sd(return_235_fww,na.rm=TRUE), N_235=sum(nad_return_235_fw),
mean_return_240=mean(return_240_fww,na.rm=TRUE),sd_240=sd(return_240_fww,na.rm=TRUE), N_240=sum(nad_return_240_fw),
mean_return_245=mean(return_245_fww,na.rm=TRUE),sd_245=sd(return_245_fww,na.rm=TRUE), N_245=sum(nad_return_245_fw),
mean_return_250=mean(return_250_fww,na.rm=TRUE),sd_250=sd(return_250_fww,na.rm=TRUE), N_250=sum(nad_return_250_fw)), by=category]


```
```{R}
check_for_run_fw_plot_a <- melt(ret_plot, id.vars="category")
check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a[grepl("sd",variable)]
setnames(check_for_run_fw_plot_a_1, "value", "sd")
#check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a_1[,.(sd=mean(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_1[,days:=rep(seq(0,250,5),each=3)]
check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a[grepl("mean",variable)]
setnames(check_for_run_fw_plot_a_2, "value", "mean")
#check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a_2[,.(mean=mean(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_2[,days:=rep(seq(0,250,5),each=3)]
check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a[grepl("N",variable)]
setnames(check_for_run_fw_plot_a_3, "value", "N")
#check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a_3[,.(N=min(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_3[,days:=rep(seq(0,250,5),each=3)]
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a_1, check_for_run_fw_plot_a_2, by=c("category","days"), all.x=TRUE)
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a, check_for_run_fw_plot_a_3, by=c("category","days"), all.x=TRUE)
check_for_run_fw_plot_a[,upper_ci:=mean+1.96*sd/sqrt(N)]
check_for_run_fw_plot_a[,lower_ci:=mean-1.96*sd/sqrt(N)]
#check_for_run_fw_plot_a[,Category:="Purchase - invested stock"]
#check_for_run_fw_plot_a[new_stock==1,Category:="New purchase"]
#check_for_run_fw_plot_a[order==2,Category:="New purchase - new industry"]
check_for_run_fw_plot_a$category <- factor(check_for_run_fw_plot_a$category, levels = c("Not Trade", "Top Up", "New Stock"))
#check_for_run_fw_plot[,type2:=paste(type,wp_group)]

# check_for_run_fw_plot$type2 <- factor(check_for_run_fw_plot$type2, levels = c("top up after positive rsp","top up after negative rsp", "new buy-invested industry after positive rsp", "new buy-invested industry after negative rsp", "new buy-new industry after positive rsp", "new buy-new industry after negative rsp"))

pd <- position_dodge(0.09) # move them .05 to the left and right



(g1 <- ggplot(check_for_run_fw_plot_a,aes(x=days,y=mean,color=category))+
       geom_ribbon(aes(ymin=lower_ci, ymax=upper_ci),alpha = .3, linetype=0) +
       geom_line(position=pd) +  xlab("Number of Working Days After the Purchase") + ylab("Raw Return") )


ggsave(g1, file="G:/rank/new_ind/codes/codes with more anon dataset/buy_info/three_types_fullsample.png",width = 8, height = 6)
```

# adj return plot
```{r}
ret_buys_info1 <- merge(buys_info1, pp_ext2, by=c("sedol","date_formated"), all.x=TRUE)
for (i in 1:50){
  name1 <- paste0("na_adjret_",i*5,"_fw")
  name2 <- paste0("adjret_",i*5,"_fw")
  ret_buys_info1[get(name1)>=i*0.5, eval(name2):=NA]
  print(i)
}
#nrow(ret_buys_info1[is.na(return_5_fw)])/nrow(ret_buys_info1)
#nrow(ret_buys_info1[is.na(return_5_fw)])/nrow(ret_buys_info1)

for (i in 1:50){
  name1 <- paste0("adjret_",i*5,"_fw")
  name2 <- paste0("nad_return_",i*5,"_fw")
  ret_buys_info1[, eval(name2):=ifelse(is.na(get(name1)),0,1)]
  print(i)
}

for (i in 1:50){
  name1 <- paste0("return_",i*5,"_fww")
  name2 <- paste0("adjret_",i*5,"_fw")
  ret_buys_info1[, eval(name1):=Winsorize(get(name2), probs = c(0.01,0.99),na.rm=TRUE)]
  print(i)
}

ret_buys_info1[,category:="Not Trade"]
ret_buys_info1[topup==1,category:="Top Up"]
ret_buys_info1[new_stock==1,category:="New Stock"]


ret_plot <- ret_buys_info1[,.(mean_return_0=0,sd_0=0, N_0=1,
mean_return_5=mean(return_5_fww,na.rm=TRUE),sd_5=sd(return_5_fww,na.rm=TRUE), N_5=sum(nad_return_5_fw),
mean_return_10=mean(return_10_fww,na.rm=TRUE),sd_10=sd(return_10_fww,na.rm=TRUE), N_10=sum(nad_return_10_fw),
mean_return_15=mean(return_15_fww,na.rm=TRUE),sd_15=sd(return_15_fww,na.rm=TRUE), N_15=sum(nad_return_15_fw),
mean_return_20=mean(return_20_fww,na.rm=TRUE),sd_20=sd(return_20_fww,na.rm=TRUE), N_20=sum(nad_return_20_fw),
mean_return_25=mean(return_25_fww,na.rm=TRUE),sd_25=sd(return_25_fww,na.rm=TRUE), N_25=sum(nad_return_25_fw),
mean_return_30=mean(return_30_fww,na.rm=TRUE),sd_30=sd(return_30_fww,na.rm=TRUE), N_30=sum(nad_return_30_fw),
mean_return_35=mean(return_35_fww,na.rm=TRUE),sd_35=sd(return_35_fww,na.rm=TRUE), N_35=sum(nad_return_35_fw),
mean_return_40=mean(return_40_fww,na.rm=TRUE),sd_40=sd(return_40_fww,na.rm=TRUE), N_40=sum(nad_return_40_fw),
mean_return_45=mean(return_45_fww,na.rm=TRUE),sd_45=sd(return_45_fww,na.rm=TRUE), N_45=sum(nad_return_45_fw),
mean_return_50=mean(return_50_fww,na.rm=TRUE),sd_50=sd(return_50_fww,na.rm=TRUE), N_50=sum(nad_return_50_fw),
mean_return_55=mean(return_55_fww,na.rm=TRUE),sd_55=sd(return_55_fww,na.rm=TRUE), N_55=sum(nad_return_55_fw),
mean_return_60=mean(return_60_fww,na.rm=TRUE),sd_60=sd(return_60_fww,na.rm=TRUE), N_60=sum(nad_return_60_fw),
mean_return_65=mean(return_65_fww,na.rm=TRUE),sd_65=sd(return_65_fww,na.rm=TRUE), N_65=sum(nad_return_65_fw),
mean_return_70=mean(return_70_fww,na.rm=TRUE),sd_70=sd(return_70_fww,na.rm=TRUE), N_70=sum(nad_return_70_fw),
mean_return_75=mean(return_75_fww,na.rm=TRUE),sd_75=sd(return_75_fww,na.rm=TRUE), N_75=sum(nad_return_75_fw),
mean_return_80=mean(return_80_fww,na.rm=TRUE),sd_80=sd(return_80_fww,na.rm=TRUE), N_80=sum(nad_return_80_fw),
mean_return_85=mean(return_85_fww,na.rm=TRUE),sd_85=sd(return_85_fww,na.rm=TRUE), N_85=sum(nad_return_85_fw),
mean_return_90=mean(return_90_fww,na.rm=TRUE),sd_90=sd(return_90_fww,na.rm=TRUE), N_90=sum(nad_return_90_fw),
mean_return_95=mean(return_95_fww,na.rm=TRUE),sd_95=sd(return_95_fww,na.rm=TRUE), N_95=sum(nad_return_95_fw),
mean_return_100=mean(return_100_fww,na.rm=TRUE),sd_100=sd(return_100_fww,na.rm=TRUE), N_100=sum(nad_return_100_fw),
mean_return_105=mean(return_105_fww,na.rm=TRUE),sd_105=sd(return_105_fww,na.rm=TRUE), N_105=sum(nad_return_105_fw),
mean_return_110=mean(return_110_fww,na.rm=TRUE),sd_110=sd(return_110_fww,na.rm=TRUE), N_110=sum(nad_return_110_fw),
mean_return_115=mean(return_115_fww,na.rm=TRUE),sd_115=sd(return_115_fww,na.rm=TRUE), N_115=sum(nad_return_115_fw),
mean_return_120=mean(return_120_fww,na.rm=TRUE),sd_120=sd(return_120_fww,na.rm=TRUE), N_120=sum(nad_return_120_fw),
mean_return_125=mean(return_125_fww,na.rm=TRUE),sd_125=sd(return_125_fww,na.rm=TRUE), N_125=sum(nad_return_125_fw),
mean_return_130=mean(return_130_fww,na.rm=TRUE),sd_130=sd(return_130_fww,na.rm=TRUE), N_130=sum(nad_return_130_fw),
mean_return_135=mean(return_135_fww,na.rm=TRUE),sd_135=sd(return_135_fww,na.rm=TRUE), N_135=sum(nad_return_135_fw),
mean_return_140=mean(return_140_fww,na.rm=TRUE),sd_140=sd(return_140_fww,na.rm=TRUE), N_140=sum(nad_return_140_fw),
mean_return_145=mean(return_145_fww,na.rm=TRUE),sd_145=sd(return_145_fww,na.rm=TRUE), N_145=sum(nad_return_145_fw),
mean_return_150=mean(return_150_fww,na.rm=TRUE),sd_150=sd(return_150_fww,na.rm=TRUE), N_150=sum(nad_return_150_fw),
mean_return_155=mean(return_155_fww,na.rm=TRUE),sd_155=sd(return_155_fww,na.rm=TRUE), N_155=sum(nad_return_155_fw),
mean_return_160=mean(return_160_fww,na.rm=TRUE),sd_160=sd(return_160_fww,na.rm=TRUE), N_160=sum(nad_return_160_fw),
mean_return_165=mean(return_165_fww,na.rm=TRUE),sd_165=sd(return_165_fww,na.rm=TRUE), N_165=sum(nad_return_165_fw),
mean_return_170=mean(return_170_fww,na.rm=TRUE),sd_170=sd(return_170_fww,na.rm=TRUE), N_170=sum(nad_return_170_fw),
mean_return_175=mean(return_175_fww,na.rm=TRUE),sd_175=sd(return_175_fww,na.rm=TRUE), N_175=sum(nad_return_175_fw),
mean_return_180=mean(return_180_fww,na.rm=TRUE),sd_180=sd(return_180_fww,na.rm=TRUE), N_180=sum(nad_return_180_fw),
mean_return_185=mean(return_185_fww,na.rm=TRUE),sd_185=sd(return_185_fww,na.rm=TRUE), N_185=sum(nad_return_185_fw),
mean_return_190=mean(return_190_fww,na.rm=TRUE),sd_190=sd(return_190_fww,na.rm=TRUE), N_190=sum(nad_return_190_fw),
mean_return_195=mean(return_195_fww,na.rm=TRUE),sd_195=sd(return_195_fww,na.rm=TRUE), N_195=sum(nad_return_195_fw),
mean_return_200=mean(return_200_fww,na.rm=TRUE),sd_200=sd(return_200_fww,na.rm=TRUE), N_200=sum(nad_return_200_fw),
mean_return_205=mean(return_205_fww,na.rm=TRUE),sd_205=sd(return_205_fww,na.rm=TRUE), N_205=sum(nad_return_205_fw),
mean_return_210=mean(return_210_fww,na.rm=TRUE),sd_210=sd(return_210_fww,na.rm=TRUE), N_210=sum(nad_return_210_fw),
mean_return_215=mean(return_215_fww,na.rm=TRUE),sd_215=sd(return_215_fww,na.rm=TRUE), N_215=sum(nad_return_215_fw),
mean_return_220=mean(return_220_fww,na.rm=TRUE),sd_220=sd(return_220_fww,na.rm=TRUE), N_220=sum(nad_return_220_fw),
mean_return_225=mean(return_225_fww,na.rm=TRUE),sd_225=sd(return_225_fww,na.rm=TRUE), N_225=sum(nad_return_225_fw),
mean_return_230=mean(return_230_fww,na.rm=TRUE),sd_230=sd(return_230_fww,na.rm=TRUE), N_230=sum(nad_return_230_fw),
mean_return_235=mean(return_235_fww,na.rm=TRUE),sd_235=sd(return_235_fww,na.rm=TRUE), N_235=sum(nad_return_235_fw),
mean_return_240=mean(return_240_fww,na.rm=TRUE),sd_240=sd(return_240_fww,na.rm=TRUE), N_240=sum(nad_return_240_fw),
mean_return_245=mean(return_245_fww,na.rm=TRUE),sd_245=sd(return_245_fww,na.rm=TRUE), N_245=sum(nad_return_245_fw),
mean_return_250=mean(return_250_fww,na.rm=TRUE),sd_250=sd(return_250_fww,na.rm=TRUE), N_250=sum(nad_return_250_fw)), by=category]

(1+1)
```
```{R}
check_for_run_fw_plot_a <- melt(ret_plot, id.vars="category")
check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a[grepl("sd",variable)]
setnames(check_for_run_fw_plot_a_1, "value", "sd")
#check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a_1[,.(sd=mean(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_1[,days:=rep(seq(0,250,5),each=3)]
check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a[grepl("mean",variable)]
setnames(check_for_run_fw_plot_a_2, "value", "mean")
#check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a_2[,.(mean=mean(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_2[,days:=rep(seq(0,250,5),each=3)]
check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a[grepl("N",variable)]
setnames(check_for_run_fw_plot_a_3, "value", "N")
#check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a_3[,.(N=min(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_3[,days:=rep(seq(0,250,5),each=3)]
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a_1, check_for_run_fw_plot_a_2, by=c("category","days"), all.x=TRUE)
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a, check_for_run_fw_plot_a_3, by=c("category","days"), all.x=TRUE)
check_for_run_fw_plot_a[,upper_ci:=mean+1.96*sd/sqrt(N)]
check_for_run_fw_plot_a[,lower_ci:=mean-1.96*sd/sqrt(N)]
#check_for_run_fw_plot_a[,Category:="Purchase - invested stock"]
#check_for_run_fw_plot_a[new_stock==1,Category:="New purchase"]
#check_for_run_fw_plot_a[order==2,Category:="New purchase - new industry"]
check_for_run_fw_plot_a$category <- factor(check_for_run_fw_plot_a$category, levels = c("Not Trade", "Top Up", "New Stock"))
#check_for_run_fw_plot[,type2:=paste(type,wp_group)]

# check_for_run_fw_plot$type2 <- factor(check_for_run_fw_plot$type2, levels = c("top up after positive rsp","top up after negative rsp", "new buy-invested industry after positive rsp", "new buy-invested industry after negative rsp", "new buy-new industry after positive rsp", "new buy-new industry after negative rsp"))

pd <- position_dodge(0.09) # move them .05 to the left and right



(g1.2 <- ggplot(check_for_run_fw_plot_a,aes(x=days,y=mean,color=category))+
       geom_ribbon(aes(ymin=lower_ci, ymax=upper_ci),alpha = .3, linetype=0) +
       geom_line(position=pd) +  xlab("Number of Working Days After the Purchase") + ylab("Adj Return") )


ggsave(g1.2, file="G:/rank/new_ind/codes/codes with more anon dataset/buy_info/adj_three_types_fullsample.png",width = 8, height = 6)
```

# sample 1.2

```{r}


buys_info2 <- buys_info1[N_anondate>1]
buys_info2[,buy_stockdate:=sum(buy),by=stock_date]

nrow(buys_info2) # 6551915
nrow(buys_info2[N_stockdate>1]) # 6276223
nrow(buys_info2[buy_stockdate>1]) # 2064093
nrow(buys_info2[buy_stockdate>1 & N_stockdate>1 &
                buy_stockdate<N_stockdate]) # 2062124
length(unique(buys_info2[buy_stockdate>1 & 
                           N_stockdate>1 &
                buy_stockdate<N_stockdate]$anon)) # 30068
length(unique(buys_info2[buy_stockdate>1 & 
                           N_stockdate>1 &
                buy_stockdate<N_stockdate]$sedol)) # 1196
buys_info2[, N_stockweek:=.N, by=stock_week]
buys_info2[, buy_stockweek:=sum(buy), by=stock_week]
buys_info2 <- buys_info2[buy_stockweek>1 & 
                           N_stockweek>1 &
                buy_stockweek<N_stockweek]

(pdenstockdatesample11 <- ggplot(buys_info2, aes(x=mean_buy_stockdate)) + 
    geom_histogram(aes(y=..density..),      
                   binwidth=.05,
                   colour="black", fill="white") +
    geom_density(alpha=.2, fill="#FF6666"))  
ggsave(pdenstockdatesample11, file="G:/rank/new_ind/codes/codes with more anon dataset/buy_info/pdenstockdatesample12.png",width = 8, height = 6)
(pdenstockweeksample11 <- ggplot(buys_info2, 
                                  aes(x=mean_buy_stockweek)) + 
    geom_histogram(aes(y=..density..),      
                   binwidth=.05,
                   colour="black", fill="white") +
    geom_density(alpha=.2, fill="#FF6666"))  
ggsave(pdenstockweeksample11, file="G:/rank/new_ind/codes/codes with more anon dataset/buy_info/pdenstockweeksample12.png",width = 8, height = 6)
(pdenanondatesample11 <- ggplot(buys_info2, 
                                  aes(x=mean_buy_anondate)) + 
    geom_histogram(aes(y=..density..),      
                   binwidth=.05,
                   colour="black", fill="white") +
    geom_density(alpha=.2, fill="#FF6666"))  
ggsave(pdenanondatesample11, file="G:/rank/new_ind/codes/codes with more anon dataset/buy_info/pdenanondatesample12.png",width = 8, height = 6)



f1.2 <- feols(new_stock~1|stock_date,data=buys_info2)



f2.2 <- feols(topup~1|stock_date,data=buys_info2)



f3.2 <- feols(new_stock~1|stock_date,data=buys_info2[!(topup==1)])



f4.2 <- feols(topup~1|stock_date,data=buys_info2[!(new_stock==1)])


f5.2 <- feols(new_stock~1|anon_date,data=buys_info2[!(topup==1)])
# Adj. R2: 0.163912
# R2: 1-(1-Adj. R2)/((3720876-1)/(3720876-321009-1))= 0.2360434
f6.2 <- feols(topup~1|anon_date,data=buys_info2[!(new_stock==1)])
# Adj. R2: 0.085606
# R2: 1-(1-Adj. R2)/((3694155-1)/(3694155-318194-1))= 0.1643668
f7.2 <- feols(new_stock~1|anon_date+stock_date,data=buys_info2[!(topup==1)])
# Adj. R2: 
# R2: 
f8.2 <- feols(topup~1|anon_date+stock_date,data=buys_info2[!(new_stock==1)])
# Adj. R2: 
# R2: 
f9.2 <- feols(new_stock~1|anon_date+stock_week,data=buys_info2[!(topup==1)])
# Adj. R2: 0.196866
# R2: 1-(1-Adj. R2)/((3720876-1)/(3720876-321009-53201-1))= 0.2776375
f10.2 <- feols(topup~1|anon_date+stock_week,data=buys_info2[!(new_stock==1)])
# Adj. R2: 0.10444
# R2: 1-(1-Adj. R2)/((3694155-1)/(3694155-318194-53201-1))= 0.1944759


```


# return plot
```{r}
ret_buys_info1 <- merge(buys_info2, pp_ext, by=c("sedol","date_formated"), all.x=TRUE)
for (i in 1:50){
  name1 <- paste0("na_return_",i*5,"_fw")
  name2 <- paste0("return_",i*5,"_fw")
  ret_buys_info1[get(name1)>=i*0.5, eval(name2):=NA]
  print(i)
}
nrow(ret_buys_info1[is.na(return_5_fw)])/nrow(ret_buys_info1)
nrow(ret_buys_info1[is.na(return_5_fw)])/nrow(ret_buys_info1)

for (i in 1:50){
  name1 <- paste0("return_",i*5,"_fw")
  name2 <- paste0("nad_return_",i*5,"_fw")
  ret_buys_info1[, eval(name2):=ifelse(is.na(get(name1)),0,1)]
  print(i)
}

for (i in 1:50){
  name1 <- paste0("return_",i*5,"_fww")
  name2 <- paste0("return_",i*5,"_fw")
  ret_buys_info1[, eval(name1):=Winsorize(get(name2), probs = c(0.01,0.99),na.rm=TRUE)]
  print(i)
}

ret_buys_info1[,category:="Not Trade"]
ret_buys_info1[topup==1,category:="Top Up"]
ret_buys_info1[new_stock==1,category:="New Stock"]


ret_plot <- ret_buys_info1[,.(mean_return_0=0,sd_0=0, N_0=1,
mean_return_5=mean(return_5_fww,na.rm=TRUE),sd_5=sd(return_5_fww,na.rm=TRUE), N_5=sum(nad_return_5_fw),
mean_return_10=mean(return_10_fww,na.rm=TRUE),sd_10=sd(return_10_fww,na.rm=TRUE), N_10=sum(nad_return_10_fw),
mean_return_15=mean(return_15_fww,na.rm=TRUE),sd_15=sd(return_15_fww,na.rm=TRUE), N_15=sum(nad_return_15_fw),
mean_return_20=mean(return_20_fww,na.rm=TRUE),sd_20=sd(return_20_fww,na.rm=TRUE), N_20=sum(nad_return_20_fw),
mean_return_25=mean(return_25_fww,na.rm=TRUE),sd_25=sd(return_25_fww,na.rm=TRUE), N_25=sum(nad_return_25_fw),
mean_return_30=mean(return_30_fww,na.rm=TRUE),sd_30=sd(return_30_fww,na.rm=TRUE), N_30=sum(nad_return_30_fw),
mean_return_35=mean(return_35_fww,na.rm=TRUE),sd_35=sd(return_35_fww,na.rm=TRUE), N_35=sum(nad_return_35_fw),
mean_return_40=mean(return_40_fww,na.rm=TRUE),sd_40=sd(return_40_fww,na.rm=TRUE), N_40=sum(nad_return_40_fw),
mean_return_45=mean(return_45_fww,na.rm=TRUE),sd_45=sd(return_45_fww,na.rm=TRUE), N_45=sum(nad_return_45_fw),
mean_return_50=mean(return_50_fww,na.rm=TRUE),sd_50=sd(return_50_fww,na.rm=TRUE), N_50=sum(nad_return_50_fw),
mean_return_55=mean(return_55_fww,na.rm=TRUE),sd_55=sd(return_55_fww,na.rm=TRUE), N_55=sum(nad_return_55_fw),
mean_return_60=mean(return_60_fww,na.rm=TRUE),sd_60=sd(return_60_fww,na.rm=TRUE), N_60=sum(nad_return_60_fw),
mean_return_65=mean(return_65_fww,na.rm=TRUE),sd_65=sd(return_65_fww,na.rm=TRUE), N_65=sum(nad_return_65_fw),
mean_return_70=mean(return_70_fww,na.rm=TRUE),sd_70=sd(return_70_fww,na.rm=TRUE), N_70=sum(nad_return_70_fw),
mean_return_75=mean(return_75_fww,na.rm=TRUE),sd_75=sd(return_75_fww,na.rm=TRUE), N_75=sum(nad_return_75_fw),
mean_return_80=mean(return_80_fww,na.rm=TRUE),sd_80=sd(return_80_fww,na.rm=TRUE), N_80=sum(nad_return_80_fw),
mean_return_85=mean(return_85_fww,na.rm=TRUE),sd_85=sd(return_85_fww,na.rm=TRUE), N_85=sum(nad_return_85_fw),
mean_return_90=mean(return_90_fww,na.rm=TRUE),sd_90=sd(return_90_fww,na.rm=TRUE), N_90=sum(nad_return_90_fw),
mean_return_95=mean(return_95_fww,na.rm=TRUE),sd_95=sd(return_95_fww,na.rm=TRUE), N_95=sum(nad_return_95_fw),
mean_return_100=mean(return_100_fww,na.rm=TRUE),sd_100=sd(return_100_fww,na.rm=TRUE), N_100=sum(nad_return_100_fw),
mean_return_105=mean(return_105_fww,na.rm=TRUE),sd_105=sd(return_105_fww,na.rm=TRUE), N_105=sum(nad_return_105_fw),
mean_return_110=mean(return_110_fww,na.rm=TRUE),sd_110=sd(return_110_fww,na.rm=TRUE), N_110=sum(nad_return_110_fw),
mean_return_115=mean(return_115_fww,na.rm=TRUE),sd_115=sd(return_115_fww,na.rm=TRUE), N_115=sum(nad_return_115_fw),
mean_return_120=mean(return_120_fww,na.rm=TRUE),sd_120=sd(return_120_fww,na.rm=TRUE), N_120=sum(nad_return_120_fw),
mean_return_125=mean(return_125_fww,na.rm=TRUE),sd_125=sd(return_125_fww,na.rm=TRUE), N_125=sum(nad_return_125_fw),
mean_return_130=mean(return_130_fww,na.rm=TRUE),sd_130=sd(return_130_fww,na.rm=TRUE), N_130=sum(nad_return_130_fw),
mean_return_135=mean(return_135_fww,na.rm=TRUE),sd_135=sd(return_135_fww,na.rm=TRUE), N_135=sum(nad_return_135_fw),
mean_return_140=mean(return_140_fww,na.rm=TRUE),sd_140=sd(return_140_fww,na.rm=TRUE), N_140=sum(nad_return_140_fw),
mean_return_145=mean(return_145_fww,na.rm=TRUE),sd_145=sd(return_145_fww,na.rm=TRUE), N_145=sum(nad_return_145_fw),
mean_return_150=mean(return_150_fww,na.rm=TRUE),sd_150=sd(return_150_fww,na.rm=TRUE), N_150=sum(nad_return_150_fw),
mean_return_155=mean(return_155_fww,na.rm=TRUE),sd_155=sd(return_155_fww,na.rm=TRUE), N_155=sum(nad_return_155_fw),
mean_return_160=mean(return_160_fww,na.rm=TRUE),sd_160=sd(return_160_fww,na.rm=TRUE), N_160=sum(nad_return_160_fw),
mean_return_165=mean(return_165_fww,na.rm=TRUE),sd_165=sd(return_165_fww,na.rm=TRUE), N_165=sum(nad_return_165_fw),
mean_return_170=mean(return_170_fww,na.rm=TRUE),sd_170=sd(return_170_fww,na.rm=TRUE), N_170=sum(nad_return_170_fw),
mean_return_175=mean(return_175_fww,na.rm=TRUE),sd_175=sd(return_175_fww,na.rm=TRUE), N_175=sum(nad_return_175_fw),
mean_return_180=mean(return_180_fww,na.rm=TRUE),sd_180=sd(return_180_fww,na.rm=TRUE), N_180=sum(nad_return_180_fw),
mean_return_185=mean(return_185_fww,na.rm=TRUE),sd_185=sd(return_185_fww,na.rm=TRUE), N_185=sum(nad_return_185_fw),
mean_return_190=mean(return_190_fww,na.rm=TRUE),sd_190=sd(return_190_fww,na.rm=TRUE), N_190=sum(nad_return_190_fw),
mean_return_195=mean(return_195_fww,na.rm=TRUE),sd_195=sd(return_195_fww,na.rm=TRUE), N_195=sum(nad_return_195_fw),
mean_return_200=mean(return_200_fww,na.rm=TRUE),sd_200=sd(return_200_fww,na.rm=TRUE), N_200=sum(nad_return_200_fw),
mean_return_205=mean(return_205_fww,na.rm=TRUE),sd_205=sd(return_205_fww,na.rm=TRUE), N_205=sum(nad_return_205_fw),
mean_return_210=mean(return_210_fww,na.rm=TRUE),sd_210=sd(return_210_fww,na.rm=TRUE), N_210=sum(nad_return_210_fw),
mean_return_215=mean(return_215_fww,na.rm=TRUE),sd_215=sd(return_215_fww,na.rm=TRUE), N_215=sum(nad_return_215_fw),
mean_return_220=mean(return_220_fww,na.rm=TRUE),sd_220=sd(return_220_fww,na.rm=TRUE), N_220=sum(nad_return_220_fw),
mean_return_225=mean(return_225_fww,na.rm=TRUE),sd_225=sd(return_225_fww,na.rm=TRUE), N_225=sum(nad_return_225_fw),
mean_return_230=mean(return_230_fww,na.rm=TRUE),sd_230=sd(return_230_fww,na.rm=TRUE), N_230=sum(nad_return_230_fw),
mean_return_235=mean(return_235_fww,na.rm=TRUE),sd_235=sd(return_235_fww,na.rm=TRUE), N_235=sum(nad_return_235_fw),
mean_return_240=mean(return_240_fww,na.rm=TRUE),sd_240=sd(return_240_fww,na.rm=TRUE), N_240=sum(nad_return_240_fw),
mean_return_245=mean(return_245_fww,na.rm=TRUE),sd_245=sd(return_245_fww,na.rm=TRUE), N_245=sum(nad_return_245_fw),
mean_return_250=mean(return_250_fww,na.rm=TRUE),sd_250=sd(return_250_fww,na.rm=TRUE), N_250=sum(nad_return_250_fw)), by=category]


```
```{R}
check_for_run_fw_plot_a <- melt(ret_plot, id.vars="category")
check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a[grepl("sd",variable)]
setnames(check_for_run_fw_plot_a_1, "value", "sd")
#check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a_1[,.(sd=mean(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_1[,days:=rep(seq(0,250,5),each=3)]
check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a[grepl("mean",variable)]
setnames(check_for_run_fw_plot_a_2, "value", "mean")
#check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a_2[,.(mean=mean(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_2[,days:=rep(seq(0,250,5),each=3)]
check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a[grepl("N",variable)]
setnames(check_for_run_fw_plot_a_3, "value", "N")
#check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a_3[,.(N=min(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_3[,days:=rep(seq(0,250,5),each=3)]
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a_1, check_for_run_fw_plot_a_2, by=c("category","days"), all.x=TRUE)
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a, check_for_run_fw_plot_a_3, by=c("category","days"), all.x=TRUE)
check_for_run_fw_plot_a[,upper_ci:=mean+1.96*sd/sqrt(N)]
check_for_run_fw_plot_a[,lower_ci:=mean-1.96*sd/sqrt(N)]
#check_for_run_fw_plot_a[,Category:="Purchase - invested stock"]
#check_for_run_fw_plot_a[new_stock==1,Category:="New purchase"]
#check_for_run_fw_plot_a[order==2,Category:="New purchase - new industry"]
check_for_run_fw_plot_a$category <- factor(check_for_run_fw_plot_a$category, levels = c("Not Trade", "Top Up", "New Stock"))
#check_for_run_fw_plot[,type2:=paste(type,wp_group)]

# check_for_run_fw_plot$type2 <- factor(check_for_run_fw_plot$type2, levels = c("top up after positive rsp","top up after negative rsp", "new buy-invested industry after positive rsp", "new buy-invested industry after negative rsp", "new buy-new industry after positive rsp", "new buy-new industry after negative rsp"))

pd <- position_dodge(0.09) # move them .05 to the left and right



(g2 <- ggplot(check_for_run_fw_plot_a,aes(x=days,y=mean,color=category))+
       geom_ribbon(aes(ymin=lower_ci, ymax=upper_ci),alpha = .3, linetype=0) +
       geom_line(position=pd) +  xlab("Number of Working Days After the Purchase") + ylab("Raw Return") )


ggsave(g2, file="G:/rank/new_ind/codes/codes with more anon dataset/buy_info/three_types_fullsample2.png",width = 8, height = 6)
```

# adj return plot
```{r}
ret_buys_info1 <- merge(buys_info2, pp_ext2, by=c("sedol","date_formated"), all.x=TRUE)
for (i in 1:50){
  name1 <- paste0("na_adjret_",i*5,"_fw")
  name2 <- paste0("adjret_",i*5,"_fw")
  ret_buys_info1[get(name1)>=i*0.5, eval(name2):=NA]
  print(i)
}
#nrow(ret_buys_info1[is.na(return_5_fw)])/nrow(ret_buys_info1)
#nrow(ret_buys_info1[is.na(return_5_fw)])/nrow(ret_buys_info1)

for (i in 1:50){
  name1 <- paste0("adjret_",i*5,"_fw")
  name2 <- paste0("nad_return_",i*5,"_fw")
  ret_buys_info1[, eval(name2):=ifelse(is.na(get(name1)),0,1)]
  print(i)
}

for (i in 1:50){
  name1 <- paste0("return_",i*5,"_fww")
  name2 <- paste0("adjret_",i*5,"_fw")
  ret_buys_info1[, eval(name1):=Winsorize(get(name2), probs = c(0.01,0.99),na.rm=TRUE)]
  print(i)
}

ret_buys_info1[,category:="Not Trade"]
ret_buys_info1[topup==1,category:="Top Up"]
ret_buys_info1[new_stock==1,category:="New Stock"]


ret_plot <- ret_buys_info1[,.(mean_return_0=0,sd_0=0, N_0=1,
mean_return_5=mean(return_5_fww,na.rm=TRUE),sd_5=sd(return_5_fww,na.rm=TRUE), N_5=sum(nad_return_5_fw),
mean_return_10=mean(return_10_fww,na.rm=TRUE),sd_10=sd(return_10_fww,na.rm=TRUE), N_10=sum(nad_return_10_fw),
mean_return_15=mean(return_15_fww,na.rm=TRUE),sd_15=sd(return_15_fww,na.rm=TRUE), N_15=sum(nad_return_15_fw),
mean_return_20=mean(return_20_fww,na.rm=TRUE),sd_20=sd(return_20_fww,na.rm=TRUE), N_20=sum(nad_return_20_fw),
mean_return_25=mean(return_25_fww,na.rm=TRUE),sd_25=sd(return_25_fww,na.rm=TRUE), N_25=sum(nad_return_25_fw),
mean_return_30=mean(return_30_fww,na.rm=TRUE),sd_30=sd(return_30_fww,na.rm=TRUE), N_30=sum(nad_return_30_fw),
mean_return_35=mean(return_35_fww,na.rm=TRUE),sd_35=sd(return_35_fww,na.rm=TRUE), N_35=sum(nad_return_35_fw),
mean_return_40=mean(return_40_fww,na.rm=TRUE),sd_40=sd(return_40_fww,na.rm=TRUE), N_40=sum(nad_return_40_fw),
mean_return_45=mean(return_45_fww,na.rm=TRUE),sd_45=sd(return_45_fww,na.rm=TRUE), N_45=sum(nad_return_45_fw),
mean_return_50=mean(return_50_fww,na.rm=TRUE),sd_50=sd(return_50_fww,na.rm=TRUE), N_50=sum(nad_return_50_fw),
mean_return_55=mean(return_55_fww,na.rm=TRUE),sd_55=sd(return_55_fww,na.rm=TRUE), N_55=sum(nad_return_55_fw),
mean_return_60=mean(return_60_fww,na.rm=TRUE),sd_60=sd(return_60_fww,na.rm=TRUE), N_60=sum(nad_return_60_fw),
mean_return_65=mean(return_65_fww,na.rm=TRUE),sd_65=sd(return_65_fww,na.rm=TRUE), N_65=sum(nad_return_65_fw),
mean_return_70=mean(return_70_fww,na.rm=TRUE),sd_70=sd(return_70_fww,na.rm=TRUE), N_70=sum(nad_return_70_fw),
mean_return_75=mean(return_75_fww,na.rm=TRUE),sd_75=sd(return_75_fww,na.rm=TRUE), N_75=sum(nad_return_75_fw),
mean_return_80=mean(return_80_fww,na.rm=TRUE),sd_80=sd(return_80_fww,na.rm=TRUE), N_80=sum(nad_return_80_fw),
mean_return_85=mean(return_85_fww,na.rm=TRUE),sd_85=sd(return_85_fww,na.rm=TRUE), N_85=sum(nad_return_85_fw),
mean_return_90=mean(return_90_fww,na.rm=TRUE),sd_90=sd(return_90_fww,na.rm=TRUE), N_90=sum(nad_return_90_fw),
mean_return_95=mean(return_95_fww,na.rm=TRUE),sd_95=sd(return_95_fww,na.rm=TRUE), N_95=sum(nad_return_95_fw),
mean_return_100=mean(return_100_fww,na.rm=TRUE),sd_100=sd(return_100_fww,na.rm=TRUE), N_100=sum(nad_return_100_fw),
mean_return_105=mean(return_105_fww,na.rm=TRUE),sd_105=sd(return_105_fww,na.rm=TRUE), N_105=sum(nad_return_105_fw),
mean_return_110=mean(return_110_fww,na.rm=TRUE),sd_110=sd(return_110_fww,na.rm=TRUE), N_110=sum(nad_return_110_fw),
mean_return_115=mean(return_115_fww,na.rm=TRUE),sd_115=sd(return_115_fww,na.rm=TRUE), N_115=sum(nad_return_115_fw),
mean_return_120=mean(return_120_fww,na.rm=TRUE),sd_120=sd(return_120_fww,na.rm=TRUE), N_120=sum(nad_return_120_fw),
mean_return_125=mean(return_125_fww,na.rm=TRUE),sd_125=sd(return_125_fww,na.rm=TRUE), N_125=sum(nad_return_125_fw),
mean_return_130=mean(return_130_fww,na.rm=TRUE),sd_130=sd(return_130_fww,na.rm=TRUE), N_130=sum(nad_return_130_fw),
mean_return_135=mean(return_135_fww,na.rm=TRUE),sd_135=sd(return_135_fww,na.rm=TRUE), N_135=sum(nad_return_135_fw),
mean_return_140=mean(return_140_fww,na.rm=TRUE),sd_140=sd(return_140_fww,na.rm=TRUE), N_140=sum(nad_return_140_fw),
mean_return_145=mean(return_145_fww,na.rm=TRUE),sd_145=sd(return_145_fww,na.rm=TRUE), N_145=sum(nad_return_145_fw),
mean_return_150=mean(return_150_fww,na.rm=TRUE),sd_150=sd(return_150_fww,na.rm=TRUE), N_150=sum(nad_return_150_fw),
mean_return_155=mean(return_155_fww,na.rm=TRUE),sd_155=sd(return_155_fww,na.rm=TRUE), N_155=sum(nad_return_155_fw),
mean_return_160=mean(return_160_fww,na.rm=TRUE),sd_160=sd(return_160_fww,na.rm=TRUE), N_160=sum(nad_return_160_fw),
mean_return_165=mean(return_165_fww,na.rm=TRUE),sd_165=sd(return_165_fww,na.rm=TRUE), N_165=sum(nad_return_165_fw),
mean_return_170=mean(return_170_fww,na.rm=TRUE),sd_170=sd(return_170_fww,na.rm=TRUE), N_170=sum(nad_return_170_fw),
mean_return_175=mean(return_175_fww,na.rm=TRUE),sd_175=sd(return_175_fww,na.rm=TRUE), N_175=sum(nad_return_175_fw),
mean_return_180=mean(return_180_fww,na.rm=TRUE),sd_180=sd(return_180_fww,na.rm=TRUE), N_180=sum(nad_return_180_fw),
mean_return_185=mean(return_185_fww,na.rm=TRUE),sd_185=sd(return_185_fww,na.rm=TRUE), N_185=sum(nad_return_185_fw),
mean_return_190=mean(return_190_fww,na.rm=TRUE),sd_190=sd(return_190_fww,na.rm=TRUE), N_190=sum(nad_return_190_fw),
mean_return_195=mean(return_195_fww,na.rm=TRUE),sd_195=sd(return_195_fww,na.rm=TRUE), N_195=sum(nad_return_195_fw),
mean_return_200=mean(return_200_fww,na.rm=TRUE),sd_200=sd(return_200_fww,na.rm=TRUE), N_200=sum(nad_return_200_fw),
mean_return_205=mean(return_205_fww,na.rm=TRUE),sd_205=sd(return_205_fww,na.rm=TRUE), N_205=sum(nad_return_205_fw),
mean_return_210=mean(return_210_fww,na.rm=TRUE),sd_210=sd(return_210_fww,na.rm=TRUE), N_210=sum(nad_return_210_fw),
mean_return_215=mean(return_215_fww,na.rm=TRUE),sd_215=sd(return_215_fww,na.rm=TRUE), N_215=sum(nad_return_215_fw),
mean_return_220=mean(return_220_fww,na.rm=TRUE),sd_220=sd(return_220_fww,na.rm=TRUE), N_220=sum(nad_return_220_fw),
mean_return_225=mean(return_225_fww,na.rm=TRUE),sd_225=sd(return_225_fww,na.rm=TRUE), N_225=sum(nad_return_225_fw),
mean_return_230=mean(return_230_fww,na.rm=TRUE),sd_230=sd(return_230_fww,na.rm=TRUE), N_230=sum(nad_return_230_fw),
mean_return_235=mean(return_235_fww,na.rm=TRUE),sd_235=sd(return_235_fww,na.rm=TRUE), N_235=sum(nad_return_235_fw),
mean_return_240=mean(return_240_fww,na.rm=TRUE),sd_240=sd(return_240_fww,na.rm=TRUE), N_240=sum(nad_return_240_fw),
mean_return_245=mean(return_245_fww,na.rm=TRUE),sd_245=sd(return_245_fww,na.rm=TRUE), N_245=sum(nad_return_245_fw),
mean_return_250=mean(return_250_fww,na.rm=TRUE),sd_250=sd(return_250_fww,na.rm=TRUE), N_250=sum(nad_return_250_fw)), by=category]

(1+1)
```
```{R}
check_for_run_fw_plot_a <- melt(ret_plot, id.vars="category")
check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a[grepl("sd",variable)]
setnames(check_for_run_fw_plot_a_1, "value", "sd")
#check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a_1[,.(sd=mean(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_1[,days:=rep(seq(0,250,5),each=3)]
check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a[grepl("mean",variable)]
setnames(check_for_run_fw_plot_a_2, "value", "mean")
#check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a_2[,.(mean=mean(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_2[,days:=rep(seq(0,250,5),each=3)]
check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a[grepl("N",variable)]
setnames(check_for_run_fw_plot_a_3, "value", "N")
#check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a_3[,.(N=min(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_3[,days:=rep(seq(0,250,5),each=3)]
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a_1, check_for_run_fw_plot_a_2, by=c("category","days"), all.x=TRUE)
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a, check_for_run_fw_plot_a_3, by=c("category","days"), all.x=TRUE)
check_for_run_fw_plot_a[,upper_ci:=mean+1.96*sd/sqrt(N)]
check_for_run_fw_plot_a[,lower_ci:=mean-1.96*sd/sqrt(N)]
#check_for_run_fw_plot_a[,Category:="Purchase - invested stock"]
#check_for_run_fw_plot_a[new_stock==1,Category:="New purchase"]
#check_for_run_fw_plot_a[order==2,Category:="New purchase - new industry"]
check_for_run_fw_plot_a$category <- factor(check_for_run_fw_plot_a$category, levels = c("Not Trade", "Top Up", "New Stock"))
#check_for_run_fw_plot[,type2:=paste(type,wp_group)]

# check_for_run_fw_plot$type2 <- factor(check_for_run_fw_plot$type2, levels = c("top up after positive rsp","top up after negative rsp", "new buy-invested industry after positive rsp", "new buy-invested industry after negative rsp", "new buy-new industry after positive rsp", "new buy-new industry after negative rsp"))

pd <- position_dodge(0.09) # move them .05 to the left and right



(g2.2 <- ggplot(check_for_run_fw_plot_a,aes(x=days,y=mean,color=category))+
       geom_ribbon(aes(ymin=lower_ci, ymax=upper_ci),alpha = .3, linetype=0) +
       geom_line(position=pd) +  xlab("Number of Working Days After the Purchase") + ylab("Adj Return") )


ggsave(g2.2, file="G:/rank/new_ind/codes/codes with more anon dataset/buy_info/adj_three_types_fullsample1.2.png",width = 8, height = 6)
```

# sample 2.1

```{r}

buys_info2 <- buys_info1[anon %in% anon_newbuy]

buys_info2[,N_anondate:=.N,by=anon_date]
buys_info2[,N_stockdate:=.N,by=stock_date]

buys_info2[, mean_buy_stockdate:=mean(buy),
           by=stock_date]
buys_info2[, mean_buy_stockweek:=mean(buy),
           by=stock_week]
buys_info2[, mean_buy_anondate:=mean(buy),
           by=anon_date]

(pdenstockdatesample21 <- ggplot(buys_info2, aes(x=mean_buy_stockdate)) + 
    geom_histogram(aes(y=..density..),      
                   binwidth=.05,
                   colour="black", fill="white") +
    geom_density(alpha=.2, fill="#FF6666"))  
ggsave(pdenstockdatesample21, file="G:/rank/new_ind/codes/codes with more anon dataset/buy_info/pdenstockdatesample21.png",width = 8, height = 6)
(pdenstockweeksample21 <- ggplot(buys_info2, 
                                  aes(x=mean_buy_stockweek)) + 
    geom_histogram(aes(y=..density..),      
                   binwidth=.05,
                   colour="black", fill="white") +
    geom_density(alpha=.2, fill="#FF6666"))  
ggsave(pdenstockweeksample21, file="G:/rank/new_ind/codes/codes with more anon dataset/buy_info/pdenstockweeksample21.png",width = 8, height = 6)
(pdenanondatesample21 <- ggplot(buys_info2, 
                                  aes(x=mean_buy_anondate)) + 
    geom_histogram(aes(y=..density..),      
                   binwidth=.05,
                   colour="black", fill="white") +
    geom_density(alpha=.2, fill="#FF6666"))  
ggsave(pdenanondatesample21, file="G:/rank/new_ind/codes/codes with more anon dataset/buy_info/pdenanondatesample21.png",width = 8, height = 6)

f1.3 <- feols(new_stock~1|stock_date,data=buys_info2)

# Adj. R2: 0.004941
# R2: 1-(1-0.004941)/((3574529-1)/(3574529-841859-1))= 0.2392934

f2.3 <- feols(topup~1|stock_date,data=buys_info2)

# Adj. R2: -0.054387
# R2: 1-(1+0.054387)/((3574529-1)/(3574529-841859-1))= 0.1939381

f3.3 <- feols(new_stock~1|stock_date,data=buys_info2[!(topup==1)])

# Adj. R2: 0.014512
# R2: 1-(1-0.014512)/((3458757-1)/(3458757-838015-1))= 0.2532839

f4.3 <- feols(topup~1|stock_date,data=buys_info2[!(new_stock==1)])
# Adj. R2: -0.042536
# R2: 1-(1+0.042536)/((3452002-1)/(3452002-834369-1))= 0.2094511

f5.3 <- feols(new_stock~1|anon_date,data=buys_info2[!(topup==1)])
# Adj. R2: 0.107723
# R2: 1-(1-Adj. R2)/((3458756-1)/(3458756-183418-1))= 0.1550405
f6.3 <- feols(topup~1|anon_date,data=buys_info2[!(new_stock==1)])
# Adj. R2: 0.08703
# R2: 1-(1-Adj. R2)/((3452002-1)/(3452002-185992-1))= 0.1643668
f7.3 <- feols(new_stock~1|anon_date+stock_date,data=buys_info2[!(topup==1)])
# Adj. R2: 0.119374
# R2: 1-(1-Adj. R2)/((3458756-1)/(3458756-183418-838014-1))= 0.3794386
f8.3 <- feols(topup~1|anon_date+stock_date,data=buys_info2[!(new_stock==1)])
# Adj. R2: 0.03468
# R2: 1-(1-Adj. R2)/((3452002-1)/(3452002-185992-834369-1))= 0.3200145
f9.3 <- feols(new_stock~1|anon_date+stock_week,data=buys_info2[!(topup==1)])
# Adj. R2: 0.134244
# R2: 1-(1-Adj. R2)/((3458756-1)/(3458756-183418-239400-1))= 0.240079
f10.3 <- feols(topup~1|anon_date+stock_week,data=buys_info2[!(new_stock==1)])
# Adj. R2: 0.10444
# R2: 1-(1-Adj. R2)/((3452002-1)/(3452002-185992-238659-1))= 0.2146081

```


# return plot
```{r}
ret_buys_info1 <- merge(buys_info2, pp_ext, by=c("sedol","date_formated"), all.x=TRUE)
for (i in 1:50){
  name1 <- paste0("na_return_",i*5,"_fw")
  name2 <- paste0("return_",i*5,"_fw")
  ret_buys_info1[get(name1)>=i*0.5, eval(name2):=NA]
  print(i)
}
nrow(ret_buys_info1[is.na(return_5_fw)])/nrow(ret_buys_info1)
nrow(ret_buys_info1[is.na(return_5_fw)])/nrow(ret_buys_info1)

for (i in 1:50){
  name1 <- paste0("return_",i*5,"_fw")
  name2 <- paste0("nad_return_",i*5,"_fw")
  ret_buys_info1[, eval(name2):=ifelse(is.na(get(name1)),0,1)]
  print(i)
}

for (i in 1:50){
  name1 <- paste0("return_",i*5,"_fww")
  name2 <- paste0("return_",i*5,"_fw")
  ret_buys_info1[, eval(name1):=Winsorize(get(name2), probs = c(0.01,0.99),na.rm=TRUE)]
  print(i)
}

ret_buys_info1[,category:="Not Trade"]
ret_buys_info1[topup==1,category:="Top Up"]
ret_buys_info1[new_stock==1,category:="New Stock"]


ret_plot <- ret_buys_info1[,.(mean_return_0=0,sd_0=0, N_0=1,
mean_return_5=mean(return_5_fww,na.rm=TRUE),sd_5=sd(return_5_fww,na.rm=TRUE), N_5=sum(nad_return_5_fw),
mean_return_10=mean(return_10_fww,na.rm=TRUE),sd_10=sd(return_10_fww,na.rm=TRUE), N_10=sum(nad_return_10_fw),
mean_return_15=mean(return_15_fww,na.rm=TRUE),sd_15=sd(return_15_fww,na.rm=TRUE), N_15=sum(nad_return_15_fw),
mean_return_20=mean(return_20_fww,na.rm=TRUE),sd_20=sd(return_20_fww,na.rm=TRUE), N_20=sum(nad_return_20_fw),
mean_return_25=mean(return_25_fww,na.rm=TRUE),sd_25=sd(return_25_fww,na.rm=TRUE), N_25=sum(nad_return_25_fw),
mean_return_30=mean(return_30_fww,na.rm=TRUE),sd_30=sd(return_30_fww,na.rm=TRUE), N_30=sum(nad_return_30_fw),
mean_return_35=mean(return_35_fww,na.rm=TRUE),sd_35=sd(return_35_fww,na.rm=TRUE), N_35=sum(nad_return_35_fw),
mean_return_40=mean(return_40_fww,na.rm=TRUE),sd_40=sd(return_40_fww,na.rm=TRUE), N_40=sum(nad_return_40_fw),
mean_return_45=mean(return_45_fww,na.rm=TRUE),sd_45=sd(return_45_fww,na.rm=TRUE), N_45=sum(nad_return_45_fw),
mean_return_50=mean(return_50_fww,na.rm=TRUE),sd_50=sd(return_50_fww,na.rm=TRUE), N_50=sum(nad_return_50_fw),
mean_return_55=mean(return_55_fww,na.rm=TRUE),sd_55=sd(return_55_fww,na.rm=TRUE), N_55=sum(nad_return_55_fw),
mean_return_60=mean(return_60_fww,na.rm=TRUE),sd_60=sd(return_60_fww,na.rm=TRUE), N_60=sum(nad_return_60_fw),
mean_return_65=mean(return_65_fww,na.rm=TRUE),sd_65=sd(return_65_fww,na.rm=TRUE), N_65=sum(nad_return_65_fw),
mean_return_70=mean(return_70_fww,na.rm=TRUE),sd_70=sd(return_70_fww,na.rm=TRUE), N_70=sum(nad_return_70_fw),
mean_return_75=mean(return_75_fww,na.rm=TRUE),sd_75=sd(return_75_fww,na.rm=TRUE), N_75=sum(nad_return_75_fw),
mean_return_80=mean(return_80_fww,na.rm=TRUE),sd_80=sd(return_80_fww,na.rm=TRUE), N_80=sum(nad_return_80_fw),
mean_return_85=mean(return_85_fww,na.rm=TRUE),sd_85=sd(return_85_fww,na.rm=TRUE), N_85=sum(nad_return_85_fw),
mean_return_90=mean(return_90_fww,na.rm=TRUE),sd_90=sd(return_90_fww,na.rm=TRUE), N_90=sum(nad_return_90_fw),
mean_return_95=mean(return_95_fww,na.rm=TRUE),sd_95=sd(return_95_fww,na.rm=TRUE), N_95=sum(nad_return_95_fw),
mean_return_100=mean(return_100_fww,na.rm=TRUE),sd_100=sd(return_100_fww,na.rm=TRUE), N_100=sum(nad_return_100_fw),
mean_return_105=mean(return_105_fww,na.rm=TRUE),sd_105=sd(return_105_fww,na.rm=TRUE), N_105=sum(nad_return_105_fw),
mean_return_110=mean(return_110_fww,na.rm=TRUE),sd_110=sd(return_110_fww,na.rm=TRUE), N_110=sum(nad_return_110_fw),
mean_return_115=mean(return_115_fww,na.rm=TRUE),sd_115=sd(return_115_fww,na.rm=TRUE), N_115=sum(nad_return_115_fw),
mean_return_120=mean(return_120_fww,na.rm=TRUE),sd_120=sd(return_120_fww,na.rm=TRUE), N_120=sum(nad_return_120_fw),
mean_return_125=mean(return_125_fww,na.rm=TRUE),sd_125=sd(return_125_fww,na.rm=TRUE), N_125=sum(nad_return_125_fw),
mean_return_130=mean(return_130_fww,na.rm=TRUE),sd_130=sd(return_130_fww,na.rm=TRUE), N_130=sum(nad_return_130_fw),
mean_return_135=mean(return_135_fww,na.rm=TRUE),sd_135=sd(return_135_fww,na.rm=TRUE), N_135=sum(nad_return_135_fw),
mean_return_140=mean(return_140_fww,na.rm=TRUE),sd_140=sd(return_140_fww,na.rm=TRUE), N_140=sum(nad_return_140_fw),
mean_return_145=mean(return_145_fww,na.rm=TRUE),sd_145=sd(return_145_fww,na.rm=TRUE), N_145=sum(nad_return_145_fw),
mean_return_150=mean(return_150_fww,na.rm=TRUE),sd_150=sd(return_150_fww,na.rm=TRUE), N_150=sum(nad_return_150_fw),
mean_return_155=mean(return_155_fww,na.rm=TRUE),sd_155=sd(return_155_fww,na.rm=TRUE), N_155=sum(nad_return_155_fw),
mean_return_160=mean(return_160_fww,na.rm=TRUE),sd_160=sd(return_160_fww,na.rm=TRUE), N_160=sum(nad_return_160_fw),
mean_return_165=mean(return_165_fww,na.rm=TRUE),sd_165=sd(return_165_fww,na.rm=TRUE), N_165=sum(nad_return_165_fw),
mean_return_170=mean(return_170_fww,na.rm=TRUE),sd_170=sd(return_170_fww,na.rm=TRUE), N_170=sum(nad_return_170_fw),
mean_return_175=mean(return_175_fww,na.rm=TRUE),sd_175=sd(return_175_fww,na.rm=TRUE), N_175=sum(nad_return_175_fw),
mean_return_180=mean(return_180_fww,na.rm=TRUE),sd_180=sd(return_180_fww,na.rm=TRUE), N_180=sum(nad_return_180_fw),
mean_return_185=mean(return_185_fww,na.rm=TRUE),sd_185=sd(return_185_fww,na.rm=TRUE), N_185=sum(nad_return_185_fw),
mean_return_190=mean(return_190_fww,na.rm=TRUE),sd_190=sd(return_190_fww,na.rm=TRUE), N_190=sum(nad_return_190_fw),
mean_return_195=mean(return_195_fww,na.rm=TRUE),sd_195=sd(return_195_fww,na.rm=TRUE), N_195=sum(nad_return_195_fw),
mean_return_200=mean(return_200_fww,na.rm=TRUE),sd_200=sd(return_200_fww,na.rm=TRUE), N_200=sum(nad_return_200_fw),
mean_return_205=mean(return_205_fww,na.rm=TRUE),sd_205=sd(return_205_fww,na.rm=TRUE), N_205=sum(nad_return_205_fw),
mean_return_210=mean(return_210_fww,na.rm=TRUE),sd_210=sd(return_210_fww,na.rm=TRUE), N_210=sum(nad_return_210_fw),
mean_return_215=mean(return_215_fww,na.rm=TRUE),sd_215=sd(return_215_fww,na.rm=TRUE), N_215=sum(nad_return_215_fw),
mean_return_220=mean(return_220_fww,na.rm=TRUE),sd_220=sd(return_220_fww,na.rm=TRUE), N_220=sum(nad_return_220_fw),
mean_return_225=mean(return_225_fww,na.rm=TRUE),sd_225=sd(return_225_fww,na.rm=TRUE), N_225=sum(nad_return_225_fw),
mean_return_230=mean(return_230_fww,na.rm=TRUE),sd_230=sd(return_230_fww,na.rm=TRUE), N_230=sum(nad_return_230_fw),
mean_return_235=mean(return_235_fww,na.rm=TRUE),sd_235=sd(return_235_fww,na.rm=TRUE), N_235=sum(nad_return_235_fw),
mean_return_240=mean(return_240_fww,na.rm=TRUE),sd_240=sd(return_240_fww,na.rm=TRUE), N_240=sum(nad_return_240_fw),
mean_return_245=mean(return_245_fww,na.rm=TRUE),sd_245=sd(return_245_fww,na.rm=TRUE), N_245=sum(nad_return_245_fw),
mean_return_250=mean(return_250_fww,na.rm=TRUE),sd_250=sd(return_250_fww,na.rm=TRUE), N_250=sum(nad_return_250_fw)), by=category]


```
```{R}
check_for_run_fw_plot_a <- melt(ret_plot, id.vars="category")
check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a[grepl("sd",variable)]
setnames(check_for_run_fw_plot_a_1, "value", "sd")
#check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a_1[,.(sd=mean(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_1[,days:=rep(seq(0,250,5),each=3)]
check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a[grepl("mean",variable)]
setnames(check_for_run_fw_plot_a_2, "value", "mean")
#check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a_2[,.(mean=mean(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_2[,days:=rep(seq(0,250,5),each=3)]
check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a[grepl("N",variable)]
setnames(check_for_run_fw_plot_a_3, "value", "N")
#check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a_3[,.(N=min(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_3[,days:=rep(seq(0,250,5),each=3)]
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a_1, check_for_run_fw_plot_a_2, by=c("category","days"), all.x=TRUE)
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a, check_for_run_fw_plot_a_3, by=c("category","days"), all.x=TRUE)
check_for_run_fw_plot_a[,upper_ci:=mean+1.96*sd/sqrt(N)]
check_for_run_fw_plot_a[,lower_ci:=mean-1.96*sd/sqrt(N)]
#check_for_run_fw_plot_a[,Category:="Purchase - invested stock"]
#check_for_run_fw_plot_a[new_stock==1,Category:="New purchase"]
#check_for_run_fw_plot_a[order==2,Category:="New purchase - new industry"]
check_for_run_fw_plot_a$category <- factor(check_for_run_fw_plot_a$category, levels = c("Not Trade", "Top Up", "New Stock"))
#check_for_run_fw_plot[,type2:=paste(type,wp_group)]

# check_for_run_fw_plot$type2 <- factor(check_for_run_fw_plot$type2, levels = c("top up after positive rsp","top up after negative rsp", "new buy-invested industry after positive rsp", "new buy-invested industry after negative rsp", "new buy-new industry after positive rsp", "new buy-new industry after negative rsp"))

pd <- position_dodge(0.09) # move them .05 to the left and right



(g3 <- ggplot(check_for_run_fw_plot_a,aes(x=days,y=mean,color=category))+
       geom_ribbon(aes(ymin=lower_ci, ymax=upper_ci),alpha = .3, linetype=0) +
       geom_line(position=pd) +  xlab("Number of Working Days After the Purchase") + ylab("Raw Return") )


ggsave(g3, file="G:/rank/new_ind/codes/codes with more anon dataset/buy_info/three_types_sample2.1.png",width = 8, height = 6)
```




# adj return plot
```{r}
ret_buys_info1 <- merge(buys_info2, pp_ext2, by=c("sedol","date_formated"), all.x=TRUE)
for (i in 1:50){
  name1 <- paste0("na_adjret_",i*5,"_fw")
  name2 <- paste0("adjret_",i*5,"_fw")
  ret_buys_info1[get(name1)>=i*0.5, eval(name2):=NA]
  print(i)
}
#nrow(ret_buys_info1[is.na(return_5_fw)])/nrow(ret_buys_info1)
#nrow(ret_buys_info1[is.na(return_5_fw)])/nrow(ret_buys_info1)

for (i in 1:50){
  name1 <- paste0("adjret_",i*5,"_fw")
  name2 <- paste0("nad_return_",i*5,"_fw")
  ret_buys_info1[, eval(name2):=ifelse(is.na(get(name1)),0,1)]
  print(i)
}

for (i in 1:50){
  name1 <- paste0("return_",i*5,"_fww")
  name2 <- paste0("adjret_",i*5,"_fw")
  ret_buys_info1[, eval(name1):=Winsorize(get(name2), probs = c(0.01,0.99),na.rm=TRUE)]
  print(i)
}

ret_buys_info1[,category:="Not Trade"]
ret_buys_info1[topup==1,category:="Top Up"]
ret_buys_info1[new_stock==1,category:="New Stock"]


ret_plot <- ret_buys_info1[,.(mean_return_0=0,sd_0=0, N_0=1,
mean_return_5=mean(return_5_fww,na.rm=TRUE),sd_5=sd(return_5_fww,na.rm=TRUE), N_5=sum(nad_return_5_fw),
mean_return_10=mean(return_10_fww,na.rm=TRUE),sd_10=sd(return_10_fww,na.rm=TRUE), N_10=sum(nad_return_10_fw),
mean_return_15=mean(return_15_fww,na.rm=TRUE),sd_15=sd(return_15_fww,na.rm=TRUE), N_15=sum(nad_return_15_fw),
mean_return_20=mean(return_20_fww,na.rm=TRUE),sd_20=sd(return_20_fww,na.rm=TRUE), N_20=sum(nad_return_20_fw),
mean_return_25=mean(return_25_fww,na.rm=TRUE),sd_25=sd(return_25_fww,na.rm=TRUE), N_25=sum(nad_return_25_fw),
mean_return_30=mean(return_30_fww,na.rm=TRUE),sd_30=sd(return_30_fww,na.rm=TRUE), N_30=sum(nad_return_30_fw),
mean_return_35=mean(return_35_fww,na.rm=TRUE),sd_35=sd(return_35_fww,na.rm=TRUE), N_35=sum(nad_return_35_fw),
mean_return_40=mean(return_40_fww,na.rm=TRUE),sd_40=sd(return_40_fww,na.rm=TRUE), N_40=sum(nad_return_40_fw),
mean_return_45=mean(return_45_fww,na.rm=TRUE),sd_45=sd(return_45_fww,na.rm=TRUE), N_45=sum(nad_return_45_fw),
mean_return_50=mean(return_50_fww,na.rm=TRUE),sd_50=sd(return_50_fww,na.rm=TRUE), N_50=sum(nad_return_50_fw),
mean_return_55=mean(return_55_fww,na.rm=TRUE),sd_55=sd(return_55_fww,na.rm=TRUE), N_55=sum(nad_return_55_fw),
mean_return_60=mean(return_60_fww,na.rm=TRUE),sd_60=sd(return_60_fww,na.rm=TRUE), N_60=sum(nad_return_60_fw),
mean_return_65=mean(return_65_fww,na.rm=TRUE),sd_65=sd(return_65_fww,na.rm=TRUE), N_65=sum(nad_return_65_fw),
mean_return_70=mean(return_70_fww,na.rm=TRUE),sd_70=sd(return_70_fww,na.rm=TRUE), N_70=sum(nad_return_70_fw),
mean_return_75=mean(return_75_fww,na.rm=TRUE),sd_75=sd(return_75_fww,na.rm=TRUE), N_75=sum(nad_return_75_fw),
mean_return_80=mean(return_80_fww,na.rm=TRUE),sd_80=sd(return_80_fww,na.rm=TRUE), N_80=sum(nad_return_80_fw),
mean_return_85=mean(return_85_fww,na.rm=TRUE),sd_85=sd(return_85_fww,na.rm=TRUE), N_85=sum(nad_return_85_fw),
mean_return_90=mean(return_90_fww,na.rm=TRUE),sd_90=sd(return_90_fww,na.rm=TRUE), N_90=sum(nad_return_90_fw),
mean_return_95=mean(return_95_fww,na.rm=TRUE),sd_95=sd(return_95_fww,na.rm=TRUE), N_95=sum(nad_return_95_fw),
mean_return_100=mean(return_100_fww,na.rm=TRUE),sd_100=sd(return_100_fww,na.rm=TRUE), N_100=sum(nad_return_100_fw),
mean_return_105=mean(return_105_fww,na.rm=TRUE),sd_105=sd(return_105_fww,na.rm=TRUE), N_105=sum(nad_return_105_fw),
mean_return_110=mean(return_110_fww,na.rm=TRUE),sd_110=sd(return_110_fww,na.rm=TRUE), N_110=sum(nad_return_110_fw),
mean_return_115=mean(return_115_fww,na.rm=TRUE),sd_115=sd(return_115_fww,na.rm=TRUE), N_115=sum(nad_return_115_fw),
mean_return_120=mean(return_120_fww,na.rm=TRUE),sd_120=sd(return_120_fww,na.rm=TRUE), N_120=sum(nad_return_120_fw),
mean_return_125=mean(return_125_fww,na.rm=TRUE),sd_125=sd(return_125_fww,na.rm=TRUE), N_125=sum(nad_return_125_fw),
mean_return_130=mean(return_130_fww,na.rm=TRUE),sd_130=sd(return_130_fww,na.rm=TRUE), N_130=sum(nad_return_130_fw),
mean_return_135=mean(return_135_fww,na.rm=TRUE),sd_135=sd(return_135_fww,na.rm=TRUE), N_135=sum(nad_return_135_fw),
mean_return_140=mean(return_140_fww,na.rm=TRUE),sd_140=sd(return_140_fww,na.rm=TRUE), N_140=sum(nad_return_140_fw),
mean_return_145=mean(return_145_fww,na.rm=TRUE),sd_145=sd(return_145_fww,na.rm=TRUE), N_145=sum(nad_return_145_fw),
mean_return_150=mean(return_150_fww,na.rm=TRUE),sd_150=sd(return_150_fww,na.rm=TRUE), N_150=sum(nad_return_150_fw),
mean_return_155=mean(return_155_fww,na.rm=TRUE),sd_155=sd(return_155_fww,na.rm=TRUE), N_155=sum(nad_return_155_fw),
mean_return_160=mean(return_160_fww,na.rm=TRUE),sd_160=sd(return_160_fww,na.rm=TRUE), N_160=sum(nad_return_160_fw),
mean_return_165=mean(return_165_fww,na.rm=TRUE),sd_165=sd(return_165_fww,na.rm=TRUE), N_165=sum(nad_return_165_fw),
mean_return_170=mean(return_170_fww,na.rm=TRUE),sd_170=sd(return_170_fww,na.rm=TRUE), N_170=sum(nad_return_170_fw),
mean_return_175=mean(return_175_fww,na.rm=TRUE),sd_175=sd(return_175_fww,na.rm=TRUE), N_175=sum(nad_return_175_fw),
mean_return_180=mean(return_180_fww,na.rm=TRUE),sd_180=sd(return_180_fww,na.rm=TRUE), N_180=sum(nad_return_180_fw),
mean_return_185=mean(return_185_fww,na.rm=TRUE),sd_185=sd(return_185_fww,na.rm=TRUE), N_185=sum(nad_return_185_fw),
mean_return_190=mean(return_190_fww,na.rm=TRUE),sd_190=sd(return_190_fww,na.rm=TRUE), N_190=sum(nad_return_190_fw),
mean_return_195=mean(return_195_fww,na.rm=TRUE),sd_195=sd(return_195_fww,na.rm=TRUE), N_195=sum(nad_return_195_fw),
mean_return_200=mean(return_200_fww,na.rm=TRUE),sd_200=sd(return_200_fww,na.rm=TRUE), N_200=sum(nad_return_200_fw),
mean_return_205=mean(return_205_fww,na.rm=TRUE),sd_205=sd(return_205_fww,na.rm=TRUE), N_205=sum(nad_return_205_fw),
mean_return_210=mean(return_210_fww,na.rm=TRUE),sd_210=sd(return_210_fww,na.rm=TRUE), N_210=sum(nad_return_210_fw),
mean_return_215=mean(return_215_fww,na.rm=TRUE),sd_215=sd(return_215_fww,na.rm=TRUE), N_215=sum(nad_return_215_fw),
mean_return_220=mean(return_220_fww,na.rm=TRUE),sd_220=sd(return_220_fww,na.rm=TRUE), N_220=sum(nad_return_220_fw),
mean_return_225=mean(return_225_fww,na.rm=TRUE),sd_225=sd(return_225_fww,na.rm=TRUE), N_225=sum(nad_return_225_fw),
mean_return_230=mean(return_230_fww,na.rm=TRUE),sd_230=sd(return_230_fww,na.rm=TRUE), N_230=sum(nad_return_230_fw),
mean_return_235=mean(return_235_fww,na.rm=TRUE),sd_235=sd(return_235_fww,na.rm=TRUE), N_235=sum(nad_return_235_fw),
mean_return_240=mean(return_240_fww,na.rm=TRUE),sd_240=sd(return_240_fww,na.rm=TRUE), N_240=sum(nad_return_240_fw),
mean_return_245=mean(return_245_fww,na.rm=TRUE),sd_245=sd(return_245_fww,na.rm=TRUE), N_245=sum(nad_return_245_fw),
mean_return_250=mean(return_250_fww,na.rm=TRUE),sd_250=sd(return_250_fww,na.rm=TRUE), N_250=sum(nad_return_250_fw)), by=category]

(1+1)
```
```{R}
check_for_run_fw_plot_a <- melt(ret_plot, id.vars="category")
check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a[grepl("sd",variable)]
setnames(check_for_run_fw_plot_a_1, "value", "sd")
#check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a_1[,.(sd=mean(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_1[,days:=rep(seq(0,250,5),each=3)]
check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a[grepl("mean",variable)]
setnames(check_for_run_fw_plot_a_2, "value", "mean")
#check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a_2[,.(mean=mean(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_2[,days:=rep(seq(0,250,5),each=3)]
check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a[grepl("N",variable)]
setnames(check_for_run_fw_plot_a_3, "value", "N")
#check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a_3[,.(N=min(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_3[,days:=rep(seq(0,250,5),each=3)]
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a_1, check_for_run_fw_plot_a_2, by=c("category","days"), all.x=TRUE)
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a, check_for_run_fw_plot_a_3, by=c("category","days"), all.x=TRUE)
check_for_run_fw_plot_a[,upper_ci:=mean+1.96*sd/sqrt(N)]
check_for_run_fw_plot_a[,lower_ci:=mean-1.96*sd/sqrt(N)]
#check_for_run_fw_plot_a[,Category:="Purchase - invested stock"]
#check_for_run_fw_plot_a[new_stock==1,Category:="New purchase"]
#check_for_run_fw_plot_a[order==2,Category:="New purchase - new industry"]
check_for_run_fw_plot_a$category <- factor(check_for_run_fw_plot_a$category, levels = c("Not Trade", "Top Up", "New Stock"))
#check_for_run_fw_plot[,type2:=paste(type,wp_group)]

# check_for_run_fw_plot$type2 <- factor(check_for_run_fw_plot$type2, levels = c("top up after positive rsp","top up after negative rsp", "new buy-invested industry after positive rsp", "new buy-invested industry after negative rsp", "new buy-new industry after positive rsp", "new buy-new industry after negative rsp"))

pd <- position_dodge(0.09) # move them .05 to the left and right



(g2.2 <- ggplot(check_for_run_fw_plot_a,aes(x=days,y=mean,color=category))+
       geom_ribbon(aes(ymin=lower_ci, ymax=upper_ci),alpha = .3, linetype=0) +
       geom_line(position=pd) +  xlab("Number of Working Days After the Purchase") + ylab("Adj Return") )


ggsave(g2.2, file="G:/rank/new_ind/codes/codes with more anon dataset/buy_info/adj_three_types_sample2.1.png",width = 8, height = 6)
```

# sample 2.2

```{r}


buys_info2[,N_stockweek:=.N,by=stock_week]
buys_info2[,buy_stockdate:=sum(buy),by=stock_date]
buys_info2[,buy_stockweek:=sum(buy),by=stock_week]

nrow(buys_info2) # 3574529
nrow(buys_info2[N_anondate>1]) # 5202223
nrow(buys_info2[N_stockdate>1]) # 4920907
nrow(buys_info2[buy_stockdate>1]) # 1510648
nrow(buys_info2[buy_stockdate>1 & N_stockdate>1 &
                buy_stockdate<N_stockdate]) # 1508165
length(unique(buys_info2[buy_stockdate>1 & 
                           N_stockdate>1 &
                buy_stockdate<N_stockdate]$anon)) # 23316
length(unique(buys_info2[buy_stockdate>1 & 
                           N_stockdate>1 &
                buy_stockdate<N_stockdate]$sedol)) # 1138
buys_info2 <- buys_info2[buy_stockweek>1 & 
                           N_stockweek>1 &
                buy_stockweek<N_stockweek]

buys_info2[, mean_buy_stockdate:=mean(buy),
           by=stock_date]
buys_info2[, mean_buy_stockweek:=mean(buy),
           by=stock_week]
buys_info2[, mean_buy_anondate:=mean(buy),
           by=anon_date]

(pdenstockdatesample22 <- ggplot(buys_info2, aes(x=mean_buy_stockdate)) + 
    geom_histogram(aes(y=..density..),      
                   binwidth=.05,
                   colour="black", fill="white") +
    geom_density(alpha=.2, fill="#FF6666"))  
ggsave(pdenstockdatesample22, file="G:/rank/new_ind/codes/codes with more anon dataset/buy_info/pdenstockdatesample22.png",width = 8, height = 6)
(pdenstockweeksample22 <- ggplot(buys_info2, 
                                  aes(x=mean_buy_stockweek)) + 
    geom_histogram(aes(y=..density..),      
                   binwidth=.05,
                   colour="black", fill="white") +
    geom_density(alpha=.2, fill="#FF6666"))  
ggsave(pdenstockweeksample22, file="G:/rank/new_ind/codes/codes with more anon dataset/buy_info/pdenstockweeksample22.png",width = 8, height = 6)
(pdenanondatesample22 <- ggplot(buys_info2, 
                                  aes(x=mean_buy_anondate)) + 
    geom_histogram(aes(y=..density..),      
                   binwidth=.05,
                   colour="black", fill="white") +
    geom_density(alpha=.2, fill="#FF6666"))  
ggsave(pdenanondatesample22, file="G:/rank/new_ind/codes/codes with more anon dataset/buy_info/pdenanondatesample22.png",width = 8, height = 6)



f1.4 <- feols(new_stock~1|stock_date,data=buys_info2)



f2.4 <- feols(topup~1|stock_date,data=buys_info2)



f3.4 <- feols(new_stock~1|stock_date,data=buys_info2[!(topup==1)])



f4.4 <- feols(topup~1|stock_date,data=buys_info2[!(new_stock==1)])



f5.4 <- feols(new_stock~1|anon_date,data=buys_info2[!(topup==1)])
# Adj. R2: 0.131851
# R2: 1-(1-Adj. R2)/((1681197-1)/(1681197-178762-1))= 0.2241615
f6.4 <- feols(topup~1|anon_date,data=buys_info2[!(new_stock==1)])
# Adj. R2: 0.093042
# R2: 1-(1-Adj. R2)/((1684247 -1)/(1684247-181333-1))= 0.2253196
f7.4 <- feols(new_stock~1|anon_date+stock_date,data=buys_info2[!(topup==1)])

f8.4 <- feols(topup~1|anon_date+stock_date,data=buys_info2[!(new_stock==1)])

f9.4 <- feols(new_stock~1|anon_date+stock_week,data=buys_info2[!(topup==1)])
# Adj. R2: 0.169786
# R2: 1-(1-Adj. R2)/((1681197-1)/(1681197-178762-34970-1))= 0.240079
f10.4 <- feols(topup~1|anon_date+stock_week,data=buys_info2[!(new_stock==1)])
# Adj. R2: 0.126811
# R2: 1-(1-Adj. R2)/((1684247-1)/(1684247-181333-34970-1))= 0.2146081


```

# return plot
```{r}
ret_buys_info1 <- merge(buys_info2, pp_ext, by=c("sedol","date_formated"), all.x=TRUE)
for (i in 1:50){
  name1 <- paste0("na_return_",i*5,"_fw")
  name2 <- paste0("return_",i*5,"_fw")
  ret_buys_info1[get(name1)>=i*0.5, eval(name2):=NA]
  print(i)
}
nrow(ret_buys_info1[is.na(return_5_fw)])/nrow(ret_buys_info1)
nrow(ret_buys_info1[is.na(return_5_fw)])/nrow(ret_buys_info1)

for (i in 1:50){
  name1 <- paste0("return_",i*5,"_fw")
  name2 <- paste0("nad_return_",i*5,"_fw")
  ret_buys_info1[, eval(name2):=ifelse(is.na(get(name1)),0,1)]
  print(i)
}

for (i in 1:50){
  name1 <- paste0("return_",i*5,"_fww")
  name2 <- paste0("return_",i*5,"_fw")
  ret_buys_info1[, eval(name1):=Winsorize(get(name2), probs = c(0.01,0.99),na.rm=TRUE)]
  print(i)
}

ret_buys_info1[,category:="Not Trade"]
ret_buys_info1[topup==1,category:="Top Up"]
ret_buys_info1[new_stock==1,category:="New Stock"]


ret_plot <- ret_buys_info1[,.(mean_return_0=0,sd_0=0, N_0=1,
mean_return_5=mean(return_5_fww,na.rm=TRUE),sd_5=sd(return_5_fww,na.rm=TRUE), N_5=sum(nad_return_5_fw),
mean_return_10=mean(return_10_fww,na.rm=TRUE),sd_10=sd(return_10_fww,na.rm=TRUE), N_10=sum(nad_return_10_fw),
mean_return_15=mean(return_15_fww,na.rm=TRUE),sd_15=sd(return_15_fww,na.rm=TRUE), N_15=sum(nad_return_15_fw),
mean_return_20=mean(return_20_fww,na.rm=TRUE),sd_20=sd(return_20_fww,na.rm=TRUE), N_20=sum(nad_return_20_fw),
mean_return_25=mean(return_25_fww,na.rm=TRUE),sd_25=sd(return_25_fww,na.rm=TRUE), N_25=sum(nad_return_25_fw),
mean_return_30=mean(return_30_fww,na.rm=TRUE),sd_30=sd(return_30_fww,na.rm=TRUE), N_30=sum(nad_return_30_fw),
mean_return_35=mean(return_35_fww,na.rm=TRUE),sd_35=sd(return_35_fww,na.rm=TRUE), N_35=sum(nad_return_35_fw),
mean_return_40=mean(return_40_fww,na.rm=TRUE),sd_40=sd(return_40_fww,na.rm=TRUE), N_40=sum(nad_return_40_fw),
mean_return_45=mean(return_45_fww,na.rm=TRUE),sd_45=sd(return_45_fww,na.rm=TRUE), N_45=sum(nad_return_45_fw),
mean_return_50=mean(return_50_fww,na.rm=TRUE),sd_50=sd(return_50_fww,na.rm=TRUE), N_50=sum(nad_return_50_fw),
mean_return_55=mean(return_55_fww,na.rm=TRUE),sd_55=sd(return_55_fww,na.rm=TRUE), N_55=sum(nad_return_55_fw),
mean_return_60=mean(return_60_fww,na.rm=TRUE),sd_60=sd(return_60_fww,na.rm=TRUE), N_60=sum(nad_return_60_fw),
mean_return_65=mean(return_65_fww,na.rm=TRUE),sd_65=sd(return_65_fww,na.rm=TRUE), N_65=sum(nad_return_65_fw),
mean_return_70=mean(return_70_fww,na.rm=TRUE),sd_70=sd(return_70_fww,na.rm=TRUE), N_70=sum(nad_return_70_fw),
mean_return_75=mean(return_75_fww,na.rm=TRUE),sd_75=sd(return_75_fww,na.rm=TRUE), N_75=sum(nad_return_75_fw),
mean_return_80=mean(return_80_fww,na.rm=TRUE),sd_80=sd(return_80_fww,na.rm=TRUE), N_80=sum(nad_return_80_fw),
mean_return_85=mean(return_85_fww,na.rm=TRUE),sd_85=sd(return_85_fww,na.rm=TRUE), N_85=sum(nad_return_85_fw),
mean_return_90=mean(return_90_fww,na.rm=TRUE),sd_90=sd(return_90_fww,na.rm=TRUE), N_90=sum(nad_return_90_fw),
mean_return_95=mean(return_95_fww,na.rm=TRUE),sd_95=sd(return_95_fww,na.rm=TRUE), N_95=sum(nad_return_95_fw),
mean_return_100=mean(return_100_fww,na.rm=TRUE),sd_100=sd(return_100_fww,na.rm=TRUE), N_100=sum(nad_return_100_fw),
mean_return_105=mean(return_105_fww,na.rm=TRUE),sd_105=sd(return_105_fww,na.rm=TRUE), N_105=sum(nad_return_105_fw),
mean_return_110=mean(return_110_fww,na.rm=TRUE),sd_110=sd(return_110_fww,na.rm=TRUE), N_110=sum(nad_return_110_fw),
mean_return_115=mean(return_115_fww,na.rm=TRUE),sd_115=sd(return_115_fww,na.rm=TRUE), N_115=sum(nad_return_115_fw),
mean_return_120=mean(return_120_fww,na.rm=TRUE),sd_120=sd(return_120_fww,na.rm=TRUE), N_120=sum(nad_return_120_fw),
mean_return_125=mean(return_125_fww,na.rm=TRUE),sd_125=sd(return_125_fww,na.rm=TRUE), N_125=sum(nad_return_125_fw),
mean_return_130=mean(return_130_fww,na.rm=TRUE),sd_130=sd(return_130_fww,na.rm=TRUE), N_130=sum(nad_return_130_fw),
mean_return_135=mean(return_135_fww,na.rm=TRUE),sd_135=sd(return_135_fww,na.rm=TRUE), N_135=sum(nad_return_135_fw),
mean_return_140=mean(return_140_fww,na.rm=TRUE),sd_140=sd(return_140_fww,na.rm=TRUE), N_140=sum(nad_return_140_fw),
mean_return_145=mean(return_145_fww,na.rm=TRUE),sd_145=sd(return_145_fww,na.rm=TRUE), N_145=sum(nad_return_145_fw),
mean_return_150=mean(return_150_fww,na.rm=TRUE),sd_150=sd(return_150_fww,na.rm=TRUE), N_150=sum(nad_return_150_fw),
mean_return_155=mean(return_155_fww,na.rm=TRUE),sd_155=sd(return_155_fww,na.rm=TRUE), N_155=sum(nad_return_155_fw),
mean_return_160=mean(return_160_fww,na.rm=TRUE),sd_160=sd(return_160_fww,na.rm=TRUE), N_160=sum(nad_return_160_fw),
mean_return_165=mean(return_165_fww,na.rm=TRUE),sd_165=sd(return_165_fww,na.rm=TRUE), N_165=sum(nad_return_165_fw),
mean_return_170=mean(return_170_fww,na.rm=TRUE),sd_170=sd(return_170_fww,na.rm=TRUE), N_170=sum(nad_return_170_fw),
mean_return_175=mean(return_175_fww,na.rm=TRUE),sd_175=sd(return_175_fww,na.rm=TRUE), N_175=sum(nad_return_175_fw),
mean_return_180=mean(return_180_fww,na.rm=TRUE),sd_180=sd(return_180_fww,na.rm=TRUE), N_180=sum(nad_return_180_fw),
mean_return_185=mean(return_185_fww,na.rm=TRUE),sd_185=sd(return_185_fww,na.rm=TRUE), N_185=sum(nad_return_185_fw),
mean_return_190=mean(return_190_fww,na.rm=TRUE),sd_190=sd(return_190_fww,na.rm=TRUE), N_190=sum(nad_return_190_fw),
mean_return_195=mean(return_195_fww,na.rm=TRUE),sd_195=sd(return_195_fww,na.rm=TRUE), N_195=sum(nad_return_195_fw),
mean_return_200=mean(return_200_fww,na.rm=TRUE),sd_200=sd(return_200_fww,na.rm=TRUE), N_200=sum(nad_return_200_fw),
mean_return_205=mean(return_205_fww,na.rm=TRUE),sd_205=sd(return_205_fww,na.rm=TRUE), N_205=sum(nad_return_205_fw),
mean_return_210=mean(return_210_fww,na.rm=TRUE),sd_210=sd(return_210_fww,na.rm=TRUE), N_210=sum(nad_return_210_fw),
mean_return_215=mean(return_215_fww,na.rm=TRUE),sd_215=sd(return_215_fww,na.rm=TRUE), N_215=sum(nad_return_215_fw),
mean_return_220=mean(return_220_fww,na.rm=TRUE),sd_220=sd(return_220_fww,na.rm=TRUE), N_220=sum(nad_return_220_fw),
mean_return_225=mean(return_225_fww,na.rm=TRUE),sd_225=sd(return_225_fww,na.rm=TRUE), N_225=sum(nad_return_225_fw),
mean_return_230=mean(return_230_fww,na.rm=TRUE),sd_230=sd(return_230_fww,na.rm=TRUE), N_230=sum(nad_return_230_fw),
mean_return_235=mean(return_235_fww,na.rm=TRUE),sd_235=sd(return_235_fww,na.rm=TRUE), N_235=sum(nad_return_235_fw),
mean_return_240=mean(return_240_fww,na.rm=TRUE),sd_240=sd(return_240_fww,na.rm=TRUE), N_240=sum(nad_return_240_fw),
mean_return_245=mean(return_245_fww,na.rm=TRUE),sd_245=sd(return_245_fww,na.rm=TRUE), N_245=sum(nad_return_245_fw),
mean_return_250=mean(return_250_fww,na.rm=TRUE),sd_250=sd(return_250_fww,na.rm=TRUE), N_250=sum(nad_return_250_fw)), by=category]


```
```{R}
check_for_run_fw_plot_a <- melt(ret_plot, id.vars="category")
check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a[grepl("sd",variable)]
setnames(check_for_run_fw_plot_a_1, "value", "sd")
#check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a_1[,.(sd=mean(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_1[,days:=rep(seq(0,250,5),each=3)]
check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a[grepl("mean",variable)]
setnames(check_for_run_fw_plot_a_2, "value", "mean")
#check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a_2[,.(mean=mean(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_2[,days:=rep(seq(0,250,5),each=3)]
check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a[grepl("N",variable)]
setnames(check_for_run_fw_plot_a_3, "value", "N")
#check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a_3[,.(N=min(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_3[,days:=rep(seq(0,250,5),each=3)]
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a_1, check_for_run_fw_plot_a_2, by=c("category","days"), all.x=TRUE)
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a, check_for_run_fw_plot_a_3, by=c("category","days"), all.x=TRUE)
check_for_run_fw_plot_a[,upper_ci:=mean+1.96*sd/sqrt(N)]
check_for_run_fw_plot_a[,lower_ci:=mean-1.96*sd/sqrt(N)]
#check_for_run_fw_plot_a[,Category:="Purchase - invested stock"]
#check_for_run_fw_plot_a[new_stock==1,Category:="New purchase"]
#check_for_run_fw_plot_a[order==2,Category:="New purchase - new industry"]
check_for_run_fw_plot_a$category <- factor(check_for_run_fw_plot_a$category, levels = c("Not Trade", "Top Up", "New Stock"))
#check_for_run_fw_plot[,type2:=paste(type,wp_group)]

# check_for_run_fw_plot$type2 <- factor(check_for_run_fw_plot$type2, levels = c("top up after positive rsp","top up after negative rsp", "new buy-invested industry after positive rsp", "new buy-invested industry after negative rsp", "new buy-new industry after positive rsp", "new buy-new industry after negative rsp"))

pd <- position_dodge(0.09) # move them .05 to the left and right



(g4 <- ggplot(check_for_run_fw_plot_a,aes(x=days,y=mean,color=category))+
       geom_ribbon(aes(ymin=lower_ci, ymax=upper_ci),alpha = .3, linetype=0) +
       geom_line(position=pd) +  xlab("Number of Working Days After the Purchase") + ylab("Raw Return") )


ggsave(g4, file="G:/rank/new_ind/codes/codes with more anon dataset/buy_info/three_types_sample2.2.png",width = 8, height = 6)
```


# adj return plot
```{r}
ret_buys_info1 <- merge(buys_info2, pp_ext2, by=c("sedol","date_formated"), all.x=TRUE)
for (i in 1:50){
  name1 <- paste0("na_adjret_",i*5,"_fw")
  name2 <- paste0("adjret_",i*5,"_fw")
  ret_buys_info1[get(name1)>=i*0.5, eval(name2):=NA]
  print(i)
}
#nrow(ret_buys_info1[is.na(return_5_fw)])/nrow(ret_buys_info1)
#nrow(ret_buys_info1[is.na(return_5_fw)])/nrow(ret_buys_info1)

for (i in 1:50){
  name1 <- paste0("adjret_",i*5,"_fw")
  name2 <- paste0("nad_return_",i*5,"_fw")
  ret_buys_info1[, eval(name2):=ifelse(is.na(get(name1)),0,1)]
  print(i)
}

for (i in 1:50){
  name1 <- paste0("return_",i*5,"_fww")
  name2 <- paste0("adjret_",i*5,"_fw")
  ret_buys_info1[, eval(name1):=Winsorize(get(name2), probs = c(0.01,0.99),na.rm=TRUE)]
  print(i)
}

ret_buys_info1[,category:="Not Trade"]
ret_buys_info1[topup==1,category:="Top Up"]
ret_buys_info1[new_stock==1,category:="New Stock"]


ret_plot <- ret_buys_info1[,.(mean_return_0=0,sd_0=0, N_0=1,
mean_return_5=mean(return_5_fww,na.rm=TRUE),sd_5=sd(return_5_fww,na.rm=TRUE), N_5=sum(nad_return_5_fw),
mean_return_10=mean(return_10_fww,na.rm=TRUE),sd_10=sd(return_10_fww,na.rm=TRUE), N_10=sum(nad_return_10_fw),
mean_return_15=mean(return_15_fww,na.rm=TRUE),sd_15=sd(return_15_fww,na.rm=TRUE), N_15=sum(nad_return_15_fw),
mean_return_20=mean(return_20_fww,na.rm=TRUE),sd_20=sd(return_20_fww,na.rm=TRUE), N_20=sum(nad_return_20_fw),
mean_return_25=mean(return_25_fww,na.rm=TRUE),sd_25=sd(return_25_fww,na.rm=TRUE), N_25=sum(nad_return_25_fw),
mean_return_30=mean(return_30_fww,na.rm=TRUE),sd_30=sd(return_30_fww,na.rm=TRUE), N_30=sum(nad_return_30_fw),
mean_return_35=mean(return_35_fww,na.rm=TRUE),sd_35=sd(return_35_fww,na.rm=TRUE), N_35=sum(nad_return_35_fw),
mean_return_40=mean(return_40_fww,na.rm=TRUE),sd_40=sd(return_40_fww,na.rm=TRUE), N_40=sum(nad_return_40_fw),
mean_return_45=mean(return_45_fww,na.rm=TRUE),sd_45=sd(return_45_fww,na.rm=TRUE), N_45=sum(nad_return_45_fw),
mean_return_50=mean(return_50_fww,na.rm=TRUE),sd_50=sd(return_50_fww,na.rm=TRUE), N_50=sum(nad_return_50_fw),
mean_return_55=mean(return_55_fww,na.rm=TRUE),sd_55=sd(return_55_fww,na.rm=TRUE), N_55=sum(nad_return_55_fw),
mean_return_60=mean(return_60_fww,na.rm=TRUE),sd_60=sd(return_60_fww,na.rm=TRUE), N_60=sum(nad_return_60_fw),
mean_return_65=mean(return_65_fww,na.rm=TRUE),sd_65=sd(return_65_fww,na.rm=TRUE), N_65=sum(nad_return_65_fw),
mean_return_70=mean(return_70_fww,na.rm=TRUE),sd_70=sd(return_70_fww,na.rm=TRUE), N_70=sum(nad_return_70_fw),
mean_return_75=mean(return_75_fww,na.rm=TRUE),sd_75=sd(return_75_fww,na.rm=TRUE), N_75=sum(nad_return_75_fw),
mean_return_80=mean(return_80_fww,na.rm=TRUE),sd_80=sd(return_80_fww,na.rm=TRUE), N_80=sum(nad_return_80_fw),
mean_return_85=mean(return_85_fww,na.rm=TRUE),sd_85=sd(return_85_fww,na.rm=TRUE), N_85=sum(nad_return_85_fw),
mean_return_90=mean(return_90_fww,na.rm=TRUE),sd_90=sd(return_90_fww,na.rm=TRUE), N_90=sum(nad_return_90_fw),
mean_return_95=mean(return_95_fww,na.rm=TRUE),sd_95=sd(return_95_fww,na.rm=TRUE), N_95=sum(nad_return_95_fw),
mean_return_100=mean(return_100_fww,na.rm=TRUE),sd_100=sd(return_100_fww,na.rm=TRUE), N_100=sum(nad_return_100_fw),
mean_return_105=mean(return_105_fww,na.rm=TRUE),sd_105=sd(return_105_fww,na.rm=TRUE), N_105=sum(nad_return_105_fw),
mean_return_110=mean(return_110_fww,na.rm=TRUE),sd_110=sd(return_110_fww,na.rm=TRUE), N_110=sum(nad_return_110_fw),
mean_return_115=mean(return_115_fww,na.rm=TRUE),sd_115=sd(return_115_fww,na.rm=TRUE), N_115=sum(nad_return_115_fw),
mean_return_120=mean(return_120_fww,na.rm=TRUE),sd_120=sd(return_120_fww,na.rm=TRUE), N_120=sum(nad_return_120_fw),
mean_return_125=mean(return_125_fww,na.rm=TRUE),sd_125=sd(return_125_fww,na.rm=TRUE), N_125=sum(nad_return_125_fw),
mean_return_130=mean(return_130_fww,na.rm=TRUE),sd_130=sd(return_130_fww,na.rm=TRUE), N_130=sum(nad_return_130_fw),
mean_return_135=mean(return_135_fww,na.rm=TRUE),sd_135=sd(return_135_fww,na.rm=TRUE), N_135=sum(nad_return_135_fw),
mean_return_140=mean(return_140_fww,na.rm=TRUE),sd_140=sd(return_140_fww,na.rm=TRUE), N_140=sum(nad_return_140_fw),
mean_return_145=mean(return_145_fww,na.rm=TRUE),sd_145=sd(return_145_fww,na.rm=TRUE), N_145=sum(nad_return_145_fw),
mean_return_150=mean(return_150_fww,na.rm=TRUE),sd_150=sd(return_150_fww,na.rm=TRUE), N_150=sum(nad_return_150_fw),
mean_return_155=mean(return_155_fww,na.rm=TRUE),sd_155=sd(return_155_fww,na.rm=TRUE), N_155=sum(nad_return_155_fw),
mean_return_160=mean(return_160_fww,na.rm=TRUE),sd_160=sd(return_160_fww,na.rm=TRUE), N_160=sum(nad_return_160_fw),
mean_return_165=mean(return_165_fww,na.rm=TRUE),sd_165=sd(return_165_fww,na.rm=TRUE), N_165=sum(nad_return_165_fw),
mean_return_170=mean(return_170_fww,na.rm=TRUE),sd_170=sd(return_170_fww,na.rm=TRUE), N_170=sum(nad_return_170_fw),
mean_return_175=mean(return_175_fww,na.rm=TRUE),sd_175=sd(return_175_fww,na.rm=TRUE), N_175=sum(nad_return_175_fw),
mean_return_180=mean(return_180_fww,na.rm=TRUE),sd_180=sd(return_180_fww,na.rm=TRUE), N_180=sum(nad_return_180_fw),
mean_return_185=mean(return_185_fww,na.rm=TRUE),sd_185=sd(return_185_fww,na.rm=TRUE), N_185=sum(nad_return_185_fw),
mean_return_190=mean(return_190_fww,na.rm=TRUE),sd_190=sd(return_190_fww,na.rm=TRUE), N_190=sum(nad_return_190_fw),
mean_return_195=mean(return_195_fww,na.rm=TRUE),sd_195=sd(return_195_fww,na.rm=TRUE), N_195=sum(nad_return_195_fw),
mean_return_200=mean(return_200_fww,na.rm=TRUE),sd_200=sd(return_200_fww,na.rm=TRUE), N_200=sum(nad_return_200_fw),
mean_return_205=mean(return_205_fww,na.rm=TRUE),sd_205=sd(return_205_fww,na.rm=TRUE), N_205=sum(nad_return_205_fw),
mean_return_210=mean(return_210_fww,na.rm=TRUE),sd_210=sd(return_210_fww,na.rm=TRUE), N_210=sum(nad_return_210_fw),
mean_return_215=mean(return_215_fww,na.rm=TRUE),sd_215=sd(return_215_fww,na.rm=TRUE), N_215=sum(nad_return_215_fw),
mean_return_220=mean(return_220_fww,na.rm=TRUE),sd_220=sd(return_220_fww,na.rm=TRUE), N_220=sum(nad_return_220_fw),
mean_return_225=mean(return_225_fww,na.rm=TRUE),sd_225=sd(return_225_fww,na.rm=TRUE), N_225=sum(nad_return_225_fw),
mean_return_230=mean(return_230_fww,na.rm=TRUE),sd_230=sd(return_230_fww,na.rm=TRUE), N_230=sum(nad_return_230_fw),
mean_return_235=mean(return_235_fww,na.rm=TRUE),sd_235=sd(return_235_fww,na.rm=TRUE), N_235=sum(nad_return_235_fw),
mean_return_240=mean(return_240_fww,na.rm=TRUE),sd_240=sd(return_240_fww,na.rm=TRUE), N_240=sum(nad_return_240_fw),
mean_return_245=mean(return_245_fww,na.rm=TRUE),sd_245=sd(return_245_fww,na.rm=TRUE), N_245=sum(nad_return_245_fw),
mean_return_250=mean(return_250_fww,na.rm=TRUE),sd_250=sd(return_250_fww,na.rm=TRUE), N_250=sum(nad_return_250_fw)), by=category]

(1+1)
```
```{R}
check_for_run_fw_plot_a <- melt(ret_plot, id.vars="category")
check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a[grepl("sd",variable)]
setnames(check_for_run_fw_plot_a_1, "value", "sd")
#check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a_1[,.(sd=mean(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_1[,days:=rep(seq(0,250,5),each=3)]
check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a[grepl("mean",variable)]
setnames(check_for_run_fw_plot_a_2, "value", "mean")
#check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a_2[,.(mean=mean(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_2[,days:=rep(seq(0,250,5),each=3)]
check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a[grepl("N",variable)]
setnames(check_for_run_fw_plot_a_3, "value", "N")
#check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a_3[,.(N=min(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_3[,days:=rep(seq(0,250,5),each=3)]
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a_1, check_for_run_fw_plot_a_2, by=c("category","days"), all.x=TRUE)
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a, check_for_run_fw_plot_a_3, by=c("category","days"), all.x=TRUE)
check_for_run_fw_plot_a[,upper_ci:=mean+1.96*sd/sqrt(N)]
check_for_run_fw_plot_a[,lower_ci:=mean-1.96*sd/sqrt(N)]
#check_for_run_fw_plot_a[,Category:="Purchase - invested stock"]
#check_for_run_fw_plot_a[new_stock==1,Category:="New purchase"]
#check_for_run_fw_plot_a[order==2,Category:="New purchase - new industry"]
check_for_run_fw_plot_a$category <- factor(check_for_run_fw_plot_a$category, levels = c("Not Trade", "Top Up", "New Stock"))
#check_for_run_fw_plot[,type2:=paste(type,wp_group)]

# check_for_run_fw_plot$type2 <- factor(check_for_run_fw_plot$type2, levels = c("top up after positive rsp","top up after negative rsp", "new buy-invested industry after positive rsp", "new buy-invested industry after negative rsp", "new buy-new industry after positive rsp", "new buy-new industry after negative rsp"))

pd <- position_dodge(0.09) # move them .05 to the left and right



(g2.22 <- ggplot(check_for_run_fw_plot_a,aes(x=days,y=mean,color=category))+
       geom_ribbon(aes(ymin=lower_ci, ymax=upper_ci),alpha = .3, linetype=0) +
       geom_line(position=pd) +  xlab("Number of Working Days After the Purchase") + ylab("Adj Return") )


ggsave(g2.22, file="G:/rank/new_ind/codes/codes with more anon dataset/buy_info/adj_three_types_sample2.2.png",width = 8, height = 6)
```

# sample 3.1

```{r}
check_for_run[,anon_date:=paste0(anon, date_formated)]


buys_info2 <- buys_info1[anon_date %in% 
                        unique(check_for_run$anon_date)]
buys_info2[,N_anondate:=.N,by=anon_date]
buys_info2[,N_stockdate:=.N,by=stock_date]

buys_info2[, mean_buy_stockdate:=mean(buy),
           by=stock_date]
buys_info2[, mean_buy_stockweek:=mean(buy),
           by=stock_week]
buys_info2[, mean_buy_anondate:=mean(buy),
           by=anon_date]

(pdenstockdatesample31 <- ggplot(buys_info2, aes(x=mean_buy_stockdate)) + 
    geom_histogram(aes(y=..density..),      
                   binwidth=.05,
                   colour="black", fill="white") +
    geom_density(alpha=.2, fill="#FF6666"))  
ggsave(pdenstockdatesample31, file="G:/rank/new_ind/codes/codes with more anon dataset/buy_info/pdenstockdatesample31.png",width = 8, height = 6)
(pdenstockweeksample31 <- ggplot(buys_info2, 
                                  aes(x=mean_buy_stockweek)) + 
    geom_histogram(aes(y=..density..),      
                   binwidth=.05,
                   colour="black", fill="white") +
    geom_density(alpha=.2, fill="#FF6666"))  
ggsave(pdenstockweeksample31, file="G:/rank/new_ind/codes/codes with more anon dataset/buy_info/pdenstockweeksample31.png",width = 8, height = 6)
(pdenanondatesample31 <- ggplot(buys_info2, 
                                  aes(x=mean_buy_anondate)) + 
    geom_histogram(aes(y=..density..),      
                   binwidth=.05,
                   colour="black", fill="white") +
    geom_density(alpha=.2, fill="#FF6666"))  
ggsave(pdenanondatesample31, file="G:/rank/new_ind/codes/codes with more anon dataset/buy_info/pdenanondatesample31.png",width = 8, height = 6)


f1.5 <- feols(new_stock~1|stock_date,data=buys_info2)

# Adj. R2: -0.046232
# R2: 1-(1+0.046232)/((1195758 -1)/(1195758-510505-1))= 0.4004362

f2.5 <- feols(topup~1|stock_date,data=buys_info2)

# Adj. R2: -0.112066
# R2: 1-(1+0.112066)/((1195758-1)/(1195758-510505-1))= 0.3627088

f3.5 <- feols(new_stock~1|stock_date,data=buys_info2[!(topup==1)])

# Adj. R2: -0.037083
# R2: 1-(1+0.037083)/((1145923-1)/(1145923-503721-1))= 0.4187949

f4.5 <- feols(topup~1|stock_date,data=buys_info2[!(new_stock==1)])
# Adj. R2: -0.097688
# R2: 1-(1+0.097688)/((1142483 -1)/(1142483-500951-1))= 0.3836219

f5.5 <- feols(new_stock~1|anon_date,data=buys_info2[!(topup==1)])
# Adj. R2: 0.084941
# R2: 1-(1-Adj. R2)/((1145922-1)/(1145922-81132-1))= 0.1497278
f6.5 <- feols(topup~1|anon_date,data=buys_info2[!(new_stock==1)])
# Adj. R2: 0.123118
# R2: 1-(1-Adj. R2)/((1142483  -1)/(1142483-83922-1))= 0.1875301
f7.5 <- feols(new_stock~1|anon_date+stock_date,data=buys_info2[!(topup==1)])
# Adj. R2: 0.05378
# R2: 1-(1-Adj. R2)/((1145922-1)/(1145922-81132-503720-1))= 0.5367092
f8.5 <- feols(topup~1|anon_date+stock_date,data=buys_info2[!(new_stock==1)])
# Adj. R2: 0.01628
# R2: 1-(1-Adj. R2)/((1142483  -1)/(1142483-83922-500951-1))= 0.5198777
f9.5 <- feols(new_stock~1|anon_date+stock_week,data=buys_info2[!(topup==1)])
# Adj. R2: 0.102049
# R2: 1-(1-Adj. R2)/((1145922-1)/(1145922-81132-183788-1))= 0.309642
f10.5 <- feols(topup~1|anon_date+stock_week,data=buys_info2[!(new_stock==1)])
# Adj. R2: 0.124345
# R2: 1-(1-Adj. R2)/((1142483  -1)/(1142483-83922-182691-1))= 0.2146081

```

# return plot
```{r}
ret_buys_info1 <- merge(buys_info2, pp_ext, by=c("sedol","date_formated"), all.x=TRUE)
for (i in 1:50){
  name1 <- paste0("na_return_",i*5,"_fw")
  name2 <- paste0("return_",i*5,"_fw")
  ret_buys_info1[get(name1)>=i*0.5, eval(name2):=NA]
  print(i)
}
nrow(ret_buys_info1[is.na(return_5_fw)])/nrow(ret_buys_info1)
nrow(ret_buys_info1[is.na(return_5_fw)])/nrow(ret_buys_info1)

for (i in 1:50){
  name1 <- paste0("return_",i*5,"_fw")
  name2 <- paste0("nad_return_",i*5,"_fw")
  ret_buys_info1[, eval(name2):=ifelse(is.na(get(name1)),0,1)]
  print(i)
}

for (i in 1:50){
  name1 <- paste0("return_",i*5,"_fww")
  name2 <- paste0("return_",i*5,"_fw")
  ret_buys_info1[, eval(name1):=Winsorize(get(name2), probs = c(0.01,0.99),na.rm=TRUE)]
  print(i)
}

ret_buys_info1[,category:="Not Trade"]
ret_buys_info1[topup==1,category:="Top Up"]
ret_buys_info1[new_stock==1,category:="New Stock"]


ret_plot <- ret_buys_info1[,.(mean_return_0=0,sd_0=0, N_0=1,
mean_return_5=mean(return_5_fww,na.rm=TRUE),sd_5=sd(return_5_fww,na.rm=TRUE), N_5=sum(nad_return_5_fw),
mean_return_10=mean(return_10_fww,na.rm=TRUE),sd_10=sd(return_10_fww,na.rm=TRUE), N_10=sum(nad_return_10_fw),
mean_return_15=mean(return_15_fww,na.rm=TRUE),sd_15=sd(return_15_fww,na.rm=TRUE), N_15=sum(nad_return_15_fw),
mean_return_20=mean(return_20_fww,na.rm=TRUE),sd_20=sd(return_20_fww,na.rm=TRUE), N_20=sum(nad_return_20_fw),
mean_return_25=mean(return_25_fww,na.rm=TRUE),sd_25=sd(return_25_fww,na.rm=TRUE), N_25=sum(nad_return_25_fw),
mean_return_30=mean(return_30_fww,na.rm=TRUE),sd_30=sd(return_30_fww,na.rm=TRUE), N_30=sum(nad_return_30_fw),
mean_return_35=mean(return_35_fww,na.rm=TRUE),sd_35=sd(return_35_fww,na.rm=TRUE), N_35=sum(nad_return_35_fw),
mean_return_40=mean(return_40_fww,na.rm=TRUE),sd_40=sd(return_40_fww,na.rm=TRUE), N_40=sum(nad_return_40_fw),
mean_return_45=mean(return_45_fww,na.rm=TRUE),sd_45=sd(return_45_fww,na.rm=TRUE), N_45=sum(nad_return_45_fw),
mean_return_50=mean(return_50_fww,na.rm=TRUE),sd_50=sd(return_50_fww,na.rm=TRUE), N_50=sum(nad_return_50_fw),
mean_return_55=mean(return_55_fww,na.rm=TRUE),sd_55=sd(return_55_fww,na.rm=TRUE), N_55=sum(nad_return_55_fw),
mean_return_60=mean(return_60_fww,na.rm=TRUE),sd_60=sd(return_60_fww,na.rm=TRUE), N_60=sum(nad_return_60_fw),
mean_return_65=mean(return_65_fww,na.rm=TRUE),sd_65=sd(return_65_fww,na.rm=TRUE), N_65=sum(nad_return_65_fw),
mean_return_70=mean(return_70_fww,na.rm=TRUE),sd_70=sd(return_70_fww,na.rm=TRUE), N_70=sum(nad_return_70_fw),
mean_return_75=mean(return_75_fww,na.rm=TRUE),sd_75=sd(return_75_fww,na.rm=TRUE), N_75=sum(nad_return_75_fw),
mean_return_80=mean(return_80_fww,na.rm=TRUE),sd_80=sd(return_80_fww,na.rm=TRUE), N_80=sum(nad_return_80_fw),
mean_return_85=mean(return_85_fww,na.rm=TRUE),sd_85=sd(return_85_fww,na.rm=TRUE), N_85=sum(nad_return_85_fw),
mean_return_90=mean(return_90_fww,na.rm=TRUE),sd_90=sd(return_90_fww,na.rm=TRUE), N_90=sum(nad_return_90_fw),
mean_return_95=mean(return_95_fww,na.rm=TRUE),sd_95=sd(return_95_fww,na.rm=TRUE), N_95=sum(nad_return_95_fw),
mean_return_100=mean(return_100_fww,na.rm=TRUE),sd_100=sd(return_100_fww,na.rm=TRUE), N_100=sum(nad_return_100_fw),
mean_return_105=mean(return_105_fww,na.rm=TRUE),sd_105=sd(return_105_fww,na.rm=TRUE), N_105=sum(nad_return_105_fw),
mean_return_110=mean(return_110_fww,na.rm=TRUE),sd_110=sd(return_110_fww,na.rm=TRUE), N_110=sum(nad_return_110_fw),
mean_return_115=mean(return_115_fww,na.rm=TRUE),sd_115=sd(return_115_fww,na.rm=TRUE), N_115=sum(nad_return_115_fw),
mean_return_120=mean(return_120_fww,na.rm=TRUE),sd_120=sd(return_120_fww,na.rm=TRUE), N_120=sum(nad_return_120_fw),
mean_return_125=mean(return_125_fww,na.rm=TRUE),sd_125=sd(return_125_fww,na.rm=TRUE), N_125=sum(nad_return_125_fw),
mean_return_130=mean(return_130_fww,na.rm=TRUE),sd_130=sd(return_130_fww,na.rm=TRUE), N_130=sum(nad_return_130_fw),
mean_return_135=mean(return_135_fww,na.rm=TRUE),sd_135=sd(return_135_fww,na.rm=TRUE), N_135=sum(nad_return_135_fw),
mean_return_140=mean(return_140_fww,na.rm=TRUE),sd_140=sd(return_140_fww,na.rm=TRUE), N_140=sum(nad_return_140_fw),
mean_return_145=mean(return_145_fww,na.rm=TRUE),sd_145=sd(return_145_fww,na.rm=TRUE), N_145=sum(nad_return_145_fw),
mean_return_150=mean(return_150_fww,na.rm=TRUE),sd_150=sd(return_150_fww,na.rm=TRUE), N_150=sum(nad_return_150_fw),
mean_return_155=mean(return_155_fww,na.rm=TRUE),sd_155=sd(return_155_fww,na.rm=TRUE), N_155=sum(nad_return_155_fw),
mean_return_160=mean(return_160_fww,na.rm=TRUE),sd_160=sd(return_160_fww,na.rm=TRUE), N_160=sum(nad_return_160_fw),
mean_return_165=mean(return_165_fww,na.rm=TRUE),sd_165=sd(return_165_fww,na.rm=TRUE), N_165=sum(nad_return_165_fw),
mean_return_170=mean(return_170_fww,na.rm=TRUE),sd_170=sd(return_170_fww,na.rm=TRUE), N_170=sum(nad_return_170_fw),
mean_return_175=mean(return_175_fww,na.rm=TRUE),sd_175=sd(return_175_fww,na.rm=TRUE), N_175=sum(nad_return_175_fw),
mean_return_180=mean(return_180_fww,na.rm=TRUE),sd_180=sd(return_180_fww,na.rm=TRUE), N_180=sum(nad_return_180_fw),
mean_return_185=mean(return_185_fww,na.rm=TRUE),sd_185=sd(return_185_fww,na.rm=TRUE), N_185=sum(nad_return_185_fw),
mean_return_190=mean(return_190_fww,na.rm=TRUE),sd_190=sd(return_190_fww,na.rm=TRUE), N_190=sum(nad_return_190_fw),
mean_return_195=mean(return_195_fww,na.rm=TRUE),sd_195=sd(return_195_fww,na.rm=TRUE), N_195=sum(nad_return_195_fw),
mean_return_200=mean(return_200_fww,na.rm=TRUE),sd_200=sd(return_200_fww,na.rm=TRUE), N_200=sum(nad_return_200_fw),
mean_return_205=mean(return_205_fww,na.rm=TRUE),sd_205=sd(return_205_fww,na.rm=TRUE), N_205=sum(nad_return_205_fw),
mean_return_210=mean(return_210_fww,na.rm=TRUE),sd_210=sd(return_210_fww,na.rm=TRUE), N_210=sum(nad_return_210_fw),
mean_return_215=mean(return_215_fww,na.rm=TRUE),sd_215=sd(return_215_fww,na.rm=TRUE), N_215=sum(nad_return_215_fw),
mean_return_220=mean(return_220_fww,na.rm=TRUE),sd_220=sd(return_220_fww,na.rm=TRUE), N_220=sum(nad_return_220_fw),
mean_return_225=mean(return_225_fww,na.rm=TRUE),sd_225=sd(return_225_fww,na.rm=TRUE), N_225=sum(nad_return_225_fw),
mean_return_230=mean(return_230_fww,na.rm=TRUE),sd_230=sd(return_230_fww,na.rm=TRUE), N_230=sum(nad_return_230_fw),
mean_return_235=mean(return_235_fww,na.rm=TRUE),sd_235=sd(return_235_fww,na.rm=TRUE), N_235=sum(nad_return_235_fw),
mean_return_240=mean(return_240_fww,na.rm=TRUE),sd_240=sd(return_240_fww,na.rm=TRUE), N_240=sum(nad_return_240_fw),
mean_return_245=mean(return_245_fww,na.rm=TRUE),sd_245=sd(return_245_fww,na.rm=TRUE), N_245=sum(nad_return_245_fw),
mean_return_250=mean(return_250_fww,na.rm=TRUE),sd_250=sd(return_250_fww,na.rm=TRUE), N_250=sum(nad_return_250_fw)), by=category]


```
```{R}
check_for_run_fw_plot_a <- melt(ret_plot, id.vars="category")
check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a[grepl("sd",variable)]
setnames(check_for_run_fw_plot_a_1, "value", "sd")
#check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a_1[,.(sd=mean(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_1[,days:=rep(seq(0,250,5),each=3)]
check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a[grepl("mean",variable)]
setnames(check_for_run_fw_plot_a_2, "value", "mean")
#check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a_2[,.(mean=mean(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_2[,days:=rep(seq(0,250,5),each=3)]
check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a[grepl("N",variable)]
setnames(check_for_run_fw_plot_a_3, "value", "N")
#check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a_3[,.(N=min(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_3[,days:=rep(seq(0,250,5),each=3)]
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a_1, check_for_run_fw_plot_a_2, by=c("category","days"), all.x=TRUE)
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a, check_for_run_fw_plot_a_3, by=c("category","days"), all.x=TRUE)
check_for_run_fw_plot_a[,upper_ci:=mean+1.96*sd/sqrt(N)]
check_for_run_fw_plot_a[,lower_ci:=mean-1.96*sd/sqrt(N)]
#check_for_run_fw_plot_a[,Category:="Purchase - invested stock"]
#check_for_run_fw_plot_a[new_stock==1,Category:="New purchase"]
#check_for_run_fw_plot_a[order==2,Category:="New purchase - new industry"]
check_for_run_fw_plot_a$category <- factor(check_for_run_fw_plot_a$category, levels = c("Not Trade", "Top Up", "New Stock"))
#check_for_run_fw_plot[,type2:=paste(type,wp_group)]

# check_for_run_fw_plot$type2 <- factor(check_for_run_fw_plot$type2, levels = c("top up after positive rsp","top up after negative rsp", "new buy-invested industry after positive rsp", "new buy-invested industry after negative rsp", "new buy-new industry after positive rsp", "new buy-new industry after negative rsp"))

pd <- position_dodge(0.09) # move them .05 to the left and right



(g5 <- ggplot(check_for_run_fw_plot_a,aes(x=days,y=mean,color=category))+
       geom_ribbon(aes(ymin=lower_ci, ymax=upper_ci),alpha = .3, linetype=0) +
       geom_line(position=pd) +  xlab("Number of Working Days After the Purchase") + ylab("Raw Return") )


ggsave(g5, file="G:/rank/new_ind/codes/codes with more anon dataset/buy_info/three_types_sample3.1.png",width = 8, height = 6)
```


# adj return plot
```{r}
ret_buys_info1 <- merge(buys_info2, pp_ext2, by=c("sedol","date_formated"), all.x=TRUE)
for (i in 1:50){
  name1 <- paste0("na_adjret_",i*5,"_fw")
  name2 <- paste0("adjret_",i*5,"_fw")
  ret_buys_info1[get(name1)>=i*0.5, eval(name2):=NA]
  print(i)
}
#nrow(ret_buys_info1[is.na(return_5_fw)])/nrow(ret_buys_info1)
#nrow(ret_buys_info1[is.na(return_5_fw)])/nrow(ret_buys_info1)

for (i in 1:50){
  name1 <- paste0("adjret_",i*5,"_fw")
  name2 <- paste0("nad_return_",i*5,"_fw")
  ret_buys_info1[, eval(name2):=ifelse(is.na(get(name1)),0,1)]
  print(i)
}

for (i in 1:50){
  name1 <- paste0("return_",i*5,"_fww")
  name2 <- paste0("adjret_",i*5,"_fw")
  ret_buys_info1[, eval(name1):=Winsorize(get(name2), probs = c(0.01,0.99),na.rm=TRUE)]
  print(i)
}

ret_buys_info1[,category:="Not Trade"]
ret_buys_info1[topup==1,category:="Top Up"]
ret_buys_info1[new_stock==1,category:="New Stock"]


ret_plot <- ret_buys_info1[,.(mean_return_0=0,sd_0=0, N_0=1,
mean_return_5=mean(return_5_fww,na.rm=TRUE),sd_5=sd(return_5_fww,na.rm=TRUE), N_5=sum(nad_return_5_fw),
mean_return_10=mean(return_10_fww,na.rm=TRUE),sd_10=sd(return_10_fww,na.rm=TRUE), N_10=sum(nad_return_10_fw),
mean_return_15=mean(return_15_fww,na.rm=TRUE),sd_15=sd(return_15_fww,na.rm=TRUE), N_15=sum(nad_return_15_fw),
mean_return_20=mean(return_20_fww,na.rm=TRUE),sd_20=sd(return_20_fww,na.rm=TRUE), N_20=sum(nad_return_20_fw),
mean_return_25=mean(return_25_fww,na.rm=TRUE),sd_25=sd(return_25_fww,na.rm=TRUE), N_25=sum(nad_return_25_fw),
mean_return_30=mean(return_30_fww,na.rm=TRUE),sd_30=sd(return_30_fww,na.rm=TRUE), N_30=sum(nad_return_30_fw),
mean_return_35=mean(return_35_fww,na.rm=TRUE),sd_35=sd(return_35_fww,na.rm=TRUE), N_35=sum(nad_return_35_fw),
mean_return_40=mean(return_40_fww,na.rm=TRUE),sd_40=sd(return_40_fww,na.rm=TRUE), N_40=sum(nad_return_40_fw),
mean_return_45=mean(return_45_fww,na.rm=TRUE),sd_45=sd(return_45_fww,na.rm=TRUE), N_45=sum(nad_return_45_fw),
mean_return_50=mean(return_50_fww,na.rm=TRUE),sd_50=sd(return_50_fww,na.rm=TRUE), N_50=sum(nad_return_50_fw),
mean_return_55=mean(return_55_fww,na.rm=TRUE),sd_55=sd(return_55_fww,na.rm=TRUE), N_55=sum(nad_return_55_fw),
mean_return_60=mean(return_60_fww,na.rm=TRUE),sd_60=sd(return_60_fww,na.rm=TRUE), N_60=sum(nad_return_60_fw),
mean_return_65=mean(return_65_fww,na.rm=TRUE),sd_65=sd(return_65_fww,na.rm=TRUE), N_65=sum(nad_return_65_fw),
mean_return_70=mean(return_70_fww,na.rm=TRUE),sd_70=sd(return_70_fww,na.rm=TRUE), N_70=sum(nad_return_70_fw),
mean_return_75=mean(return_75_fww,na.rm=TRUE),sd_75=sd(return_75_fww,na.rm=TRUE), N_75=sum(nad_return_75_fw),
mean_return_80=mean(return_80_fww,na.rm=TRUE),sd_80=sd(return_80_fww,na.rm=TRUE), N_80=sum(nad_return_80_fw),
mean_return_85=mean(return_85_fww,na.rm=TRUE),sd_85=sd(return_85_fww,na.rm=TRUE), N_85=sum(nad_return_85_fw),
mean_return_90=mean(return_90_fww,na.rm=TRUE),sd_90=sd(return_90_fww,na.rm=TRUE), N_90=sum(nad_return_90_fw),
mean_return_95=mean(return_95_fww,na.rm=TRUE),sd_95=sd(return_95_fww,na.rm=TRUE), N_95=sum(nad_return_95_fw),
mean_return_100=mean(return_100_fww,na.rm=TRUE),sd_100=sd(return_100_fww,na.rm=TRUE), N_100=sum(nad_return_100_fw),
mean_return_105=mean(return_105_fww,na.rm=TRUE),sd_105=sd(return_105_fww,na.rm=TRUE), N_105=sum(nad_return_105_fw),
mean_return_110=mean(return_110_fww,na.rm=TRUE),sd_110=sd(return_110_fww,na.rm=TRUE), N_110=sum(nad_return_110_fw),
mean_return_115=mean(return_115_fww,na.rm=TRUE),sd_115=sd(return_115_fww,na.rm=TRUE), N_115=sum(nad_return_115_fw),
mean_return_120=mean(return_120_fww,na.rm=TRUE),sd_120=sd(return_120_fww,na.rm=TRUE), N_120=sum(nad_return_120_fw),
mean_return_125=mean(return_125_fww,na.rm=TRUE),sd_125=sd(return_125_fww,na.rm=TRUE), N_125=sum(nad_return_125_fw),
mean_return_130=mean(return_130_fww,na.rm=TRUE),sd_130=sd(return_130_fww,na.rm=TRUE), N_130=sum(nad_return_130_fw),
mean_return_135=mean(return_135_fww,na.rm=TRUE),sd_135=sd(return_135_fww,na.rm=TRUE), N_135=sum(nad_return_135_fw),
mean_return_140=mean(return_140_fww,na.rm=TRUE),sd_140=sd(return_140_fww,na.rm=TRUE), N_140=sum(nad_return_140_fw),
mean_return_145=mean(return_145_fww,na.rm=TRUE),sd_145=sd(return_145_fww,na.rm=TRUE), N_145=sum(nad_return_145_fw),
mean_return_150=mean(return_150_fww,na.rm=TRUE),sd_150=sd(return_150_fww,na.rm=TRUE), N_150=sum(nad_return_150_fw),
mean_return_155=mean(return_155_fww,na.rm=TRUE),sd_155=sd(return_155_fww,na.rm=TRUE), N_155=sum(nad_return_155_fw),
mean_return_160=mean(return_160_fww,na.rm=TRUE),sd_160=sd(return_160_fww,na.rm=TRUE), N_160=sum(nad_return_160_fw),
mean_return_165=mean(return_165_fww,na.rm=TRUE),sd_165=sd(return_165_fww,na.rm=TRUE), N_165=sum(nad_return_165_fw),
mean_return_170=mean(return_170_fww,na.rm=TRUE),sd_170=sd(return_170_fww,na.rm=TRUE), N_170=sum(nad_return_170_fw),
mean_return_175=mean(return_175_fww,na.rm=TRUE),sd_175=sd(return_175_fww,na.rm=TRUE), N_175=sum(nad_return_175_fw),
mean_return_180=mean(return_180_fww,na.rm=TRUE),sd_180=sd(return_180_fww,na.rm=TRUE), N_180=sum(nad_return_180_fw),
mean_return_185=mean(return_185_fww,na.rm=TRUE),sd_185=sd(return_185_fww,na.rm=TRUE), N_185=sum(nad_return_185_fw),
mean_return_190=mean(return_190_fww,na.rm=TRUE),sd_190=sd(return_190_fww,na.rm=TRUE), N_190=sum(nad_return_190_fw),
mean_return_195=mean(return_195_fww,na.rm=TRUE),sd_195=sd(return_195_fww,na.rm=TRUE), N_195=sum(nad_return_195_fw),
mean_return_200=mean(return_200_fww,na.rm=TRUE),sd_200=sd(return_200_fww,na.rm=TRUE), N_200=sum(nad_return_200_fw),
mean_return_205=mean(return_205_fww,na.rm=TRUE),sd_205=sd(return_205_fww,na.rm=TRUE), N_205=sum(nad_return_205_fw),
mean_return_210=mean(return_210_fww,na.rm=TRUE),sd_210=sd(return_210_fww,na.rm=TRUE), N_210=sum(nad_return_210_fw),
mean_return_215=mean(return_215_fww,na.rm=TRUE),sd_215=sd(return_215_fww,na.rm=TRUE), N_215=sum(nad_return_215_fw),
mean_return_220=mean(return_220_fww,na.rm=TRUE),sd_220=sd(return_220_fww,na.rm=TRUE), N_220=sum(nad_return_220_fw),
mean_return_225=mean(return_225_fww,na.rm=TRUE),sd_225=sd(return_225_fww,na.rm=TRUE), N_225=sum(nad_return_225_fw),
mean_return_230=mean(return_230_fww,na.rm=TRUE),sd_230=sd(return_230_fww,na.rm=TRUE), N_230=sum(nad_return_230_fw),
mean_return_235=mean(return_235_fww,na.rm=TRUE),sd_235=sd(return_235_fww,na.rm=TRUE), N_235=sum(nad_return_235_fw),
mean_return_240=mean(return_240_fww,na.rm=TRUE),sd_240=sd(return_240_fww,na.rm=TRUE), N_240=sum(nad_return_240_fw),
mean_return_245=mean(return_245_fww,na.rm=TRUE),sd_245=sd(return_245_fww,na.rm=TRUE), N_245=sum(nad_return_245_fw),
mean_return_250=mean(return_250_fww,na.rm=TRUE),sd_250=sd(return_250_fww,na.rm=TRUE), N_250=sum(nad_return_250_fw)), by=category]

(1+1)
```

```{R}
check_for_run_fw_plot_a <- melt(ret_plot, id.vars="category")
check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a[grepl("sd",variable)]
setnames(check_for_run_fw_plot_a_1, "value", "sd")
#check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a_1[,.(sd=mean(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_1[,days:=rep(seq(0,250,5),each=3)]
check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a[grepl("mean",variable)]
setnames(check_for_run_fw_plot_a_2, "value", "mean")
#check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a_2[,.(mean=mean(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_2[,days:=rep(seq(0,250,5),each=3)]
check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a[grepl("N",variable)]
setnames(check_for_run_fw_plot_a_3, "value", "N")
#check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a_3[,.(N=min(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_3[,days:=rep(seq(0,250,5),each=3)]
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a_1, check_for_run_fw_plot_a_2, by=c("category","days"), all.x=TRUE)
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a, check_for_run_fw_plot_a_3, by=c("category","days"), all.x=TRUE)
check_for_run_fw_plot_a[,upper_ci:=mean+1.96*sd/sqrt(N)]
check_for_run_fw_plot_a[,lower_ci:=mean-1.96*sd/sqrt(N)]
#check_for_run_fw_plot_a[,Category:="Purchase - invested stock"]
#check_for_run_fw_plot_a[new_stock==1,Category:="New purchase"]
#check_for_run_fw_plot_a[order==2,Category:="New purchase - new industry"]
check_for_run_fw_plot_a$category <- factor(check_for_run_fw_plot_a$category, levels = c("Not Trade", "Top Up", "New Stock"))
#check_for_run_fw_plot[,type2:=paste(type,wp_group)]

# check_for_run_fw_plot$type2 <- factor(check_for_run_fw_plot$type2, levels = c("top up after positive rsp","top up after negative rsp", "new buy-invested industry after positive rsp", "new buy-invested industry after negative rsp", "new buy-new industry after positive rsp", "new buy-new industry after negative rsp"))

pd <- position_dodge(0.09) # move them .05 to the left and right



(g3.2 <- ggplot(check_for_run_fw_plot_a,aes(x=days,y=mean,color=category))+
       geom_ribbon(aes(ymin=lower_ci, ymax=upper_ci),alpha = .3, linetype=0) +
       geom_line(position=pd) +  xlab("Number of Working Days After the Purchase") + ylab("Adj Return") )


ggsave(g3.2, file="G:/rank/new_ind/codes/codes with more anon dataset/buy_info/adj_three_types_sample3.2.png",width = 8, height = 6)
```

```{r}

buys_info2[,N_stockdate:=.N,by=stock_date]
buys_info2[,N_anondate:=.N,by=anon_date]
#buys_info2 <- buys_info2[N_anondate>1]
buys_info2[,buy_stockdate:=sum(buy),by=stock_date]

nrow(buys_info2) # 3574529
nrow(buys_info2[N_anondate>1]) # 5202223
nrow(buys_info2[N_stockdate>1]) # 4920907
nrow(buys_info2[buy_stockdate>1]) # 1510648
nrow(buys_info2[buy_stockdate>1 & N_stockdate>1 &
                buy_stockdate<N_stockdate]) # 1508165
length(unique(buys_info2[buy_stockdate>1 & 
                           N_stockdate>1 &
                buy_stockdate<N_stockdate]$anon)) # 23316
length(unique(buys_info2[buy_stockdate>1 & 
                           N_stockdate>1 &
                buy_stockdate<N_stockdate]$sedol)) # 1138
buys_info2 <- buys_info2[buy_stockdate>1 & 
                           N_stockdate>1 &
                buy_stockdate<N_stockdate]


f1.6 <- feols(new_stock~1|stock_date,data=buys_info2)

# Adj. R2: 0.085927
# R2: 1-(1-0.085927)/((168991-1)/(168991-14446-1))= 0.1640659

f2.6 <- feols(topup~1|stock_date,data=buys_info2)

# Adj. R2: 0.064302
# R2: 1-(1-0.064302)/((168991 -1)/(168991 -14446-1))= 0.1442895

f3.6 <- feols(new_stock~1|stock_date,data=buys_info2[!(topup==1)])

# Adj. R2: 0.091466
# R2: 1-(1-0.091466)/((144288-1)/(144288-14446-1))= 0.1824283

f4.6 <- feols(topup~1|stock_date,data=buys_info2[!(new_stock==1)])
# Adj. R2: 0.069514
# R2: 1-(1-0.069514)/((147842 -1)/(147842-14446-1))= 0.1604347

```


```{r}

buys_info2 <- check_for_run[,CJ(sedol=unique(sedol), date_formated=unique(date_formated)),
                                  by=.(anon)][order(anon, date_formated, sedol),]
buys <-  transaction_buy_run_sub[,.(anon, date_formated, sedol, new_stock)]
buys[,buy:=1]
buys_info2 <- merge(buys_info2, buys, by=c("anon","date_formated","sedol"), all.x=TRUE)
buys_info2 <- buys_info2[order(anon, date_formated, sedol)]
buys_info2[,topup:=0]
buys_info2[is.na(new_stock), new_stock:=0]
buys_info2[new_stock==0&buy==1,topup:=1]
buys_info2[,stock_date:=paste0(sedol, date_formated)]

# library(fixest)

f1 <- feols(new_stock~1|stock_date,data=buys_info2)

# Adj. R2: -0.024008
# R2: 1-(1-Adj. R2)/((771305 -1)/(771305 - 379946-1))= 0.4804205

f2 <- feols(topup~1|stock_date,data=buys_info2)

# Adj. R2: -0.113327
# R2: 1-(1-Adj. R2)/((771305 -1)/(771305 - 379946-1))= 0.4351003

f3 <- feols(new_stock~1|stock_date,data=buys_info2[!(topup==1)])

# Adj. R2: -0.012899
# R2: 1-(1-Adj. R2)/((721467-1)/(721467-370260-1))= 0.5069259

f4 <- feols(topup~1|stock_date,data=buys_info2[!(new_stock==1)])

# Adj. R2: -0.092278
# R2: 1-(1-Adj. R2)/((718018-1)/(718018-366417-1))= 0.4651311

```


```{r}
check_for_run2 <- check_for_run[,.(new_stock2=mean(new_stock), 
                                   new_sic_2digits2=mean(new_sic_2digits), 
                                   new_sic_industry2=mean(new_sic_industry),
                                   new_icb_industry2=mean(new_icb_industry),
                                   new_icb_supersector2=mean(new_icb_supersector),
                                   no.in.portfolio=mean(no.in.portfolio),
                                   winning_prop=mean(winning_prop),
                                   initial_portfolio_value=mean(initial_portfolio_value_2),
                                   portfolio_value=mean(portfolio_value),
                                   rsp_portf_size=mean(rsp_portf_size),
                                   winning1day_prop=mean(winning1day_prop),
                                   ntrades_freq=mean(ntrades_freq),
                                   median_house_price=mean(median_house_price),
                                   median_weeklypay=mean(median_weeklypay),
                                   age=mean(age),
                                   log_ntrades_freq=mean(log_ntrades_freq),
                                   cum_new_buy=mean(cum_new_buy),
                                   sum_new_stock_cost=sum(new_stock_cost),
                                   sum_old_stock_cost=sum(old_stock_cost),
                                   postcode=.SD[1,postcode]),
                                   by=c("anon","date_formated")]

setnames(selldayamount,"port_date","date_formated")
check_for_run2 <- merge(check_for_run2, selldayamount, by=c("anon","date_formated"), all.x=TRUE)
check_for_run3 <- check_for_run2[is.na(sum_sell_pounds)]
check_for_run3[,dep_var_1:=sum_new_stock_cost/(portfolio_value+sum_new_stock_cost+sum_old_stock_cost)]
check_for_run3[,dep_var_2:=sum_new_stock_cost/(sum_new_stock_cost+sum_old_stock_cost)]
check_for_run2[is.na(sum_sell_pounds),sum_sell_pounds:=0]
check_for_run2[,dep_var_1:=sum_new_stock_cost/(portfolio_value+sum_new_stock_cost+sum_sell_pounds+sum_old_stock_cost)]
check_for_run2[,dep_var_2:=sum_new_stock_cost/(sum_new_stock_cost+sum_sell_pounds+sum_old_stock_cost)]
r0.11 <- felm(dep_var_1~ postcode + winning_prop+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender |date_formated   |0|anon,data =check_for_run3)
r0.12 <- felm(dep_var_1~ postcode + winning_prop+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender |date_formated   |0|date_formated,data =check_for_run3)
r0.13 <- felm(dep_var_2~ postcode + winning_prop+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender |date_formated   |0|anon,data =check_for_run3)
r0.14 <- felm(dep_var_2~ postcode + winning_prop+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender |date_formated   |0|date_formated,data =check_for_run3)

r0.21 <- felm(dep_var_1~ postcode + winning_prop+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender |date_formated   |0|anon,data =check_for_run2)
r0.22 <- felm(dep_var_1~ postcode + winning_prop+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender |date_formated   |0|date_formated,data =check_for_run2)
r0.23 <- felm(dep_var_2~ postcode + winning_prop+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender |date_formated   |0|anon,data =check_for_run2[dep_var_2>=0])
r0.24 <- felm(dep_var_2~ postcode + winning_prop+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender |date_formated   |0|date_formated,data =check_for_run2[dep_var_2>=0])
check_for_run2[,new_stock:=ifelse(new_stock2>0,1,0)]
check_for_run2[,new_sic_2digits:=ifelse(new_sic_2digits2>0,1,0)]
check_for_run2[,new_sic_industry:=ifelse(new_sic_industry2>0,1,0)]
check_for_run2[,new_icb_industry:=ifelse(new_icb_industry2>0,1,0)]
check_for_run2[,new_icb_supersector:=ifelse(new_icb_supersector2>0,1,0)]
check_for_run2[,log_age:=log(age)]
check_for_run2[,log_initial_value:=log(initial_portfolio_value)]
check_for_run2[,log_portfolio_value:=log(portfolio_value)]
check_for_run2[,log_median_house_price:=log(median_house_price)]
check_for_run2[,log_median_weeklypay:=log(median_weeklypay)]
check_for_run2[,log_age_win:=Winsorize(log_age,probs = c(0.01,0.99))]
check_for_run2[,log_initial_value_win:=Winsorize(log_initial_value,probs = c(0.01,0.99))]
check_for_run2[,log_portfolio_value_win:=Winsorize(log_portfolio_value,probs = c(0.01,0.99))]
check_for_run2[,log_median_house_price_win:=Winsorize(log_median_house_price,probs = c(0.01,0.99))]
check_for_run2[,log_median_weeklypay_win:=Winsorize(log_median_weeklypay,probs = c(0.01,0.99))]
check_for_run2[,log_ntrades_freq_win:=Winsorize(log_ntrades_freq,probs = c(0.01,0.99))]
check_for_run2[,rsp_portf_size_win:=Winsorize(rsp_portf_size,probs = c(0.01,0.99))]
check_for_run2[,cum_new_buy_win:=Winsorize(cum_new_buy,probs = c(0.01,0.99))]
anon_gender <- anon[,.(anon,gender)]
check_for_run2 <- merge(check_for_run2, anon_gender, by="anon", all.x=TRUE)
check_for_run2[,anon_date:=paste0(anon,date_formated)]
check_for_run2[, order_buy:=new_stock]
check_for_run2[new_sic_2digits==1, order_buy:=2]
check_for_run2[,order_buy:=as.factor(order_buy)]

check_for_run2[order_buy==2, order_buy:=3]
check_for_run2[order_buy==1, order_buy:=2]
check_for_run2[order_buy==0, order_buy:=1]
fwrite(check_for_run2, file="G:/rank/new_ind/codes/codes with more anon dataset/order_2digits_buy_stata.csv")
check_for_run2[, order_buy:=new_stock]
check_for_run2[new_sic_industry==1, order_buy:=2]
check_for_run2[,order_buy:=as.factor(order_buy)]
check_for_run2[order_buy==2, order_buy:=3]
check_for_run2[order_buy==1, order_buy:=2]
check_for_run2[order_buy==0, order_buy:=1]
fwrite(check_for_run2, file="G:/rank/new_ind/codes/codes with more anon dataset/order_industry_buy_stata.csv")
check_for_run2[, order_buy:=new_stock]
check_for_run2[new_icb_industry==1, order_buy:=2]
check_for_run2[,order_buy:=as.factor(order_buy)]
check_for_run2[order_buy==2, order_buy:=3]
check_for_run2[order_buy==1, order_buy:=2]
check_for_run2[order_buy==0, order_buy:=1]
fwrite(check_for_run2, file="G:/rank/new_ind/codes/codes with more anon dataset/order_icb_ind_buy_stata.csv")
check_for_run2[, order_buy:=new_stock]
check_for_run2[new_icb_supersector==1, order_buy:=2]
check_for_run2[,order_buy:=as.factor(order_buy)]
check_for_run2[order_buy==2, order_buy:=3]
check_for_run2[order_buy==1, order_buy:=2]
check_for_run2[order_buy==0, order_buy:=1]
fwrite(check_for_run2, file="G:/rank/new_ind/codes/codes with more anon dataset/order_icb_sec_buy_stata.csv")
```

```{R}

check_for_run[,anon_date:=paste0(anon, date_formated)]



check_for_run[,winning_prop_group:=cut(winning_prop,breaks = seq(0,1,0.1),include.lowest = TRUE)]

check_for_run_plot <- check_for_run[,.(mean_new_stock=mean(new_stock),N=.N,sd=sd(new_stock)),by=c("no.in.portfolio.group","winning_prop_group")]
check_for_run_plot[,upper_ci:=mean_new_stock+1.96*sd/sqrt(N)]
check_for_run_plot[,lower_ci:=mean_new_stock-1.96*sd/sqrt(N)]
check_plot_median <- data.table(x=seq(0.05,0.95,0.1))
check_plot_median[,winning_prop_group:=cut(x,breaks = seq(0,1,0.1),include.lowest = TRUE)]
check_for_run_plot <- merge(check_for_run_plot, check_plot_median, by="winning_prop_group", all.x=TRUE)

interval <- quantile(check_for_run$gain_size,c(0.01,0.99))
a <- interval[1]
b <- interval[2]

pd <- position_dodge(0.03) # move them .05 to the left and right

(g3 <- ggplot(check_for_run_plot,aes(x=x,y=mean_new_stock,color=no.in.portfolio.group))+
       geom_errorbar(aes(ymin=lower_ci, ymax=upper_ci), width=.05, position=pd) +
       geom_line(position=pd) +
       geom_point(position=pd) + xlab("Winning Proportion") + ylab("Conditional probability of purchasing a new stock") + labs(color='Number of holdings') )



ggsave(g3, file="G:/rank/new_ind/codes/codes with more anon dataset/rspdescriptive_all.png",width = 7.29, height = 4.5)


check_for_run[,rsp_group:=cut(rsp,breaks = seq(0,1,0.1),include.lowest = TRUE)]

check_for_run_plot <- check_for_run[,.(mean_new_stock=mean(new_stock),N=.N,sd=sd(new_stock)),by=c("no.in.portfolio.group","winning_prop_group")]
check_for_run_plot[,upper_ci:=mean_new_stock+1.96*sd/sqrt(N)]
check_for_run_plot[,lower_ci:=mean_new_stock-1.96*sd/sqrt(N)]
check_plot_median <- data.table(x=seq(0.05,0.95,0.1))
check_plot_median[,winning_prop_group:=cut(x,breaks = seq(0,1,0.1),include.lowest = TRUE)]
check_for_run_plot <- merge(check_for_run_plot, check_plot_median, by="winning_prop_group", all.x=TRUE)

interval <- quantile(check_for_run$gain_size,c(0.01,0.99))
a <- interval[1]
b <- interval[2]

pd <- position_dodge(0.03) # move them .05 to the left and right

(g3 <- ggplot(check_for_run_plot,aes(x=x,y=mean_new_stock,color=no.in.portfolio.group))+
       geom_errorbar(aes(ymin=lower_ci, ymax=upper_ci), width=.05, position=pd) +
       geom_line(position=pd) +
       geom_point(position=pd) + xlab("Winning Proportion") + ylab("Probability of buying a new stock") )

(g3 <- ggplot(check_for_run,aes(x=rsp_portf_size_2_win,y=new_stock,color=no.in.portfolio.group)) + geom_smooth() +  ylab("Probability of buying a new stock \n(Adjusted by account, sedol, dateFEs)") )
#r4 <- felm(new_ind_adj~gain_size|0|0|anon+date_formated,data =check_for_run)



check_for_run[,order_buy:=new_stock]
check_for_run[new_icb_industry==1,order_buy:=2]
check_for_run[,order_buy:=as.factor(order_buy)]
check_for_run_plot_2 <- check_for_run[,.(N=.N),by=order_buy]
check_for_run_plot_2[,N_all:=sum(N)]
check_for_run_plot_2[,proportion:=N/N_all]
check_for_run_plot_2[,type:="Only invested stocks"]
check_for_run_plot_2[order_buy=="1",type:="New purchases in invested industries"]
check_for_run_plot_2[order_buy=="2",type:="New purchases in new industries"]
check_for_run_plot_2[,type:=factor(type, levels=c("Only invested stocks", "New purchases in invested industries", "New purchases in new industries"))]
check_for_run_plot_2[,classification:="ICB-10"]

check_for_run[,order_buy:=new_stock]
check_for_run[new_icb_supersector==1,order_buy:=2]
check_for_run[,order_buy:=as.factor(order_buy)]
check_for_run_plot_3 <- check_for_run[,.(N=.N),by=order_buy]
check_for_run_plot_3[,N_all:=sum(N)]
check_for_run_plot_3[,proportion:=N/N_all]
check_for_run_plot_3[,type:="Only invested stocks"]
check_for_run_plot_3[order_buy=="1",type:="New purchases in invested industries"]
check_for_run_plot_3[order_buy=="2",type:="New purchases in new industries"]
check_for_run_plot_3[,type:=factor(type, levels=c("Only invested stocks", "New purchases in invested industries", "New purchases in new industries"))]
check_for_run_plot_3[,classification:="ICB-19"]
check_for_run_plot_2 <- rbind(check_for_run_plot_2, check_for_run_plot_3)


(g4 <- ggplot(check_for_run_plot_2,aes(x=type,y=proportion,fill=classification))+
       #geom_errorbar(aes(ymin=lower_ci, ymax=upper_ci), width=.05, position=pd) +
       geom_bar(stat="identity", position=position_dodge()) + xlab("Types of Purchases") + ylab("Proportion of Each Type of Purchases") )

ggsave(g4, file="G:/rank/new_ind/codes/codes with more anon dataset/three_types_icb10.png",width = 8, height = 4.5)

feologit <- copy(check_for_run_plot_2)
feologit[,return:=rep("WinProp",6)]
feologit[,c("N", "N_all", "proportion"):=NULL]
feologit[,value:=c(0.103,-0.132,0.028,0.120,-0.137,0.017)]
feologit[,group:=paste(classification, return)]
feologit[,classification:=factor(classification, levels = c("ICB-10","ICB-19" ))]
feologit[,label:=paste0(value,"***")]

(g5 <- ggplot(feologit,aes(x=type,y=value))+
       #geom_errorbar(aes(ymin=lower_ci, ymax=upper_ci), width=.05, position=pd) +
       geom_bar(stat="identity", position=position_dodge()) + xlab("Types of Purchase Days") + ylab("Coefficients from Marginal Effects")+ geom_text(aes(y = value + .02 * sign(value), label = label), size = 7, colour = "black") + facet_grid(.~classification)+theme(text = element_text(size=20), axis.text.x = element_text(angle = 20))) 
ggsave(g5, file="G:/rank/new_ind/codes/codes with more anon dataset/feologit_marginal.png",width = 20, height = 10)
   
#   + scale_x_discrete(guide = guide_axis(n.dodge = 2))

```

```{r}
#check_for_run[,winning_prop:=Winsorize(gain_size, probs = c(0.01,0.99))]
check_for_run[,rsp_portf_size_win:=Winsorize(rsp_portf_size, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run[,rsp_portf_size_2_win:=Winsorize(rsp_portf_size_2, probs = c(0.01,0.99),na.rm=TRUE)]

check_for_run[,portf_return_1week_weight_win:=Winsorize(portf_return_1week_weight, probs = c(0.01,0.99),na.rm = TRUE)]
check_for_run[,portf_return_2week_weight_win:=Winsorize(portf_return_2week_weight, probs = c(0.01,0.99),na.rm = TRUE)]
check_for_run[,portf_return_3week_weight_win:=Winsorize(portf_return_3week_weight, probs = c(0.01,0.99),na.rm = TRUE)]
check_for_run[,portf_return_1month_weight_win:=Winsorize(portf_return_1month_weight, probs = c(0.01,0.99),na.rm = TRUE)]
check_for_run[,portf_return_1day_weight_win:=Winsorize(portf_return_1day_weight, probs = c(0.01,0.99),na.rm = TRUE)]  
check_for_run[,portf_return_3day_weight_win:=Winsorize(portf_return_3day_weight, probs = c(0.01,0.99),na.rm = TRUE)] 
check_for_run[,portf_return_2_4days_weight_win:=Winsorize(portf_return_2_4days_weight, probs = c(0.01,0.99),na.rm = TRUE)] 
check_for_run[,portf_return_4_6days_weight_win:=Winsorize(portf_return_4_6days_weight, probs = c(0.01,0.99),na.rm = TRUE)]
check_for_run[,portf_return_6_11days_weight_win:=Winsorize(portf_return_6_11days_weight, probs = c(0.01,0.99),na.rm = TRUE)]
check_for_run[,portf_return_11_16days_weight_win:=Winsorize(portf_return_11_16days_weight, probs = c(0.01,0.99),na.rm = TRUE)]
check_for_run[,portf_return_16_21days_weight_win:=Winsorize(portf_return_16_21days_weight, probs = c(0.01,0.99),na.rm = TRUE)]
check_for_run[,log_age:=log(age)]
check_for_run[,log_initial_value:=log(initial_portfolio_value_2)]
check_for_run[,log_portfolio_value:=log(portfolio_value)]
check_for_run[,ntrades2:=min(ntrades),by=c("anon","date_formated")]
check_for_run[,length_account:=as.numeric(date_formated-open_date)]
check_for_run[,ntrades_freq:=((ntrades2-1)/length_account)*30]
check_for_run[,log_median_house_price:=log(median_house_price)]
check_for_run[,log_median_weeklypay:=log(median_weeklypay)]
check_for_run[,log_age_win:=Winsorize(log_age,probs = c(0.01,0.99))]
check_for_run[,log_initial_value_win:=Winsorize(log_initial_value,probs = c(0.01,0.99))]
check_for_run[,log_portfolio_value_win:=Winsorize(log_portfolio_value,probs = c(0.01,0.99))]
check_for_run[,log_ntrades_freq_win:=Winsorize(log_ntrades_freq,probs = c(0.01,0.99))]
check_for_run[,log_median_house_price_win:=Winsorize(log_median_house_price,probs = c(0.01,0.99))]
check_for_run[,log_median_weeklypay_win:=Winsorize(log_median_weeklypay,probs = c(0.01,0.99))]
check_for_run[,port_value_change_last_buy_prop:=port_value_change_last_buy/portfolio_value]
check_for_run[,port_value_change_last_buy_prop_win:=Winsorize(port_value_change_last_buy_prop,probs = c(0.01,0.99))]
check_for_run[,cum_new_buy_win:=Winsorize(cum_new_buy,probs = c(0.01,0.99))]
check_for_run[,anon_date:=paste0(anon, date_formated)]




smry <- check_for_run[,.(new_stock, winning_prop, rsp_portf_size_win, portf_return_1week_weight_win, portf_return_2week_weight_win, portf_return_3week_weight_win, portf_return_1month_weight_win, no.in.portfolio.group, log_age_win, log_initial_value_win, log_portfolio_value_win, log_ntrades_freq_win, log_median_house_price_win, log_median_weeklypay_win, no.in.portfolio,cum_new_buy_win)]
 stargazer(smry, summary.stat=c("n","mean","sd","min","p25","median","p75","max"),type="latex")
 
smry2.1 <- check_for_run[,.(num.buys=.N,new_prop=mean(new_stock),log_age=mean(log_age_win),log_initial_value=mean(log_initial_value_win), log_ntrades_freq = mean(log_ntrades_freq_win), log_median_house_price=mean(log_median_house_price_win), log_median_weeklypay=mean(log_median_weeklypay_win)),by=anon]
smry2.2 <- check_for_run[,.SD[1],by=anon]
smry2.2 <- smry2.2[,.(anon,gender)]
smry2.3 <- check_for_run2[,.N,by=anon]
setnames(smry2.3,"N","N_buyday")
smry2.1 <- merge(smry2.1, smry2.2, by="anon", all.x=TRUE)
smry2.1 <- merge(smry2.1, smry2.3, by="anon", all.x=TRUE)
smry2.1[,age:=exp(log_age)]
smry2.1[,initial_value:=exp(log_initial_value)]
smry2.1[,ntrades_freq:=exp(log_ntrades_freq)]
smry2.1[,median_house_price:=exp(log_median_house_price)]
smry2.1[,median_weeklypay:=exp(log_median_weeklypay)]

smry <- smry2.1[,.(age, log_initial_value, log_ntrades_freq, log_median_house_price, log_median_weeklypay, N_buyday)]

stargazer(smry, summary.stat=c("n","mean","sd","min","p25","median","p75","max"),type="latex")

load("G:/rank/raw_data_not_confidential/calculating return sd/price_info_with_sd.RData") # from G:\rank\raw_data_not_confidential\calculating return sd
head(price)
price2 <- price[,.(sedol, date_formated, return_1day, return_1week, return_1month, sd_1day, sd_1week)]
#price2 <- price[,.(sedol, date_formated, return_1day, return_1week)]
check_for_run_test <- merge(check_for_run,price2,by=c("sedol","date_formated"))
check_for_run_test[, return_1day_win:=Winsorize(return_1day, probs = c(0.01,0.99),na.rm = TRUE)]
check_for_run_test[, return_1week_win:=Winsorize(return_1week, probs = c(0.01,0.99),na.rm = TRUE)]
#check_for_run_test[, return_1month_win:=Winsorize(return_1month, probs = c(0.01,0.99),na.rm = TRUE)]
check_for_run_test[, sd_1day_win:=Winsorize(sd_1day, probs = c(0.01,0.99),na.rm = TRUE)]


load("G:/rank/raw_data_not_confidential/calculating return sd/price_info_with_sd2.RData") # from G:\rank\raw_data_not_confidential\calculating return sd
head(price)
price2 <- price[,.(sedol, date_formated,  return_1month, return_3month, return_6month, sd_1month, sd_3month, sd_6month)]
#price2 <- price[,.(sedol, date_formated, return_1day, return_1week)]
check_for_run_test <- merge(check_for_run,price2,by=c("sedol","date_formated"))
check_for_run_test[, return_1month_win:=Winsorize(return_1month, probs = c(0.01,0.99),na.rm = TRUE)]
check_for_run_test[, return_3month_win:=Winsorize(return_3month, probs = c(0.01,0.99),na.rm = TRUE)]
check_for_run_test[, return_6month_win:=Winsorize(return_6month, probs = c(0.01,0.99),na.rm = TRUE)]
check_for_run_test[, sd_1month_win:=Winsorize(sd_1month, probs = c(0.01,0.99),na.rm = TRUE)]
check_for_run_test[, sd_3month_win:=Winsorize(sd_3month, probs = c(0.01,0.99),na.rm = TRUE)]
check_for_run_test[, sd_6month_win:=Winsorize(sd_6month, probs = c(0.01,0.99),na.rm = TRUE)]
#check_for_run_test[, return_1month_win:=Winsorize(return_1month, probs = c(0.01,0.99),na.rm = TRUE)]
#check_for_run_test[, sd_1day_win:=Winsorize(sd_1day, probs = c(0.01,0.99),na.rm = TRUE)]

r1.1 <- felm(new_stock~ winning_prop  |0|0|anon_date,data =check_for_run)
r1.2 <- felm(new_stock~ winning_prop + no.in.portfolio + cum_new_buy_win + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode |0|0|anon_date,data =check_for_run)
r1.3 <- felm(new_stock~ winning_prop + no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode |sedol |0|anon_date,data =check_for_run)
r1.4 <- felm(new_stock~ winning_prop + no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender  + postcode |date_formated |0|anon_date,data =check_for_run)
r1.5 <- felm(new_stock~ postcode + winning_prop+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender |sedol+date_formated   |0|anon_date,data =check_for_run)


r1.5.1 <- felm(new_stock~ postcode + winning_prop+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + return_1month_win |sedol+date_formated   |0|anon_date,data =check_for_run_test)
r1.5.2 <- felm(new_stock~ postcode + winning_prop+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + return_3month_win |sedol+date_formated   |0|anon_date,data =check_for_run_test)
r1.5.3 <- felm(new_stock~ postcode + winning_prop+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + return_6month_win |sedol+date_formated   |0|anon_date,data =check_for_run_test)
r1.5.4 <- felm(new_stock~ postcode + winning_prop+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + sd_1month_win |sedol+date_formated   |0|anon_date,data =check_for_run_test)
r1.5.5 <- felm(new_stock~ postcode + winning_prop+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + sd_3month_win |sedol+date_formated   |0|anon_date,data =check_for_run_test)
r1.5.6 <- felm(new_stock~ postcode + winning_prop+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender +  sd_6month_win |sedol+date_formated   |0|anon_date,data =check_for_run_test)

r1.5.7 <- felm(new_stock~ postcode + winning_prop+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + return_6month_win + sd_6month_win |sedol+date_formated   |0|anon_date,data =check_for_run_test)
r1.5.8 <- felm(new_stock~ postcode + winning_prop+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + return_3month_win + sd_3month_win |sedol+date_formated   |0|anon_date,data =check_for_run_test)
r1.5.9 <- felm(new_stock~ postcode + winning_prop+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + return_1month_win + sd_1month_win |sedol+date_formated   |0|anon_date,data =check_for_run_test)

r1.6 <- felm(new_stock~ winning_prop *no.in.portfolio.group |0|0|anon_date,data =check_for_run)
r1.7 <- felm(new_stock~ winning_prop *no.in.portfolio.group + cum_new_buy_win + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender  + postcode  |0 |0|anon_date,data =check_for_run)
r1.8 <- felm(new_stock~ winning_prop *no.in.portfolio.group + cum_new_buy_win + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender  + postcode |sedol |0|anon_date,data =check_for_run)
r1.9 <- felm(new_stock~ winning_prop *no.in.portfolio.group + cum_new_buy_win + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender  + postcode |date_formated |0|anon_date,data =check_for_run)
r1.10 <- felm(new_stock~  postcode+ winning_prop *no.in.portfolio.group + cum_new_buy_win + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender  |sedol+date_formated   |0|anon_date,data =check_for_run)

r1.10 <- felm(new_stock~  postcode+ winning_prop *no.in.portfolio.group + cum_new_buy_win + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + return_1week_win + sd_1day_win |sedol+date_formated   |0|anon_date,data =check_for_run_test)

stargazer(r1.1,r1.2,r1.3,r1.4,r1.5, type="html",  omit="postcode",   dep.var.labels=c("A New Stock"), star.cutoffs = c(0.05, 0.01, 0.005),out="check.tex")

stargazer(r1.5.1,r1.5.2,r1.5.3,r1.5.4,r1.5.5, r1.5.6, type="html",  omit="postcode",   dep.var.labels=c("A New Stock"), star.cutoffs = c(0.05, 0.01, 0.005),out="check.htm")

stargazer(r1.5.7,r1.5.8, r1.5.9, type="latex",  omit="postcode",   dep.var.labels=c("A New Stock"), star.cutoffs = c(0.05, 0.01, 0.005))

stargazer(r1.6,r1.7,r1.8,r1.9,r1.10, type="latex",  omit="postcode",   dep.var.labels=c("A New Stock"), star.cutoffs = c(0.05, 0.01, 0.005),out="check.tex")


r1.11 <- felm(new_stock~  winning_prop+ no.in.portfolio + cum_new_buy |anon+sedol+date_formated   |0|anon_date,data =check_for_run)

r1.12 <- felm(new_stock~ winning_prop *no.in.portfolio.group + cum_new_buy  |anon+sedol+date_formated   |0|anon_date,data =check_for_run)

stargazer(r1.11, r1.12, type="latex",  omit="postcode",   dep.var.labels=c("A New Stock"), star.cutoffs = c(0.05, 0.01, 0.005),out="check.tex")
```

```{r}
check <- check_for_run[,.N,by=c("anon","date_formated")]
check2 <- check[,.N,by=anon]
check_for_run <- merge(check_for_run, check2, by="anon", all.x=TRUE)
r1.10 <- felm(new_stock~    winning_prop *no.in.portfolio.group + cum_new_buy_win+ log_portfolio_value_win  |anon+sedol+date_formated   |0|anon_date,data =check_for_run[N>=5])

```




```{r}
check_for_run <- merge(check_for_run, all_dates, by="date_formated", all.x=TRUE)
check_for_run[,date_index_lag_1:=date_index-1]
setnames(account_date_change,"port_date","date_formated")
account_date_change <- merge(account_date_change, all_dates, by="date_formated", all.x=TRUE)
setnames(account_date_change,"date_index","date_index_lag_1")
account_date_change[,date_formated:=NULL]
check_for_run <- merge( check_for_run, account_date_change, by=c("anon","date_index_lag_1"), all.x=TRUE)
nrow(check_for_run[!(is.na(sum_change))])
check_for_run[is.na(sum_change),sum_change:=0]
check_for_run[,portfolio_value_1:=portfolio_value-sum_change]

setnames(selldayamount,"port_date","date_formated")
selldayamount <- merge(selldayamount, all_dates, by="date_formated", all.x=TRUE)
selldayamount[,date_formated:=NULL]
check_for_run <- merge(check_for_run, selldayamount, by=c("anon","date_index"), all.x=TRUE)
selldayamount[,date_index:=date_index-1]
check_for_run <- merge(check_for_run, selldayamount, by=c("anon","date_index"), all.x=TRUE)
check_for_run[is.na(sum_sell_pounds.x),sum_sell_pounds.x:=0]
check_for_run[is.na(sum_sell_pounds.y),sum_sell_pounds.y:=0]
check_for_run[,sell_prop_united:=(sum_sell_pounds.x+sum_sell_pounds.y)/portfolio_value_1]
check_for_run3 <- check_for_run[!(is.na(sell_prop_united))]
check_for_run3[,sell_prop_united_win:=Winsorize(sell_prop_united,probs = c(0.01,0.99))]

r1.11 <- felm(new_stock~ postcode + winning_prop+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender +sell_prop_united_win|sedol+date_formated   |0|anon_date,data =check_for_run3)
```



```{r}

quant <- quantile(check_for_run$rsp_portf_size,seq(0,1,0.1))

check_for_run[,rspsize_group:=cut(rsp_portf_size,breaks = quant,include.lowest = TRUE)]
check_for_run[,rspsize_positive:=ifelse(rsp_portf_size_win>0,1,0)]
check_for_run[,rspsize_negative:=ifelse(rsp_portf_size_win<=0,1,0)]

                                         
r2.1 <- felm(new_stock~ rsp_portf_size_2_win  |0|0|anon_date,data =check_for_run)
r2.2 <- felm(new_stock~ rsp_portf_size_2_win + no.in.portfolio + cum_new_buy_win + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode |0|0|anon_date,data =check_for_run)
r2.3 <- felm(new_stock~ rsp_portf_size_2_win + no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode |sedol |0|anon_date,data =check_for_run)
r2.4 <- felm(new_stock~ rsp_portf_size_2_win + no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender  + postcode |date_formated |0|anon_date,data =check_for_run)
r2.5 <- felm(new_stock~ postcode + rsp_portf_size_2_win+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender |sedol+date_formated   |0|anon_date,data =check_for_run)



# r2.2 <- felm(new_stock~ portf_return_1day_weight_win + no.in.portfolio + cum_new_buy_win + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode |sedol+date_formated   |0|anon_date,data =check_for_run)
# r2.3 <- felm(new_stock~ portf_return_1week_weight_win + no.in.portfolio + cum_new_buy_win + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode |sedol+date_formated   |0|anon_date,data =check_for_run)
# r2.4 <- felm(new_stock~ portf_return_2week_weight_win + no.in.portfolio + cum_new_buy_win + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode |sedol+date_formated   |0|anon_date,data =check_for_run)
# r2.5 <- felm(new_stock~ portf_return_3week_weight_win + no.in.portfolio + cum_new_buy_win + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode |sedol+date_formated   |0|anon_date,data =check_for_run)
# r2.6 <- felm(new_stock~ portf_return_1month_weight_win + no.in.portfolio + cum_new_buy_win + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode |sedol+date_formated   |0|anon_date,data =check_for_run)




# r2.6 <- felm(new_stock~ rsp_portf_size_win *no.in.portfolio.group + cum_new_buy +  log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode |sedol+date_formated   |0|anon_date,data =check_for_run)
# r2.7 <- felm(new_stock~ portf_return_1day_weight_win *no.in.portfolio.group + cum_new_buy  + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode |sedol+date_formated   |0|anon_date,data =check_for_run)
# r2.8 <- felm(new_stock~ portf_return_3day_weight_win *no.in.portfolio.group + cum_new_buy  + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode|sedol+date_formated   |0|anon_date,data =check_for_run)
# r2.9 <- felm(new_stock~ portf_return_1week_weight_win *no.in.portfolio.group + cum_new_buy  + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode |sedol+date_formated   |0|anon_date,data =check_for_run)
# r2.10 <- felm(new_stock~ portf_return_2week_weight_win *no.in.portfolio.group + cum_new_buy + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode  |sedol+date_formated   |0|anon_date,data =check_for_run)


# r2.11 <- felm(new_stock~ winning_prop +rsp_portf_size_win +portf_return_1day_weight_win + portf_return_2_4days_weight_win + portf_return_4_6days_weight_win + portf_return_6_11days_weight_win + no.in.portfolio+ cum_new_buy  + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode  |sedol+date_formated   |0|anon_date,data =check_for_run)



stargazer(r2.1,r2.2,r2.3, r2.4, r2.5, type="latex",  omit="postcode",   dep.var.labels=c("Buy Is A New Stock"), star.cutoffs = c(0.05, 0.01, 0.005),out="check.tex")


stargazer(r2.6,r2.7,r2.8, r2.9, r2.10, type="latex",  omit="postcode",   dep.var.labels=c("A New Stock"), star.cutoffs = c(0.05, 0.01, 0.005),out="check.tex")

stargazer(r2.11, type="latex",  omit="postcode",   dep.var.labels=c("A New Stock"), star.cutoffs = c(0.05, 0.01, 0.005),out="check.tex")

# covariate.labels = c("D(gain)", "D(return decile 2)", "D(return decile 3)","D(return decile 4)","D(return decile 5)","D(return decile 6)","D(return decile 7)","D(return decile 8)","D(return decile 9)","D(return decile 10)","Number of holdings","Constant")




check_for_run[,late:=ifelse(id_anon>half.num.buys,1,0)]

r1 <- felm(new_stock~ rsp_portf_size_win  *late + no.in.portfolio  + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode  |sedol+date_formated   |0|anon_date,data =check_for_run[half.num.buys>=5])
stargazer(r1,   type="html", omit="postcode",   dep.var.labels=c("New Stock"),star.cutoffs = c(0.05, 0.01, 0.005),out="check.htm")


```


```{r}
load("G:/rank/new_ind/codes/codes with more anon dataset/last_sell_day.RData")
check_for_run_nas <- merge(check_for_run, last_sell_day, by=c("anon", "date_formated"), all.x=TRUE)  # not right after a sell day
check_for_run_nas <- merge(check_for_run_nas, all_dates, by="date_formated", all.x=TRUE)
setnames(all_dates,c("date_formated","date_index"),c("last_sell_day","last_date_index"))
check_for_run_nas <- merge(check_for_run_nas, all_dates, by="last_sell_day", all.x=TRUE)
check_for_run_nas[is.na(date_index), date_index:=0]
check_for_run_nas[is.na(last_date_index), last_date_index:=0]
check_for_run_nas <- check_for_run_nas[!(date_index==last_date_index+1)]

r1.5.3 <- felm(new_stock~ postcode + winning_prop+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender  |sedol+date_formated   |0|anon_date,data =check_for_run_nas)

check_for_run_nas_2 <- check_for_run_nas[!(date_index==last_date_index+2)]
r1.5.4 <- felm(new_stock~ postcode + winning_prop+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender  |sedol+date_formated   |0|anon_date,data =check_for_run_nas_2)

check_for_run_nas_3 <- check_for_run_nas_2[!(date_index==last_date_index+3)]
r1.5.5 <- felm(new_stock~ postcode + winning_prop+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender |sedol+date_formated   |0|anon_date,data =check_for_run_nas_3)

stargazer(r1.5.3, r1.5.4, r1.5.5, type="html",  omit="postcode",   dep.var.labels=c("A New Stock"), star.cutoffs = c(0.05, 0.01, 0.005),out="check.htm")

(1+1)
```



```{r}
check_for_run_buydayonly <- check_for_run[sellday==0]

r1.5.2 <- felm(new_stock~ postcode + winning_prop+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender |sedol+date_formated   |0|anon_date,data =check_for_run_buydayonly)

r1.6.2 <- felm(new_stock~ postcode + rsp_portf_size_win+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender  |sedol+date_formated   |0|anon_date,data =check_for_run_buydayonly)


load("G:/rank/new_ind/codes/codes with more anon dataset/disposition.RData")
quantile(disposition[!is.na(disp)]$disp,c(0,0.01,0.05,0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,0.95,0.99,1))
check_for_run_con <- merge(check_for_run, disposition, by="anon", all.x=TRUE)
check_for_run_con[, disposition:=ifelse(disp>0,1,0)]

r1.7.1 <- felm(new_stock~ postcode + winning_prop+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + disp |sedol+date_formated   |0|anon_date,data =check_for_run_con)
r1.7.2 <- felm(new_stock~ postcode + winning_prop+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + disposition |sedol+date_formated   |0|anon_date,data =check_for_run_con)

load("G:/rank/new_ind/codes/codes with more anon dataset/contrarian.RData")
quantile(contrarian[!(is.na(con_measure))]$con_measure,c(0,0.01,0.05,seq(0.1,0.9,0.1),0.95,0.99,1))
check_for_run_con <- merge(check_for_run_con, contrarian, by="anon", all.x=TRUE)
check_for_run_con[, con_measure_win:=Winsorize(con_measure, probs = c(0.01,0.99),na.rm = TRUE)]
check_for_run_con[, momentum:=ifelse(con_measure>0,1,0)]
check_for_run_con[is.na(momentum), momentum:=1]

r1.7.3 <- felm(new_stock~ postcode + winning_prop+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender +  con_measure_win |sedol+date_formated   |0|anon_date,data =check_for_run_con)

r1.7.4 <- felm(new_stock~ postcode + winning_prop+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender +  momentum |sedol+date_formated   |0|anon_date,data =check_for_run_con)

r1.7.5 <- felm(new_stock~ postcode + winning_prop+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + disp + con_measure_win |sedol+date_formated   |0|anon_date,data =check_for_run_con)

r1.7.6 <- felm(new_stock~ postcode + winning_prop+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + disposition + momentum |sedol+date_formated   |0|anon_date,data =check_for_run_con)

check_for_run_con <- merge(check_for_run, disposition, by="anon", all.x=TRUE)
check_for_run_con[, disposition:=ifelse(disp>0,1,0)]
load("G:/rank/new_ind/codes/codes with more anon dataset/contrarian_quarterlyport.RData")
quantile(contrarian[!(is.na(con_measure))]$con_measure,c(0,0.01,0.05,seq(0.1,0.9,0.1),0.95,0.99,1))
check_for_run_con <- merge(check_for_run_con, contrarian, by="anon", all.x=TRUE)
check_for_run_con[, con_measure_win:=Winsorize(con_measure, probs = c(0.01,0.99),na.rm = TRUE)]
check_for_run_con[, momentum:=ifelse(con_measure>0,1,0)]
check_for_run_con[is.na(momentum), momentum:=1]

r1.7.7 <- felm(new_stock~ postcode + winning_prop+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender +  con_measure_win |sedol+date_formated   |0|anon_date,data =check_for_run_con)

r1.7.8 <- felm(new_stock~ postcode + winning_prop+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender +  momentum |sedol+date_formated   |0|anon_date,data =check_for_run_con)

r1.7.9 <- felm(new_stock~ postcode + winning_prop+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + disp + con_measure_win |sedol+date_formated   |0|anon_date,data =check_for_run_con)

r1.7.10 <- felm(new_stock~ postcode + winning_prop+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + disposition + momentum |sedol+date_formated   |0|anon_date,data =check_for_run_con)

rdis2 <- felm(new_stock~ postcode + rsp_portf_size_win*disposition+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender  |sedol+date_formated   |0|anon_date,data =check_for_run_con)

stargazer(r1.7.1,r1.7.2,r1.7.3,r1.7.4,r1.7.5,r1.7.6,r1.7.7,r1.7.8,r1.7.9,r1.7.10, type="html",    star.cutoffs = c(0.05, 0.01, 0.005), omit = c("postcode"), out="check.htm")


r1.8.1 <- felm(new_stock~ postcode + winning_prop+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender  |sedol+date_formated   |0|anon_date,data =check_for_run[net.posit.port.pre1day==0])


stargazer( r1.7.9, r1.5.2, r1.8.1, type="latex",    star.cutoffs = c(0.05, 0.01, 0.005), omit = c("postcode"), out="check.tex")
(1+1)
```

```{r}

 # looking at topup vs same ind, and topup vs new ind (new industry category)
check_ind <- check_for_run[!(is.na(winning_prop)) & no.in.portfolio>=0 &  !(is.na(ICB_CODE))]

 # check_ind <- merge(check_ind, distance_buy, by=c("anon","sedol","date_formated"), all.x=TRUE)
 # check_ind[is.na(mean_distance),mean_distance:=1]

 # r3 <- felm(mean_distance ~ winning_prop*no.in.portfolio.group + log_age + log_initial_value + log_portfolio_value + gender + postcode|date_formated+sedol  |0|anon_date,data =check_ind[!(is.na(mean_distance))])

 # felogit <- feglm(new_stock~ winning_prop+no.in.portfolio |anon+date_formated , data =check_ind)


 # check_for_run_plot <- check_ind[,.(mean_new_stock=mean(mean_distance),N=.N,sd=mean(new_stock)),by=c("no.in.portfolio.group","winning_prop_group")]
 # check_for_run_plot[,upper_ci:=mean_new_stock+1.96*sd/sqrt(N)]
 # check_for_run_plot[,lower_ci:=mean_new_stock-1.96*sd/sqrt(N)]
 # check_plot_median <- data.table(x=seq(0.05,0.95,0.1))
 # check_plot_median[,winning_prop_group:=cut(x,breaks = seq(0,1,0.1),include.lowest = TRUE)]
 # check_for_run_plot <- merge(check_for_run_plot, check_plot_median, by="winning_prop_group", all.x=TRUE)

 # interval <- quantile(check_for_run$gain_size,c(0.01,0.99))
 # a <- interval[1]
 # b <- interval[2]

 # pd <- position_dodge(0.03) # move them .05 to the left and right

 # (g3 <- ggplot(check_for_run_plot,aes(x=x,y=mean_new_stock,color=no.in.portfolio.group))+
 #        geom_errorbar(aes(ymin=lower_ci, ymax=upper_ci), width=.05, position=pd) +
 #        geom_line(position=pd) +
 #        geom_point(position=pd) + xlab("Winning Proportion") + ylab("Probability of buying a new stock") )



 # check_ind[, order_buy:=new_stock]
 # check_ind[new_sic_industry==1, order_buy:=2]
 # check_ind[,order_buy:=as.factor(order_buy)]

 # fwrite(check_ind, file="G:/rank/new_ind/codes/codes with more anon dataset/order_buy_stata.csv")

 # library(MASS)

 # options(contrasts = c("contr.treatment", "contr.poly"))

 # plr <- oprobit.reg(order_buy ~ winning_prop + no.in.portfolio ,  data = check_ind)
 # plr
 # summary(plr)
## slightly worse fit from
 # summary(update(plr, method = "probit"))
 # r1.2 <- felm(new_stock~ winning_prop + no.in.portfolio + log_age + log_initial_value + log_portfolio_value + postcode |0|0|anon_date,data =check_for_run)

 # cum_new_icb_industry
 # cum_new_icb_supersector

r2.1 <- felm(new_icb_industry~ winning_prop +  no.in.portfolio +  log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode |0 |0|anon_date,data =check_ind[new_stock==1 ])
r2.2 <- felm(new_icb_industry~ winning_prop + no.in.portfolio +  log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode |date_formated  |0|anon_date,data =check_ind[new_stock==1 ])
r2.3 <- felm(new_icb_industry~ winning_prop + no.in.portfolio +  log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode |sedol |0|anon_date,data =check_ind[new_stock==1 ])
r2.4 <- felm(new_icb_industry~ winning_prop + no.in.portfolio +  log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode |date_formated+sedol  |0|anon_date,data =check_ind[new_stock==1 ])
r2.5 <- felm(new_icb_supersector~ winning_prop + no.in.portfolio +  log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode |0  |0|anon_date,data =check_ind[new_stock==1 ])
r2.6 <- felm(new_icb_supersector~ winning_prop + no.in.portfolio +  log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode |date_formated  |0|anon_date,data =check_ind[new_stock==1 ])
r2.7 <- felm(new_icb_supersector~ winning_prop + no.in.portfolio +  log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + gender + postcode |sedol |0|anon_date,data =check_ind[new_stock==1 ])
r2.8 <- felm(new_icb_supersector~ winning_prop + no.in.portfolio +  log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode |date_formated+sedol  |0|anon_date,data =check_ind[new_stock==1 ])

stargazer(r2.1,r2.2,r2.3,r2.4,r2.5,r2.6,r2.7,r2.8, type="html",     dep.var.labels=c("new stock in a new industry"), star.cutoffs = c(0.05, 0.01, 0.005), omit = "postcode", out="check.htm")

r3.1 <- felm(new_icb_industry~ winning_prop * no.in.portfolio.group  + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + postcode |0 |0|anon_date,data =check_ind[new_stock==1 ])
r3.2 <- felm(new_icb_industry~ winning_prop * no.in.portfolio.group  + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + postcode |date_formated  |0|anon_date,data =check_ind[new_stock==1 ])
r3.3 <- felm(new_icb_industry~ winning_prop * no.in.portfolio.group  + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + postcode |sedol |0|anon_date,data =check_ind[new_stock==1 ])
r3.4 <- felm(new_icb_industry~ winning_prop * no.in.portfolio.group  + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + postcode |date_formated+sedol  |0|anon_date,data =check_ind[new_stock==1 ])
r3.5 <- felm(new_icb_supersector~ winning_prop * no.in.portfolio.group  + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + postcode |0  |0|anon_date,data =check_ind[new_stock==1 ])
r3.6 <- felm(new_icb_supersector~ winning_prop * no.in.portfolio.group  + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + postcode |date_formated  |0|anon_date,data =check_ind[new_stock==1 ])
r3.7 <- felm(new_icb_supersector~ winning_prop * no.in.portfolio.group  + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + postcode |sedol |0|anon_date,data =check_ind[new_stock==1 ])
r3.8 <- felm(new_icb_supersector~ winning_prop * no.in.portfolio.group  + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + postcode |date_formated+sedol  |0|anon_date,data =check_ind[new_stock==1 ])


stargazer(r3.1,r3.2,r3.3,r3.4,r3.5,r3.6,r3.7,r3.8, type="html",     dep.var.labels=c("new stock in a new industry"), star.cutoffs = c(0.05, 0.01, 0.005), omit = "postcode", out="check.htm")


r3 <- felm(new_sic_industry~ winning_prop * no.in.portfolio.group |anon+date_formated+sedol  |0|anon+date_formated+sedol,data =check_ind[new_sic_2digits==1 ])


check_ind <- check_for_run[!(is.na(winning_prop)) & no.in.portfolio>=0 &  !(is.na(ICB_CODE))]
check_ind_1 <- check_ind[new_stock==0 | (new_stock==1 & new_icb_industry==0)]
check_ind_2 <- check_ind[new_stock==0 | (new_stock==1 & new_icb_industry==1)]

r3 <- felm(new_stock~ winning_prop*no.in.portfolio.group + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode |date_formated+sedol  |0|anon_date,data =check_ind_1)
r4 <- felm(new_stock~ winning_prop+no.in.portfolio+ cum_new_buy_win + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode |date_formated+sedol  |0|anon_date,data =check_ind_2)

load("G:/rank/intermdiate_data/dt_portfolio_moreanon/portfolios_icbind_return.RData")
check_ind_1 <- merge(check_ind_1, portfolios_return_icb_ind, by=c("anon","date_formated","icb_industry"),all.x=TRUE)



check_ind_1 <- check_ind_1[!(is.na(rsp_portf_size_icb_ind))]

check_ind_1[,rsp_portf_size_icb_ind_win:=Winsorize(rsp_portf_size_icb_ind, probs = c(0.01,0.99),na.rm = TRUE)]
check_ind_1[,portfolios_return_1day_icb_ind_win:=Winsorize(portfolios_return_1day_icb_ind, probs = c(0.01,0.99),na.rm = TRUE)]
check_ind_1[,portfolios_return_1month_icb_ind_win:=Winsorize(portfolios_return_1month_icb_ind, probs = c(0.01,0.99),na.rm = TRUE)]
check_ind_1[,portfolios_return_2week_icb_ind_win:=Winsorize(portfolios_return_2week_icb_ind, probs = c(0.01,0.99),na.rm = TRUE)]

r3.2.1 <- felm(new_stock~ winning_prop + no.in.portfolio + cum_new_buy_win + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode|date_formated+sedol  |0|anon_date,data =check_ind_1)
r3.2.2 <- felm(new_stock~ winning_prop + no.in.portfolio + cum_new_buy_win + rsp_portf_size_icb_ind_win + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode |date_formated+sedol  |0|anon_date,data =check_ind_1)
r3.2.3 <- felm(new_stock~ winning_prop + no.in.portfolio + cum_new_buy_win + portfolios_return_1day_icb_ind_win + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode |date_formated+sedol  |0|anon_date,data =check_ind_1)

r3.2.4 <- felm(new_stock~ winning_prop + no.in.portfolio + cum_new_buy_win + portfolios_return_2week_icb_ind_win + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode |date_formated+sedol  |0|anon_date,data =check_ind_1)
r3.2.5 <- felm(new_stock~ winning_prop + no.in.portfolio + cum_new_buy_win + portfolios_return_1month_icb_ind_win + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode |date_formated+sedol  |0|anon_date,data =check_ind_1)


stargazer(r3.2.1,r3.2.2,r3.2.3,r3.2.4,r3.2.5,r4,type="latex",     dep.var.labels=c("new stock in a new industry"), star.cutoffs = c(0.05, 0.01, 0.005), omit = "postcode", out="check.tex")
#covariate.labels = c("winning proportion", "portfolio sic 10 return since purchase size", "portfolio sic 10 1-day return", "portfolio sic 10 3day return", "portfolio sic 10 1-week return",  "portfolio sic 10 2-4day return", "portfolio sic 10 4-6day return", "portfolio sic 10 6-11day return",  "number of holdings"),

check_ind_1_1 <- check_ind_1[!(is.na(winning_prop_icb_ind)) & !(is.na(winning_prop_other_icb_ind))]

check_ind_1_2 <- check_ind_1[!(is.na(rsp_portf_size_icb_ind))  & !(rsp_portf_size_other_icb_ind==Inf) & !(rsp_portf_size_other_icb_ind==-Inf) ]



check_ind_1_2[,rsp_portf_size_icb_ind_win:=Winsorize(rsp_portf_size_icb_ind, probs = c(0.01,0.99),na.rm = TRUE)]
check_ind_1_2[,rsp_portf_size_other_icb_ind_win:=Winsorize(rsp_portf_size_other_icb_ind, probs = c(0.01,0.99),na.rm = TRUE)]
#check_ind_1_1[,portfolios_return_1day_icb_ind_win:=Winsorize(portfolios_return_1day_icb_ind, probs = c(0.01,0.99),na.rm = TRUE)]
#check_ind_1_1[,portfolios_return_1month_icb_ind_win:=Winsorize(portfolios_return_1month_icb_ind, probs = c(0.01,0.99),na.rm = TRUE)]
#check_ind_1_1[,portfolios_return_2week_icb_ind_win:=Winsorize(portfolios_return_2week_icb_ind, probs = c(0.01,0.99),na.rm = TRUE)]
#check_ind_1_1[,rsp_portf_size_other_icb_ind_win:=Winsorize(rsp_portf_size_other_icb_ind, probs = c(0.01,0.99),na.rm = TRUE)]
#check_ind_1_1[,return_1day_weight_other_icb_ind_win:=Winsorize(return_1day_weight_other_icb_ind, probs = c(0.01,0.99),na.rm = TRUE)]
#check_ind_1_1[,return_2week_weight_other_icb_ind_win:=Winsorize(return_2week_weight_other_icb_ind, probs = c(0.01,0.99),na.rm = TRUE)]
#check_ind_1_1[,return_1month_weight_other_icb_ind_win:=Winsorize(return_1month_weight_other_icb_ind, probs = c(0.01,0.99),na.rm = TRUE)]

r3.2.1.2 <- felm(new_stock~ postcode +  no.in.portfolio + cum_new_buy_win + winning_prop_icb_ind + winning_prop_other_icb_ind + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender  |date_formated+sedol  |0|anon_date,data =check_ind_1_1)

library(car)
linearHypothesis(r3.2.1.2, "winning_prop_icb_ind = winning_prop_other_icb_ind")

r3.2.2.2 <- felm(new_stock~ postcode +  no.in.portfolio + cum_new_buy_win + rsp_portf_size_other_icb_ind_win + rsp_portf_size_icb_ind_win + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender  |date_formated+sedol  |0|anon_date,data =check_ind_1_2)

linearHypothesis(r3.2.2.2, "rsp_portf_size_other_icb_ind_win = rsp_portf_size_icb_ind_win")

r3.2.3.2 <- felm(new_stock~ postcode + portfolios_return_1day_icb_ind_win + return_1day_weight_other_icb_ind_win + no.in.portfolio + cum_new_buy_win + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender |date_formated+sedol  |0|anon_date,data =check_ind_1_1)

r3.2.4.2 <- felm(new_stock~ postcode + portfolios_return_2week_icb_ind_win + return_2week_weight_other_icb_ind_win + no.in.portfolio + cum_new_buy_win + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender |date_formated+sedol  |0|anon_date,data =check_ind_1_1)

r3.2.5.2 <- felm(new_stock~ postcode + portfolios_return_1month_icb_ind_win + return_1month_weight_other_icb_ind_win + no.in.portfolio + cum_new_buy_win + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender |date_formated+sedol  |0|anon_date,data =check_ind_1_1)

stargazer(r3.2.1.2,r3.2.2.2,r3.2.3.2,r3.2.4.2,r3.2.5.2, type="html",     dep.var.labels=c("new stock in a new industry"), star.cutoffs = c(0.05, 0.01, 0.005), omit = "postcode", out="check.htm")













# looking at topup vs same ind, and topup vs new ind (new sic_2digits)

  
check_ind_1 <- check_ind[new_stock==0 | (new_stock==1 & new_icb_supersector==0)]
check_ind_2 <- check_ind[new_stock==0 | (new_stock==1 & new_icb_supersector==1)]

r5 <- felm(new_stock~ winning_prop + no.in.portfolio + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode |date_formated+sedol  |0|anon_date,data =check_ind_1)
r6 <- felm(new_stock~ winning_prop + no.in.portfolio + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode |date_formated+sedol  |0|anon_date,data =check_ind_2)

load("G:/rank/intermdiate_data/dt_portfolio_moreanon/portfolios_icb2d_return.RData")
check_ind_1 <- merge(check_ind_1, portfolios_return_icb_2d, by=c("anon","date_formated","icb_supersector"),all.x=TRUE)



check_ind_1 <- check_ind_1[!(is.na(rsp_portf_size_icb_2d)) & !(is.na(portfolios_return_1day_icb_2d)) & !(is.na(portfolios_return_1week_icb_2d)) & !(is.na(portfolios_return_2week_icb_2d))]

check_ind_1[,rsp_portf_size_icb_2d_win:=Winsorize(rsp_portf_size_icb_2d, probs = c(0.01,0.99),na.rm = TRUE)]
check_ind_1[,portfolios_return_1day_icb_2d_win:=Winsorize(portfolios_return_1day_icb_2d, probs = c(0.01,0.99),na.rm = TRUE)]
check_ind_1[,portfolios_return_1week_icb_2d_win:=Winsorize(portfolios_return_1week_icb_2d, probs = c(0.01,0.99),na.rm = TRUE)]
check_ind_1[,portfolios_return_2week_icb_2d_win:=Winsorize(portfolios_return_2week_icb_2d, probs = c(0.01,0.99),na.rm = TRUE)]


r5.2.1 <- felm(new_stock~ winning_prop + no.in.portfolio + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode |date_formated+sedol  |0|anon_date,data =check_ind_1)
r5.2.2 <- felm(new_stock~ winning_prop + no.in.portfolio + rsp_portf_size_icb_2d_win + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode |date_formated+sedol  |0|anon_date,data =check_ind_1)
r5.2.3 <- felm(new_stock~ winning_prop+ no.in.portfolio + portfolios_return_1day_icb_2d_win + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode |date_formated+sedol  |0|anon_date,data =check_ind_1)
r5.2.4 <- felm(new_stock~ winning_prop+ no.in.portfolio + portfolios_return_1week_icb_2d_win + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode |date_formated+sedol  |0|anon_date,data =check_ind_1)
r5.2.5 <- felm(new_stock~ winning_prop+ no.in.portfolio + portfolios_return_2week_icb_2d_win + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode |date_formated+sedol  |0|anon_date,data =check_ind_1)


stargazer(r5.2.1,r5.2.2,r5.2.3,r5.2.4,r5.2.5,r6,type="latex",  omit = "postcode",   star.cutoffs = c(0.05, 0.01, 0.005),out="check.tex")

check_ind_1_1 <- check_ind_1[!(is.na(winning_prop_icb_2d)) &!(is.na( winning_prop_other_icb_2d))]

check_ind_1_1[,rsp_portf_size_icb_2d_win:=Winsorize(rsp_portf_size_icb_2d, probs = c(0.01,0.99),na.rm = TRUE)]
#check_ind_1_1[,portfolios_return_1day_icb_2d_win:=Winsorize(portfolios_return_1day_icb_2d, probs = c(0.01,0.99),na.rm = TRUE)]
#check_ind_1_1[,portfolios_return_1month_icb_2d_win:=Winsorize(portfolios_return_1month_icb_2d, probs = c(0.01,0.99),na.rm = TRUE)]
#check_ind_1_1[,portfolios_return_2week_icb_2d_win:=Winsorize(portfolios_return_2week_icb_2d, probs = c(0.01,0.99),na.rm = TRUE)]
check_ind_1_1[,rsp_portf_size_other_icb_2d_win:=Winsorize(rsp_portf_size_other_icb_2d, probs = c(0.01,0.99),na.rm = TRUE)]
#check_ind_1_1[,return_1day_weight_other_icb_2d_win:=Winsorize(return_1day_weight_other_icb_2d, probs = c(0.01,0.99),na.rm = TRUE)]
#check_ind_1_1[,return_2week_weight_other_icb_2d_win:=Winsorize(return_2week_weight_other_icb_2d, probs = c(0.01,0.99),na.rm = TRUE)]
#check_ind_1_1[,return_1month_weight_other_icb_2d_win:=Winsorize(return_1month_weight_other_icb_2d, probs = c(0.01,0.99),na.rm = TRUE)]

r5.2.1.2 <- felm(new_stock~ postcode +  no.in.portfolio + cum_new_buy_win + winning_prop_icb_2d + winning_prop_other_icb_2d + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender  +return_1week_win+sd_1day_win|date_formated+sedol  |0|anon_date,data =check_ind_1_1)

linearHypothesis(r5.2.1.2, "winning_prop_icb_2d = winning_prop_other_icb_2d")

r5.2.2.2 <- felm(new_stock~ postcode +  no.in.portfolio + cum_new_buy_win + rsp_portf_size_other_icb_2d_win + rsp_portf_size_icb_2d_win + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender  |date_formated+sedol  |0|anon_date,data =check_ind_1_1)

linearHypothesis(r5.2.2.2, "rsp_portf_size_other_icb_2d_win = rsp_portf_size_icb_2d_win")

r5.2.3.2 <- felm(new_stock~ postcode + portfolios_return_1day_icb_2d_win + return_1day_weight_other_icb_2d_win + no.in.portfolio + cum_new_buy_win + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender |date_formated+sedol  |0|anon_date,data =check_ind_1_1)

r5.2.4.2 <- felm(new_stock~ postcode + portfolios_return_2week_icb_2d_win + return_2week_weight_other_icb_2d_win + no.in.portfolio + cum_new_buy_win + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender |date_formated+sedol  |0|anon_date,data =check_ind_1_1)

r5.2.5.2 <- felm(new_stock~ postcode + portfolios_return_1month_icb_2d_win + return_1month_weight_other_icb_2d_win + no.in.portfolio + cum_new_buy_win + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender |date_formated+sedol  |0|anon_date,data =check_ind_1_1)


stargazer(r3.2.1.2,r3.2.2.2,r3.2.4.2,r3.2.5.2, r5.2.1.2,r5.2.2.2,r5.2.4.2,r5.2.5.2, type="html",     dep.var.labels=c("new stock in a new industry"), star.cutoffs = c(0.05, 0.01, 0.005), omit = "postcode", out="check.htm")
```

```{r}
# calculate industry distances for each new buy in a new sic-2d industry
transaction_buy_run_sub[,anon_date:=paste0(anon,date_formated)]
sample_distance_anondate <- unique(transaction_buy_run_sub[new_sic_2digits==1]$anon_date)
transaction_buy_run_sub[,anon_date:=NULL]

portfolio_stock_composition[,anon_date:=paste0(anon,date_formated)]
portfolio_composition_for_distance <- portfolio_stock_composition[anon_date %in% sample_distance_anondate]
portfolio_stock_composition[,anon_date:=NULL]
portfolio_composition_for_distance[,anon_date:=NULL]

sic_static <- static[,.(sedol, SIC_CODE_1)] 
portfolio_composition_for_distance <- merge(portfolio_composition_for_distance, sic_static, by="sedol", all.x=TRUE)
setnames(portfolio_composition_for_distance, "SIC_CODE_1","sic_in_portfolio")
portfolio_composition_for_distance[,sic_in_portfolio_2d:=floor(sic_in_portfolio/100)]
portfolio_composition_for_distance <- portfolio_composition_for_distance[net.posit.port.pre1day>0]
portfolio_composition_for_distance[,no.in.portoflio:=.N,by=c("anon","date_formated")]
portfolio_composition_for_distance <- portfolio_composition_for_distance[, .SD[1], by=c("date_formated", "anon", "sic_in_portfolio_2d")]


new_buys_for_distance <- transaction_buy_run_sub[new_sic_2digits==1]
new_buys_for_distance <- new_buys_for_distance[,.(sedol, anon, date_formated, SIC_CODE_1_2digits)]
setnames(new_buys_for_distance,"SIC_CODE_1_2digits","sic_new_buy_2d")
new_buys_for_distance[, buy_seq:=seq(1:.N)]

# calculate expected number of rows to check whether merge is correct
new_buys_for_distance[,anon_date:=paste0(anon,date_formated)]
portfolio_composition_for_distance[,anon_date:=paste0(anon,date_formated)]
no_holding <- portfolio_composition_for_distance[,.SD[1],by=anon_date]
no_holding <- no_holding[,.(anon,date_formated,no.in.portoflio)]
check1 <- new_buys_for_distance[,.N,by=anon_date]
check2 <- portfolio_composition_for_distance[,.N,by=anon_date]
check <- merge(check1, check2, by="anon_date", all.x=TRUE)
check[is.na(N.y),N.y:=1]
check[,rows:=N.x*N.y]
sum(check$rows) # 606367

distance_sic2d <- merge(new_buys_for_distance, portfolio_composition_for_distance, by="anon_date", all.x=TRUE, allow.cartesian=TRUE)
nrow(distance_sic2d)
# 606367

distance <- fread("D:/sic_data/industry_distance_sic2d_uk.csv")
setnames(distance, c("ind_1", "ind_2"), c("sic_new_buy_2d", "sic_in_portfolio_2d"))
distance_sic2d <- merge(distance_sic2d, distance, by=c("sic_new_buy_2d", "sic_in_portfolio_2d"), all.x=TRUE)

distance_sic2d <- distance_sic2d[!(is.na(sic_new_buy_2d))]
distance_sic2d <- distance_sic2d[!(is.na(sic_in_portfolio_2d))]
distance_sic2d <- distance_sic2d[!(sic_new_buy_2d==sic_in_portfolio_2d)]

distance_buy <- distance_sic2d[,.(mean_distance=mean(corr,na.rm=TRUE)),by=c("sedol.x", "anon.x", "date_formated.x")]

setnames(distance_buy, c("sedol.x", "anon.x", "date_formated.x"), c("sedol", "anon", "date_formated"))
distance_buy <- merge(distance_buy, no_holding, by=c("anon", "date_formated"), all.x=TRUE)
distance_check <- distance_buy[,.(N=.N, median_distance=median(mean_distance,na.rm = TRUE)),by=no.in.portoflio]
distance_buy <- merge(distance_buy,distance_check,by="no.in.portoflio",all.x=TRUE)
distance_buy[mean_distance >= median_distance, far_ind:=0]
distance_buy[mean_distance < median_distance, far_ind:=1]
```

```{r}
# analysis based on ICB code
icb_return <- fread("G:/rank/raw_data_not_confidential/icb_return.csv")
library(reshape2)
icb_return <- melt(icb_return, id.vars = "Name")
setnames(icb_return,c("Name","variable","value"),c("date","ind","ri"))
icb_return[,date:=as.Date(date, format="%d/%m/%Y")]

icb_mv <- fread("G:/rank/raw_data_not_confidential/icb_market_value.csv")
icb_mv <- melt(icb_mv, id.vars = "Name")
setnames(icb_mv,c("Name","variable","value"),c("date","ind","mv"))
icb_mv[,date:=as.Date(date, format="%d/%m/%Y")]

icb_return <- merge(icb_return, icb_mv, by=c("date","ind"), all.x=TRUE)
icb_return <- icb_return[order(ind,date)]
icb_return[,ri_lag:=c(NA, ri[-.N]),by=ind]
icb_return[,return:=(ri-ri_lag)/ri_lag]
icb_00 <- icb_return[ind=="OIL&GAS"]
icb_10 <- icb_return[ind=="CHEMICALS"|ind=="BASIC_RESOURCE"]
icb_20 <- icb_return[ind=="CON&MAT"|ind=="INDSGDS&SVS"]
icb_30 <- icb_return[ind=="AUTO&PARTS"|ind=="FOOD&BEV"|ind=="PERS&H/HGDS"]
icb_40 <- icb_return[ind=="HEALTHCARE"]
icb_50 <- icb_return[ind=="RETAIL"|ind=="MEDIA"|ind=="TRAVEL&LEIS"]
icb_60 <- icb_return[ind=="TELECOM"]
icb_70 <- icb_return[ind=="UTILITIES"]
icb_80 <- icb_return[ind=="BANKS"|ind=="INSURANCE"|ind=="FINANCIALSVS"]
icb_90 <- icb_return[ind=="TECHNOLOGY"]

icb_00 <- icb_00[,.(date,return)]
icb_00[,icb_industry:=0]
icb_10[,sum_mv:=sum(mv),by=date]
icb_10[,prop_mv:=mv/sum_mv]
icb_10[,prop_ri:=prop_mv*return]
icb_10 <- icb_10[,.(return=sum(prop_ri)),by=date]
icb_10[,icb_industry:=1]
icb_20[,sum_mv:=sum(mv),by=date]
icb_20[,prop_mv:=mv/sum_mv]
icb_20[,prop_ri:=prop_mv*return]
icb_20 <- icb_20[,.(return=sum(prop_ri)),by=date]
icb_20[,icb_industry:=2]
icb_30[,sum_mv:=sum(mv),by=date]
icb_30[,prop_mv:=mv/sum_mv]
icb_30[,prop_ri:=prop_mv*return]
icb_30 <- icb_30[,.(return=sum(prop_ri)),by=date]
icb_30[,icb_industry:=3]
icb_40 <- icb_40[,.(date,return)]
icb_40[,icb_industry:=4]
icb_50[,sum_mv:=sum(mv),by=date]
icb_50[,prop_mv:=mv/sum_mv]
icb_50[,prop_ri:=prop_mv*return]
icb_50 <- icb_50[,.(return=sum(prop_ri)),by=date]
icb_50[,icb_industry:=5]
icb_60 <- icb_60[,.(date,return)]
icb_60[,icb_industry:=6]
icb_70 <- icb_70[,.(date,return)]
icb_70[,icb_industry:=7]
icb_80[,sum_mv:=sum(mv),by=date]
icb_80[,prop_mv:=mv/sum_mv]
icb_80[,prop_ri:=prop_mv*return]
icb_80 <- icb_80[,.(return=sum(prop_ri)),by=date]
icb_80[,icb_industry:=8]
icb_90 <- icb_90[,.(date,return)]
icb_90[,icb_industry:=9]
icb <- rbind(icb_00,icb_10,icb_20,icb_30,icb_40,icb_50,icb_60,icb_70,icb_80,icb_90)f
x <- seq(0, 9)
y <- seq(0,9)
icb_distance <- as.data.table(expand.grid(icb_1 = x, icb_2 = y))
icb_distance <- icb_distance[icb_1!=icb_2]
library(pbapply)
icb <- icb[!(is.na(return))]
icb_distance[,correlation:=pblapply(.I,function(i) cor(icb[icb_industry==icb_1[i]]$return, icb[icb_industry==icb_2[i]]$return))]
icb_distance[,correlation:=unlist(correlation)]

# calculate industry distances for each new buy in a new icb industry
transaction_buy_run_sub[,anon_date:=paste0(anon,date_formated)]
sample_distance_anondate <- unique(transaction_buy_run_sub[new_icb_industry==1]$anon_date)
transaction_buy_run_sub[,anon_date:=NULL]

portfolio_stock_composition[,anon_date:=paste0(anon,date_formated)]
portfolio_stock_composition[,holding_value:=net.posit.port.pre1day*upp_lag]
portfolio_composition_for_distance <- portfolio_stock_composition[anon_date %in% sample_distance_anondate]
portfolio_stock_composition[,anon_date:=NULL]
portfolio_composition_for_distance[,anon_date:=NULL]

sic_static <- static[,.(sedol, ICB_CODE)] 
portfolio_composition_for_distance <- merge(portfolio_composition_for_distance, sic_static, by="sedol", all.x=TRUE)
setnames(portfolio_composition_for_distance, "ICB_CODE","icb_in_portfolio")
portfolio_composition_for_distance[,icb_industry_in_portfolio:=floor(icb_in_portfolio/1000)]
portfolio_composition_for_distance <- portfolio_composition_for_distance[net.posit.port.pre1day>0]
portfolio_composition_for_distance[,no.in.portoflio:=.N,by=c("anon","date_formated")]
portfolio_composition_for_distance <- portfolio_composition_for_distance[, .SD[1], by=c("date_formated", "anon", "icb_industry_in_portfolio")]


new_buys_for_distance <- transaction_buy_run_sub[new_icb_industry==1]
new_buys_for_distance <- new_buys_for_distance[,.(sedol, anon, date_formated, icb_industry)]
setnames(new_buys_for_distance,"icb_industry","icb_industry_new_buy")
new_buys_for_distance[, buy_seq:=seq(1:.N)]

# calculate expected number of rows to check whether merge is correct
new_buys_for_distance[,anon_date:=paste0(anon,date_formated)]
portfolio_composition_for_distance[,anon_date:=paste0(anon,date_formated)]
no_holding <- portfolio_composition_for_distance[,.SD[1],by=anon_date]
no_holding <- no_holding[,.(anon,date_formated,no.in.portoflio)]
check1 <- new_buys_for_distance[,.N,by=anon_date]
check2 <- portfolio_composition_for_distance[,.N,by=anon_date]
check <- merge(check1, check2, by="anon_date", all.x=TRUE)
check[is.na(N.y),N.y:=1]
check[,rows:=N.x*N.y]
sum(check$rows) # 290593

distance_icb_ind <- merge(new_buys_for_distance, portfolio_composition_for_distance, by="anon_date", all.x=TRUE, allow.cartesian=TRUE)
nrow(distance_icb_ind)
# 290593


setnames(icb_distance, c("icb_1", "icb_2"), c("icb_industry_in_portfolio", "icb_industry_new_buy"))
distance_icb_ind <- merge(distance_icb_ind, icb_distance, by=c("icb_industry_in_portfolio", "icb_industry_new_buy"), all.x=TRUE)

distance_icb_ind <- distance_icb_ind[!(is.na(icb_industry_in_portfolio))]
distance_icb_ind <- distance_icb_ind[!(is.na(icb_industry_new_buy))]
distance_icb_ind <- distance_icb_ind[!(icb_industry_in_portfolio==icb_industry_new_buy)]
distance_buy <- distance_icb_ind[,.(mean_distance=weighted.mean(x=correlation,w=holding_value)),by=c("sedol.x", "anon.x", "date_formated.x")]

setnames(distance_buy, c("sedol.x", "anon.x", "date_formated.x"), c("sedol", "anon", "date_formated"))
distance_buy <- merge(distance_buy, no_holding, by=c("anon", "date_formated"), all.x=TRUE)
distance_check <- distance_buy[,.(N=.N, median_distance=median(mean_distance,na.rm = TRUE)),by=no.in.portoflio]
distance_buy <- merge(distance_buy,distance_check,by="no.in.portoflio",all.x=TRUE)
distance_buy[mean_distance >= median_distance, far_ind:=0]
distance_buy[mean_distance < median_distance, far_ind:=1]

 # looking at topup vs same ind, and topup vs new ind (new industry category)
check_ind <- check_for_run[!(is.na(winning_prop)) & no.in.portfolio>=0 &  !(is.na(ICB_CODE))]

check_ind <- merge(check_ind, distance_buy, by=c("anon","sedol","date_formated"), all.x=TRUE)


r7.1 <- felm(mean_distance ~ postcode + winning_prop+no.in.portfolio + log_age + log_initial_value + log_portfolio_value + log_ntrades_freq_win+ gender  |date_formated+sedol  |0|anon_date,data =check_ind[!(is.na(mean_distance))])

r7.2 <- felm(far_ind ~  postcode + winning_prop+no.in.portfolio + log_age + log_initial_value + log_portfolio_value + log_ntrades_freq_win+ gender  |date_formated+sedol  |0|anon_date,data =check_ind[!(is.na(far_ind))])

```


```{r}

# analysis based on ICB code
icb_return <- fread("G:/rank/raw_data_not_confidential/icb_return2.csv")
library(reshape2)
icb_return <- melt(icb_return, id.vars = "Name")
setnames(icb_return,c("Name","variable","value"),c("date","ind","ri"))
icb_return[,date:=as.Date(date, format="%d/%m/%Y")]

icb_return <- icb_return[order(ind,date)]
icb_return[,ri_lag:=c(NA, ri[-.N]),by=ind]
icb_return[,return:=(ri-ri_lag)/ri_lag]

icb_return[ind=="OIL&GAS",icb_supersector:=5]
icb_return[ind=="CHEMICALS",icb_supersector:=13]
icb_return[ind=="BASIC_RESOURCE",icb_supersector:=17]
icb_return[ind=="CON&MAT",icb_supersector:=23]
icb_return[ind=="INDSGDS&SVS",icb_supersector:=27]
icb_return[ind=="AUTO&PARTS",icb_supersector:=33]
icb_return[ind=="FOOD&BEV",icb_supersector:=35]
icb_return[ind=="PERS&H/HGDS",icb_supersector:=37]
icb_return[ind=="HEALTHCARE",icb_supersector:=45]
icb_return[ind=="RETAIL",icb_supersector:=53]
icb_return[ind=="MEDIA",icb_supersector:=55]
icb_return[ind=="TRAVEL&LEIS",icb_supersector:=57]
icb_return[ind=="TELECOM",icb_supersector:=65]
icb_return[ind=="UTILITIES",icb_supersector:=75]
icb_return[ind=="BANKS",icb_supersector:=83]
icb_return[ind=="INSURANCE",icb_supersector:=85]
icb_return[ind=="REALESTATE",icb_supersector:=86]
icb_return[ind=="FINANCIALSVS",icb_supersector:=87]
icb_return[ind=="TECHNOLOGY",icb_supersector:=95]

icb <- icb_return
x <- c(83, 53, 75,  5, 17, 95, 27, 37, 45, 57, 13, 85, 87, 65, 86, 35, 23, 55, 33)
y <- c(83, 53, 75,  5, 17, 95, 27, 37, 45, 57, 13, 85, 87, 65, 86, 35, 23, 55, 33)
icb_distance <- as.data.table(expand.grid(icb_1 = x, icb_2 = y))
icb_distance <- icb_distance[icb_1!=icb_2]
library(pbapply)
icb <- icb[!(is.na(return))]
icb_distance[,correlation:=pblapply(.I,function(i) cor(icb[icb_supersector==icb_1[i]]$return, icb[icb_supersector==icb_2[i]]$return))]
icb_distance[,correlation:=unlist(correlation)]

# calculate industry distances for each new buy in a new icb industry
transaction_buy_run_sub[,anon_date:=paste0(anon,date_formated)]
sample_distance_anondate <- unique(transaction_buy_run_sub[new_icb_supersector==1]$anon_date)
transaction_buy_run_sub[,anon_date:=NULL]

portfolio_stock_composition[,anon_date:=paste0(anon,date_formated)]
portfolio_stock_composition[,holding_value:=net.posit.port.pre1day*upp_lag]
portfolio_composition_for_distance <- portfolio_stock_composition[anon_date %in% sample_distance_anondate]
portfolio_stock_composition[,anon_date:=NULL]
portfolio_composition_for_distance[,anon_date:=NULL]

sic_static <- static[,.(sedol, ICB_CODE)] 
portfolio_composition_for_distance <- merge(portfolio_composition_for_distance, sic_static, by="sedol", all.x=TRUE)
setnames(portfolio_composition_for_distance, "ICB_CODE","icb_in_portfolio")
portfolio_composition_for_distance[,icb_supersector_in_portfolio:=floor(icb_in_portfolio/100)]
portfolio_composition_for_distance[icb_supersector_in_portfolio==89,icb_supersector_in_portfolio:=85]
portfolio_composition_for_distance <- portfolio_composition_for_distance[net.posit.port.pre1day>0]
portfolio_composition_for_distance[,no.in.portoflio:=.N,by=c("anon","date_formated")]
portfolio_composition_for_distance <- portfolio_composition_for_distance[, .SD[1], by=c("date_formated", "anon", "icb_supersector_in_portfolio")]


new_buys_for_distance <- transaction_buy_run_sub[new_icb_supersector==1]
new_buys_for_distance <- new_buys_for_distance[,.(sedol, anon, date_formated, icb_supersector)]
setnames(new_buys_for_distance,"icb_supersector","icb_supersector_new_buy")
new_buys_for_distance[, buy_seq:=seq(1:.N)]

# calculate expected number of rows to check whether merge is correct
new_buys_for_distance[,anon_date:=paste0(anon,date_formated)]
portfolio_composition_for_distance[,anon_date:=paste0(anon,date_formated)]
no_holding <- portfolio_composition_for_distance[,.SD[1],by=anon_date]
no_holding <- no_holding[,.(anon,date_formated,no.in.portoflio)]
check1 <- new_buys_for_distance[,.N,by=anon_date]
check2 <- portfolio_composition_for_distance[,.N,by=anon_date]
check <- merge(check1, check2, by="anon_date", all.x=TRUE)
check[is.na(N.y),N.y:=1]
check[,rows:=N.x*N.y]
sum(check$rows) # 290593

distance_icb_ind <- merge(new_buys_for_distance, portfolio_composition_for_distance, by="anon_date", all.x=TRUE, allow.cartesian=TRUE)
nrow(distance_icb_ind)
# 290593


setnames(icb_distance, c("icb_1", "icb_2"), c("icb_supersector_in_portfolio", "icb_supersector_new_buy"))
distance_icb_ind <- merge(distance_icb_ind, icb_distance, by=c("icb_supersector_in_portfolio", "icb_supersector_new_buy"), all.x=TRUE)

distance_icb_ind <- distance_icb_ind[!(is.na(icb_supersector_in_portfolio))]
distance_icb_ind <- distance_icb_ind[!(is.na(icb_supersector_new_buy))]
distance_icb_ind <- distance_icb_ind[!(icb_supersector_in_portfolio==icb_supersector_new_buy)]
distance_buy <- distance_icb_ind[,.(mean_distance=weighted.mean(x=correlation,w=holding_value)),by=c("sedol.x", "anon.x", "date_formated.x")]

setnames(distance_buy, c("sedol.x", "anon.x", "date_formated.x"), c("sedol", "anon", "date_formated"))
distance_buy <- merge(distance_buy, no_holding, by=c("anon", "date_formated"), all.x=TRUE)
distance_check <- distance_buy[,.(N=.N, median_distance=median(mean_distance,na.rm = TRUE)),by=no.in.portoflio]
distance_buy <- merge(distance_buy,distance_check,by="no.in.portoflio",all.x=TRUE)
distance_buy[mean_distance >= median_distance, far_ind:=0]
distance_buy[mean_distance < median_distance, far_ind:=1]

check_ind <- check_for_run[!(is.na(winning_prop)) & no.in.portfolio>=0 &  !(is.na(ICB_CODE))]

check_ind <- merge(check_ind, distance_buy, by=c("anon","sedol","date_formated"), all.x=TRUE)


r7.3 <- felm(mean_distance ~ postcode + winning_prop + no.in.portfolio + log_age + log_initial_value + log_portfolio_value + log_ntrades_freq_win+ gender |date_formated+sedol  |0|anon_date,data =check_ind[!(is.na(mean_distance))])

r7.4 <- felm(far_ind ~ postcode + winning_prop + no.in.portfolio + log_age + log_initial_value + log_portfolio_value + log_ntrades_freq_win+ gender + postcode|date_formated+sedol  |0|anon_date,data =check_ind[!(is.na(far_ind))])

stargazer(r7.1,r7.2,r7.3,r7.4,type="latex",    star.cutoffs = c(0.05, 0.01, 0.005), omit = "postcode", out="check.tex")

(1+1)
```

# plot for direct returns

## calculate returns for buys

```{R}

##################################### adding extra price information into the dataset

leading_zero <- function(x, n)
{
  x <- as.character(x)
  str <- unlist(strsplit(x, split=""))
  if(length(str)<n)
  {
    add <- as.character(rep(0, (n-length(str)) ))
    x <- paste(c(add, str), collapse="")
  }
  return(x)
} 
load("G:/rank/raw_data_not_confidential/0704ds/extended_price_150421.RData")  # <----------- from 

check <- pp_ext[,.N,by=sedol][order(N)]
pp_ext <- pp_ext[!(sedol%in%check[1:10]$sedol)]
pp_ext[,sedol:=unlist(lapply(sedol, function(x){leading_zero(x=x, n=7)}))]
pp_ext <- pp_ext[order(sedol,date_formated)]

pp_ext <- pp_ext[,.(sedol, date_formated, app )]
pp_ext <- pp_ext[order(sedol,date_formated)]
pp_ext[,app_lag1:=c(rep(NA,1), app[1:(.N-1)]),by=sedol]
pp_ext[,app_lag5:=c(rep(NA,5), app[1:(.N-5)]),by=sedol]
pp_ext[,app_lag10:=c(rep(NA,10), app[1:(.N-10)]),by=sedol]
pp_ext[,app_lag15:=c(rep(NA,15), app[1:(.N-15)]),by=sedol]
pp_ext[,app_lag20:=c(rep(NA,20), app[1:(.N-20)]),by=sedol]
pp_ext[,app_lag25:=c(rep(NA,25), app[1:(.N-25)]),by=sedol]
pp_ext[,app_lag30:=c(rep(NA,30), app[1:(.N-30)]),by=sedol]
pp_ext[,app_lag35:=c(rep(NA,35), app[1:(.N-35)]),by=sedol]
pp_ext[,app_lag40:=c(rep(NA,40), app[1:(.N-40)]),by=sedol]
pp_ext[,app_lag45:=c(rep(NA,45), app[1:(.N-45)]),by=sedol]
pp_ext[,app_lag50:=c(rep(NA,50), app[1:(.N-50)]),by=sedol]
pp_ext[,app_lag55:=c(rep(NA,55), app[1:(.N-55)]),by=sedol]
pp_ext[,app_lag60:=c(rep(NA,60), app[1:(.N-60)]),by=sedol]
pp_ext[,app_lag65:=c(rep(NA,65), app[1:(.N-65)]),by=sedol]
pp_ext[,app_lag70:=c(rep(NA,70), app[1:(.N-70)]),by=sedol]
pp_ext[,app_lag75:=c(rep(NA,75), app[1:(.N-75)]),by=sedol]
pp_ext[,app_lag80:=c(rep(NA,80), app[1:(.N-80)]),by=sedol]
pp_ext[,app_lag85:=c(rep(NA,85), app[1:(.N-85)]),by=sedol]
pp_ext[,app_lag90:=c(rep(NA,90), app[1:(.N-90)]),by=sedol]
pp_ext[,app_lag95:=c(rep(NA,95), app[1:(.N-95)]),by=sedol]
pp_ext[,app_lag100:=c(rep(NA,100), app[1:(.N-100)]),by=sedol]
pp_ext[,app_lag105:=c(rep(NA,105), app[1:(.N-105)]),by=sedol]
pp_ext[,app_lag110:=c(rep(NA,110), app[1:(.N-110)]),by=sedol]
pp_ext[,app_lag115:=c(rep(NA,115), app[1:(.N-115)]),by=sedol]
pp_ext[,app_lag120:=c(rep(NA,120), app[1:(.N-120)]),by=sedol]
pp_ext[,app_lead5:=shift(app, n=5L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead10:=shift(app, n=10L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead15:=shift(app, n=15L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead20:=shift(app, n=20L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead25:=shift(app, n=25L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead30:=shift(app, n=30L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead35:=shift(app, n=35L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead40:=shift(app, n=40L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead45:=shift(app, n=45L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead50:=shift(app, n=50L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead55:=shift(app, n=55L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead60:=shift(app, n=60L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead65:=shift(app, n=65L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead70:=shift(app, n=70L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead75:=shift(app, n=75L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead80:=shift(app, n=80L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead85:=shift(app, n=85L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead90:=shift(app, n=90L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead95:=shift(app, n=95L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead100:=shift(app, n=100L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead105:=shift(app, n=105L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead110:=shift(app, n=110L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead115:=shift(app, n=115L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead120:=shift(app, n=120L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead125:=shift(app, n=125L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead130:=shift(app, n=130L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead135:=shift(app, n=135L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead140:=shift(app, n=140L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead145:=shift(app, n=145L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead150:=shift(app, n=150L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead155:=shift(app, n=155L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead160:=shift(app, n=160L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead165:=shift(app, n=165L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead170:=shift(app, n=170L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead175:=shift(app, n=175L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead180:=shift(app, n=180L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead185:=shift(app, n=185L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead190:=shift(app, n=190L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead195:=shift(app, n=195L, fill=NA, type='lead'),by=sedol]
pp_ext[,app_lead200:=shift(app, n=200L, fill=NA, type='lead'),by=sedol]


pp_ext[,return_5_fw:=(app_lead5-app)/app]
pp_ext[,return_10_fw:=(app_lead10-app)/app]
pp_ext[,return_15_fw:=(app_lead15-app)/app]
pp_ext[,return_20_fw:=(app_lead20-app)/app]
pp_ext[,return_25_fw:=(app_lead25-app)/app]
pp_ext[,return_30_fw:=(app_lead30-app)/app]
pp_ext[,return_35_fw:=(app_lead35-app)/app]
pp_ext[,return_40_fw:=(app_lead40-app)/app]
pp_ext[,return_5_fw:=(app_lead5-app)/app]
pp_ext[,return_10_fw:=(app_lead10-app)/app]
pp_ext[,return_15_fw:=(app_lead15-app)/app]
pp_ext[,return_20_fw:=(app_lead20-app)/app]
pp_ext[,return_25_fw:=(app_lead25-app)/app]
pp_ext[,return_30_fw:=(app_lead30-app)/app]
pp_ext[,return_35_fw:=(app_lead35-app)/app]
pp_ext[,return_40_fw:=(app_lead40-app)/app]
pp_ext[,return_45_fw:=(app_lead45-app)/app]
pp_ext[,return_50_fw:=(app_lead50-app)/app]
pp_ext[,return_55_fw:=(app_lead55-app)/app]
pp_ext[,return_60_fw:=(app_lead60-app)/app]
pp_ext[,return_65_fw:=(app_lead65-app)/app]
pp_ext[,return_70_fw:=(app_lead70-app)/app]
pp_ext[,return_75_fw:=(app_lead75-app)/app]
pp_ext[,return_80_fw:=(app_lead80-app)/app]
pp_ext[,return_85_fw:=(app_lead85-app)/app]
pp_ext[,return_90_fw:=(app_lead90-app)/app]
pp_ext[,return_95_fw:=(app_lead95-app)/app]
pp_ext[,return_100_fw:=(app_lead100-app)/app]
pp_ext[,return_105_fw:=(app_lead105-app)/app]
pp_ext[,return_110_fw:=(app_lead110-app)/app]
pp_ext[,return_115_fw:=(app_lead115-app)/app]
pp_ext[,return_120_fw:=(app_lead120-app)/app]
pp_ext[,return_125_fw:=(app_lead125-app)/app]
pp_ext[,return_130_fw:=(app_lead130-app)/app]
pp_ext[,return_135_fw:=(app_lead135-app)/app]
pp_ext[,return_140_fw:=(app_lead140-app)/app]
pp_ext[,return_145_fw:=(app_lead145-app)/app]
pp_ext[,return_150_fw:=(app_lead150-app)/app]
pp_ext[,return_155_fw:=(app_lead155-app)/app]
pp_ext[,return_160_fw:=(app_lead160-app)/app]
pp_ext[,return_165_fw:=(app_lead165-app)/app]
pp_ext[,return_170_fw:=(app_lead170-app)/app]
pp_ext[,return_175_fw:=(app_lead175-app)/app]
pp_ext[,return_180_fw:=(app_lead180-app)/app]
pp_ext[,return_185_fw:=(app_lead185-app)/app]
pp_ext[,return_190_fw:=(app_lead190-app)/app]
pp_ext[,return_195_fw:=(app_lead195-app)/app]
pp_ext[,return_200_fw:=(app_lead200-app)/app]

pp_ext[,return_5_lag:=(app_lag1-app_lag5)/app_lag5] 
pp_ext[,return_10_lag:=(app_lag1-app_lag10)/app_lag10]
pp_ext[,return_15_lag:=(app_lag1-app_lag15)/app_lag15]
pp_ext[,return_20_lag:=(app_lag1-app_lag20)/app_lag20]
pp_ext[,return_25_lag:=(app_lag1-app_lag25)/app_lag25]
pp_ext[,return_30_lag:=(app_lag1-app_lag30)/app_lag30]
pp_ext[,return_35_lag:=(app_lag1-app_lag35)/app_lag35]
pp_ext[,return_40_lag:=(app_lag1-app_lag40)/app_lag40]
pp_ext[,return_45_lag:=(app_lag1-app_lag45)/app_lag45]
pp_ext[,return_50_lag:=(app_lag1-app_lag50)/app_lag50]
pp_ext[,return_55_lag:=(app_lag1-app_lag55)/app_lag55]
pp_ext[,return_60_lag:=(app_lag1-app_lag60)/app_lag60]
pp_ext[,return_65_lag:=(app_lag1-app_lag65)/app_lag65]
pp_ext[,return_70_lag:=(app_lag1-app_lag70)/app_lag70]
pp_ext[,return_75_lag:=(app_lag1-app_lag75)/app_lag75]
pp_ext[,return_80_lag:=(app_lag1-app_lag80)/app_lag80]
pp_ext[,return_85_lag:=(app_lag1-app_lag85)/app_lag85]
pp_ext[,return_90_lag:=(app_lag1-app_lag90)/app_lag90]
pp_ext[,return_95_lag:=(app_lag1-app_lag95)/app_lag95]
pp_ext[,return_100_lag:=(app_lag1-app_lag100)/app_lag100]
pp_ext[,return_105_lag:=(app_lag1-app_lag105)/app_lag105] 
pp_ext[,return_110_lag:=(app_lag1-app_lag110)/app_lag110]
pp_ext[,return_115_lag:=(app_lag1-app_lag115)/app_lag115]
pp_ext[,return_120_lag:=(app_lag1-app_lag120)/app_lag120]

pp_ext[,return_5_lag_p:=(app_lag1-app_lag5)/app_lag5] # p represents 5-working day period
pp_ext[,return_10_lag_p:=(app_lag5-app_lag10)/app_lag10]
pp_ext[,return_15_lag_p:=(app_lag10-app_lag15)/app_lag15]
pp_ext[,return_20_lag_p:=(app_lag15-app_lag20)/app_lag20]
pp_ext[,return_25_lag_p:=(app_lag20-app_lag25)/app_lag25]
pp_ext[,return_30_lag_p:=(app_lag25-app_lag30)/app_lag30]
pp_ext[,return_35_lag_p:=(app_lag30-app_lag35)/app_lag35]
pp_ext[,return_40_lag_p:=(app_lag35-app_lag40)/app_lag40]
pp_ext[,return_45_lag_p:=(app_lag40-app_lag45)/app_lag45]
pp_ext[,return_50_lag_p:=(app_lag45-app_lag50)/app_lag50]
pp_ext[,return_55_lag_p:=(app_lag50-app_lag55)/app_lag55]
pp_ext[,return_60_lag_p:=(app_lag55-app_lag60)/app_lag60]
pp_ext[,return_65_lag_p:=(app_lag60-app_lag65)/app_lag65]
pp_ext[,return_70_lag_p:=(app_lag65-app_lag70)/app_lag70]
pp_ext[,return_75_lag_p:=(app_lag70-app_lag75)/app_lag75]
pp_ext[,return_80_lag_p:=(app_lag75-app_lag80)/app_lag80]
pp_ext[,return_85_lag_p:=(app_lag80-app_lag85)/app_lag85]
pp_ext[,return_90_lag_p:=(app_lag85-app_lag90)/app_lag90]
pp_ext[,return_95_lag_p:=(app_lag90-app_lag95)/app_lag95]
pp_ext[,return_100_lag_p:=(app_lag95-app_lag100)/app_lag100]
pp_ext[,return_105_lag_p:=(app_lag100-app_lag105)/app_lag105] 
pp_ext[,return_110_lag_p:=(app_lag105-app_lag110)/app_lag110]
pp_ext[,return_115_lag_p:=(app_lag110-app_lag115)/app_lag115]
pp_ext[,return_120_lag_p:=(app_lag115-app_lag120)/app_lag120]
pp_ext[,return_5_fw_p:=(app_lead5-app)/app] 
pp_ext[,return_10_fw_p:=(app_lead10-app_lead5)/app_lead5]
pp_ext[,return_15_fw_p:=(app_lead15-app_lead10)/app_lead10]
pp_ext[,return_20_fw_p:=(app_lead20-app_lead15)/app_lead15]
pp_ext[,return_25_fw_p:=(app_lead25-app_lead20)/app_lead20]
pp_ext[,return_30_fw_p:=(app_lead30-app_lead25)/app_lead25]
pp_ext[,return_35_fw_p:=(app_lead35-app_lead30)/app_lead30]
pp_ext[,return_40_fw_p:=(app_lead40-app_lead35)/app_lead35]
pp_ext[,return_45_fw_p:=(app_lead45-app_lead40)/app_lead40]
pp_ext[,return_50_fw_p:=(app_lead50-app_lead45)/app_lead45]
pp_ext[,return_55_fw_p:=(app_lead55-app_lead50)/app_lead50]
pp_ext[,return_60_fw_p:=(app_lead60-app_lead55)/app_lead55]
pp_ext[,return_65_fw_p:=(app_lead65-app_lead60)/app_lead60]
pp_ext[,return_70_fw_p:=(app_lead70-app_lead65)/app_lead65]
pp_ext[,return_75_fw_p:=(app_lead75-app_lead70)/app_lead70]
pp_ext[,return_80_fw_p:=(app_lead80-app_lead75)/app_lead75]
pp_ext[,return_85_fw_p:=(app_lead85-app_lead80)/app_lead80]
pp_ext[,return_90_fw_p:=(app_lead90-app_lead85)/app_lead85]
pp_ext[,return_95_fw_p:=(app_lead95-app_lead90)/app_lead90]
pp_ext[,return_100_fw_p:=(app_lead100-app_lead95)/app_lead95]
pp_ext[,return_105_fw_p:=(app_lead105-app_lead100)/app_lead100] 
pp_ext[,return_110_fw_p:=(app_lead110-app_lead105)/app_lead105]
pp_ext[,return_115_fw_p:=(app_lead115-app_lead110)/app_lead110]
pp_ext[,return_120_fw_p:=(app_lead120-app_lead115)/app_lead115]
pp_ext[,return_125_fw_p:=(app_lead125-app_lead120)/app_lead120]
pp_ext[,return_130_fw_p:=(app_lead130-app_lead125)/app_lead125]
pp_ext[,return_135_fw_p:=(app_lead135-app_lead130)/app_lead130]
pp_ext[,return_140_fw_p:=(app_lead140-app_lead135)/app_lead135]
pp_ext[,return_145_fw_p:=(app_lead145-app_lead140)/app_lead140]
pp_ext[,return_150_fw_p:=(app_lead150-app_lead145)/app_lead145]
pp_ext[,return_155_fw_p:=(app_lead155-app_lead150)/app_lead150]
pp_ext[,return_160_fw_p:=(app_lead160-app_lead155)/app_lead155]
pp_ext[,return_165_fw_p:=(app_lead165-app_lead160)/app_lead160]
pp_ext[,return_170_fw_p:=(app_lead170-app_lead165)/app_lead165]
pp_ext[,return_175_fw_p:=(app_lead175-app_lead170)/app_lead170]
pp_ext[,return_180_fw_p:=(app_lead180-app_lead175)/app_lead175]
pp_ext[,return_185_fw_p:=(app_lead185-app_lead180)/app_lead180]
pp_ext[,return_190_fw_p:=(app_lead190-app_lead185)/app_lead185]
pp_ext[,return_195_fw_p:=(app_lead195-app_lead190)/app_lead190]
pp_ext[,return_200_fw_p:=(app_lead200-app_lead195)/app_lead195]



```

```{r}
check_for_run_fw <- merge(check_for_run, pp_ext, by=c("sedol", "date_formated"), all.x=TRUE)
check_for_run_fw[,order:=new_stock]
check_for_run_fw[new_icb_industry==1,order:=2]
check_for_run_fw[,order:=as.factor(order)]

check_for_run_fw[,order2:=0]
check_for_run_fw[new_stock==1,order2:=2]
check_for_run_fw[net.posit.port.pre1day==0&new_stock==0,order2:=1]
check_for_run_fw[,order2:=as.factor(order2)]



check_for_run_fw[,return_5_fw:=Winsorize(return_5_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_10_fw:=Winsorize(return_10_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_15_fw:=Winsorize(return_15_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_20_fw:=Winsorize(return_20_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_25_fw:=Winsorize(return_25_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_30_fw:=Winsorize(return_30_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_35_fw:=Winsorize(return_35_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_40_fw:=Winsorize(return_40_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_45_fw:=Winsorize(return_45_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_50_fw:=Winsorize(return_50_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_55_fw:=Winsorize(return_55_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_60_fw:=Winsorize(return_60_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_65_fw:=Winsorize(return_65_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_70_fw:=Winsorize(return_70_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_75_fw:=Winsorize(return_75_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_80_fw:=Winsorize(return_80_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_85_fw:=Winsorize(return_85_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_90_fw:=Winsorize(return_90_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_95_fw:=Winsorize(return_95_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_100_fw:=Winsorize(return_100_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_105_fw:=Winsorize(return_105_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_110_fw:=Winsorize(return_110_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_115_fw:=Winsorize(return_115_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_120_fw:=Winsorize(return_120_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_125_fw:=Winsorize(return_125_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_130_fw:=Winsorize(return_130_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_135_fw:=Winsorize(return_135_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_140_fw:=Winsorize(return_140_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_145_fw:=Winsorize(return_145_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_150_fw:=Winsorize(return_150_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_155_fw:=Winsorize(return_155_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_160_fw:=Winsorize(return_160_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_165_fw:=Winsorize(return_165_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_170_fw:=Winsorize(return_170_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_175_fw:=Winsorize(return_175_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_180_fw:=Winsorize(return_180_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_185_fw:=Winsorize(return_185_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_190_fw:=Winsorize(return_190_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_195_fw:=Winsorize(return_195_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_200_fw:=Winsorize(return_200_fw, probs = c(0.01,0.99),na.rm=TRUE)]


check_for_run_fw[,return_5_lag_p:=Winsorize(return_5_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_10_lag_p:=Winsorize(return_10_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_15_lag_p:=Winsorize(return_15_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_20_lag_p:=Winsorize(return_20_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_25_lag_p:=Winsorize(return_25_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_30_lag_p:=Winsorize(return_30_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_35_lag_p:=Winsorize(return_35_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_40_lag_p:=Winsorize(return_40_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_45_lag_p:=Winsorize(return_45_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_50_lag_p:=Winsorize(return_50_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_55_lag_p:=Winsorize(return_55_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_60_lag_p:=Winsorize(return_60_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_65_lag_p:=Winsorize(return_65_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_70_lag_p:=Winsorize(return_70_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_75_lag_p:=Winsorize(return_75_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_80_lag_p:=Winsorize(return_80_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_85_lag_p:=Winsorize(return_85_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_90_lag_p:=Winsorize(return_90_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_95_lag_p:=Winsorize(return_95_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_100_lag_p:=Winsorize(return_100_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_105_lag_p:=Winsorize(return_105_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_110_lag_p:=Winsorize(return_110_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_115_lag_p:=Winsorize(return_115_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_120_lag_p:=Winsorize(return_120_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]

check_for_run_fw[,return_5_lag:=Winsorize(return_5_lag, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_10_lag:=Winsorize(return_10_lag, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_15_lag:=Winsorize(return_15_lag, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_20_lag:=Winsorize(return_20_lag, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_25_lag:=Winsorize(return_25_lag, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_30_lag:=Winsorize(return_30_lag, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_35_lag:=Winsorize(return_35_lag, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_40_lag:=Winsorize(return_40_lag, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_45_lag:=Winsorize(return_45_lag, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_50_lag:=Winsorize(return_50_lag, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_55_lag:=Winsorize(return_55_lag, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_60_lag:=Winsorize(return_60_lag, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_65_lag:=Winsorize(return_65_lag, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_70_lag:=Winsorize(return_70_lag, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_75_lag:=Winsorize(return_75_lag, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_80_lag:=Winsorize(return_80_lag, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_85_lag:=Winsorize(return_85_lag, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_90_lag:=Winsorize(return_90_lag, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_95_lag:=Winsorize(return_95_lag, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_100_lag:=Winsorize(return_100_lag, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_105_lag:=Winsorize(return_105_lag, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_110_lag:=Winsorize(return_110_lag, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_115_lag:=Winsorize(return_115_lag, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_120_lag:=Winsorize(return_120_lag, probs = c(0.01,0.99),na.rm=TRUE)]



check_for_run_fw[,return_5_fw_p:=Winsorize(return_5_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_10_fw_p:=Winsorize(return_10_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_15_fw_p:=Winsorize(return_15_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_20_fw_p:=Winsorize(return_20_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_25_fw_p:=Winsorize(return_25_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_30_fw_p:=Winsorize(return_30_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_35_fw_p:=Winsorize(return_35_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_40_fw_p:=Winsorize(return_40_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_45_fw_p:=Winsorize(return_45_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_50_fw_p:=Winsorize(return_50_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_55_fw_p:=Winsorize(return_55_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_60_fw_p:=Winsorize(return_60_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_65_fw_p:=Winsorize(return_65_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_70_fw_p:=Winsorize(return_70_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_75_fw_p:=Winsorize(return_75_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_80_fw_p:=Winsorize(return_80_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_85_fw_p:=Winsorize(return_85_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_90_fw_p:=Winsorize(return_90_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_95_fw_p:=Winsorize(return_95_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_100_fw_p:=Winsorize(return_100_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_105_fw_p:=Winsorize(return_105_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_110_fw_p:=Winsorize(return_110_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_115_fw_p:=Winsorize(return_115_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_120_fw_p:=Winsorize(return_120_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_125_fw_p:=Winsorize(return_125_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_130_fw_p:=Winsorize(return_130_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_135_fw_p:=Winsorize(return_135_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_140_fw_p:=Winsorize(return_140_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_145_fw_p:=Winsorize(return_145_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_150_fw_p:=Winsorize(return_150_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_155_fw_p:=Winsorize(return_155_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_160_fw_p:=Winsorize(return_160_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_165_fw_p:=Winsorize(return_165_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_170_fw_p:=Winsorize(return_170_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_175_fw_p:=Winsorize(return_175_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_180_fw_p:=Winsorize(return_180_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_185_fw_p:=Winsorize(return_185_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_190_fw_p:=Winsorize(return_190_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_195_fw_p:=Winsorize(return_195_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_200_fw_p:=Winsorize(return_200_fw_p, probs = c(0.01,0.99),na.rm=TRUE)]



check_for_run_fw[,Nna_return_5_fw:=ifelse(is.na(return_5_fw),0,1)]
check_for_run_fw[,Nna_return_10_fw:=ifelse(is.na(return_10_fw),0,1)]
check_for_run_fw[,Nna_return_15_fw:=ifelse(is.na(return_15_fw),0,1)]
check_for_run_fw[,Nna_return_20_fw:=ifelse(is.na(return_20_fw),0,1)]
check_for_run_fw[,Nna_return_25_fw:=ifelse(is.na(return_25_fw),0,1)]
check_for_run_fw[,Nna_return_30_fw:=ifelse(is.na(return_30_fw),0,1)]
check_for_run_fw[,Nna_return_35_fw:=ifelse(is.na(return_35_fw),0,1)]
check_for_run_fw[,Nna_return_40_fw:=ifelse(is.na(return_40_fw),0,1)]
check_for_run_fw[,Nna_return_45_fw:=ifelse(is.na(return_45_fw),0,1)]
check_for_run_fw[,Nna_return_50_fw:=ifelse(is.na(return_50_fw),0,1)]
check_for_run_fw[,Nna_return_55_fw:=ifelse(is.na(return_55_fw),0,1)]
check_for_run_fw[,Nna_return_60_fw:=ifelse(is.na(return_60_fw),0,1)]
check_for_run_fw[,Nna_return_65_fw:=ifelse(is.na(return_65_fw),0,1)]
check_for_run_fw[,Nna_return_70_fw:=ifelse(is.na(return_70_fw),0,1)]
check_for_run_fw[,Nna_return_75_fw:=ifelse(is.na(return_75_fw),0,1)]
check_for_run_fw[,Nna_return_80_fw:=ifelse(is.na(return_80_fw),0,1)]
check_for_run_fw[,Nna_return_85_fw:=ifelse(is.na(return_85_fw),0,1)]
check_for_run_fw[,Nna_return_90_fw:=ifelse(is.na(return_90_fw),0,1)]
check_for_run_fw[,Nna_return_95_fw:=ifelse(is.na(return_95_fw),0,1)]
check_for_run_fw[,Nna_return_100_fw:=ifelse(is.na(return_100_fw),0,1)]
check_for_run_fw[,Nna_return_105_fw:=ifelse(is.na(return_105_fw),0,1)]
check_for_run_fw[,Nna_return_110_fw:=ifelse(is.na(return_110_fw),0,1)]
check_for_run_fw[,Nna_return_115_fw:=ifelse(is.na(return_115_fw),0,1)]
check_for_run_fw[,Nna_return_120_fw:=ifelse(is.na(return_120_fw),0,1)]
check_for_run_fw[,Nna_return_125_fw:=ifelse(is.na(return_125_fw),0,1)]
check_for_run_fw[,Nna_return_130_fw:=ifelse(is.na(return_130_fw),0,1)]
check_for_run_fw[,Nna_return_135_fw:=ifelse(is.na(return_135_fw),0,1)]
check_for_run_fw[,Nna_return_140_fw:=ifelse(is.na(return_140_fw),0,1)]
check_for_run_fw[,Nna_return_145_fw:=ifelse(is.na(return_145_fw),0,1)]
check_for_run_fw[,Nna_return_150_fw:=ifelse(is.na(return_150_fw),0,1)]
check_for_run_fw[,Nna_return_155_fw:=ifelse(is.na(return_155_fw),0,1)]
check_for_run_fw[,Nna_return_160_fw:=ifelse(is.na(return_160_fw),0,1)]
check_for_run_fw[,Nna_return_165_fw:=ifelse(is.na(return_165_fw),0,1)]
check_for_run_fw[,Nna_return_170_fw:=ifelse(is.na(return_170_fw),0,1)]
check_for_run_fw[,Nna_return_175_fw:=ifelse(is.na(return_175_fw),0,1)]
check_for_run_fw[,Nna_return_180_fw:=ifelse(is.na(return_180_fw),0,1)]
check_for_run_fw[,Nna_return_185_fw:=ifelse(is.na(return_185_fw),0,1)]
check_for_run_fw[,Nna_return_190_fw:=ifelse(is.na(return_190_fw),0,1)]
check_for_run_fw[,Nna_return_195_fw:=ifelse(is.na(return_195_fw),0,1)]
check_for_run_fw[,Nna_return_200_fw:=ifelse(is.na(return_200_fw),0,1)]
check_for_run_fw[,Nna_return_5_lag_p:=ifelse(is.na(return_5_lag_p),0,1)]
check_for_run_fw[,Nna_return_10_lag_p:=ifelse(is.na(return_10_lag_p),0,1)]
check_for_run_fw[,Nna_return_15_lag_p:=ifelse(is.na(return_15_lag_p),0,1)]
check_for_run_fw[,Nna_return_20_lag_p:=ifelse(is.na(return_20_lag_p),0,1)]
check_for_run_fw[,Nna_return_25_lag_p:=ifelse(is.na(return_25_lag_p),0,1)]
check_for_run_fw[,Nna_return_30_lag_p:=ifelse(is.na(return_30_lag_p),0,1)]
check_for_run_fw[,Nna_return_35_lag_p:=ifelse(is.na(return_35_lag_p),0,1)]
check_for_run_fw[,Nna_return_40_lag_p:=ifelse(is.na(return_40_lag_p),0,1)]
check_for_run_fw[,Nna_return_45_lag_p:=ifelse(is.na(return_45_lag_p),0,1)]
check_for_run_fw[,Nna_return_50_lag_p:=ifelse(is.na(return_50_lag_p),0,1)]
check_for_run_fw[,Nna_return_55_lag_p:=ifelse(is.na(return_55_lag_p),0,1)]
check_for_run_fw[,Nna_return_60_lag_p:=ifelse(is.na(return_60_lag_p),0,1)]
check_for_run_fw[,Nna_return_65_lag_p:=ifelse(is.na(return_65_lag_p),0,1)]
check_for_run_fw[,Nna_return_70_lag_p:=ifelse(is.na(return_70_lag_p),0,1)]
check_for_run_fw[,Nna_return_75_lag_p:=ifelse(is.na(return_75_lag_p),0,1)]
check_for_run_fw[,Nna_return_80_lag_p:=ifelse(is.na(return_80_lag_p),0,1)]
check_for_run_fw[,Nna_return_85_lag_p:=ifelse(is.na(return_85_lag_p),0,1)]
check_for_run_fw[,Nna_return_90_lag_p:=ifelse(is.na(return_90_lag_p),0,1)]
check_for_run_fw[,Nna_return_95_lag_p:=ifelse(is.na(return_95_lag_p),0,1)]
check_for_run_fw[,Nna_return_100_lag_p:=ifelse(is.na(return_100_lag_p),0,1)]
check_for_run_fw[,Nna_return_105_lag_p:=ifelse(is.na(return_105_lag_p),0,1)]
check_for_run_fw[,Nna_return_110_lag_p:=ifelse(is.na(return_110_lag_p),0,1)]
check_for_run_fw[,Nna_return_115_lag_p:=ifelse(is.na(return_115_lag_p),0,1)]
check_for_run_fw[,Nna_return_120_lag_p:=ifelse(is.na(return_120_lag_p),0,1)]
check_for_run_fw[,Nna_return_5_lag:=ifelse(is.na(return_5_lag),0,1)]
check_for_run_fw[,Nna_return_10_lag:=ifelse(is.na(return_10_lag),0,1)]
check_for_run_fw[,Nna_return_15_lag:=ifelse(is.na(return_15_lag),0,1)]
check_for_run_fw[,Nna_return_20_lag:=ifelse(is.na(return_20_lag),0,1)]
check_for_run_fw[,Nna_return_25_lag:=ifelse(is.na(return_25_lag),0,1)]
check_for_run_fw[,Nna_return_30_lag:=ifelse(is.na(return_30_lag),0,1)]
check_for_run_fw[,Nna_return_35_lag:=ifelse(is.na(return_35_lag),0,1)]
check_for_run_fw[,Nna_return_40_lag:=ifelse(is.na(return_40_lag),0,1)]
check_for_run_fw[,Nna_return_45_lag:=ifelse(is.na(return_45_lag),0,1)]
check_for_run_fw[,Nna_return_50_lag:=ifelse(is.na(return_50_lag),0,1)]
check_for_run_fw[,Nna_return_55_lag:=ifelse(is.na(return_55_lag),0,1)]
check_for_run_fw[,Nna_return_60_lag:=ifelse(is.na(return_60_lag),0,1)]
check_for_run_fw[,Nna_return_65_lag:=ifelse(is.na(return_65_lag),0,1)]
check_for_run_fw[,Nna_return_70_lag:=ifelse(is.na(return_70_lag),0,1)]
check_for_run_fw[,Nna_return_75_lag:=ifelse(is.na(return_75_lag),0,1)]
check_for_run_fw[,Nna_return_80_lag:=ifelse(is.na(return_80_lag),0,1)]
check_for_run_fw[,Nna_return_85_lag:=ifelse(is.na(return_85_lag),0,1)]
check_for_run_fw[,Nna_return_90_lag:=ifelse(is.na(return_90_lag),0,1)]
check_for_run_fw[,Nna_return_95_lag:=ifelse(is.na(return_95_lag),0,1)]
check_for_run_fw[,Nna_return_100_lag:=ifelse(is.na(return_100_lag),0,1)]
check_for_run_fw[,Nna_return_105_lag:=ifelse(is.na(return_105_lag),0,1)]
check_for_run_fw[,Nna_return_110_lag:=ifelse(is.na(return_110_lag),0,1)]
check_for_run_fw[,Nna_return_115_lag:=ifelse(is.na(return_115_lag),0,1)]
check_for_run_fw[,Nna_return_120_lag:=ifelse(is.na(return_120_lag),0,1)]
check_for_run_fw[,Nna_return_5_fw_p:=ifelse(is.na(return_5_fw_p),0,1)]
check_for_run_fw[,Nna_return_10_fw_p:=ifelse(is.na(return_10_fw_p),0,1)]
check_for_run_fw[,Nna_return_15_fw_p:=ifelse(is.na(return_15_fw_p),0,1)]
check_for_run_fw[,Nna_return_20_fw_p:=ifelse(is.na(return_20_fw_p),0,1)]
check_for_run_fw[,Nna_return_25_fw_p:=ifelse(is.na(return_25_fw_p),0,1)]
check_for_run_fw[,Nna_return_30_fw_p:=ifelse(is.na(return_30_fw_p),0,1)]
check_for_run_fw[,Nna_return_35_fw_p:=ifelse(is.na(return_35_fw_p),0,1)]
check_for_run_fw[,Nna_return_40_fw_p:=ifelse(is.na(return_40_fw_p),0,1)]
check_for_run_fw[,Nna_return_45_fw_p:=ifelse(is.na(return_45_fw_p),0,1)]
check_for_run_fw[,Nna_return_50_fw_p:=ifelse(is.na(return_50_fw_p),0,1)]
check_for_run_fw[,Nna_return_55_fw_p:=ifelse(is.na(return_55_fw_p),0,1)]
check_for_run_fw[,Nna_return_60_fw_p:=ifelse(is.na(return_60_fw_p),0,1)]
check_for_run_fw[,Nna_return_65_fw_p:=ifelse(is.na(return_65_fw_p),0,1)]
check_for_run_fw[,Nna_return_70_fw_p:=ifelse(is.na(return_70_fw_p),0,1)]
check_for_run_fw[,Nna_return_75_fw_p:=ifelse(is.na(return_75_fw_p),0,1)]
check_for_run_fw[,Nna_return_80_fw_p:=ifelse(is.na(return_80_fw_p),0,1)]
check_for_run_fw[,Nna_return_85_fw_p:=ifelse(is.na(return_85_fw_p),0,1)]
check_for_run_fw[,Nna_return_90_fw_p:=ifelse(is.na(return_90_fw_p),0,1)]
check_for_run_fw[,Nna_return_95_fw_p:=ifelse(is.na(return_95_fw_p),0,1)]
check_for_run_fw[,Nna_return_100_fw_p:=ifelse(is.na(return_100_fw_p),0,1)]
check_for_run_fw[,Nna_return_105_fw_p:=ifelse(is.na(return_105_fw_p),0,1)]
check_for_run_fw[,Nna_return_110_fw_p:=ifelse(is.na(return_110_fw_p),0,1)]
check_for_run_fw[,Nna_return_115_fw_p:=ifelse(is.na(return_115_fw_p),0,1)]
check_for_run_fw[,Nna_return_120_fw_p:=ifelse(is.na(return_120_fw_p),0,1)]
check_for_run_fw[,Nna_return_125_fw_p:=ifelse(is.na(return_125_fw_p),0,1)]
check_for_run_fw[,Nna_return_130_fw_p:=ifelse(is.na(return_130_fw_p),0,1)]
check_for_run_fw[,Nna_return_135_fw_p:=ifelse(is.na(return_135_fw_p),0,1)]
check_for_run_fw[,Nna_return_140_fw_p:=ifelse(is.na(return_140_fw_p),0,1)]
check_for_run_fw[,Nna_return_145_fw_p:=ifelse(is.na(return_145_fw_p),0,1)]
check_for_run_fw[,Nna_return_150_fw_p:=ifelse(is.na(return_150_fw_p),0,1)]
check_for_run_fw[,Nna_return_155_fw_p:=ifelse(is.na(return_155_fw_p),0,1)]
check_for_run_fw[,Nna_return_160_fw_p:=ifelse(is.na(return_160_fw_p),0,1)]
check_for_run_fw[,Nna_return_165_fw_p:=ifelse(is.na(return_165_fw_p),0,1)]
check_for_run_fw[,Nna_return_170_fw_p:=ifelse(is.na(return_170_fw_p),0,1)]
check_for_run_fw[,Nna_return_175_fw_p:=ifelse(is.na(return_175_fw_p),0,1)]
check_for_run_fw[,Nna_return_180_fw_p:=ifelse(is.na(return_180_fw_p),0,1)]
check_for_run_fw[,Nna_return_185_fw_p:=ifelse(is.na(return_185_fw_p),0,1)]
check_for_run_fw[,Nna_return_190_fw_p:=ifelse(is.na(return_190_fw_p),0,1)]
check_for_run_fw[,Nna_return_195_fw_p:=ifelse(is.na(return_195_fw_p),0,1)]
check_for_run_fw[,Nna_return_200_fw_p:=ifelse(is.na(return_200_fw_p),0,1)]

check_for_run_fw[,wp_group:=cut(winning_prop,breaks = seq(0,1,0.25),include.lowest = TRUE)]

```


```{r}
transaction2 <- transaction[,.(sedol, anon, date_formated, quantity, net_cost)]
portfolio_stock_composition <- merge(portfolio_stock_composition, transaction2, 
                                     by=c("anon","date_formated","sedol"), all.x=TRUE)
portfolio_stock_composition[,buy:=ifelse(net_cost>0,1,0)]
portfolio_stock_composition[is.na(buy), buy:=0]
portfolio_stock_composition[,buyday:=sum(buy), by=c("anon","date_formated")]
portfolio_buyday <- portfolio_stock_composition[buyday>0]
```

```{r}
portfolio_unchange_buyday <- portfolio_buyday[is.na(net_cost)]
portfolio_unchange_buyday <- portfolio_unchange_buyday[anon %in% unique(check_for_run$anon)]

portfolio_unchange_buyday <- merge(portfolio_unchange_buyday, pp_ext, by=c("sedol", "date_formated"), all.x=TRUE)

```
```{r}
portfolio_unchange_buyday[,return_5_fw:=Winsorize(return_5_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_10_fw:=Winsorize(return_10_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_15_fw:=Winsorize(return_15_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_20_fw:=Winsorize(return_20_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_25_fw:=Winsorize(return_25_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_30_fw:=Winsorize(return_30_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_35_fw:=Winsorize(return_35_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_40_fw:=Winsorize(return_40_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_45_fw:=Winsorize(return_45_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_50_fw:=Winsorize(return_50_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_55_fw:=Winsorize(return_55_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_60_fw:=Winsorize(return_60_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_65_fw:=Winsorize(return_65_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_70_fw:=Winsorize(return_70_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_75_fw:=Winsorize(return_75_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_80_fw:=Winsorize(return_80_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_85_fw:=Winsorize(return_85_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_90_fw:=Winsorize(return_90_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_95_fw:=Winsorize(return_95_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_100_fw:=Winsorize(return_100_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_105_fw:=Winsorize(return_105_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_110_fw:=Winsorize(return_110_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_115_fw:=Winsorize(return_115_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_120_fw:=Winsorize(return_120_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_125_fw:=Winsorize(return_125_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_130_fw:=Winsorize(return_130_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_135_fw:=Winsorize(return_135_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_140_fw:=Winsorize(return_140_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_145_fw:=Winsorize(return_145_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_150_fw:=Winsorize(return_150_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_155_fw:=Winsorize(return_155_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_160_fw:=Winsorize(return_160_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_165_fw:=Winsorize(return_165_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_170_fw:=Winsorize(return_170_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_175_fw:=Winsorize(return_175_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_180_fw:=Winsorize(return_180_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_185_fw:=Winsorize(return_185_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_190_fw:=Winsorize(return_190_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_195_fw:=Winsorize(return_195_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_200_fw:=Winsorize(return_200_fw, probs = c(0.01,0.99),na.rm=TRUE)]

portfolio_unchange_buyday[,return_5_lag_p:=Winsorize(return_5_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_10_lag_p:=Winsorize(return_10_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_15_lag_p:=Winsorize(return_15_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_20_lag_p:=Winsorize(return_20_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_25_lag_p:=Winsorize(return_25_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_30_lag_p:=Winsorize(return_30_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_35_lag_p:=Winsorize(return_35_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_40_lag_p:=Winsorize(return_40_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_45_lag_p:=Winsorize(return_45_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_50_lag_p:=Winsorize(return_50_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_55_lag_p:=Winsorize(return_55_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_60_lag_p:=Winsorize(return_60_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_65_lag_p:=Winsorize(return_65_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_70_lag_p:=Winsorize(return_70_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_75_lag_p:=Winsorize(return_75_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_80_lag_p:=Winsorize(return_80_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_85_lag_p:=Winsorize(return_85_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_90_lag_p:=Winsorize(return_90_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_95_lag_p:=Winsorize(return_95_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_100_lag_p:=Winsorize(return_100_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_105_lag_p:=Winsorize(return_105_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_110_lag_p:=Winsorize(return_110_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_115_lag_p:=Winsorize(return_115_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_120_lag_p:=Winsorize(return_120_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]

portfolio_unchange_buyday[,return_5_lag:=Winsorize(return_5_lag, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_10_lag:=Winsorize(return_10_lag, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_15_lag:=Winsorize(return_15_lag, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_20_lag:=Winsorize(return_20_lag, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_25_lag:=Winsorize(return_25_lag, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_30_lag:=Winsorize(return_30_lag, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_35_lag:=Winsorize(return_35_lag, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_40_lag:=Winsorize(return_40_lag, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_45_lag:=Winsorize(return_45_lag, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_50_lag:=Winsorize(return_50_lag, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_55_lag:=Winsorize(return_55_lag, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_60_lag:=Winsorize(return_60_lag, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_65_lag:=Winsorize(return_65_lag, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_70_lag:=Winsorize(return_70_lag, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_75_lag:=Winsorize(return_75_lag, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_80_lag:=Winsorize(return_80_lag, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_85_lag:=Winsorize(return_85_lag, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_90_lag:=Winsorize(return_90_lag, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_95_lag:=Winsorize(return_95_lag, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_100_lag:=Winsorize(return_100_lag, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_105_lag:=Winsorize(return_105_lag, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_110_lag:=Winsorize(return_110_lag, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_115_lag:=Winsorize(return_115_lag, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_120_lag:=Winsorize(return_120_lag, probs = c(0.01,0.99),na.rm=TRUE)]


portfolio_unchange_buyday[,Nna_return_5_fw:=ifelse(is.na(return_5_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_10_fw:=ifelse(is.na(return_10_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_15_fw:=ifelse(is.na(return_15_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_20_fw:=ifelse(is.na(return_20_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_25_fw:=ifelse(is.na(return_25_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_30_fw:=ifelse(is.na(return_30_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_35_fw:=ifelse(is.na(return_35_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_40_fw:=ifelse(is.na(return_40_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_45_fw:=ifelse(is.na(return_45_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_50_fw:=ifelse(is.na(return_50_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_55_fw:=ifelse(is.na(return_55_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_60_fw:=ifelse(is.na(return_60_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_65_fw:=ifelse(is.na(return_65_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_70_fw:=ifelse(is.na(return_70_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_75_fw:=ifelse(is.na(return_75_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_80_fw:=ifelse(is.na(return_80_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_85_fw:=ifelse(is.na(return_85_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_90_fw:=ifelse(is.na(return_90_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_95_fw:=ifelse(is.na(return_95_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_100_fw:=ifelse(is.na(return_100_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_105_fw:=ifelse(is.na(return_105_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_110_fw:=ifelse(is.na(return_110_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_115_fw:=ifelse(is.na(return_115_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_120_fw:=ifelse(is.na(return_120_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_125_fw:=ifelse(is.na(return_125_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_130_fw:=ifelse(is.na(return_130_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_135_fw:=ifelse(is.na(return_135_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_140_fw:=ifelse(is.na(return_140_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_145_fw:=ifelse(is.na(return_145_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_150_fw:=ifelse(is.na(return_150_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_155_fw:=ifelse(is.na(return_155_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_160_fw:=ifelse(is.na(return_160_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_165_fw:=ifelse(is.na(return_165_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_170_fw:=ifelse(is.na(return_170_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_175_fw:=ifelse(is.na(return_175_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_180_fw:=ifelse(is.na(return_180_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_185_fw:=ifelse(is.na(return_185_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_190_fw:=ifelse(is.na(return_190_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_195_fw:=ifelse(is.na(return_195_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_200_fw:=ifelse(is.na(return_200_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_5_lag_p:=ifelse(is.na(return_5_lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_10_lag_p:=ifelse(is.na(return_10_lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_15_lag_p:=ifelse(is.na(return_15_lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_20_lag_p:=ifelse(is.na(return_20_lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_25_lag_p:=ifelse(is.na(return_25_lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_30_lag_p:=ifelse(is.na(return_30_lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_35_lag_p:=ifelse(is.na(return_35_lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_40_lag_p:=ifelse(is.na(return_40_lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_45_lag_p:=ifelse(is.na(return_45_lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_50_lag_p:=ifelse(is.na(return_50_lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_55_lag_p:=ifelse(is.na(return_55_lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_60_lag_p:=ifelse(is.na(return_60_lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_65_lag_p:=ifelse(is.na(return_65_lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_70_lag_p:=ifelse(is.na(return_70_lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_75_lag_p:=ifelse(is.na(return_75_lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_80_lag_p:=ifelse(is.na(return_80_lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_85_lag_p:=ifelse(is.na(return_85_lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_90_lag_p:=ifelse(is.na(return_90_lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_95_lag_p:=ifelse(is.na(return_95_lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_100_lag_p:=ifelse(is.na(return_100_lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_105_lag_p:=ifelse(is.na(return_105_lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_110_lag_p:=ifelse(is.na(return_110_lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_115_lag_p:=ifelse(is.na(return_115_lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_120_lag_p:=ifelse(is.na(return_120_lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_5_lag:=ifelse(is.na(return_5_lag),0,1)]
portfolio_unchange_buyday[,Nna_return_10_lag:=ifelse(is.na(return_10_lag),0,1)]
portfolio_unchange_buyday[,Nna_return_15_lag:=ifelse(is.na(return_15_lag),0,1)]
portfolio_unchange_buyday[,Nna_return_20_lag:=ifelse(is.na(return_20_lag),0,1)]
portfolio_unchange_buyday[,Nna_return_25_lag:=ifelse(is.na(return_25_lag),0,1)]
portfolio_unchange_buyday[,Nna_return_30_lag:=ifelse(is.na(return_30_lag),0,1)]
portfolio_unchange_buyday[,Nna_return_35_lag:=ifelse(is.na(return_35_lag),0,1)]
portfolio_unchange_buyday[,Nna_return_40_lag:=ifelse(is.na(return_40_lag),0,1)]
portfolio_unchange_buyday[,Nna_return_45_lag:=ifelse(is.na(return_45_lag),0,1)]
portfolio_unchange_buyday[,Nna_return_50_lag:=ifelse(is.na(return_50_lag),0,1)]
portfolio_unchange_buyday[,Nna_return_55_lag:=ifelse(is.na(return_55_lag),0,1)]
portfolio_unchange_buyday[,Nna_return_60_lag:=ifelse(is.na(return_60_lag),0,1)]
portfolio_unchange_buyday[,Nna_return_65_lag:=ifelse(is.na(return_65_lag),0,1)]
portfolio_unchange_buyday[,Nna_return_70_lag:=ifelse(is.na(return_70_lag),0,1)]
portfolio_unchange_buyday[,Nna_return_75_lag:=ifelse(is.na(return_75_lag),0,1)]
portfolio_unchange_buyday[,Nna_return_80_lag:=ifelse(is.na(return_80_lag),0,1)]
portfolio_unchange_buyday[,Nna_return_85_lag:=ifelse(is.na(return_85_lag),0,1)]
portfolio_unchange_buyday[,Nna_return_90_lag:=ifelse(is.na(return_90_lag),0,1)]
portfolio_unchange_buyday[,Nna_return_95_lag:=ifelse(is.na(return_95_lag),0,1)]
portfolio_unchange_buyday[,Nna_return_100_lag:=ifelse(is.na(return_100_lag),0,1)]
portfolio_unchange_buyday[,Nna_return_105_lag:=ifelse(is.na(return_105_lag),0,1)]
portfolio_unchange_buyday[,Nna_return_110_lag:=ifelse(is.na(return_110_lag),0,1)]
portfolio_unchange_buyday[,Nna_return_115_lag:=ifelse(is.na(return_115_lag),0,1)]
portfolio_unchange_buyday[,Nna_return_120_lag:=ifelse(is.na(return_120_lag),0,1)]
portfolio_unchange_buyday[,Nna_return_5_fw_p:=ifelse(is.na(return_5_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_10_fw_p:=ifelse(is.na(return_10_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_15_fw_p:=ifelse(is.na(return_15_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_20_fw_p:=ifelse(is.na(return_20_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_25_fw_p:=ifelse(is.na(return_25_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_30_fw_p:=ifelse(is.na(return_30_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_35_fw_p:=ifelse(is.na(return_35_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_40_fw_p:=ifelse(is.na(return_40_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_45_fw_p:=ifelse(is.na(return_45_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_50_fw_p:=ifelse(is.na(return_50_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_55_fw_p:=ifelse(is.na(return_55_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_60_fw_p:=ifelse(is.na(return_60_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_65_fw_p:=ifelse(is.na(return_65_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_70_fw_p:=ifelse(is.na(return_70_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_75_fw_p:=ifelse(is.na(return_75_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_80_fw_p:=ifelse(is.na(return_80_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_85_fw_p:=ifelse(is.na(return_85_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_90_fw_p:=ifelse(is.na(return_90_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_95_fw_p:=ifelse(is.na(return_95_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_100_fw_p:=ifelse(is.na(return_100_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_105_fw_p:=ifelse(is.na(return_105_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_110_fw_p:=ifelse(is.na(return_110_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_115_fw_p:=ifelse(is.na(return_115_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_120_fw_p:=ifelse(is.na(return_120_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_125_fw_p:=ifelse(is.na(return_125_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_130_fw_p:=ifelse(is.na(return_130_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_135_fw_p:=ifelse(is.na(return_135_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_140_fw_p:=ifelse(is.na(return_140_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_145_fw_p:=ifelse(is.na(return_145_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_150_fw_p:=ifelse(is.na(return_150_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_155_fw_p:=ifelse(is.na(return_155_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_160_fw_p:=ifelse(is.na(return_160_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_165_fw_p:=ifelse(is.na(return_165_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_170_fw_p:=ifelse(is.na(return_170_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_175_fw_p:=ifelse(is.na(return_175_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_180_fw_p:=ifelse(is.na(return_180_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_185_fw_p:=ifelse(is.na(return_185_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_190_fw_p:=ifelse(is.na(return_190_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_195_fw_p:=ifelse(is.na(return_195_fw_p),0,1)]
portfolio_unchange_buyday[,Nna_return_200_fw_p:=ifelse(is.na(return_200_fw_p),0,1)]


```

## plot



```{r}

check_for_run_lag_plot <- check_for_run_fw[,.(
mean_return_0=0,sd_0=0, N_0=1,
mean_return_5=mean(return_5_lag_p,na.rm=TRUE),sd_5=sd(return_5_lag_p,na.rm=TRUE), N_5=sum(Nna_return_5_lag_p),
mean_return_10=mean(return_10_lag_p,na.rm=TRUE),sd_10=sd(return_10_lag_p,na.rm=TRUE), N_10=sum(Nna_return_10_lag_p),
mean_return_15=mean(return_15_lag_p,na.rm=TRUE),sd_15=sd(return_15_lag_p,na.rm=TRUE), N_15=sum(Nna_return_15_lag_p),
mean_return_20=mean(return_20_lag_p,na.rm=TRUE),sd_20=sd(return_20_lag_p,na.rm=TRUE), N_20=sum(Nna_return_20_lag_p),
mean_return_25=mean(return_25_lag_p,na.rm=TRUE),sd_25=sd(return_25_lag_p,na.rm=TRUE), N_25=sum(Nna_return_25_lag_p),
mean_return_30=mean(return_30_lag_p,na.rm=TRUE),sd_30=sd(return_30_lag_p,na.rm=TRUE), N_30=sum(Nna_return_30_lag_p),
mean_return_35=mean(return_35_lag_p,na.rm=TRUE),sd_35=sd(return_35_lag_p,na.rm=TRUE), N_35=sum(Nna_return_35_lag_p),
mean_return_40=mean(return_40_lag_p,na.rm=TRUE),sd_40=sd(return_40_lag_p,na.rm=TRUE), N_40=sum(Nna_return_40_lag_p),
mean_return_45=mean(return_45_lag_p,na.rm=TRUE),sd_45=sd(return_45_lag_p,na.rm=TRUE), N_45=sum(Nna_return_45_lag_p),
mean_return_50=mean(return_50_lag_p,na.rm=TRUE),sd_50=sd(return_50_lag_p,na.rm=TRUE), N_50=sum(Nna_return_50_lag_p),
mean_return_55=mean(return_55_lag_p,na.rm=TRUE),sd_55=sd(return_55_lag_p,na.rm=TRUE), N_55=sum(Nna_return_55_lag_p),
mean_return_60=mean(return_60_lag_p,na.rm=TRUE),sd_60=sd(return_60_lag_p,na.rm=TRUE), N_60=sum(Nna_return_60_lag_p),
mean_return_65=mean(return_65_lag_p,na.rm=TRUE),sd_65=sd(return_65_lag_p,na.rm=TRUE), N_65=sum(Nna_return_65_lag_p),
mean_return_70=mean(return_70_lag_p,na.rm=TRUE),sd_70=sd(return_70_lag_p,na.rm=TRUE), N_70=sum(Nna_return_70_lag_p),
mean_return_75=mean(return_75_lag_p,na.rm=TRUE),sd_75=sd(return_75_lag_p,na.rm=TRUE), N_75=sum(Nna_return_75_lag_p),
mean_return_80=mean(return_80_lag_p,na.rm=TRUE),sd_80=sd(return_80_lag_p,na.rm=TRUE), N_80=sum(Nna_return_80_lag_p),
mean_return_85=mean(return_85_lag_p,na.rm=TRUE),sd_85=sd(return_85_lag_p,na.rm=TRUE), N_85=sum(Nna_return_85_lag_p),
mean_return_90=mean(return_90_lag_p,na.rm=TRUE),sd_90=sd(return_90_lag_p,na.rm=TRUE), N_90=sum(Nna_return_90_lag_p),
mean_return_95=mean(return_95_lag_p,na.rm=TRUE),sd_95=sd(return_95_lag_p,na.rm=TRUE), N_95=sum(Nna_return_95_lag_p),
mean_return_100=mean(return_100_lag_p,na.rm=TRUE),sd_100=sd(return_100_lag_p,na.rm=TRUE), N_100=sum(Nna_return_100_lag_p),
mean_return_105=mean(return_105_lag_p,na.rm=TRUE),sd_105=sd(return_105_lag_p,na.rm=TRUE), N_105=sum(Nna_return_105_lag_p),
mean_return_110=mean(return_110_lag_p,na.rm=TRUE),sd_110=sd(return_110_lag_p,na.rm=TRUE), N_110=sum(Nna_return_110_lag_p),
mean_return_115=mean(return_115_lag_p,na.rm=TRUE),sd_115=sd(return_115_lag_p,na.rm=TRUE), N_115=sum(Nna_return_115_lag_p),
mean_return_120=mean(return_120_lag_p,na.rm=TRUE),sd_120=sd(return_120_lag_p,na.rm=TRUE), N_120=sum(Nna_return_120_lag_p)
), by="new_stock"]



check_for_run_fw_plot_a <- melt(check_for_run_lag_plot, id.vars="new_stock")
check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a[grepl("sd",variable)]
setnames(check_for_run_fw_plot_a_1, "value", "sd")
#check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a_1[,.(sd=mean(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_1[,days:=rep(seq(0,-120,-5),each=2)]
check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a[grepl("mean",variable)]
setnames(check_for_run_fw_plot_a_2, "value", "mean")
#check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a_2[,.(mean=mean(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_2[,days:=rep(seq(0,-120,-5),each=2)]
check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a[grepl("N",variable)]
setnames(check_for_run_fw_plot_a_3, "value", "N")
#check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a_3[,.(N=min(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_3[,days:=rep(seq(0,-120,-5),each=2)]
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a_1, check_for_run_fw_plot_a_2, by=c("new_stock","days"), all.x=TRUE)
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a, check_for_run_fw_plot_a_3, by=c("new_stock","days"), all.x=TRUE)
check_for_run_fw_plot_a[,upper_ci:=mean+1.96*sd/sqrt(N)]
check_for_run_fw_plot_a[,lower_ci:=mean-1.96*sd/sqrt(N)]
check_for_run_fw_plot_a[,Category:="Purchase - invested stock"]
check_for_run_fw_plot_a[new_stock==1,Category:="New purchase"]
#check_for_run_fw_plot_a[order==2,Category:="New purchase - new industry"]
check_for_run_fw_plot_a$Category <- factor(check_for_run_fw_plot_a$Category, levels = c("Purchase - invested stock", "New purchase"))
#check_for_run_fw_plot[,type2:=paste(type,wp_group)]

# check_for_run_fw_plot$type2 <- factor(check_for_run_fw_plot$type2, levels = c("top up after positive rsp","top up after negative rsp", "new buy-invested industry after positive rsp", "new buy-invested industry after negative rsp", "new buy-new industry after positive rsp", "new buy-new industry after negative rsp"))

pd <- position_dodge(0.09) # move them .05 to the left and right



(g6 <- ggplot(check_for_run_fw_plot_a,aes(x=days,y=mean,color=Category))+
       geom_ribbon(aes(ymin=lower_ci, ymax=upper_ci),alpha = .3, linetype=0) +
       geom_line(position=pd) +  xlab("Number of Working Days After the Purchase") + ylab("Return ") )
```

```{r}
portfolio_unchange_buyday2 <- merge(portfolio_unchange_buyday, portfolios_return, 
                                   by=c("date_formated", "anon"))
portfolio_unchange_buyday2 <- portfolio_unchange_buyday2[!(is.na(winning_prop))]
portfolio_unchange_buyday2 <- portfolio_unchange_buyday2[anon %in% unique(check_for_run_fw$anon)]
portfolio_unchange_buyday_lag_plot <- portfolio_unchange_buyday2[,.(
mean_return_0=0,sd_0=0, N_0=1,
mean_return_5=mean(return_5_lag_p,na.rm=TRUE),sd_5=sd(return_5_lag_p,na.rm=TRUE), N_5=sum(Nna_return_5_lag_p),
mean_return_10=mean(return_10_lag_p,na.rm=TRUE),sd_10=sd(return_10_lag_p,na.rm=TRUE), N_10=sum(Nna_return_10_lag_p),
mean_return_15=mean(return_15_lag_p,na.rm=TRUE),sd_15=sd(return_15_lag_p,na.rm=TRUE), N_15=sum(Nna_return_15_lag_p),
mean_return_20=mean(return_20_lag_p,na.rm=TRUE),sd_20=sd(return_20_lag_p,na.rm=TRUE), N_20=sum(Nna_return_20_lag_p),
mean_return_25=mean(return_25_lag_p,na.rm=TRUE),sd_25=sd(return_25_lag_p,na.rm=TRUE), N_25=sum(Nna_return_25_lag_p),
mean_return_30=mean(return_30_lag_p,na.rm=TRUE),sd_30=sd(return_30_lag_p,na.rm=TRUE), N_30=sum(Nna_return_30_lag_p),
mean_return_35=mean(return_35_lag_p,na.rm=TRUE),sd_35=sd(return_35_lag_p,na.rm=TRUE), N_35=sum(Nna_return_35_lag_p),
mean_return_40=mean(return_40_lag_p,na.rm=TRUE),sd_40=sd(return_40_lag_p,na.rm=TRUE), N_40=sum(Nna_return_40_lag_p),
mean_return_45=mean(return_45_lag_p,na.rm=TRUE),sd_45=sd(return_45_lag_p,na.rm=TRUE), N_45=sum(Nna_return_45_lag_p),
mean_return_50=mean(return_50_lag_p,na.rm=TRUE),sd_50=sd(return_50_lag_p,na.rm=TRUE), N_50=sum(Nna_return_50_lag_p),
mean_return_55=mean(return_55_lag_p,na.rm=TRUE),sd_55=sd(return_55_lag_p,na.rm=TRUE), N_55=sum(Nna_return_55_lag_p),
mean_return_60=mean(return_60_lag_p,na.rm=TRUE),sd_60=sd(return_60_lag_p,na.rm=TRUE), N_60=sum(Nna_return_60_lag_p),
mean_return_65=mean(return_65_lag_p,na.rm=TRUE),sd_65=sd(return_65_lag_p,na.rm=TRUE), N_65=sum(Nna_return_65_lag_p),
mean_return_70=mean(return_70_lag_p,na.rm=TRUE),sd_70=sd(return_70_lag_p,na.rm=TRUE), N_70=sum(Nna_return_70_lag_p),
mean_return_75=mean(return_75_lag_p,na.rm=TRUE),sd_75=sd(return_75_lag_p,na.rm=TRUE), N_75=sum(Nna_return_75_lag_p),
mean_return_80=mean(return_80_lag_p,na.rm=TRUE),sd_80=sd(return_80_lag_p,na.rm=TRUE), N_80=sum(Nna_return_80_lag_p),
mean_return_85=mean(return_85_lag_p,na.rm=TRUE),sd_85=sd(return_85_lag_p,na.rm=TRUE), N_85=sum(Nna_return_85_lag_p),
mean_return_90=mean(return_90_lag_p,na.rm=TRUE),sd_90=sd(return_90_lag_p,na.rm=TRUE), N_90=sum(Nna_return_90_lag_p),
mean_return_95=mean(return_95_lag_p,na.rm=TRUE),sd_95=sd(return_95_lag_p,na.rm=TRUE), N_95=sum(Nna_return_95_lag_p),
mean_return_100=mean(return_100_lag_p,na.rm=TRUE),sd_100=sd(return_100_lag_p,na.rm=TRUE), N_100=sum(Nna_return_100_lag_p),
mean_return_105=mean(return_105_lag_p,na.rm=TRUE),sd_105=sd(return_105_lag_p,na.rm=TRUE), N_105=sum(Nna_return_105_lag_p),
mean_return_110=mean(return_110_lag_p,na.rm=TRUE),sd_110=sd(return_110_lag_p,na.rm=TRUE), N_110=sum(Nna_return_110_lag_p),
mean_return_115=mean(return_115_lag_p,na.rm=TRUE),sd_115=sd(return_115_lag_p,na.rm=TRUE), N_115=sum(Nna_return_115_lag_p),
mean_return_120=mean(return_120_lag_p,na.rm=TRUE),sd_120=sd(return_120_lag_p,na.rm=TRUE), N_120=sum(Nna_return_120_lag_p)
)]



portfolio_unchange_buyday_plot <- t(portfolio_unchange_buyday_lag_plot)
rnames <- row.names(portfolio_unchange_buyday_plot)
portfolio_unchange_buyday_plot <- as.data.table(portfolio_unchange_buyday_plot)
portfolio_unchange_buyday_plot[,variable:=rnames]
setnames(portfolio_unchange_buyday_plot,"V1","value")
#check_for_run_fw_plot_a <- melt(check_for_run_fw_plot, id.vars="new_stock")
portfolio_unchange_buyday_plot_a_1 <- portfolio_unchange_buyday_plot[grepl("sd",variable)]
setnames(portfolio_unchange_buyday_plot_a_1, "value", "sd")
#check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a_1[,.(sd=mean(value,na.rm=TRUE)),by=c("order", "variable")]
portfolio_unchange_buyday_plot_a_1[,days:=rep(seq(0,-120,-5),each=1)]
portfolio_unchange_buyday_plot_a_2 <-portfolio_unchange_buyday_plot[grepl("mean",variable)]
setnames(portfolio_unchange_buyday_plot_a_2, "value", "mean")
#check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a_2[,.(mean=mean(value,na.rm=TRUE)),by=c("order", "variable")]
portfolio_unchange_buyday_plot_a_2[,days:=rep(seq(0,-120,-5),each=1)]
portfolio_unchange_buyday_plot_a_3 <-portfolio_unchange_buyday_plot[grepl("N",variable)]
setnames(portfolio_unchange_buyday_plot_a_3, "value", "N")
#check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a_3[,.(N=min(value,na.rm=TRUE)),by=c("order", "variable")]
portfolio_unchange_buyday_plot_a_3[,days:=rep(seq(0,-120,-5),each=1)]
portfolio_unchange_buyday_plot_a <- merge(portfolio_unchange_buyday_plot_a_1, portfolio_unchange_buyday_plot_a_2, by="days", all.x=TRUE)
portfolio_unchange_buyday_plot_a <- merge(portfolio_unchange_buyday_plot_a, portfolio_unchange_buyday_plot_a_3, by="days", all.x=TRUE)
portfolio_unchange_buyday_plot_a[,upper_ci:=mean+1.96*sd/sqrt(N)]
portfolio_unchange_buyday_plot_a[,lower_ci:=mean-1.96*sd/sqrt(N)]

pd <- position_dodge(0.09) # move them .05 to the left and right
portfolio_unchange_buyday_plot_a[,Category:="Untouched Stocks"]
portfolio_unchange_buyday_plot_a[,new_stock:=NA]
check_for_run_fw_plot_b <- rbind(check_for_run_fw_plot_a, portfolio_unchange_buyday_plot_a)


(g6 <- ggplot(check_for_run_fw_plot_b,aes(x=days,y=mean, color=Category))+
       geom_ribbon(aes(ymin=lower_ci, ymax=upper_ci),alpha = .3, linetype=0) +
       geom_line(position=pd) +  
    xlab("Number of Working Days After the Purchase") + ylab("Return") )
ggsave(g6, file="G:/rank/new_ind/codes/codes with more anon dataset/preret_threegroups.png",width = 7.29, height = 4.5)
```



```{r}

check_for_run_fw_plot <- check_for_run_fw[,.(
mean_return_0=0,sd_0=0, N_0=1,
mean_return_5=mean(return_5_fw,na.rm=TRUE),sd_5=sd(return_5_fw,na.rm=TRUE), N_5=sum(Nna_return_5_fw),
mean_return_10=mean(return_10_fw,na.rm=TRUE),sd_10=sd(return_10_fw,na.rm=TRUE), N_10=sum(Nna_return_10_fw),
mean_return_15=mean(return_15_fw,na.rm=TRUE),sd_15=sd(return_15_fw,na.rm=TRUE), N_15=sum(Nna_return_15_fw),
mean_return_20=mean(return_20_fw,na.rm=TRUE),sd_20=sd(return_20_fw,na.rm=TRUE), N_20=sum(Nna_return_20_fw),
mean_return_25=mean(return_25_fw,na.rm=TRUE),sd_25=sd(return_25_fw,na.rm=TRUE), N_25=sum(Nna_return_25_fw),
mean_return_30=mean(return_30_fw,na.rm=TRUE),sd_30=sd(return_30_fw,na.rm=TRUE), N_30=sum(Nna_return_30_fw),
mean_return_35=mean(return_35_fw,na.rm=TRUE),sd_35=sd(return_35_fw,na.rm=TRUE), N_35=sum(Nna_return_35_fw),
mean_return_40=mean(return_40_fw,na.rm=TRUE),sd_40=sd(return_40_fw,na.rm=TRUE), N_40=sum(Nna_return_40_fw),
mean_return_45=mean(return_45_fw,na.rm=TRUE),sd_45=sd(return_45_fw,na.rm=TRUE), N_45=sum(Nna_return_45_fw),
mean_return_50=mean(return_50_fw,na.rm=TRUE),sd_50=sd(return_50_fw,na.rm=TRUE), N_50=sum(Nna_return_50_fw),
mean_return_55=mean(return_55_fw,na.rm=TRUE),sd_55=sd(return_55_fw,na.rm=TRUE), N_55=sum(Nna_return_55_fw),
mean_return_60=mean(return_60_fw,na.rm=TRUE),sd_60=sd(return_60_fw,na.rm=TRUE), N_60=sum(Nna_return_60_fw),
mean_return_65=mean(return_65_fw,na.rm=TRUE),sd_65=sd(return_65_fw,na.rm=TRUE), N_65=sum(Nna_return_65_fw),
mean_return_70=mean(return_70_fw,na.rm=TRUE),sd_70=sd(return_70_fw,na.rm=TRUE), N_70=sum(Nna_return_70_fw),
mean_return_75=mean(return_75_fw,na.rm=TRUE),sd_75=sd(return_75_fw,na.rm=TRUE), N_75=sum(Nna_return_75_fw),
mean_return_80=mean(return_80_fw,na.rm=TRUE),sd_80=sd(return_80_fw,na.rm=TRUE), N_80=sum(Nna_return_80_fw),
mean_return_85=mean(return_85_fw,na.rm=TRUE),sd_85=sd(return_85_fw,na.rm=TRUE), N_85=sum(Nna_return_85_fw),
mean_return_90=mean(return_90_fw,na.rm=TRUE),sd_90=sd(return_90_fw,na.rm=TRUE), N_90=sum(Nna_return_90_fw),
mean_return_95=mean(return_95_fw,na.rm=TRUE),sd_95=sd(return_95_fw,na.rm=TRUE), N_95=sum(Nna_return_95_fw),
mean_return_100=mean(return_100_fw,na.rm=TRUE),sd_100=sd(return_100_fw,na.rm=TRUE), N_100=sum(Nna_return_100_fw),
mean_return_105=mean(return_105_fw,na.rm=TRUE),sd_105=sd(return_105_fw,na.rm=TRUE), N_105=sum(Nna_return_105_fw),
mean_return_110=mean(return_110_fw,na.rm=TRUE),sd_110=sd(return_110_fw,na.rm=TRUE), N_110=sum(Nna_return_110_fw),
mean_return_115=mean(return_115_fw,na.rm=TRUE),sd_115=sd(return_115_fw,na.rm=TRUE), N_115=sum(Nna_return_115_fw),
mean_return_120=mean(return_120_fw,na.rm=TRUE),sd_120=sd(return_120_fw,na.rm=TRUE), N_120=sum(Nna_return_120_fw),
mean_return_125=mean(return_125_fw,na.rm=TRUE),sd_125=sd(return_125_fw,na.rm=TRUE), N_125=sum(Nna_return_125_fw),
mean_return_130=mean(return_130_fw,na.rm=TRUE),sd_130=sd(return_130_fw,na.rm=TRUE), N_130=sum(Nna_return_130_fw),
mean_return_135=mean(return_135_fw,na.rm=TRUE),sd_135=sd(return_135_fw,na.rm=TRUE), N_135=sum(Nna_return_135_fw),
mean_return_140=mean(return_140_fw,na.rm=TRUE),sd_140=sd(return_140_fw,na.rm=TRUE), N_140=sum(Nna_return_140_fw),
mean_return_145=mean(return_145_fw,na.rm=TRUE),sd_145=sd(return_145_fw,na.rm=TRUE), N_145=sum(Nna_return_145_fw),
mean_return_150=mean(return_150_fw,na.rm=TRUE),sd_150=sd(return_150_fw,na.rm=TRUE), N_150=sum(Nna_return_150_fw),
mean_return_155=mean(return_155_fw,na.rm=TRUE),sd_155=sd(return_155_fw,na.rm=TRUE), N_155=sum(Nna_return_155_fw),
mean_return_160=mean(return_160_fw,na.rm=TRUE),sd_160=sd(return_160_fw,na.rm=TRUE), N_160=sum(Nna_return_160_fw),
mean_return_165=mean(return_165_fw,na.rm=TRUE),sd_165=sd(return_165_fw,na.rm=TRUE), N_165=sum(Nna_return_165_fw),
mean_return_170=mean(return_170_fw,na.rm=TRUE),sd_170=sd(return_170_fw,na.rm=TRUE), N_170=sum(Nna_return_170_fw),
mean_return_175=mean(return_175_fw,na.rm=TRUE),sd_175=sd(return_175_fw,na.rm=TRUE), N_175=sum(Nna_return_175_fw),
mean_return_180=mean(return_180_fw,na.rm=TRUE),sd_180=sd(return_180_fw,na.rm=TRUE), N_180=sum(Nna_return_180_fw),
mean_return_185=mean(return_185_fw,na.rm=TRUE),sd_185=sd(return_185_fw,na.rm=TRUE), N_185=sum(Nna_return_185_fw),
mean_return_190=mean(return_190_fw,na.rm=TRUE),sd_190=sd(return_190_fw,na.rm=TRUE), N_190=sum(Nna_return_190_fw),
mean_return_195=mean(return_195_fw,na.rm=TRUE),sd_195=sd(return_195_fw,na.rm=TRUE), N_195=sum(Nna_return_195_fw),
mean_return_200=mean(return_200_fw,na.rm=TRUE),sd_200=sd(return_200_fw,na.rm=TRUE), N_200=sum(Nna_return_200_fw)
), by="new_stock"]



check_for_run_fw_plot_a <- melt(check_for_run_fw_plot, id.vars="new_stock")
check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a[grepl("sd",variable)]
setnames(check_for_run_fw_plot_a_1, "value", "sd")
#check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a_1[,.(sd=mean(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_1[,days:=rep(seq(0,200,5),each=2)]
check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a[grepl("mean",variable)]
setnames(check_for_run_fw_plot_a_2, "value", "mean")
#check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a_2[,.(mean=mean(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_2[,days:=rep(seq(0,200,5),each=2)]
check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a[grepl("N",variable)]
setnames(check_for_run_fw_plot_a_3, "value", "N")
#check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a_3[,.(N=min(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_3[,days:=rep(seq(0,200,5),each=2)]
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a_1, check_for_run_fw_plot_a_2, by=c("new_stock","days"), all.x=TRUE)
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a, check_for_run_fw_plot_a_3, by=c("new_stock","days"), all.x=TRUE)
check_for_run_fw_plot_a[,upper_ci:=mean+1.96*sd/sqrt(N)]
check_for_run_fw_plot_a[,lower_ci:=mean-1.96*sd/sqrt(N)]
check_for_run_fw_plot_a[,Category:="Purchase - invested stock"]
check_for_run_fw_plot_a[new_stock==1,Category:="New purchase"]
#check_for_run_fw_plot_a[order==2,Category:="New purchase - new industry"]
check_for_run_fw_plot_a$Category <- factor(check_for_run_fw_plot_a$Category, levels = c("Purchase - invested stock", "New purchase"))
#check_for_run_fw_plot[,type2:=paste(type,wp_group)]

# check_for_run_fw_plot$type2 <- factor(check_for_run_fw_plot$type2, levels = c("top up after positive rsp","top up after negative rsp", "new buy-invested industry after positive rsp", "new buy-invested industry after negative rsp", "new buy-new industry after positive rsp", "new buy-new industry after negative rsp"))

pd <- position_dodge(0.09) # move them .05 to the left and right



(g4 <- ggplot(check_for_run_fw_plot_a,aes(x=days,y=mean,color=Category))+
       geom_ribbon(aes(ymin=lower_ci, ymax=upper_ci),alpha = .3, linetype=0) +
       geom_line(position=pd) +  xlab("Number of Working Days After the Purchase") + ylab("Return Since Purchase") )
```

## placebo return
### placebo return calculations



### placebo return plot
```{r}
portfolio_unchange_buyday2 <- merge(portfolio_unchange_buyday, portfolios_return, 
                                   by=c("date_formated", "anon"))
portfolio_unchange_buyday2 <- portfolio_unchange_buyday2[!(is.na(winning_prop))]
portfolio_unchange_buyday2 <- portfolio_unchange_buyday2[anon %in% unique(check_for_run_fw$anon)]
portfolio_unchange_buyday_plot <- portfolio_unchange_buyday2[,.(
mean_return_0=0,sd_0=0, N_0=1,
mean_return_5=mean(return_5_fw,na.rm=TRUE),sd_5=sd(return_5_fw,na.rm=TRUE), N_5=sum(Nna_return_5_fw),
mean_return_10=mean(return_10_fw,na.rm=TRUE),sd_10=sd(return_10_fw,na.rm=TRUE), N_10=sum(Nna_return_10_fw),
mean_return_15=mean(return_15_fw,na.rm=TRUE),sd_15=sd(return_15_fw,na.rm=TRUE), N_15=sum(Nna_return_15_fw),
mean_return_20=mean(return_20_fw,na.rm=TRUE),sd_20=sd(return_20_fw,na.rm=TRUE), N_20=sum(Nna_return_20_fw),
mean_return_25=mean(return_25_fw,na.rm=TRUE),sd_25=sd(return_25_fw,na.rm=TRUE), N_25=sum(Nna_return_25_fw),
mean_return_30=mean(return_30_fw,na.rm=TRUE),sd_30=sd(return_30_fw,na.rm=TRUE), N_30=sum(Nna_return_30_fw),
mean_return_35=mean(return_35_fw,na.rm=TRUE),sd_35=sd(return_35_fw,na.rm=TRUE), N_35=sum(Nna_return_35_fw),
mean_return_40=mean(return_40_fw,na.rm=TRUE),sd_40=sd(return_40_fw,na.rm=TRUE), N_40=sum(Nna_return_40_fw),
mean_return_45=mean(return_45_fw,na.rm=TRUE),sd_45=sd(return_45_fw,na.rm=TRUE), N_45=sum(Nna_return_45_fw),
mean_return_50=mean(return_50_fw,na.rm=TRUE),sd_50=sd(return_50_fw,na.rm=TRUE), N_50=sum(Nna_return_50_fw),
mean_return_55=mean(return_55_fw,na.rm=TRUE),sd_55=sd(return_55_fw,na.rm=TRUE), N_55=sum(Nna_return_55_fw),
mean_return_60=mean(return_60_fw,na.rm=TRUE),sd_60=sd(return_60_fw,na.rm=TRUE), N_60=sum(Nna_return_60_fw),
mean_return_65=mean(return_65_fw,na.rm=TRUE),sd_65=sd(return_65_fw,na.rm=TRUE), N_65=sum(Nna_return_65_fw),
mean_return_70=mean(return_70_fw,na.rm=TRUE),sd_70=sd(return_70_fw,na.rm=TRUE), N_70=sum(Nna_return_70_fw),
mean_return_75=mean(return_75_fw,na.rm=TRUE),sd_75=sd(return_75_fw,na.rm=TRUE), N_75=sum(Nna_return_75_fw),
mean_return_80=mean(return_80_fw,na.rm=TRUE),sd_80=sd(return_80_fw,na.rm=TRUE), N_80=sum(Nna_return_80_fw),
mean_return_85=mean(return_85_fw,na.rm=TRUE),sd_85=sd(return_85_fw,na.rm=TRUE), N_85=sum(Nna_return_85_fw),
mean_return_90=mean(return_90_fw,na.rm=TRUE),sd_90=sd(return_90_fw,na.rm=TRUE), N_90=sum(Nna_return_90_fw),
mean_return_95=mean(return_95_fw,na.rm=TRUE),sd_95=sd(return_95_fw,na.rm=TRUE), N_95=sum(Nna_return_95_fw),
mean_return_100=mean(return_100_fw,na.rm=TRUE),sd_100=sd(return_100_fw,na.rm=TRUE), N_100=sum(Nna_return_100_fw),
mean_return_105=mean(return_105_fw,na.rm=TRUE),sd_105=sd(return_105_fw,na.rm=TRUE), N_105=sum(Nna_return_105_fw),
mean_return_110=mean(return_110_fw,na.rm=TRUE),sd_110=sd(return_110_fw,na.rm=TRUE), N_110=sum(Nna_return_110_fw),
mean_return_115=mean(return_115_fw,na.rm=TRUE),sd_115=sd(return_115_fw,na.rm=TRUE), N_115=sum(Nna_return_115_fw),
mean_return_120=mean(return_120_fw,na.rm=TRUE),sd_120=sd(return_120_fw,na.rm=TRUE), N_120=sum(Nna_return_120_fw),
mean_return_125=mean(return_125_fw,na.rm=TRUE),sd_125=sd(return_125_fw,na.rm=TRUE), N_125=sum(Nna_return_125_fw),
mean_return_130=mean(return_130_fw,na.rm=TRUE),sd_130=sd(return_130_fw,na.rm=TRUE), N_130=sum(Nna_return_130_fw),
mean_return_135=mean(return_135_fw,na.rm=TRUE),sd_135=sd(return_135_fw,na.rm=TRUE), N_135=sum(Nna_return_135_fw),
mean_return_140=mean(return_140_fw,na.rm=TRUE),sd_140=sd(return_140_fw,na.rm=TRUE), N_140=sum(Nna_return_140_fw),
mean_return_145=mean(return_145_fw,na.rm=TRUE),sd_145=sd(return_145_fw,na.rm=TRUE), N_145=sum(Nna_return_145_fw),
mean_return_150=mean(return_150_fw,na.rm=TRUE),sd_150=sd(return_150_fw,na.rm=TRUE), N_150=sum(Nna_return_150_fw),
mean_return_155=mean(return_155_fw,na.rm=TRUE),sd_155=sd(return_155_fw,na.rm=TRUE), N_155=sum(Nna_return_155_fw),
mean_return_160=mean(return_160_fw,na.rm=TRUE),sd_160=sd(return_160_fw,na.rm=TRUE), N_160=sum(Nna_return_160_fw),
mean_return_165=mean(return_165_fw,na.rm=TRUE),sd_165=sd(return_165_fw,na.rm=TRUE), N_165=sum(Nna_return_165_fw),
mean_return_170=mean(return_170_fw,na.rm=TRUE),sd_170=sd(return_170_fw,na.rm=TRUE), N_170=sum(Nna_return_170_fw),
mean_return_175=mean(return_175_fw,na.rm=TRUE),sd_175=sd(return_175_fw,na.rm=TRUE), N_175=sum(Nna_return_175_fw),
mean_return_180=mean(return_180_fw,na.rm=TRUE),sd_180=sd(return_180_fw,na.rm=TRUE), N_180=sum(Nna_return_180_fw),
mean_return_185=mean(return_185_fw,na.rm=TRUE),sd_185=sd(return_185_fw,na.rm=TRUE), N_185=sum(Nna_return_185_fw),
mean_return_190=mean(return_190_fw,na.rm=TRUE),sd_190=sd(return_190_fw,na.rm=TRUE), N_190=sum(Nna_return_190_fw),
mean_return_195=mean(return_195_fw,na.rm=TRUE),sd_195=sd(return_195_fw,na.rm=TRUE), N_195=sum(Nna_return_195_fw),
mean_return_200=mean(return_200_fw,na.rm=TRUE),sd_200=sd(return_200_fw,na.rm=TRUE), N_200=sum(Nna_return_200_fw)
)]



portfolio_unchange_buyday_plot <- t(portfolio_unchange_buyday_plot)
rnames <- row.names(portfolio_unchange_buyday_plot)
portfolio_unchange_buyday_plot <- as.data.table(portfolio_unchange_buyday_plot)
portfolio_unchange_buyday_plot[,variable:=rnames]
setnames(portfolio_unchange_buyday_plot,"V1","value")
#check_for_run_fw_plot_a <- melt(check_for_run_fw_plot, id.vars="new_stock")
portfolio_unchange_buyday_plot_a_1 <- portfolio_unchange_buyday_plot[grepl("sd",variable)]
setnames(portfolio_unchange_buyday_plot_a_1, "value", "sd")
#check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a_1[,.(sd=mean(value,na.rm=TRUE)),by=c("order", "variable")]
portfolio_unchange_buyday_plot_a_1[,days:=rep(seq(0,200,5),each=1)]
portfolio_unchange_buyday_plot_a_2 <-portfolio_unchange_buyday_plot[grepl("mean",variable)]
setnames(portfolio_unchange_buyday_plot_a_2, "value", "mean")
#check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a_2[,.(mean=mean(value,na.rm=TRUE)),by=c("order", "variable")]
portfolio_unchange_buyday_plot_a_2[,days:=rep(seq(0,200,5),each=1)]
portfolio_unchange_buyday_plot_a_3 <-portfolio_unchange_buyday_plot[grepl("N",variable)]
setnames(portfolio_unchange_buyday_plot_a_3, "value", "N")
#check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a_3[,.(N=min(value,na.rm=TRUE)),by=c("order", "variable")]
portfolio_unchange_buyday_plot_a_3[,days:=rep(seq(0,200,5),each=1)]
portfolio_unchange_buyday_plot_a <- merge(portfolio_unchange_buyday_plot_a_1, portfolio_unchange_buyday_plot_a_2, by="days", all.x=TRUE)
portfolio_unchange_buyday_plot_a <- merge(portfolio_unchange_buyday_plot_a, portfolio_unchange_buyday_plot_a_3, by="days", all.x=TRUE)
portfolio_unchange_buyday_plot_a[,upper_ci:=mean+1.96*sd/sqrt(N)]
portfolio_unchange_buyday_plot_a[,lower_ci:=mean-1.96*sd/sqrt(N)]

pd <- position_dodge(0.09) # move them .05 to the left and right
portfolio_unchange_buyday_plot_a[,Category:="Untouched Stocks"]
portfolio_unchange_buyday_plot_a[,new_stock:=NA]
check_for_run_fw_plot_b <- rbind(check_for_run_fw_plot_a, portfolio_unchange_buyday_plot_a)


(g4 <- ggplot(check_for_run_fw_plot_b,aes(x=days,y=mean, color=Category))+
       geom_ribbon(aes(ymin=lower_ci, ymax=upper_ci),alpha = .3, linetype=0) +
       geom_line(position=pd) +  
    xlab("Number of Working Days After the Purchase") + ylab("Return Since Purchase") )
#ggsave(g4, file="G:/rank/new_ind/codes/codes with more anon dataset/ret_threegroups.png",width = 7.29, height = 4.5)
```

## plot broken by winprop
```{r}
# forward rsp, break by order, and further by winprop 
check_for_run_fw_plot <- check_for_run_fw[,.(
mean_return_0=0,sd_0=0, N_0=1,
mean_return_5=mean(return_5_fw,na.rm=TRUE),sd_5=sd(return_5_fw,na.rm=TRUE), N_5=sum(Nna_return_5_fw),
mean_return_10=mean(return_10_fw,na.rm=TRUE),sd_10=sd(return_10_fw,na.rm=TRUE), N_10=sum(Nna_return_10_fw),
mean_return_15=mean(return_15_fw,na.rm=TRUE),sd_15=sd(return_15_fw,na.rm=TRUE), N_15=sum(Nna_return_15_fw),
mean_return_20=mean(return_20_fw,na.rm=TRUE),sd_20=sd(return_20_fw,na.rm=TRUE), N_20=sum(Nna_return_20_fw),
mean_return_25=mean(return_25_fw,na.rm=TRUE),sd_25=sd(return_25_fw,na.rm=TRUE), N_25=sum(Nna_return_25_fw),
mean_return_30=mean(return_30_fw,na.rm=TRUE),sd_30=sd(return_30_fw,na.rm=TRUE), N_30=sum(Nna_return_30_fw),
mean_return_35=mean(return_35_fw,na.rm=TRUE),sd_35=sd(return_35_fw,na.rm=TRUE), N_35=sum(Nna_return_35_fw),
mean_return_40=mean(return_40_fw,na.rm=TRUE),sd_40=sd(return_40_fw,na.rm=TRUE), N_40=sum(Nna_return_40_fw),
mean_return_45=mean(return_45_fw,na.rm=TRUE),sd_45=sd(return_45_fw,na.rm=TRUE), N_45=sum(Nna_return_45_fw),
mean_return_50=mean(return_50_fw,na.rm=TRUE),sd_50=sd(return_50_fw,na.rm=TRUE), N_50=sum(Nna_return_50_fw),
mean_return_55=mean(return_55_fw,na.rm=TRUE),sd_55=sd(return_55_fw,na.rm=TRUE), N_55=sum(Nna_return_55_fw),
mean_return_60=mean(return_60_fw,na.rm=TRUE),sd_60=sd(return_60_fw,na.rm=TRUE), N_60=sum(Nna_return_60_fw),
mean_return_65=mean(return_65_fw,na.rm=TRUE),sd_65=sd(return_65_fw,na.rm=TRUE), N_65=sum(Nna_return_65_fw),
mean_return_70=mean(return_70_fw,na.rm=TRUE),sd_70=sd(return_70_fw,na.rm=TRUE), N_70=sum(Nna_return_70_fw),
mean_return_75=mean(return_75_fw,na.rm=TRUE),sd_75=sd(return_75_fw,na.rm=TRUE), N_75=sum(Nna_return_75_fw),
mean_return_80=mean(return_80_fw,na.rm=TRUE),sd_80=sd(return_80_fw,na.rm=TRUE), N_80=sum(Nna_return_80_fw),
mean_return_85=mean(return_85_fw,na.rm=TRUE),sd_85=sd(return_85_fw,na.rm=TRUE), N_85=sum(Nna_return_85_fw),
mean_return_90=mean(return_90_fw,na.rm=TRUE),sd_90=sd(return_90_fw,na.rm=TRUE), N_90=sum(Nna_return_90_fw),
mean_return_95=mean(return_95_fw,na.rm=TRUE),sd_95=sd(return_95_fw,na.rm=TRUE), N_95=sum(Nna_return_95_fw),
mean_return_100=mean(return_100_fw,na.rm=TRUE),sd_100=sd(return_100_fw,na.rm=TRUE), N_100=sum(Nna_return_100_fw),
mean_return_105=mean(return_105_fw,na.rm=TRUE),sd_105=sd(return_105_fw,na.rm=TRUE), N_105=sum(Nna_return_105_fw),
mean_return_110=mean(return_110_fw,na.rm=TRUE),sd_110=sd(return_110_fw,na.rm=TRUE), N_110=sum(Nna_return_110_fw),
mean_return_115=mean(return_115_fw,na.rm=TRUE),sd_115=sd(return_115_fw,na.rm=TRUE), N_115=sum(Nna_return_115_fw),
mean_return_120=mean(return_120_fw,na.rm=TRUE),sd_120=sd(return_120_fw,na.rm=TRUE), N_120=sum(Nna_return_120_fw),
mean_return_125=mean(return_125_fw,na.rm=TRUE),sd_125=sd(return_125_fw,na.rm=TRUE), N_125=sum(Nna_return_125_fw),
mean_return_130=mean(return_130_fw,na.rm=TRUE),sd_130=sd(return_130_fw,na.rm=TRUE), N_130=sum(Nna_return_130_fw),
mean_return_135=mean(return_135_fw,na.rm=TRUE),sd_135=sd(return_135_fw,na.rm=TRUE), N_135=sum(Nna_return_135_fw),
mean_return_140=mean(return_140_fw,na.rm=TRUE),sd_140=sd(return_140_fw,na.rm=TRUE), N_140=sum(Nna_return_140_fw),
mean_return_145=mean(return_145_fw,na.rm=TRUE),sd_145=sd(return_145_fw,na.rm=TRUE), N_145=sum(Nna_return_145_fw),
mean_return_150=mean(return_150_fw,na.rm=TRUE),sd_150=sd(return_150_fw,na.rm=TRUE), N_150=sum(Nna_return_150_fw),
mean_return_155=mean(return_155_fw,na.rm=TRUE),sd_155=sd(return_155_fw,na.rm=TRUE), N_155=sum(Nna_return_155_fw),
mean_return_160=mean(return_160_fw,na.rm=TRUE),sd_160=sd(return_160_fw,na.rm=TRUE), N_160=sum(Nna_return_160_fw),
mean_return_165=mean(return_165_fw,na.rm=TRUE),sd_165=sd(return_165_fw,na.rm=TRUE), N_165=sum(Nna_return_165_fw),
mean_return_170=mean(return_170_fw,na.rm=TRUE),sd_170=sd(return_170_fw,na.rm=TRUE), N_170=sum(Nna_return_170_fw),
mean_return_175=mean(return_175_fw,na.rm=TRUE),sd_175=sd(return_175_fw,na.rm=TRUE), N_175=sum(Nna_return_175_fw),
mean_return_180=mean(return_180_fw,na.rm=TRUE),sd_180=sd(return_180_fw,na.rm=TRUE), N_180=sum(Nna_return_180_fw),
mean_return_185=mean(return_185_fw,na.rm=TRUE),sd_185=sd(return_185_fw,na.rm=TRUE), N_185=sum(Nna_return_185_fw),
mean_return_190=mean(return_190_fw,na.rm=TRUE),sd_190=sd(return_190_fw,na.rm=TRUE), N_190=sum(Nna_return_190_fw),
mean_return_195=mean(return_195_fw,na.rm=TRUE),sd_195=sd(return_195_fw,na.rm=TRUE), N_195=sum(Nna_return_195_fw),
mean_return_200=mean(return_200_fw,na.rm=TRUE),sd_200=sd(return_200_fw,na.rm=TRUE), N_200=sum(Nna_return_200_fw)
), by=c("new_stock","wp_group")]



check_for_run_fw_plot_a <- melt(check_for_run_fw_plot, id.vars=c("new_stock","wp_group"))
check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a[grepl("sd",variable)]
setnames(check_for_run_fw_plot_a_1, "value", "sd")
#check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a_1[,.(sd=mean(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_1[,days:=rep(seq(0,200,5),each=8)]
check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a[grepl("mean",variable)]
setnames(check_for_run_fw_plot_a_2, "value", "mean")
#check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a_2[,.(mean=mean(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_2[,days:=rep(seq(0,200,5),each=8)]
check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a[grepl("N",variable)]
setnames(check_for_run_fw_plot_a_3, "value", "N")
#check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a_3[,.(N=min(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_3[,days:=rep(seq(0,200,5),each=8)]
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a_1, check_for_run_fw_plot_a_2, by=c("new_stock","days","wp_group"), all.x=TRUE)
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a, check_for_run_fw_plot_a_3, by=c("new_stock","days","wp_group"), all.x=TRUE)
check_for_run_fw_plot_a[,upper_ci:=mean+1.96*sd/sqrt(N)]
check_for_run_fw_plot_a[,lower_ci:=mean-1.96*sd/sqrt(N)]
check_for_run_fw_plot_a[,Category:="Purchase - invested stock"]
check_for_run_fw_plot_a[new_stock==1,Category:="New purchase"]
#check_for_run_fw_plot_a[order==2,Category:="New purchase - new industry"]
check_for_run_fw_plot_a$Category <- factor(check_for_run_fw_plot_a$Category, levels = c("Purchase - invested stock", "New purchase"))
#check_for_run_fw_plot[,type2:=paste(type,wp_group)]

# check_for_run_fw_plot$type2 <- factor(check_for_run_fw_plot$type2, levels = c("top up after positive rsp","top up after negative rsp", "new buy-invested industry after positive rsp", "new buy-invested industry after negative rsp", "new buy-new industry after positive rsp", "new buy-new industry after negative rsp"))

pd <- position_dodge(0.09) # move them .05 to the left and right



(g4 <- ggplot(check_for_run_fw_plot_a,aes(x=days,y=mean,color=Category))+
       geom_ribbon(aes(ymin=lower_ci, ymax=upper_ci),alpha = .3, linetype=0) +
       geom_line(position=pd) +  facet_wrap(vars(wp_group)) +
    xlab("Number of Working Days After the Purchase") + ylab("Return Since Purchase") )

#ggsave(g5, file="G:/rank/new_ind/codes/codes with more anon dataset/returnafterbuy2.png",width = 7.29, height = 4.5)
```

## plot broken by winprop with placebo
```{r}
portfolio_unchange_buyday3 <- merge(portfolio_unchange_buyday, portfolios_return, 
                                   by=c("date_formated", "anon"))
portfolio_unchange_buyday3 <- portfolio_unchange_buyday3[!(is.na(winning_prop))]
portfolio_unchange_buyday3 <- portfolio_unchange_buyday3[anon %in% unique(check_for_run_fw$anon)]
portfolio_unchange_buyday3[,wp_group:=cut(winning_prop,breaks = seq(0,1,0.25),include.lowest = TRUE)]

portfolio_unchange_buyday_plot <- portfolio_unchange_buyday3[,.(
mean_return_0=0,sd_0=0, N_0=1,
mean_return_5=mean(return_5_fw,na.rm=TRUE),sd_5=sd(return_5_fw,na.rm=TRUE), N_5=sum(Nna_return_5_fw),
mean_return_10=mean(return_10_fw,na.rm=TRUE),sd_10=sd(return_10_fw,na.rm=TRUE), N_10=sum(Nna_return_10_fw),
mean_return_15=mean(return_15_fw,na.rm=TRUE),sd_15=sd(return_15_fw,na.rm=TRUE), N_15=sum(Nna_return_15_fw),
mean_return_20=mean(return_20_fw,na.rm=TRUE),sd_20=sd(return_20_fw,na.rm=TRUE), N_20=sum(Nna_return_20_fw),
mean_return_25=mean(return_25_fw,na.rm=TRUE),sd_25=sd(return_25_fw,na.rm=TRUE), N_25=sum(Nna_return_25_fw),
mean_return_30=mean(return_30_fw,na.rm=TRUE),sd_30=sd(return_30_fw,na.rm=TRUE), N_30=sum(Nna_return_30_fw),
mean_return_35=mean(return_35_fw,na.rm=TRUE),sd_35=sd(return_35_fw,na.rm=TRUE), N_35=sum(Nna_return_35_fw),
mean_return_40=mean(return_40_fw,na.rm=TRUE),sd_40=sd(return_40_fw,na.rm=TRUE), N_40=sum(Nna_return_40_fw),
mean_return_45=mean(return_45_fw,na.rm=TRUE),sd_45=sd(return_45_fw,na.rm=TRUE), N_45=sum(Nna_return_45_fw),
mean_return_50=mean(return_50_fw,na.rm=TRUE),sd_50=sd(return_50_fw,na.rm=TRUE), N_50=sum(Nna_return_50_fw),
mean_return_55=mean(return_55_fw,na.rm=TRUE),sd_55=sd(return_55_fw,na.rm=TRUE), N_55=sum(Nna_return_55_fw),
mean_return_60=mean(return_60_fw,na.rm=TRUE),sd_60=sd(return_60_fw,na.rm=TRUE), N_60=sum(Nna_return_60_fw),
mean_return_65=mean(return_65_fw,na.rm=TRUE),sd_65=sd(return_65_fw,na.rm=TRUE), N_65=sum(Nna_return_65_fw),
mean_return_70=mean(return_70_fw,na.rm=TRUE),sd_70=sd(return_70_fw,na.rm=TRUE), N_70=sum(Nna_return_70_fw),
mean_return_75=mean(return_75_fw,na.rm=TRUE),sd_75=sd(return_75_fw,na.rm=TRUE), N_75=sum(Nna_return_75_fw),
mean_return_80=mean(return_80_fw,na.rm=TRUE),sd_80=sd(return_80_fw,na.rm=TRUE), N_80=sum(Nna_return_80_fw),
mean_return_85=mean(return_85_fw,na.rm=TRUE),sd_85=sd(return_85_fw,na.rm=TRUE), N_85=sum(Nna_return_85_fw),
mean_return_90=mean(return_90_fw,na.rm=TRUE),sd_90=sd(return_90_fw,na.rm=TRUE), N_90=sum(Nna_return_90_fw),
mean_return_95=mean(return_95_fw,na.rm=TRUE),sd_95=sd(return_95_fw,na.rm=TRUE), N_95=sum(Nna_return_95_fw),
mean_return_100=mean(return_100_fw,na.rm=TRUE),sd_100=sd(return_100_fw,na.rm=TRUE), N_100=sum(Nna_return_100_fw),
mean_return_105=mean(return_105_fw,na.rm=TRUE),sd_105=sd(return_105_fw,na.rm=TRUE), N_105=sum(Nna_return_105_fw),
mean_return_110=mean(return_110_fw,na.rm=TRUE),sd_110=sd(return_110_fw,na.rm=TRUE), N_110=sum(Nna_return_110_fw),
mean_return_115=mean(return_115_fw,na.rm=TRUE),sd_115=sd(return_115_fw,na.rm=TRUE), N_115=sum(Nna_return_115_fw),
mean_return_120=mean(return_120_fw,na.rm=TRUE),sd_120=sd(return_120_fw,na.rm=TRUE), N_120=sum(Nna_return_120_fw),
mean_return_125=mean(return_125_fw,na.rm=TRUE),sd_125=sd(return_125_fw,na.rm=TRUE), N_125=sum(Nna_return_125_fw),
mean_return_130=mean(return_130_fw,na.rm=TRUE),sd_130=sd(return_130_fw,na.rm=TRUE), N_130=sum(Nna_return_130_fw),
mean_return_135=mean(return_135_fw,na.rm=TRUE),sd_135=sd(return_135_fw,na.rm=TRUE), N_135=sum(Nna_return_135_fw),
mean_return_140=mean(return_140_fw,na.rm=TRUE),sd_140=sd(return_140_fw,na.rm=TRUE), N_140=sum(Nna_return_140_fw),
mean_return_145=mean(return_145_fw,na.rm=TRUE),sd_145=sd(return_145_fw,na.rm=TRUE), N_145=sum(Nna_return_145_fw),
mean_return_150=mean(return_150_fw,na.rm=TRUE),sd_150=sd(return_150_fw,na.rm=TRUE), N_150=sum(Nna_return_150_fw),
mean_return_155=mean(return_155_fw,na.rm=TRUE),sd_155=sd(return_155_fw,na.rm=TRUE), N_155=sum(Nna_return_155_fw),
mean_return_160=mean(return_160_fw,na.rm=TRUE),sd_160=sd(return_160_fw,na.rm=TRUE), N_160=sum(Nna_return_160_fw),
mean_return_165=mean(return_165_fw,na.rm=TRUE),sd_165=sd(return_165_fw,na.rm=TRUE), N_165=sum(Nna_return_165_fw),
mean_return_170=mean(return_170_fw,na.rm=TRUE),sd_170=sd(return_170_fw,na.rm=TRUE), N_170=sum(Nna_return_170_fw),
mean_return_175=mean(return_175_fw,na.rm=TRUE),sd_175=sd(return_175_fw,na.rm=TRUE), N_175=sum(Nna_return_175_fw),
mean_return_180=mean(return_180_fw,na.rm=TRUE),sd_180=sd(return_180_fw,na.rm=TRUE), N_180=sum(Nna_return_180_fw),
mean_return_185=mean(return_185_fw,na.rm=TRUE),sd_185=sd(return_185_fw,na.rm=TRUE), N_185=sum(Nna_return_185_fw),
mean_return_190=mean(return_190_fw,na.rm=TRUE),sd_190=sd(return_190_fw,na.rm=TRUE), N_190=sum(Nna_return_190_fw),
mean_return_195=mean(return_195_fw,na.rm=TRUE),sd_195=sd(return_195_fw,na.rm=TRUE), N_195=sum(Nna_return_195_fw),
mean_return_200=mean(return_200_fw,na.rm=TRUE),sd_200=sd(return_200_fw,na.rm=TRUE), N_200=sum(Nna_return_200_fw)
), by=wp_group]

portfolio_unchange_buyday_plot <- portfolio_unchange_buyday_plot[!(is.na(wp_group))]

portfolio_unchange_buyday_plot <- melt(portfolio_unchange_buyday_plot, id.vars="wp_group")
portfolio_unchange_buyday_plot <- as.data.table(portfolio_unchange_buyday_plot)
#setnames(portfolio_unchange_buyday_plot,"V1","value")
#check_for_run_fw_plot_a <- melt(check_for_run_fw_plot, id.vars="new_stock")
portfolio_unchange_buyday_plot_a_1 <- portfolio_unchange_buyday_plot[grepl("sd",variable)]
setnames(portfolio_unchange_buyday_plot_a_1, "value", "sd")
#check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a_1[,.(sd=mean(value,na.rm=TRUE)),by=c("order", "variable")]
portfolio_unchange_buyday_plot_a_1[,days:=rep(seq(0,200,5),each=4)]
portfolio_unchange_buyday_plot_a_2 <-portfolio_unchange_buyday_plot[grepl("mean",variable)]
setnames(portfolio_unchange_buyday_plot_a_2, "value", "mean")
#check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a_2[,.(mean=mean(value,na.rm=TRUE)),by=c("order", "variable")]
portfolio_unchange_buyday_plot_a_2[,days:=rep(seq(0,200,5),each=4)]
portfolio_unchange_buyday_plot_a_3 <-portfolio_unchange_buyday_plot[grepl("N",variable)]
setnames(portfolio_unchange_buyday_plot_a_3, "value", "N")
#check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a_3[,.(N=min(value,na.rm=TRUE)),by=c("order", "variable")]
portfolio_unchange_buyday_plot_a_3[,days:=rep(seq(0,200,5),each=4)]
portfolio_unchange_buyday_plot_a <- merge(portfolio_unchange_buyday_plot_a_1, portfolio_unchange_buyday_plot_a_2, by=c("wp_group","days"), all.x=TRUE)
portfolio_unchange_buyday_plot_a <- merge(portfolio_unchange_buyday_plot_a, portfolio_unchange_buyday_plot_a_3, by=c("wp_group","days"), all.x=TRUE)
portfolio_unchange_buyday_plot_a[,upper_ci:=mean+1.96*sd/sqrt(N)]
portfolio_unchange_buyday_plot_a[,lower_ci:=mean-1.96*sd/sqrt(N)]

pd <- position_dodge(0.09) # move them .05 to the left and right
portfolio_unchange_buyday_plot_a[,Category:="Untouched Stocks"]
portfolio_unchange_buyday_plot_a[,new_stock:=NA]
check_for_run_fw_plot_b <- rbind(check_for_run_fw_plot_a, portfolio_unchange_buyday_plot_a)


(g4 <- ggplot(check_for_run_fw_plot_b,aes(x=days,y=mean, color=Category))+
       geom_ribbon(aes(ymin=lower_ci, ymax=upper_ci),alpha = .3, linetype=0) +
       geom_line(position=pd) +  facet_wrap(vars(wp_group)) +
    xlab("Number of Working Days After the Purchase") + ylab("Return Since Purchase") )
# ggsave(g4, file="G:/rank/new_ind/codes/codes with more anon dataset/ret_threegroups_winprop.png",width = 7.29, height = 4.5)
```


# risk adjusted returns

```{r}

ptbv <- fread("G:/rank/raw_data_not_confidential/ptbv1117.csv")  # <--------------------------------------
library(tidyr)

ptbv <- gather(ptbv,port_date,ptbv,"01/03/2011":"31/08/2017" )
ptbv <- as.data.table(ptbv)
#ptbv[,code2:=substring(Code,1,nchar(Code)-6)]
ptbv[,port_date:=as.Date(port_date,format="%d/%m/%Y")]
ptbv[,ptbv:=as.numeric(ptbv)]
ptbv <- ptbv[!(is.na(ptbv))]

# load price data

load("G:/rank/raw_data_not_confidential/0704ds/extended_price_150421.RData") 
upp <- pp_ext[,.(date_formated,upp,sedol,Code_used_DS)]
sedol_match <- pp_ext[,.SD[1],by=Code_used_DS]
sedol_match <- sedol_match[,.(Code_used_DS, sedol)]
setnames(ptbv,"Code","Code_used_DS")
ptbv <- merge(ptbv, sedol_match, by="Code_used_DS", all.x=TRUE)
library(lubridate)
ptbv[, month:=format( port_date%m+% months(1), "%Y-%m")]
ptbv[, max_date:=max(port_date),by=c("sedol","month")]
ptbv <- ptbv[port_date==max_date]
ptbv[, bm0:=quantile(ptbv,0,na.rm=TRUE), by=month]
ptbv[, bm20:=quantile(ptbv,0.2,na.rm=TRUE), by=month]
ptbv[, bm40:=quantile(ptbv,0.4,na.rm=TRUE), by=month]
ptbv[, bm60:=quantile(ptbv,0.6,na.rm=TRUE), by=month]
ptbv[, bm80:=quantile(ptbv,0.8,na.rm=TRUE), by=month]
ptbv[, bm100:=quantile(ptbv,1.0,na.rm=TRUE), by=month]
ptbv <- ptbv[,.(sedol, ptbv, month, bm0, bm20, bm40, bm60, bm80, bm100)]


outstanding_ibnosh <- fread("G:/rank/raw_data_not_confidential/outstanding_ibnosh_1117.csv")  # <--------------------------------------
library(tidyr)

outstanding_ibnosh <- gather(outstanding_ibnosh,date,ibnosh,"01/03/2011":"31/08/2017" )
outstanding_ibnosh <- as.data.table(outstanding_ibnosh)
#outstanding_ibnosh[,code2:=substring(Code,1,nchar(Code)-8)]
outstanding_ibnosh[,date:=as.Date(date,format="%d/%m/%Y")]
outstanding_ibnosh[,ibnosh:=as.numeric(ibnosh)]
outstanding_ibnosh <- outstanding_ibnosh[!(is.na(ibnosh))]
outstanding_ibnosh[,o5301:=NA]

codes <- unique(outstanding_ibnosh$Code)

outstanding_5301 <- fread("G:/rank/raw_data_not_confidential/outstanding_WC05301_1117.csv") 
outstanding_5301 <- gather(outstanding_5301,date,o5301,"01/03/2011":"31/08/2017" )
outstanding_5301 <- as.data.table(outstanding_5301)
outstanding_5301[,date:=as.Date(date,format="%d/%m/%Y")]
outstanding_5301[,o5301:=as.numeric(o5301)]
outstanding_5301 <- outstanding_5301[!(is.na(o5301))]
outstanding_5301 <- outstanding_5301[!(Code %in% codes)]
outstanding_5301[,ibnosh:=NA]

outstanding <- rbind(outstanding_ibnosh, outstanding_5301)
head(outstanding)
outstanding[,outstanding:=ibnosh*1000]
outstanding[is.na(outstanding),outstanding:=o5301]
outstanding <- outstanding[,.(date,Code,outstanding)]
setnames(outstanding,c("date","Code"),c("date_formated","Code_used_DS"))
outstanding <- merge(outstanding, upp, by=c("date_formated","Code_used_DS"),all.x=TRUE)
outstanding[,market_value:=outstanding*upp]
outstanding <- outstanding[,.(date_formated, sedol, market_value)]
outstanding <- outstanding[!(is.na(sedol))]
head(outstanding)
outstanding[, month:=format( date_formated%m+% months(1), "%Y-%m")]
outstanding[, max_date:=max(date_formated),by=c("sedol","month")]
outstanding <- outstanding[date_formated==max_date]
outstanding[, mv0:=quantile(market_value,0,na.rm=TRUE), by=month]
outstanding[, mv20:=quantile(market_value,0.2,na.rm=TRUE), by=month]
outstanding[, mv40:=quantile(market_value,0.4,na.rm=TRUE), by=month]
outstanding[, mv60:=quantile(market_value,0.6,na.rm=TRUE), by=month]
outstanding[, mv80:=quantile(market_value,0.8,na.rm=TRUE), by=month]
outstanding[, mv100:=quantile(market_value,1.0,na.rm=TRUE), by=month]
outstanding <- outstanding[,.(sedol, month, market_value, mv0, mv20, mv40, mv60, mv80, mv100)]


pp_ext2 <- pp_ext[,.(sedol, date_formated, app)]
pp_ext2 <- pp_ext2[order(sedol, date_formated)]
pp_ext2[,app_lead1:=shift(app, n=1L, fill=NA, type='lead'),by=sedol]
pp_ext2[,ret_lea1:=(app_lead1-app)/app]
pp_ext2[, month:=format( date_formated, "%Y-%m")]
pp_ext2 <- pp_ext2[!(sedol=="0000000")]
```
```{r}
pp_ext2 <- merge(pp_ext2, outstanding,by=c("sedol", "month"), all.x=TRUE)
pp_ext2 <- pp_ext2[!is.na(market_value)]

pp_ext2 <- merge(pp_ext2, ptbv,  by=c("sedol", "month"), all.x=TRUE)
pp_ext2 <- pp_ext2[!is.na(ptbv)]


for (i in 1:5){
  for (j in 1:5){
    name1 <- paste0("mv",i*20)
    name2 <- paste0("bm",j*20)
    name3 <- paste0("mv",(i-1)*20)
    name4 <- paste0("bm",(j-1)*20)
    name5 <- paste0("group",i,j)
    if (i < 5 & j < 5){
      pp_ext2[,eval(name5):=ifelse(
        get(name1)>market_value &  get(name3)<=market_value &
        get(name2)>ptbv &  get(name4)<=ptbv,
        1,0)]
    }
    if (i==5 & j<5){
      pp_ext2[,eval(name5):=ifelse(
        get(name1)>=market_value &  get(name3)<=market_value &
        get(name2)>ptbv &  get(name4)<=ptbv,
        1,0)]
    }
    if (i<5 & j==5){
      pp_ext2[,eval(name5):=ifelse(
        get(name1)>market_value &  get(name3)<=market_value &
        get(name2)>=ptbv &  get(name4)<=ptbv,
        1,0)]
    }
     if (i==5 & j==5){
      pp_ext2[,eval(name5):=ifelse(
        get(name1)>=market_value &  get(name3)<=market_value &
        get(name2)>=ptbv &  get(name4)<=ptbv,
        1,0)]
    }
  }
}
pp_ext2[,group:=as.character(NA)]
for (i in 1:5){
  for (j in 1:5){
    namea <- paste0("group",i,j)
pp_ext2[get(namea)==1, group:=eval(namea)]
  }}
for (i in 1:5){
  for (j in 1:5){
    name5 <- paste0("group",i,j)
      pp_ext2[,eval(name5):=NULL]
}}
pp_ext2[,group2:=paste0(eval(date_formated),eval(group))]
pp_ext2[is.infinite(ret_lea1),ret_lea1:=NA]
pp_ext2[,group_mean:=mean(ret_lea1,na.rm=TRUE),by=group2]
pp_ext2[,ret1_adj:=ret_lea1-group_mean]


pp_ext3 <- pp_ext2[,.(sedol, date_formated, ret1_adj)]
pp_ext3 <- pp_ext3[order(sedol,date_formated)]
for (i in 1:200){
  name <- paste0("ret_adj_lead",i)
  pp_ext3[,eval(name):=shift(ret1_adj, n=i, fill=NA, type='lead'),by=sedol]
  print(i)
}
pp_ext3[,returnadj_5_fw:=(1+ret1_adj)*(1+ret_adj_lead1)*(1+ret_adj_lead2)*
         (1+ret_adj_lead3)*(1+ret_adj_lead4)-1]
pp_ext3[,returnadj_10_fw:=(1+returnadj_5_fw)*(1+ret_adj_lead5)*(1+ret_adj_lead6)*
         (1+ret_adj_lead7)*(1+ret_adj_lead8)*(1+ret_adj_lead9)-1]

for (i in 3:40){
  name1 <- paste0("returnadj_",i*5,"_fw")
  name2 <- paste0("returnadj_",(i-1)*5,"_fw")
  name3 <- paste0("ret_adj_lead",i*5-5)
  name4 <- paste0("ret_adj_lead",i*5-4)
  name5 <- paste0("ret_adj_lead",i*5-3)
  name6 <- paste0("ret_adj_lead",i*5-2)
  name7 <- paste0("ret_adj_lead",i*5-1)
  pp_ext3[,eval(name1):=(1+get(name2))*(1+get(name3))*(1+get(name4))*
         (1+get(name5))*(1+get(name6))*(1+get(name7))-1]
print(i)
}

for (i in 1:200){
  name <- paste0("ret_adj_lead",i)
  pp_ext3[,eval(name):=NULL]
}

for (i in 1:200){
  name <- paste0("ret_adj_lag",i)
  pp_ext3[,eval(name):=shift(ret1_adj, n=(i+1), fill=NA, type='lag'),by=sedol]
  print(i)
}

pp_ext3[,returnadj_5_lag_p:=(1+ret_adj_lag1)*(1+ret_adj_lag2)*(1+ret_adj_lag3)*
         (1+ret_adj_lag4)*(1+ret_adj_lag5)-1]
pp_ext3[,returnadj_10_lag_p:=(1+ret_adj_lag6)*(1+ret_adj_lag7)*(1+ret_adj_lag8)*
         (1+ret_adj_lag9)*(1+ret_adj_lag10)-1]

for (i in 3:40){
  name1 <- paste0("returnadj_",i*5,"lag_p")

  name3 <- paste0("ret_adj_lag",i*5)
  name4 <- paste0("ret_adj_lag",i*5-4)
  name5 <- paste0("ret_adj_lag",i*5-3)
  name6 <- paste0("ret_adj_lag",i*5-2)
  name7 <- paste0("ret_adj_lag",i*5-1)
  pp_ext3[,eval(name1):=(1+get(name3))*(1+get(name4))*
         (1+get(name5))*(1+get(name6))*(1+get(name7))-1]
print(i)
}

for (i in 1:200){
  name <- paste0("ret_adj_lag",i)
  pp_ext3[,eval(name):=NULL]
}

```

## plot return for buys

```{r}
check_for_run_fw <- merge(check_for_run, pp_ext3, by=c("sedol", "date_formated"), all.x=TRUE)
check_for_run_fw[,order:=new_stock]
check_for_run_fw[new_icb_industry==1,order:=2]
check_for_run_fw[,order:=as.factor(order)]

check_for_run_fw[,order2:=0]
check_for_run_fw[new_stock==1,order2:=2]
check_for_run_fw[net.posit.port.pre1day==0&new_stock==0,order2:=1]
check_for_run_fw[,order2:=as.factor(order2)]






check_for_run_fw[,return_5_fw:=Winsorize(returnadj_5_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_10_fw:=Winsorize(returnadj_10_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_15_fw:=Winsorize(returnadj_15_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_20_fw:=Winsorize(returnadj_20_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_25_fw:=Winsorize(returnadj_25_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_30_fw:=Winsorize(returnadj_30_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_35_fw:=Winsorize(returnadj_35_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_40_fw:=Winsorize(returnadj_40_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_45_fw:=Winsorize(returnadj_45_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_50_fw:=Winsorize(returnadj_50_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_55_fw:=Winsorize(returnadj_55_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_60_fw:=Winsorize(returnadj_60_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_65_fw:=Winsorize(returnadj_65_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_70_fw:=Winsorize(returnadj_70_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_75_fw:=Winsorize(returnadj_75_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_80_fw:=Winsorize(returnadj_80_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_85_fw:=Winsorize(returnadj_85_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_90_fw:=Winsorize(returnadj_90_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_95_fw:=Winsorize(returnadj_95_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_100_fw:=Winsorize(returnadj_100_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_105_fw:=Winsorize(returnadj_105_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_110_fw:=Winsorize(returnadj_110_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_115_fw:=Winsorize(returnadj_115_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_120_fw:=Winsorize(returnadj_120_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_125_fw:=Winsorize(returnadj_125_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_130_fw:=Winsorize(returnadj_130_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_135_fw:=Winsorize(returnadj_135_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_140_fw:=Winsorize(returnadj_140_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_145_fw:=Winsorize(returnadj_145_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_150_fw:=Winsorize(returnadj_150_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_155_fw:=Winsorize(returnadj_155_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_160_fw:=Winsorize(returnadj_160_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_165_fw:=Winsorize(returnadj_165_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_170_fw:=Winsorize(returnadj_170_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_175_fw:=Winsorize(returnadj_175_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_180_fw:=Winsorize(returnadj_180_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_185_fw:=Winsorize(returnadj_185_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_190_fw:=Winsorize(returnadj_190_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_195_fw:=Winsorize(returnadj_195_fw, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_200_fw:=Winsorize(returnadj_200_fw, probs = c(0.01,0.99),na.rm=TRUE)]

check_for_run_fw[,Nna_return_5_fw:=ifelse(is.na(returnadj_5_fw),0,1)]
check_for_run_fw[,Nna_return_10_fw:=ifelse(is.na(returnadj_10_fw),0,1)]
check_for_run_fw[,Nna_return_15_fw:=ifelse(is.na(returnadj_15_fw),0,1)]
check_for_run_fw[,Nna_return_20_fw:=ifelse(is.na(returnadj_20_fw),0,1)]
check_for_run_fw[,Nna_return_25_fw:=ifelse(is.na(returnadj_25_fw),0,1)]
check_for_run_fw[,Nna_return_30_fw:=ifelse(is.na(returnadj_30_fw),0,1)]
check_for_run_fw[,Nna_return_35_fw:=ifelse(is.na(returnadj_35_fw),0,1)]
check_for_run_fw[,Nna_return_40_fw:=ifelse(is.na(returnadj_40_fw),0,1)]
check_for_run_fw[,Nna_return_45_fw:=ifelse(is.na(returnadj_45_fw),0,1)]
check_for_run_fw[,Nna_return_50_fw:=ifelse(is.na(returnadj_50_fw),0,1)]
check_for_run_fw[,Nna_return_55_fw:=ifelse(is.na(returnadj_55_fw),0,1)]
check_for_run_fw[,Nna_return_60_fw:=ifelse(is.na(returnadj_60_fw),0,1)]
check_for_run_fw[,Nna_return_65_fw:=ifelse(is.na(returnadj_65_fw),0,1)]
check_for_run_fw[,Nna_return_70_fw:=ifelse(is.na(returnadj_70_fw),0,1)]
check_for_run_fw[,Nna_return_75_fw:=ifelse(is.na(returnadj_75_fw),0,1)]
check_for_run_fw[,Nna_return_80_fw:=ifelse(is.na(returnadj_80_fw),0,1)]
check_for_run_fw[,Nna_return_85_fw:=ifelse(is.na(returnadj_85_fw),0,1)]
check_for_run_fw[,Nna_return_90_fw:=ifelse(is.na(returnadj_90_fw),0,1)]
check_for_run_fw[,Nna_return_95_fw:=ifelse(is.na(returnadj_95_fw),0,1)]
check_for_run_fw[,Nna_return_100_fw:=ifelse(is.na(returnadj_100_fw),0,1)]
check_for_run_fw[,Nna_return_105_fw:=ifelse(is.na(returnadj_105_fw),0,1)]
check_for_run_fw[,Nna_return_110_fw:=ifelse(is.na(returnadj_110_fw),0,1)]
check_for_run_fw[,Nna_return_115_fw:=ifelse(is.na(returnadj_115_fw),0,1)]
check_for_run_fw[,Nna_return_120_fw:=ifelse(is.na(returnadj_120_fw),0,1)]
check_for_run_fw[,Nna_return_125_fw:=ifelse(is.na(returnadj_125_fw),0,1)]
check_for_run_fw[,Nna_return_130_fw:=ifelse(is.na(returnadj_130_fw),0,1)]
check_for_run_fw[,Nna_return_135_fw:=ifelse(is.na(returnadj_135_fw),0,1)]
check_for_run_fw[,Nna_return_140_fw:=ifelse(is.na(returnadj_140_fw),0,1)]
check_for_run_fw[,Nna_return_145_fw:=ifelse(is.na(returnadj_145_fw),0,1)]
check_for_run_fw[,Nna_return_150_fw:=ifelse(is.na(returnadj_150_fw),0,1)]
check_for_run_fw[,Nna_return_155_fw:=ifelse(is.na(returnadj_155_fw),0,1)]
check_for_run_fw[,Nna_return_160_fw:=ifelse(is.na(returnadj_160_fw),0,1)]
check_for_run_fw[,Nna_return_165_fw:=ifelse(is.na(returnadj_165_fw),0,1)]
check_for_run_fw[,Nna_return_170_fw:=ifelse(is.na(returnadj_170_fw),0,1)]
check_for_run_fw[,Nna_return_175_fw:=ifelse(is.na(returnadj_175_fw),0,1)]
check_for_run_fw[,Nna_return_180_fw:=ifelse(is.na(returnadj_180_fw),0,1)]
check_for_run_fw[,Nna_return_185_fw:=ifelse(is.na(returnadj_185_fw),0,1)]
check_for_run_fw[,Nna_return_190_fw:=ifelse(is.na(returnadj_190_fw),0,1)]
check_for_run_fw[,Nna_return_195_fw:=ifelse(is.na(returnadj_195_fw),0,1)]
check_for_run_fw[,Nna_return_200_fw:=ifelse(is.na(returnadj_200_fw),0,1)]

check_for_run_fw[,return_5_lag_p:=Winsorize(returnadj_5_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_10_lag_p:=Winsorize(returnadj_10_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_15_lag_p:=Winsorize(returnadj_15lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_20_lag_p:=Winsorize(returnadj_20lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_25_lag_p:=Winsorize(returnadj_25lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_30_lag_p:=Winsorize(returnadj_30lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_35_lag_p:=Winsorize(returnadj_35lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_40_lag_p:=Winsorize(returnadj_40lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_45_lag_p:=Winsorize(returnadj_45lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_50_lag_p:=Winsorize(returnadj_50lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_55_lag_p:=Winsorize(returnadj_55lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_60_lag_p:=Winsorize(returnadj_60lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_65_lag_p:=Winsorize(returnadj_65lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_70_lag_p:=Winsorize(returnadj_70lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_75_lag_p:=Winsorize(returnadj_75lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_80_lag_p:=Winsorize(returnadj_80lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_85_lag_p:=Winsorize(returnadj_85lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_90_lag_p:=Winsorize(returnadj_90lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_95_lag_p:=Winsorize(returnadj_95lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_100_lag_p:=Winsorize(returnadj_100lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_105_lag_p:=Winsorize(returnadj_105lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_110_lag_p:=Winsorize(returnadj_110lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_115_lag_p:=Winsorize(returnadj_115lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_120_lag_p:=Winsorize(returnadj_120lag_p, probs = c(0.01,0.99),na.rm=TRUE)]

check_for_run_fw[,Nna_return_5_lag_p:=ifelse(is.na(returnadj_5_lag_p),0,1)]
check_for_run_fw[,Nna_return_10_lag_p:=ifelse(is.na(returnadj_10_lag_p),0,1)]
check_for_run_fw[,Nna_return_15_lag_p:=ifelse(is.na(returnadj_15lag_p),0,1)]
check_for_run_fw[,Nna_return_20_lag_p:=ifelse(is.na(returnadj_20lag_p),0,1)]
check_for_run_fw[,Nna_return_25_lag_p:=ifelse(is.na(returnadj_25lag_p),0,1)]
check_for_run_fw[,Nna_return_30_lag_p:=ifelse(is.na(returnadj_30lag_p),0,1)]
check_for_run_fw[,Nna_return_35_lag_p:=ifelse(is.na(returnadj_35lag_p),0,1)]
check_for_run_fw[,Nna_return_40_lag_p:=ifelse(is.na(returnadj_40lag_p),0,1)]
check_for_run_fw[,Nna_return_45_lag_p:=ifelse(is.na(returnadj_45lag_p),0,1)]
check_for_run_fw[,Nna_return_50_lag_p:=ifelse(is.na(returnadj_50lag_p),0,1)]
check_for_run_fw[,Nna_return_55_lag_p:=ifelse(is.na(returnadj_55lag_p),0,1)]
check_for_run_fw[,Nna_return_60_lag_p:=ifelse(is.na(returnadj_60lag_p),0,1)]
check_for_run_fw[,Nna_return_65_lag_p:=ifelse(is.na(returnadj_65lag_p),0,1)]
check_for_run_fw[,Nna_return_70_lag_p:=ifelse(is.na(returnadj_70lag_p),0,1)]
check_for_run_fw[,Nna_return_75_lag_p:=ifelse(is.na(returnadj_75lag_p),0,1)]
check_for_run_fw[,Nna_return_80_lag_p:=ifelse(is.na(returnadj_80lag_p),0,1)]
check_for_run_fw[,Nna_return_85_lag_p:=ifelse(is.na(returnadj_85lag_p),0,1)]
check_for_run_fw[,Nna_return_90_lag_p:=ifelse(is.na(returnadj_90lag_p),0,1)]
check_for_run_fw[,Nna_return_95_lag_p:=ifelse(is.na(returnadj_95lag_p),0,1)]
check_for_run_fw[,Nna_return_100_lag_p:=ifelse(is.na(returnadj_100lag_p),0,1)]
check_for_run_fw[,Nna_return_105_lag_p:=ifelse(is.na(returnadj_105lag_p),0,1)]
check_for_run_fw[,Nna_return_110_lag_p:=ifelse(is.na(returnadj_110lag_p),0,1)]
check_for_run_fw[,Nna_return_115_lag_p:=ifelse(is.na(returnadj_115lag_p),0,1)]
check_for_run_fw[,Nna_return_120_lag_p:=ifelse(is.na(returnadj_120lag_p),0,1)]

check_for_run_fw[,wp_group:=cut(winning_prop,breaks = seq(0,1,0.25),include.lowest = TRUE)]
```



```{r}

check_for_run_lag_plot <- check_for_run_fw[,.(
mean_return_0=0,sd_0=0, N_0=1,
mean_return_5=mean(return_5_lag_p,na.rm=TRUE),sd_5=sd(return_5_lag_p,na.rm=TRUE), N_5=sum(Nna_return_5_lag_p),
mean_return_10=mean(return_10_lag_p,na.rm=TRUE),sd_10=sd(return_10_lag_p,na.rm=TRUE), N_10=sum(Nna_return_10_lag_p),
mean_return_15=mean(return_15_lag_p,na.rm=TRUE),sd_15=sd(return_15_lag_p,na.rm=TRUE), N_15=sum(Nna_return_15_lag_p),
mean_return_20=mean(return_20_lag_p,na.rm=TRUE),sd_20=sd(return_20_lag_p,na.rm=TRUE), N_20=sum(Nna_return_20_lag_p),
mean_return_25=mean(return_25_lag_p,na.rm=TRUE),sd_25=sd(return_25_lag_p,na.rm=TRUE), N_25=sum(Nna_return_25_lag_p),
mean_return_30=mean(return_30_lag_p,na.rm=TRUE),sd_30=sd(return_30_lag_p,na.rm=TRUE), N_30=sum(Nna_return_30_lag_p),
mean_return_35=mean(return_35_lag_p,na.rm=TRUE),sd_35=sd(return_35_lag_p,na.rm=TRUE), N_35=sum(Nna_return_35_lag_p),
mean_return_40=mean(return_40_lag_p,na.rm=TRUE),sd_40=sd(return_40_lag_p,na.rm=TRUE), N_40=sum(Nna_return_40_lag_p),
mean_return_45=mean(return_45_lag_p,na.rm=TRUE),sd_45=sd(return_45_lag_p,na.rm=TRUE), N_45=sum(Nna_return_45_lag_p),
mean_return_50=mean(return_50_lag_p,na.rm=TRUE),sd_50=sd(return_50_lag_p,na.rm=TRUE), N_50=sum(Nna_return_50_lag_p),
mean_return_55=mean(return_55_lag_p,na.rm=TRUE),sd_55=sd(return_55_lag_p,na.rm=TRUE), N_55=sum(Nna_return_55_lag_p),
mean_return_60=mean(return_60_lag_p,na.rm=TRUE),sd_60=sd(return_60_lag_p,na.rm=TRUE), N_60=sum(Nna_return_60_lag_p),
mean_return_65=mean(return_65_lag_p,na.rm=TRUE),sd_65=sd(return_65_lag_p,na.rm=TRUE), N_65=sum(Nna_return_65_lag_p),
mean_return_70=mean(return_70_lag_p,na.rm=TRUE),sd_70=sd(return_70_lag_p,na.rm=TRUE), N_70=sum(Nna_return_70_lag_p),
mean_return_75=mean(return_75_lag_p,na.rm=TRUE),sd_75=sd(return_75_lag_p,na.rm=TRUE), N_75=sum(Nna_return_75_lag_p),
mean_return_80=mean(return_80_lag_p,na.rm=TRUE),sd_80=sd(return_80_lag_p,na.rm=TRUE), N_80=sum(Nna_return_80_lag_p),
mean_return_85=mean(return_85_lag_p,na.rm=TRUE),sd_85=sd(return_85_lag_p,na.rm=TRUE), N_85=sum(Nna_return_85_lag_p),
mean_return_90=mean(return_90_lag_p,na.rm=TRUE),sd_90=sd(return_90_lag_p,na.rm=TRUE), N_90=sum(Nna_return_90_lag_p),
mean_return_95=mean(return_95_lag_p,na.rm=TRUE),sd_95=sd(return_95_lag_p,na.rm=TRUE), N_95=sum(Nna_return_95_lag_p),
mean_return_100=mean(return_100_lag_p,na.rm=TRUE),sd_100=sd(return_100_lag_p,na.rm=TRUE), N_100=sum(Nna_return_100_lag_p),
mean_return_105=mean(return_105_lag_p,na.rm=TRUE),sd_105=sd(return_105_lag_p,na.rm=TRUE), N_105=sum(Nna_return_105_lag_p),
mean_return_110=mean(return_110_lag_p,na.rm=TRUE),sd_110=sd(return_110_lag_p,na.rm=TRUE), N_110=sum(Nna_return_110_lag_p),
mean_return_115=mean(return_115_lag_p,na.rm=TRUE),sd_115=sd(return_115_lag_p,na.rm=TRUE), N_115=sum(Nna_return_115_lag_p),
mean_return_120=mean(return_120_lag_p,na.rm=TRUE),sd_120=sd(return_120_lag_p,na.rm=TRUE), N_120=sum(Nna_return_120_lag_p)
), by="new_stock"]



check_for_run_fw_plot_a <- melt(check_for_run_lag_plot, id.vars="new_stock")
check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a[grepl("sd",variable)]
setnames(check_for_run_fw_plot_a_1, "value", "sd")
#check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a_1[,.(sd=mean(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_1[,days:=rep(seq(0,-120,-5),each=2)]
check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a[grepl("mean",variable)]
setnames(check_for_run_fw_plot_a_2, "value", "mean")
#check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a_2[,.(mean=mean(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_2[,days:=rep(seq(0,-120,-5),each=2)]
check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a[grepl("N",variable)]
setnames(check_for_run_fw_plot_a_3, "value", "N")
#check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a_3[,.(N=min(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_3[,days:=rep(seq(0,-120,-5),each=2)]
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a_1, check_for_run_fw_plot_a_2, by=c("new_stock","days"), all.x=TRUE)
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a, check_for_run_fw_plot_a_3, by=c("new_stock","days"), all.x=TRUE)
check_for_run_fw_plot_a[,upper_ci:=mean+1.96*sd/sqrt(N)]
check_for_run_fw_plot_a[,lower_ci:=mean-1.96*sd/sqrt(N)]
check_for_run_fw_plot_a[,Category:="Purchase - invested stock"]
check_for_run_fw_plot_a[new_stock==1,Category:="New purchase"]
#check_for_run_fw_plot_a[order==2,Category:="New purchase - new industry"]
check_for_run_fw_plot_a$Category <- factor(check_for_run_fw_plot_a$Category, levels = c("Purchase - invested stock", "New purchase"))
#check_for_run_fw_plot[,type2:=paste(type,wp_group)]

# check_for_run_fw_plot$type2 <- factor(check_for_run_fw_plot$type2, levels = c("top up after positive rsp","top up after negative rsp", "new buy-invested industry after positive rsp", "new buy-invested industry after negative rsp", "new buy-new industry after positive rsp", "new buy-new industry after negative rsp"))

pd <- position_dodge(0.09) # move them .05 to the left and right



(g6 <- ggplot(check_for_run_fw_plot_a,aes(x=days,y=mean,color=Category))+
       geom_ribbon(aes(ymin=lower_ci, ymax=upper_ci),alpha = .3, linetype=0) +
       geom_line(position=pd) +  xlab("Number of Working Days After the Purchase") + ylab("Adj Return ") )
```

## placebo adj return

```{r}
portfolio_buyday <- portfolio_stock_composition[buyday>0]
portfolio_unchange_buyday <- portfolio_buyday[is.na(net_cost)]
portfolio_unchange_buyday <- portfolio_unchange_buyday[anon %in% unique(check_for_run$anon)]


portfolio_unchange_buyday <- merge(portfolio_unchange_buyday, pp_ext3, by=c("sedol", "date_formated"), all.x=TRUE)
```
```{r}
portfolio_unchange_buyday[,return_5_fw:=Winsorize(returnadj_5_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_10_fw:=Winsorize(returnadj_10_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_15_fw:=Winsorize(returnadj_15_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_20_fw:=Winsorize(returnadj_20_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_25_fw:=Winsorize(returnadj_25_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_30_fw:=Winsorize(returnadj_30_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_35_fw:=Winsorize(returnadj_35_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_40_fw:=Winsorize(returnadj_40_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_45_fw:=Winsorize(returnadj_45_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_50_fw:=Winsorize(returnadj_50_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_55_fw:=Winsorize(returnadj_55_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_60_fw:=Winsorize(returnadj_60_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_65_fw:=Winsorize(returnadj_65_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_70_fw:=Winsorize(returnadj_70_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_75_fw:=Winsorize(returnadj_75_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_80_fw:=Winsorize(returnadj_80_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_85_fw:=Winsorize(returnadj_85_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_90_fw:=Winsorize(returnadj_90_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_95_fw:=Winsorize(returnadj_95_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_100_fw:=Winsorize(returnadj_100_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_105_fw:=Winsorize(returnadj_105_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_110_fw:=Winsorize(returnadj_110_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_115_fw:=Winsorize(returnadj_115_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_120_fw:=Winsorize(returnadj_120_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_125_fw:=Winsorize(returnadj_125_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_130_fw:=Winsorize(returnadj_130_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_135_fw:=Winsorize(returnadj_135_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_140_fw:=Winsorize(returnadj_140_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_145_fw:=Winsorize(returnadj_145_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_150_fw:=Winsorize(returnadj_150_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_155_fw:=Winsorize(returnadj_155_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_160_fw:=Winsorize(returnadj_160_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_165_fw:=Winsorize(returnadj_165_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_170_fw:=Winsorize(returnadj_170_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_175_fw:=Winsorize(returnadj_175_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_180_fw:=Winsorize(returnadj_180_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_185_fw:=Winsorize(returnadj_185_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_190_fw:=Winsorize(returnadj_190_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_195_fw:=Winsorize(returnadj_195_fw, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_200_fw:=Winsorize(returnadj_200_fw, probs = c(0.01,0.99),na.rm=TRUE)]


portfolio_unchange_buyday[,Nna_return_5_fw:=ifelse(is.na(returnadj_5_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_10_fw:=ifelse(is.na(returnadj_10_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_15_fw:=ifelse(is.na(returnadj_15_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_20_fw:=ifelse(is.na(returnadj_20_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_25_fw:=ifelse(is.na(returnadj_25_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_30_fw:=ifelse(is.na(returnadj_30_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_35_fw:=ifelse(is.na(returnadj_35_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_40_fw:=ifelse(is.na(returnadj_40_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_45_fw:=ifelse(is.na(returnadj_45_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_50_fw:=ifelse(is.na(returnadj_50_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_55_fw:=ifelse(is.na(returnadj_55_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_60_fw:=ifelse(is.na(returnadj_60_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_65_fw:=ifelse(is.na(returnadj_65_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_70_fw:=ifelse(is.na(returnadj_70_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_75_fw:=ifelse(is.na(returnadj_75_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_80_fw:=ifelse(is.na(returnadj_80_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_85_fw:=ifelse(is.na(returnadj_85_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_90_fw:=ifelse(is.na(returnadj_90_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_95_fw:=ifelse(is.na(returnadj_95_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_100_fw:=ifelse(is.na(returnadj_100_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_105_fw:=ifelse(is.na(returnadj_105_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_110_fw:=ifelse(is.na(returnadj_110_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_115_fw:=ifelse(is.na(returnadj_115_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_120_fw:=ifelse(is.na(returnadj_120_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_125_fw:=ifelse(is.na(returnadj_125_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_130_fw:=ifelse(is.na(returnadj_130_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_135_fw:=ifelse(is.na(returnadj_135_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_140_fw:=ifelse(is.na(returnadj_140_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_145_fw:=ifelse(is.na(returnadj_145_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_150_fw:=ifelse(is.na(returnadj_150_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_155_fw:=ifelse(is.na(returnadj_155_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_160_fw:=ifelse(is.na(return_160_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_165_fw:=ifelse(is.na(returnadj_165_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_170_fw:=ifelse(is.na(returnadj_170_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_175_fw:=ifelse(is.na(returnadj_175_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_180_fw:=ifelse(is.na(returnadj_180_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_185_fw:=ifelse(is.na(returnadj_185_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_190_fw:=ifelse(is.na(returnadj_190_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_195_fw:=ifelse(is.na(returnadj_195_fw),0,1)]
portfolio_unchange_buyday[,Nna_return_200_fw:=ifelse(is.na(returnadj_200_fw),0,1)]



portfolio_unchange_buyday[,return_5_lag_p:=Winsorize(returnadj_5_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_10_lag_p:=Winsorize(returnadj_10_lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_15_lag_p:=Winsorize(returnadj_15lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_20_lag_p:=Winsorize(returnadj_20lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_25_lag_p:=Winsorize(returnadj_25lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_30_lag_p:=Winsorize(returnadj_30lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_35_lag_p:=Winsorize(returnadj_35lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_40_lag_p:=Winsorize(returnadj_40lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_45_lag_p:=Winsorize(returnadj_45lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_50_lag_p:=Winsorize(returnadj_50lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_55_lag_p:=Winsorize(returnadj_55lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_60_lag_p:=Winsorize(returnadj_60lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_65_lag_p:=Winsorize(returnadj_65lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_70_lag_p:=Winsorize(returnadj_70lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_75_lag_p:=Winsorize(returnadj_75lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_80_lag_p:=Winsorize(returnadj_80lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_85_lag_p:=Winsorize(returnadj_85lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_90_lag_p:=Winsorize(returnadj_90lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_95_lag_p:=Winsorize(returnadj_95lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_100_lag_p:=Winsorize(returnadj_100lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_105_lag_p:=Winsorize(returnadj_105lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_110_lag_p:=Winsorize(returnadj_110lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_115_lag_p:=Winsorize(returnadj_115lag_p, probs = c(0.01,0.99),na.rm=TRUE)]
portfolio_unchange_buyday[,return_120_lag_p:=Winsorize(returnadj_120lag_p, probs = c(0.01,0.99),na.rm=TRUE)]

portfolio_unchange_buyday[,Nna_return_5_lag_p:=ifelse(is.na(returnadj_5_lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_10_lag_p:=ifelse(is.na(returnadj_10_lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_15_lag_p:=ifelse(is.na(returnadj_15lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_20_lag_p:=ifelse(is.na(returnadj_20lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_25_lag_p:=ifelse(is.na(returnadj_25lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_30_lag_p:=ifelse(is.na(returnadj_30lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_35_lag_p:=ifelse(is.na(returnadj_35lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_40_lag_p:=ifelse(is.na(returnadj_40lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_45_lag_p:=ifelse(is.na(returnadj_45lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_50_lag_p:=ifelse(is.na(returnadj_50lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_55_lag_p:=ifelse(is.na(returnadj_55lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_60_lag_p:=ifelse(is.na(returnadj_60lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_65_lag_p:=ifelse(is.na(returnadj_65lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_70_lag_p:=ifelse(is.na(returnadj_70lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_75_lag_p:=ifelse(is.na(returnadj_75lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_80_lag_p:=ifelse(is.na(returnadj_80lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_85_lag_p:=ifelse(is.na(returnadj_85lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_90_lag_p:=ifelse(is.na(returnadj_90lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_95_lag_p:=ifelse(is.na(returnadj_95lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_100_lag_p:=ifelse(is.na(returnadj_100lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_105_lag_p:=ifelse(is.na(returnadj_105lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_110_lag_p:=ifelse(is.na(returnadj_110lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_115_lag_p:=ifelse(is.na(returnadj_115lag_p),0,1)]
portfolio_unchange_buyday[,Nna_return_120_lag_p:=ifelse(is.na(returnadj_120lag_p),0,1)]
```


```{r}
portfolio_unchange_buyday2 <- merge(portfolio_unchange_buyday, portfolios_return, 
                                   by=c("date_formated", "anon"))
portfolio_unchange_buyday2 <- portfolio_unchange_buyday2[!(is.na(winning_prop))]
portfolio_unchange_buyday2 <- portfolio_unchange_buyday2[anon %in% unique(check_for_run_fw$anon)]
portfolio_unchange_buyday_lag_plot <- portfolio_unchange_buyday2[,.(
mean_return_0=0,sd_0=0, N_0=1,
mean_return_5=mean(return_5_lag_p,na.rm=TRUE),sd_5=sd(return_5_lag_p,na.rm=TRUE), N_5=sum(Nna_return_5_lag_p),
mean_return_10=mean(return_10_lag_p,na.rm=TRUE),sd_10=sd(return_10_lag_p,na.rm=TRUE), N_10=sum(Nna_return_10_lag_p),
mean_return_15=mean(return_15_lag_p,na.rm=TRUE),sd_15=sd(return_15_lag_p,na.rm=TRUE), N_15=sum(Nna_return_15_lag_p),
mean_return_20=mean(return_20_lag_p,na.rm=TRUE),sd_20=sd(return_20_lag_p,na.rm=TRUE), N_20=sum(Nna_return_20_lag_p),
mean_return_25=mean(return_25_lag_p,na.rm=TRUE),sd_25=sd(return_25_lag_p,na.rm=TRUE), N_25=sum(Nna_return_25_lag_p),
mean_return_30=mean(return_30_lag_p,na.rm=TRUE),sd_30=sd(return_30_lag_p,na.rm=TRUE), N_30=sum(Nna_return_30_lag_p),
mean_return_35=mean(return_35_lag_p,na.rm=TRUE),sd_35=sd(return_35_lag_p,na.rm=TRUE), N_35=sum(Nna_return_35_lag_p),
mean_return_40=mean(return_40_lag_p,na.rm=TRUE),sd_40=sd(return_40_lag_p,na.rm=TRUE), N_40=sum(Nna_return_40_lag_p),
mean_return_45=mean(return_45_lag_p,na.rm=TRUE),sd_45=sd(return_45_lag_p,na.rm=TRUE), N_45=sum(Nna_return_45_lag_p),
mean_return_50=mean(return_50_lag_p,na.rm=TRUE),sd_50=sd(return_50_lag_p,na.rm=TRUE), N_50=sum(Nna_return_50_lag_p),
mean_return_55=mean(return_55_lag_p,na.rm=TRUE),sd_55=sd(return_55_lag_p,na.rm=TRUE), N_55=sum(Nna_return_55_lag_p),
mean_return_60=mean(return_60_lag_p,na.rm=TRUE),sd_60=sd(return_60_lag_p,na.rm=TRUE), N_60=sum(Nna_return_60_lag_p),
mean_return_65=mean(return_65_lag_p,na.rm=TRUE),sd_65=sd(return_65_lag_p,na.rm=TRUE), N_65=sum(Nna_return_65_lag_p),
mean_return_70=mean(return_70_lag_p,na.rm=TRUE),sd_70=sd(return_70_lag_p,na.rm=TRUE), N_70=sum(Nna_return_70_lag_p),
mean_return_75=mean(return_75_lag_p,na.rm=TRUE),sd_75=sd(return_75_lag_p,na.rm=TRUE), N_75=sum(Nna_return_75_lag_p),
mean_return_80=mean(return_80_lag_p,na.rm=TRUE),sd_80=sd(return_80_lag_p,na.rm=TRUE), N_80=sum(Nna_return_80_lag_p),
mean_return_85=mean(return_85_lag_p,na.rm=TRUE),sd_85=sd(return_85_lag_p,na.rm=TRUE), N_85=sum(Nna_return_85_lag_p),
mean_return_90=mean(return_90_lag_p,na.rm=TRUE),sd_90=sd(return_90_lag_p,na.rm=TRUE), N_90=sum(Nna_return_90_lag_p),
mean_return_95=mean(return_95_lag_p,na.rm=TRUE),sd_95=sd(return_95_lag_p,na.rm=TRUE), N_95=sum(Nna_return_95_lag_p),
mean_return_100=mean(return_100_lag_p,na.rm=TRUE),sd_100=sd(return_100_lag_p,na.rm=TRUE), N_100=sum(Nna_return_100_lag_p),
mean_return_105=mean(return_105_lag_p,na.rm=TRUE),sd_105=sd(return_105_lag_p,na.rm=TRUE), N_105=sum(Nna_return_105_lag_p),
mean_return_110=mean(return_110_lag_p,na.rm=TRUE),sd_110=sd(return_110_lag_p,na.rm=TRUE), N_110=sum(Nna_return_110_lag_p),
mean_return_115=mean(return_115_lag_p,na.rm=TRUE),sd_115=sd(return_115_lag_p,na.rm=TRUE), N_115=sum(Nna_return_115_lag_p),
mean_return_120=mean(return_120_lag_p,na.rm=TRUE),sd_120=sd(return_120_lag_p,na.rm=TRUE), N_120=sum(Nna_return_120_lag_p)
)]



portfolio_unchange_buyday_plot <- t(portfolio_unchange_buyday_lag_plot)
rnames <- row.names(portfolio_unchange_buyday_plot)
portfolio_unchange_buyday_plot <- as.data.table(portfolio_unchange_buyday_plot)
portfolio_unchange_buyday_plot[,variable:=rnames]
setnames(portfolio_unchange_buyday_plot,"V1","value")
#check_for_run_fw_plot_a <- melt(check_for_run_fw_plot, id.vars="new_stock")
portfolio_unchange_buyday_plot_a_1 <- portfolio_unchange_buyday_plot[grepl("sd",variable)]
setnames(portfolio_unchange_buyday_plot_a_1, "value", "sd")
#check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a_1[,.(sd=mean(value,na.rm=TRUE)),by=c("order", "variable")]
portfolio_unchange_buyday_plot_a_1[,days:=rep(seq(0,-120,-5),each=1)]
portfolio_unchange_buyday_plot_a_2 <-portfolio_unchange_buyday_plot[grepl("mean",variable)]
setnames(portfolio_unchange_buyday_plot_a_2, "value", "mean")
#check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a_2[,.(mean=mean(value,na.rm=TRUE)),by=c("order", "variable")]
portfolio_unchange_buyday_plot_a_2[,days:=rep(seq(0,-120,-5),each=1)]
portfolio_unchange_buyday_plot_a_3 <-portfolio_unchange_buyday_plot[grepl("N",variable)]
setnames(portfolio_unchange_buyday_plot_a_3, "value", "N")
#check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a_3[,.(N=min(value,na.rm=TRUE)),by=c("order", "variable")]
portfolio_unchange_buyday_plot_a_3[,days:=rep(seq(0,-120,-5),each=1)]
portfolio_unchange_buyday_plot_a <- merge(portfolio_unchange_buyday_plot_a_1, portfolio_unchange_buyday_plot_a_2, by="days", all.x=TRUE)
portfolio_unchange_buyday_plot_a <- merge(portfolio_unchange_buyday_plot_a, portfolio_unchange_buyday_plot_a_3, by="days", all.x=TRUE)
portfolio_unchange_buyday_plot_a[,upper_ci:=mean+1.96*sd/sqrt(N)]
portfolio_unchange_buyday_plot_a[,lower_ci:=mean-1.96*sd/sqrt(N)]

pd <- position_dodge(0.09) # move them .05 to the left and right
portfolio_unchange_buyday_plot_a[,Category:="Untouched Stocks"]
portfolio_unchange_buyday_plot_a[,new_stock:=NA]
check_for_run_fw_plot_b <- rbind(check_for_run_fw_plot_a, portfolio_unchange_buyday_plot_a)


(g6 <- ggplot(check_for_run_fw_plot_b,aes(x=days,y=mean, color=Category))+
       geom_ribbon(aes(ymin=lower_ci, ymax=upper_ci),alpha = .3, linetype=0) +
       geom_line(position=pd) +  
    xlab("Number of Working Days Before the Purchase") + ylab("1-Week Adj Return") )
ggsave(g6, file="G:/rank/new_ind/codes/codes with more anon dataset/preadjret_threegroups.png",width = 7.29, height = 4.5)
```

```{r}
check_for_run_fw_plot <- check_for_run_fw[,.(
mean_return_0=0,sd_0=0, N_0=1,
mean_return_5=mean(return_5_fw,na.rm=TRUE),sd_5=sd(return_5_fw,na.rm=TRUE), N_5=sum(Nna_return_5_fw),
mean_return_10=mean(return_10_fw,na.rm=TRUE),sd_10=sd(return_10_fw,na.rm=TRUE), N_10=sum(Nna_return_10_fw),
mean_return_15=mean(return_15_fw,na.rm=TRUE),sd_15=sd(return_15_fw,na.rm=TRUE), N_15=sum(Nna_return_15_fw),
mean_return_20=mean(return_20_fw,na.rm=TRUE),sd_20=sd(return_20_fw,na.rm=TRUE), N_20=sum(Nna_return_20_fw),
mean_return_25=mean(return_25_fw,na.rm=TRUE),sd_25=sd(return_25_fw,na.rm=TRUE), N_25=sum(Nna_return_25_fw),
mean_return_30=mean(return_30_fw,na.rm=TRUE),sd_30=sd(return_30_fw,na.rm=TRUE), N_30=sum(Nna_return_30_fw),
mean_return_35=mean(return_35_fw,na.rm=TRUE),sd_35=sd(return_35_fw,na.rm=TRUE), N_35=sum(Nna_return_35_fw),
mean_return_40=mean(return_40_fw,na.rm=TRUE),sd_40=sd(return_40_fw,na.rm=TRUE), N_40=sum(Nna_return_40_fw),
mean_return_45=mean(return_45_fw,na.rm=TRUE),sd_45=sd(return_45_fw,na.rm=TRUE), N_45=sum(Nna_return_45_fw),
mean_return_50=mean(return_50_fw,na.rm=TRUE),sd_50=sd(return_50_fw,na.rm=TRUE), N_50=sum(Nna_return_50_fw),
mean_return_55=mean(return_55_fw,na.rm=TRUE),sd_55=sd(return_55_fw,na.rm=TRUE), N_55=sum(Nna_return_55_fw),
mean_return_60=mean(return_60_fw,na.rm=TRUE),sd_60=sd(return_60_fw,na.rm=TRUE), N_60=sum(Nna_return_60_fw),
mean_return_65=mean(return_65_fw,na.rm=TRUE),sd_65=sd(return_65_fw,na.rm=TRUE), N_65=sum(Nna_return_65_fw),
mean_return_70=mean(return_70_fw,na.rm=TRUE),sd_70=sd(return_70_fw,na.rm=TRUE), N_70=sum(Nna_return_70_fw),
mean_return_75=mean(return_75_fw,na.rm=TRUE),sd_75=sd(return_75_fw,na.rm=TRUE), N_75=sum(Nna_return_75_fw),
mean_return_80=mean(return_80_fw,na.rm=TRUE),sd_80=sd(return_80_fw,na.rm=TRUE), N_80=sum(Nna_return_80_fw),
mean_return_85=mean(return_85_fw,na.rm=TRUE),sd_85=sd(return_85_fw,na.rm=TRUE), N_85=sum(Nna_return_85_fw),
mean_return_90=mean(return_90_fw,na.rm=TRUE),sd_90=sd(return_90_fw,na.rm=TRUE), N_90=sum(Nna_return_90_fw),
mean_return_95=mean(return_95_fw,na.rm=TRUE),sd_95=sd(return_95_fw,na.rm=TRUE), N_95=sum(Nna_return_95_fw),
mean_return_100=mean(return_100_fw,na.rm=TRUE),sd_100=sd(return_100_fw,na.rm=TRUE), N_100=sum(Nna_return_100_fw),
mean_return_105=mean(return_105_fw,na.rm=TRUE),sd_105=sd(return_105_fw,na.rm=TRUE), N_105=sum(Nna_return_105_fw),
mean_return_110=mean(return_110_fw,na.rm=TRUE),sd_110=sd(return_110_fw,na.rm=TRUE), N_110=sum(Nna_return_110_fw),
mean_return_115=mean(return_115_fw,na.rm=TRUE),sd_115=sd(return_115_fw,na.rm=TRUE), N_115=sum(Nna_return_115_fw),
mean_return_120=mean(return_120_fw,na.rm=TRUE),sd_120=sd(return_120_fw,na.rm=TRUE), N_120=sum(Nna_return_120_fw),
mean_return_125=mean(return_125_fw,na.rm=TRUE),sd_125=sd(return_125_fw,na.rm=TRUE), N_125=sum(Nna_return_125_fw),
mean_return_130=mean(return_130_fw,na.rm=TRUE),sd_130=sd(return_130_fw,na.rm=TRUE), N_130=sum(Nna_return_130_fw),
mean_return_135=mean(return_135_fw,na.rm=TRUE),sd_135=sd(return_135_fw,na.rm=TRUE), N_135=sum(Nna_return_135_fw),
mean_return_140=mean(return_140_fw,na.rm=TRUE),sd_140=sd(return_140_fw,na.rm=TRUE), N_140=sum(Nna_return_140_fw),
mean_return_145=mean(return_145_fw,na.rm=TRUE),sd_145=sd(return_145_fw,na.rm=TRUE), N_145=sum(Nna_return_145_fw),
mean_return_150=mean(return_150_fw,na.rm=TRUE),sd_150=sd(return_150_fw,na.rm=TRUE), N_150=sum(Nna_return_150_fw),
mean_return_155=mean(return_155_fw,na.rm=TRUE),sd_155=sd(return_155_fw,na.rm=TRUE), N_155=sum(Nna_return_155_fw),
mean_return_160=mean(return_160_fw,na.rm=TRUE),sd_160=sd(return_160_fw,na.rm=TRUE), N_160=sum(Nna_return_160_fw),
mean_return_165=mean(return_165_fw,na.rm=TRUE),sd_165=sd(return_165_fw,na.rm=TRUE), N_165=sum(Nna_return_165_fw),
mean_return_170=mean(return_170_fw,na.rm=TRUE),sd_170=sd(return_170_fw,na.rm=TRUE), N_170=sum(Nna_return_170_fw),
mean_return_175=mean(return_175_fw,na.rm=TRUE),sd_175=sd(return_175_fw,na.rm=TRUE), N_175=sum(Nna_return_175_fw),
mean_return_180=mean(return_180_fw,na.rm=TRUE),sd_180=sd(return_180_fw,na.rm=TRUE), N_180=sum(Nna_return_180_fw),
mean_return_185=mean(return_185_fw,na.rm=TRUE),sd_185=sd(return_185_fw,na.rm=TRUE), N_185=sum(Nna_return_185_fw),
mean_return_190=mean(return_190_fw,na.rm=TRUE),sd_190=sd(return_190_fw,na.rm=TRUE), N_190=sum(Nna_return_190_fw),
mean_return_195=mean(return_195_fw,na.rm=TRUE),sd_195=sd(return_195_fw,na.rm=TRUE), N_195=sum(Nna_return_195_fw),
mean_return_200=mean(return_200_fw,na.rm=TRUE),sd_200=sd(return_200_fw,na.rm=TRUE), N_200=sum(Nna_return_200_fw)
), by="new_stock"]



check_for_run_fw_plot_a <- melt(check_for_run_fw_plot, id.vars="new_stock")
check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a[grepl("sd",variable)]
setnames(check_for_run_fw_plot_a_1, "value", "sd")
#check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a_1[,.(sd=mean(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_1[,days:=rep(seq(0,200,5),each=2)]
check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a[grepl("mean",variable)]
setnames(check_for_run_fw_plot_a_2, "value", "mean")
#check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a_2[,.(mean=mean(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_2[,days:=rep(seq(0,200,5),each=2)]
check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a[grepl("N",variable)]
setnames(check_for_run_fw_plot_a_3, "value", "N")
#check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a_3[,.(N=min(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_3[,days:=rep(seq(0,200,5),each=2)]
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a_1, check_for_run_fw_plot_a_2, by=c("new_stock","days"), all.x=TRUE)
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a, check_for_run_fw_plot_a_3, by=c("new_stock","days"), all.x=TRUE)
check_for_run_fw_plot_a[,upper_ci:=mean+1.96*sd/sqrt(N)]
check_for_run_fw_plot_a[,lower_ci:=mean-1.96*sd/sqrt(N)]
check_for_run_fw_plot_a[,Category:="Purchase - invested stock"]
check_for_run_fw_plot_a[new_stock==1,Category:="New purchase"]
#check_for_run_fw_plot_a[order==2,Category:="New purchase - new industry"]
check_for_run_fw_plot_a$Category <- factor(check_for_run_fw_plot_a$Category, levels = c("Purchase - invested stock", "New purchase"))
#check_for_run_fw_plot[,type2:=paste(type,wp_group)]

# check_for_run_fw_plot$type2 <- factor(check_for_run_fw_plot$type2, levels = c("top up after positive rsp","top up after negative rsp", "new buy-invested industry after positive rsp", "new buy-invested industry after negative rsp", "new buy-new industry after positive rsp", "new buy-new industry after negative rsp"))

pd <- position_dodge(0.09) # move them .05 to the left and right



(g4 <- ggplot(check_for_run_fw_plot_a,aes(x=days,y=mean,color=Category))+
       geom_ribbon(aes(ymin=lower_ci, ymax=upper_ci),alpha = .3, linetype=0) +
       geom_line(position=pd) +  xlab("Number of Working Days After the Purchase") + ylab("Adj Return Since Purchase") )
```



## plot adj return for buys with placebo

```{r}
portfolio_unchange_buyday2 <- merge(portfolio_unchange_buyday, portfolios_return, 
                                   by=c("date_formated", "anon"))
portfolio_unchange_buyday2 <- portfolio_unchange_buyday2[!(is.na(winning_prop))]
portfolio_unchange_buyday2 <- portfolio_unchange_buyday2[anon %in% unique(check_for_run_fw$anon)]

portfolio_unchange_buyday_plot <- portfolio_unchange_buyday2[,.(
mean_return_0=0,sd_0=0, N_0=1,
mean_return_5=mean(return_5_fw,na.rm=TRUE),sd_5=sd(return_5_fw,na.rm=TRUE), N_5=sum(Nna_return_5_fw),
mean_return_10=mean(return_10_fw,na.rm=TRUE),sd_10=sd(return_10_fw,na.rm=TRUE), N_10=sum(Nna_return_10_fw),
mean_return_15=mean(return_15_fw,na.rm=TRUE),sd_15=sd(return_15_fw,na.rm=TRUE), N_15=sum(Nna_return_15_fw),
mean_return_20=mean(return_20_fw,na.rm=TRUE),sd_20=sd(return_20_fw,na.rm=TRUE), N_20=sum(Nna_return_20_fw),
mean_return_25=mean(return_25_fw,na.rm=TRUE),sd_25=sd(return_25_fw,na.rm=TRUE), N_25=sum(Nna_return_25_fw),
mean_return_30=mean(return_30_fw,na.rm=TRUE),sd_30=sd(return_30_fw,na.rm=TRUE), N_30=sum(Nna_return_30_fw),
mean_return_35=mean(return_35_fw,na.rm=TRUE),sd_35=sd(return_35_fw,na.rm=TRUE), N_35=sum(Nna_return_35_fw),
mean_return_40=mean(return_40_fw,na.rm=TRUE),sd_40=sd(return_40_fw,na.rm=TRUE), N_40=sum(Nna_return_40_fw),
mean_return_45=mean(return_45_fw,na.rm=TRUE),sd_45=sd(return_45_fw,na.rm=TRUE), N_45=sum(Nna_return_45_fw),
mean_return_50=mean(return_50_fw,na.rm=TRUE),sd_50=sd(return_50_fw,na.rm=TRUE), N_50=sum(Nna_return_50_fw),
mean_return_55=mean(return_55_fw,na.rm=TRUE),sd_55=sd(return_55_fw,na.rm=TRUE), N_55=sum(Nna_return_55_fw),
mean_return_60=mean(return_60_fw,na.rm=TRUE),sd_60=sd(return_60_fw,na.rm=TRUE), N_60=sum(Nna_return_60_fw),
mean_return_65=mean(return_65_fw,na.rm=TRUE),sd_65=sd(return_65_fw,na.rm=TRUE), N_65=sum(Nna_return_65_fw),
mean_return_70=mean(return_70_fw,na.rm=TRUE),sd_70=sd(return_70_fw,na.rm=TRUE), N_70=sum(Nna_return_70_fw),
mean_return_75=mean(return_75_fw,na.rm=TRUE),sd_75=sd(return_75_fw,na.rm=TRUE), N_75=sum(Nna_return_75_fw),
mean_return_80=mean(return_80_fw,na.rm=TRUE),sd_80=sd(return_80_fw,na.rm=TRUE), N_80=sum(Nna_return_80_fw),
mean_return_85=mean(return_85_fw,na.rm=TRUE),sd_85=sd(return_85_fw,na.rm=TRUE), N_85=sum(Nna_return_85_fw),
mean_return_90=mean(return_90_fw,na.rm=TRUE),sd_90=sd(return_90_fw,na.rm=TRUE), N_90=sum(Nna_return_90_fw),
mean_return_95=mean(return_95_fw,na.rm=TRUE),sd_95=sd(return_95_fw,na.rm=TRUE), N_95=sum(Nna_return_95_fw),
mean_return_100=mean(return_100_fw,na.rm=TRUE),sd_100=sd(return_100_fw,na.rm=TRUE), N_100=sum(Nna_return_100_fw),
mean_return_105=mean(return_105_fw,na.rm=TRUE),sd_105=sd(return_105_fw,na.rm=TRUE), N_105=sum(Nna_return_105_fw),
mean_return_110=mean(return_110_fw,na.rm=TRUE),sd_110=sd(return_110_fw,na.rm=TRUE), N_110=sum(Nna_return_110_fw),
mean_return_115=mean(return_115_fw,na.rm=TRUE),sd_115=sd(return_115_fw,na.rm=TRUE), N_115=sum(Nna_return_115_fw),
mean_return_120=mean(return_120_fw,na.rm=TRUE),sd_120=sd(return_120_fw,na.rm=TRUE), N_120=sum(Nna_return_120_fw),
mean_return_125=mean(return_125_fw,na.rm=TRUE),sd_125=sd(return_125_fw,na.rm=TRUE), N_125=sum(Nna_return_125_fw),
mean_return_130=mean(return_130_fw,na.rm=TRUE),sd_130=sd(return_130_fw,na.rm=TRUE), N_130=sum(Nna_return_130_fw),
mean_return_135=mean(return_135_fw,na.rm=TRUE),sd_135=sd(return_135_fw,na.rm=TRUE), N_135=sum(Nna_return_135_fw),
mean_return_140=mean(return_140_fw,na.rm=TRUE),sd_140=sd(return_140_fw,na.rm=TRUE), N_140=sum(Nna_return_140_fw),
mean_return_145=mean(return_145_fw,na.rm=TRUE),sd_145=sd(return_145_fw,na.rm=TRUE), N_145=sum(Nna_return_145_fw),
mean_return_150=mean(return_150_fw,na.rm=TRUE),sd_150=sd(return_150_fw,na.rm=TRUE), N_150=sum(Nna_return_150_fw),
mean_return_155=mean(return_155_fw,na.rm=TRUE),sd_155=sd(return_155_fw,na.rm=TRUE), N_155=sum(Nna_return_155_fw),
mean_return_160=mean(return_160_fw,na.rm=TRUE),sd_160=sd(return_160_fw,na.rm=TRUE), N_160=sum(Nna_return_160_fw),
mean_return_165=mean(return_165_fw,na.rm=TRUE),sd_165=sd(return_165_fw,na.rm=TRUE), N_165=sum(Nna_return_165_fw),
mean_return_170=mean(return_170_fw,na.rm=TRUE),sd_170=sd(return_170_fw,na.rm=TRUE), N_170=sum(Nna_return_170_fw),
mean_return_175=mean(return_175_fw,na.rm=TRUE),sd_175=sd(return_175_fw,na.rm=TRUE), N_175=sum(Nna_return_175_fw),
mean_return_180=mean(return_180_fw,na.rm=TRUE),sd_180=sd(return_180_fw,na.rm=TRUE), N_180=sum(Nna_return_180_fw),
mean_return_185=mean(return_185_fw,na.rm=TRUE),sd_185=sd(return_185_fw,na.rm=TRUE), N_185=sum(Nna_return_185_fw),
mean_return_190=mean(return_190_fw,na.rm=TRUE),sd_190=sd(return_190_fw,na.rm=TRUE), N_190=sum(Nna_return_190_fw),
mean_return_195=mean(return_195_fw,na.rm=TRUE),sd_195=sd(return_195_fw,na.rm=TRUE), N_195=sum(Nna_return_195_fw),
mean_return_200=mean(return_200_fw,na.rm=TRUE),sd_200=sd(return_200_fw,na.rm=TRUE), N_200=sum(Nna_return_200_fw)
)]


portfolio_unchange_buyday_plot <- t(portfolio_unchange_buyday_plot)
rnames <- row.names(portfolio_unchange_buyday_plot)
portfolio_unchange_buyday_plot <- as.data.table(portfolio_unchange_buyday_plot)
portfolio_unchange_buyday_plot[,variable:=rnames]
setnames(portfolio_unchange_buyday_plot,"V1","value")
#check_for_run_fw_plot_a <- melt(check_for_run_fw_plot, id.vars="new_stock")
portfolio_unchange_buyday_plot_a_1 <- portfolio_unchange_buyday_plot[grepl("sd",variable)]
setnames(portfolio_unchange_buyday_plot_a_1, "value", "sd")
#check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a_1[,.(sd=mean(value,na.rm=TRUE)),by=c("order", "variable")]
portfolio_unchange_buyday_plot_a_1[,days:=rep(seq(0,200,5),each=1)]
portfolio_unchange_buyday_plot_a_2 <-portfolio_unchange_buyday_plot[grepl("mean",variable)]
setnames(portfolio_unchange_buyday_plot_a_2, "value", "mean")
#check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a_2[,.(mean=mean(value,na.rm=TRUE)),by=c("order", "variable")]
portfolio_unchange_buyday_plot_a_2[,days:=rep(seq(0,200,5),each=1)]
portfolio_unchange_buyday_plot_a_3 <-portfolio_unchange_buyday_plot[grepl("N",variable)]
setnames(portfolio_unchange_buyday_plot_a_3, "value", "N")
#check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a_3[,.(N=min(value,na.rm=TRUE)),by=c("order", "variable")]
portfolio_unchange_buyday_plot_a_3[,days:=rep(seq(0,200,5),each=1)]
portfolio_unchange_buyday_plot_a <- merge(portfolio_unchange_buyday_plot_a_1, portfolio_unchange_buyday_plot_a_2, by="days", all.x=TRUE)
portfolio_unchange_buyday_plot_a <- merge(portfolio_unchange_buyday_plot_a, portfolio_unchange_buyday_plot_a_3, by="days", all.x=TRUE)
portfolio_unchange_buyday_plot_a[,upper_ci:=mean+1.96*sd/sqrt(N)]
portfolio_unchange_buyday_plot_a[,lower_ci:=mean-1.96*sd/sqrt(N)]

pd <- position_dodge(0.09) # move them .05 to the left and right
portfolio_unchange_buyday_plot_a[,Category:="Untouched Stocks"]
portfolio_unchange_buyday_plot_a[,new_stock:=NA]
check_for_run_fw_plot_b <- rbind(check_for_run_fw_plot_a, portfolio_unchange_buyday_plot_a)


(g4 <- ggplot(check_for_run_fw_plot_b,aes(x=days,y=mean, color=Category))+
       geom_ribbon(aes(ymin=lower_ci, ymax=upper_ci),alpha = .3, linetype=0) +
       geom_line(position=pd) +  xlab("Number of Working Days After the Purchase") + ylab("Adj Return Since Purchase") )


ggsave(g4, file="G:/rank/new_ind/codes/codes with more anon dataset/adjret_threegroups.png",width = 7.29, height = 4.5)

```

## adj return for purchases, break by winprop 

```{r}
# forward rsp, break by order, and further by winprop 
check_for_run_fw_plot <- check_for_run_fw[,.(
mean_return_0=0,sd_0=0, N_0=1,
mean_return_5=mean(return_5_fw,na.rm=TRUE),sd_5=sd(return_5_fw,na.rm=TRUE), N_5=sum(Nna_return_5_fw),
mean_return_10=mean(return_10_fw,na.rm=TRUE),sd_10=sd(return_10_fw,na.rm=TRUE), N_10=sum(Nna_return_10_fw),
mean_return_15=mean(return_15_fw,na.rm=TRUE),sd_15=sd(return_15_fw,na.rm=TRUE), N_15=sum(Nna_return_15_fw),
mean_return_20=mean(return_20_fw,na.rm=TRUE),sd_20=sd(return_20_fw,na.rm=TRUE), N_20=sum(Nna_return_20_fw),
mean_return_25=mean(return_25_fw,na.rm=TRUE),sd_25=sd(return_25_fw,na.rm=TRUE), N_25=sum(Nna_return_25_fw),
mean_return_30=mean(return_30_fw,na.rm=TRUE),sd_30=sd(return_30_fw,na.rm=TRUE), N_30=sum(Nna_return_30_fw),
mean_return_35=mean(return_35_fw,na.rm=TRUE),sd_35=sd(return_35_fw,na.rm=TRUE), N_35=sum(Nna_return_35_fw),
mean_return_40=mean(return_40_fw,na.rm=TRUE),sd_40=sd(return_40_fw,na.rm=TRUE), N_40=sum(Nna_return_40_fw),
mean_return_45=mean(return_45_fw,na.rm=TRUE),sd_45=sd(return_45_fw,na.rm=TRUE), N_45=sum(Nna_return_45_fw),
mean_return_50=mean(return_50_fw,na.rm=TRUE),sd_50=sd(return_50_fw,na.rm=TRUE), N_50=sum(Nna_return_50_fw),
mean_return_55=mean(return_55_fw,na.rm=TRUE),sd_55=sd(return_55_fw,na.rm=TRUE), N_55=sum(Nna_return_55_fw),
mean_return_60=mean(return_60_fw,na.rm=TRUE),sd_60=sd(return_60_fw,na.rm=TRUE), N_60=sum(Nna_return_60_fw),
mean_return_65=mean(return_65_fw,na.rm=TRUE),sd_65=sd(return_65_fw,na.rm=TRUE), N_65=sum(Nna_return_65_fw),
mean_return_70=mean(return_70_fw,na.rm=TRUE),sd_70=sd(return_70_fw,na.rm=TRUE), N_70=sum(Nna_return_70_fw),
mean_return_75=mean(return_75_fw,na.rm=TRUE),sd_75=sd(return_75_fw,na.rm=TRUE), N_75=sum(Nna_return_75_fw),
mean_return_80=mean(return_80_fw,na.rm=TRUE),sd_80=sd(return_80_fw,na.rm=TRUE), N_80=sum(Nna_return_80_fw),
mean_return_85=mean(return_85_fw,na.rm=TRUE),sd_85=sd(return_85_fw,na.rm=TRUE), N_85=sum(Nna_return_85_fw),
mean_return_90=mean(return_90_fw,na.rm=TRUE),sd_90=sd(return_90_fw,na.rm=TRUE), N_90=sum(Nna_return_90_fw),
mean_return_95=mean(return_95_fw,na.rm=TRUE),sd_95=sd(return_95_fw,na.rm=TRUE), N_95=sum(Nna_return_95_fw),
mean_return_100=mean(return_100_fw,na.rm=TRUE),sd_100=sd(return_100_fw,na.rm=TRUE), N_100=sum(Nna_return_100_fw),
mean_return_105=mean(return_105_fw,na.rm=TRUE),sd_105=sd(return_105_fw,na.rm=TRUE), N_105=sum(Nna_return_105_fw),
mean_return_110=mean(return_110_fw,na.rm=TRUE),sd_110=sd(return_110_fw,na.rm=TRUE), N_110=sum(Nna_return_110_fw),
mean_return_115=mean(return_115_fw,na.rm=TRUE),sd_115=sd(return_115_fw,na.rm=TRUE), N_115=sum(Nna_return_115_fw),
mean_return_120=mean(return_120_fw,na.rm=TRUE),sd_120=sd(return_120_fw,na.rm=TRUE), N_120=sum(Nna_return_120_fw),
mean_return_125=mean(return_125_fw,na.rm=TRUE),sd_125=sd(return_125_fw,na.rm=TRUE), N_125=sum(Nna_return_125_fw),
mean_return_130=mean(return_130_fw,na.rm=TRUE),sd_130=sd(return_130_fw,na.rm=TRUE), N_130=sum(Nna_return_130_fw),
mean_return_135=mean(return_135_fw,na.rm=TRUE),sd_135=sd(return_135_fw,na.rm=TRUE), N_135=sum(Nna_return_135_fw),
mean_return_140=mean(return_140_fw,na.rm=TRUE),sd_140=sd(return_140_fw,na.rm=TRUE), N_140=sum(Nna_return_140_fw),
mean_return_145=mean(return_145_fw,na.rm=TRUE),sd_145=sd(return_145_fw,na.rm=TRUE), N_145=sum(Nna_return_145_fw),
mean_return_150=mean(return_150_fw,na.rm=TRUE),sd_150=sd(return_150_fw,na.rm=TRUE), N_150=sum(Nna_return_150_fw),
mean_return_155=mean(return_155_fw,na.rm=TRUE),sd_155=sd(return_155_fw,na.rm=TRUE), N_155=sum(Nna_return_155_fw),
mean_return_160=mean(return_160_fw,na.rm=TRUE),sd_160=sd(return_160_fw,na.rm=TRUE), N_160=sum(Nna_return_160_fw),
mean_return_165=mean(return_165_fw,na.rm=TRUE),sd_165=sd(return_165_fw,na.rm=TRUE), N_165=sum(Nna_return_165_fw),
mean_return_170=mean(return_170_fw,na.rm=TRUE),sd_170=sd(return_170_fw,na.rm=TRUE), N_170=sum(Nna_return_170_fw),
mean_return_175=mean(return_175_fw,na.rm=TRUE),sd_175=sd(return_175_fw,na.rm=TRUE), N_175=sum(Nna_return_175_fw),
mean_return_180=mean(return_180_fw,na.rm=TRUE),sd_180=sd(return_180_fw,na.rm=TRUE), N_180=sum(Nna_return_180_fw),
mean_return_185=mean(return_185_fw,na.rm=TRUE),sd_185=sd(return_185_fw,na.rm=TRUE), N_185=sum(Nna_return_185_fw),
mean_return_190=mean(return_190_fw,na.rm=TRUE),sd_190=sd(return_190_fw,na.rm=TRUE), N_190=sum(Nna_return_190_fw),
mean_return_195=mean(return_195_fw,na.rm=TRUE),sd_195=sd(return_195_fw,na.rm=TRUE), N_195=sum(Nna_return_195_fw),
mean_return_200=mean(return_200_fw,na.rm=TRUE),sd_200=sd(return_200_fw,na.rm=TRUE), N_200=sum(Nna_return_200_fw)
), by=c("new_stock","wp_group")]



check_for_run_fw_plot_a <- melt(check_for_run_fw_plot, id.vars=c("new_stock","wp_group"))
check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a[grepl("sd",variable)]
setnames(check_for_run_fw_plot_a_1, "value", "sd")
#check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a_1[,.(sd=mean(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_1[,days:=rep(seq(0,200,5),each=8)]
check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a[grepl("mean",variable)]
setnames(check_for_run_fw_plot_a_2, "value", "mean")
#check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a_2[,.(mean=mean(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_2[,days:=rep(seq(0,200,5),each=8)]
check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a[grepl("N",variable)]
setnames(check_for_run_fw_plot_a_3, "value", "N")
#check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a_3[,.(N=min(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_3[,days:=rep(seq(0,200,5),each=8)]
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a_1, check_for_run_fw_plot_a_2, by=c("new_stock","days","wp_group"), all.x=TRUE)
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a, check_for_run_fw_plot_a_3, by=c("new_stock","days","wp_group"), all.x=TRUE)
check_for_run_fw_plot_a[,upper_ci:=mean+1.96*sd/sqrt(N)]
check_for_run_fw_plot_a[,lower_ci:=mean-1.96*sd/sqrt(N)]
check_for_run_fw_plot_a[,Category:="Purchase - invested stock"]
check_for_run_fw_plot_a[new_stock==1,Category:="New purchase"]
#check_for_run_fw_plot_a[order==2,Category:="New purchase - new industry"]
check_for_run_fw_plot_a$Category <- factor(check_for_run_fw_plot_a$Category, levels = c("Purchase - invested stock", "New purchase"))
#check_for_run_fw_plot[,type2:=paste(type,wp_group)]

# check_for_run_fw_plot$type2 <- factor(check_for_run_fw_plot$type2, levels = c("top up after positive rsp","top up after negative rsp", "new buy-invested industry after positive rsp", "new buy-invested industry after negative rsp", "new buy-new industry after positive rsp", "new buy-new industry after negative rsp"))

pd <- position_dodge(0.09) # move them .05 to the left and right



(g4 <- ggplot(check_for_run_fw_plot_a,aes(x=days,y=mean,color=Category))+
       geom_ribbon(aes(ymin=lower_ci, ymax=upper_ci),alpha = .3, linetype=0) +
       geom_line(position=pd) +  facet_wrap(vars(wp_group)) +
    xlab("Number of Working Days After the Purchase") + ylab("Adj Return Since Purchase") )

#ggsave(g5, file="G:/rank/new_ind/codes/codes with more anon dataset/returnafterbuy2.png",width = 7.29, height = 4.5)
```

## plot broken by winprop with placebo

```{r}
portfolio_unchange_buyday3 <- merge(portfolio_unchange_buyday, portfolios_return, 
                                   by=c("date_formated", "anon"))
portfolio_unchange_buyday3 <- portfolio_unchange_buyday3[!(is.na(winning_prop))]
portfolio_unchange_buyday3 <- portfolio_unchange_buyday3[anon %in% unique(check_for_run_fw$anon)]
portfolio_unchange_buyday3[,wp_group:=cut(winning_prop,breaks = seq(0,1,0.25),include.lowest = TRUE)]

portfolio_unchange_buyday_plot <- portfolio_unchange_buyday3[,.(
mean_return_0=0,sd_0=0, N_0=1,
mean_return_5=mean(return_5_fw,na.rm=TRUE),sd_5=sd(return_5_fw,na.rm=TRUE), N_5=sum(Nna_return_5_fw),
mean_return_10=mean(return_10_fw,na.rm=TRUE),sd_10=sd(return_10_fw,na.rm=TRUE), N_10=sum(Nna_return_10_fw),
mean_return_15=mean(return_15_fw,na.rm=TRUE),sd_15=sd(return_15_fw,na.rm=TRUE), N_15=sum(Nna_return_15_fw),
mean_return_20=mean(return_20_fw,na.rm=TRUE),sd_20=sd(return_20_fw,na.rm=TRUE), N_20=sum(Nna_return_20_fw),
mean_return_25=mean(return_25_fw,na.rm=TRUE),sd_25=sd(return_25_fw,na.rm=TRUE), N_25=sum(Nna_return_25_fw),
mean_return_30=mean(return_30_fw,na.rm=TRUE),sd_30=sd(return_30_fw,na.rm=TRUE), N_30=sum(Nna_return_30_fw),
mean_return_35=mean(return_35_fw,na.rm=TRUE),sd_35=sd(return_35_fw,na.rm=TRUE), N_35=sum(Nna_return_35_fw),
mean_return_40=mean(return_40_fw,na.rm=TRUE),sd_40=sd(return_40_fw,na.rm=TRUE), N_40=sum(Nna_return_40_fw),
mean_return_45=mean(return_45_fw,na.rm=TRUE),sd_45=sd(return_45_fw,na.rm=TRUE), N_45=sum(Nna_return_45_fw),
mean_return_50=mean(return_50_fw,na.rm=TRUE),sd_50=sd(return_50_fw,na.rm=TRUE), N_50=sum(Nna_return_50_fw),
mean_return_55=mean(return_55_fw,na.rm=TRUE),sd_55=sd(return_55_fw,na.rm=TRUE), N_55=sum(Nna_return_55_fw),
mean_return_60=mean(return_60_fw,na.rm=TRUE),sd_60=sd(return_60_fw,na.rm=TRUE), N_60=sum(Nna_return_60_fw),
mean_return_65=mean(return_65_fw,na.rm=TRUE),sd_65=sd(return_65_fw,na.rm=TRUE), N_65=sum(Nna_return_65_fw),
mean_return_70=mean(return_70_fw,na.rm=TRUE),sd_70=sd(return_70_fw,na.rm=TRUE), N_70=sum(Nna_return_70_fw),
mean_return_75=mean(return_75_fw,na.rm=TRUE),sd_75=sd(return_75_fw,na.rm=TRUE), N_75=sum(Nna_return_75_fw),
mean_return_80=mean(return_80_fw,na.rm=TRUE),sd_80=sd(return_80_fw,na.rm=TRUE), N_80=sum(Nna_return_80_fw),
mean_return_85=mean(return_85_fw,na.rm=TRUE),sd_85=sd(return_85_fw,na.rm=TRUE), N_85=sum(Nna_return_85_fw),
mean_return_90=mean(return_90_fw,na.rm=TRUE),sd_90=sd(return_90_fw,na.rm=TRUE), N_90=sum(Nna_return_90_fw),
mean_return_95=mean(return_95_fw,na.rm=TRUE),sd_95=sd(return_95_fw,na.rm=TRUE), N_95=sum(Nna_return_95_fw),
mean_return_100=mean(return_100_fw,na.rm=TRUE),sd_100=sd(return_100_fw,na.rm=TRUE), N_100=sum(Nna_return_100_fw),
mean_return_105=mean(return_105_fw,na.rm=TRUE),sd_105=sd(return_105_fw,na.rm=TRUE), N_105=sum(Nna_return_105_fw),
mean_return_110=mean(return_110_fw,na.rm=TRUE),sd_110=sd(return_110_fw,na.rm=TRUE), N_110=sum(Nna_return_110_fw),
mean_return_115=mean(return_115_fw,na.rm=TRUE),sd_115=sd(return_115_fw,na.rm=TRUE), N_115=sum(Nna_return_115_fw),
mean_return_120=mean(return_120_fw,na.rm=TRUE),sd_120=sd(return_120_fw,na.rm=TRUE), N_120=sum(Nna_return_120_fw),
mean_return_125=mean(return_125_fw,na.rm=TRUE),sd_125=sd(return_125_fw,na.rm=TRUE), N_125=sum(Nna_return_125_fw),
mean_return_130=mean(return_130_fw,na.rm=TRUE),sd_130=sd(return_130_fw,na.rm=TRUE), N_130=sum(Nna_return_130_fw),
mean_return_135=mean(return_135_fw,na.rm=TRUE),sd_135=sd(return_135_fw,na.rm=TRUE), N_135=sum(Nna_return_135_fw),
mean_return_140=mean(return_140_fw,na.rm=TRUE),sd_140=sd(return_140_fw,na.rm=TRUE), N_140=sum(Nna_return_140_fw),
mean_return_145=mean(return_145_fw,na.rm=TRUE),sd_145=sd(return_145_fw,na.rm=TRUE), N_145=sum(Nna_return_145_fw),
mean_return_150=mean(return_150_fw,na.rm=TRUE),sd_150=sd(return_150_fw,na.rm=TRUE), N_150=sum(Nna_return_150_fw),
mean_return_155=mean(return_155_fw,na.rm=TRUE),sd_155=sd(return_155_fw,na.rm=TRUE), N_155=sum(Nna_return_155_fw),
mean_return_160=mean(return_160_fw,na.rm=TRUE),sd_160=sd(return_160_fw,na.rm=TRUE), N_160=sum(Nna_return_160_fw),
mean_return_165=mean(return_165_fw,na.rm=TRUE),sd_165=sd(return_165_fw,na.rm=TRUE), N_165=sum(Nna_return_165_fw),
mean_return_170=mean(return_170_fw,na.rm=TRUE),sd_170=sd(return_170_fw,na.rm=TRUE), N_170=sum(Nna_return_170_fw),
mean_return_175=mean(return_175_fw,na.rm=TRUE),sd_175=sd(return_175_fw,na.rm=TRUE), N_175=sum(Nna_return_175_fw),
mean_return_180=mean(return_180_fw,na.rm=TRUE),sd_180=sd(return_180_fw,na.rm=TRUE), N_180=sum(Nna_return_180_fw),
mean_return_185=mean(return_185_fw,na.rm=TRUE),sd_185=sd(return_185_fw,na.rm=TRUE), N_185=sum(Nna_return_185_fw),
mean_return_190=mean(return_190_fw,na.rm=TRUE),sd_190=sd(return_190_fw,na.rm=TRUE), N_190=sum(Nna_return_190_fw),
mean_return_195=mean(return_195_fw,na.rm=TRUE),sd_195=sd(return_195_fw,na.rm=TRUE), N_195=sum(Nna_return_195_fw),
mean_return_200=mean(return_200_fw,na.rm=TRUE),sd_200=sd(return_200_fw,na.rm=TRUE), N_200=sum(Nna_return_200_fw)
), by=wp_group]

portfolio_unchange_buyday_plot <- portfolio_unchange_buyday_plot[!(is.na(wp_group))]

portfolio_unchange_buyday_plot <- melt(portfolio_unchange_buyday_plot, id.vars="wp_group")
portfolio_unchange_buyday_plot <- as.data.table(portfolio_unchange_buyday_plot)
#setnames(portfolio_unchange_buyday_plot,"V1","value")
#check_for_run_fw_plot_a <- melt(check_for_run_fw_plot, id.vars="new_stock")
portfolio_unchange_buyday_plot_a_1 <- portfolio_unchange_buyday_plot[grepl("sd",variable)]
setnames(portfolio_unchange_buyday_plot_a_1, "value", "sd")
#check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a_1[,.(sd=mean(value,na.rm=TRUE)),by=c("order", "variable")]
portfolio_unchange_buyday_plot_a_1[,days:=rep(seq(0,200,5),each=4)]
portfolio_unchange_buyday_plot_a_2 <-portfolio_unchange_buyday_plot[grepl("mean",variable)]
setnames(portfolio_unchange_buyday_plot_a_2, "value", "mean")
#check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a_2[,.(mean=mean(value,na.rm=TRUE)),by=c("order", "variable")]
portfolio_unchange_buyday_plot_a_2[,days:=rep(seq(0,200,5),each=4)]
portfolio_unchange_buyday_plot_a_3 <-portfolio_unchange_buyday_plot[grepl("N",variable)]
setnames(portfolio_unchange_buyday_plot_a_3, "value", "N")
#check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a_3[,.(N=min(value,na.rm=TRUE)),by=c("order", "variable")]
portfolio_unchange_buyday_plot_a_3[,days:=rep(seq(0,200,5),each=4)]
portfolio_unchange_buyday_plot_a <- merge(portfolio_unchange_buyday_plot_a_1, portfolio_unchange_buyday_plot_a_2, by=c("wp_group","days"), all.x=TRUE)
portfolio_unchange_buyday_plot_a <- merge(portfolio_unchange_buyday_plot_a, portfolio_unchange_buyday_plot_a_3, by=c("wp_group","days"), all.x=TRUE)
portfolio_unchange_buyday_plot_a[,upper_ci:=mean+1.96*sd/sqrt(N)]
portfolio_unchange_buyday_plot_a[,lower_ci:=mean-1.96*sd/sqrt(N)]

pd <- position_dodge(0.09) # move them .05 to the left and right
portfolio_unchange_buyday_plot_a[,Category:="Untouched Stocks"]
portfolio_unchange_buyday_plot_a[,new_stock:=NA]
check_for_run_fw_plot_b <- rbind(check_for_run_fw_plot_a, portfolio_unchange_buyday_plot_a)


(g4 <- ggplot(check_for_run_fw_plot_b,aes(x=days,y=mean, color=Category))+
       geom_ribbon(aes(ymin=lower_ci, ymax=upper_ci),alpha = .3, linetype=0) +
       geom_line(position=pd) +  facet_wrap(vars(wp_group)) +
    xlab("Number of Working Days After the Purchase") + ylab("Adj Return Since Purchase") )
#ggsave(g4, file="G:/rank/new_ind/codes/codes with more anon dataset/adjret_threegroups_winprop.png",width = 7.29, height = 4.5)
```



# plot: forward rsp, break by order, and further by winprop
```{r}
# forward rsp, break by order, and further by winprop

check_for_run_fw_plot <- check_for_run_fw[,.(
mean_return_0=0,sd_0=0, N_0=1,
mean_return_5=mean(return_5_fw,na.rm=TRUE),sd_5=sd(return_5_fw,na.rm=TRUE), N_5=sum(Nna_return_5_fw),
mean_return_10=mean(return_10_fw,na.rm=TRUE),sd_10=sd(return_10_fw,na.rm=TRUE), N_10=sum(Nna_return_10_fw),
mean_return_15=mean(return_15_fw,na.rm=TRUE),sd_15=sd(return_15_fw,na.rm=TRUE), N_15=sum(Nna_return_15_fw),
mean_return_20=mean(return_20_fw,na.rm=TRUE),sd_20=sd(return_20_fw,na.rm=TRUE), N_20=sum(Nna_return_20_fw),
mean_return_25=mean(return_25_fw,na.rm=TRUE),sd_25=sd(return_25_fw,na.rm=TRUE), N_25=sum(Nna_return_25_fw),
mean_return_30=mean(return_30_fw,na.rm=TRUE),sd_30=sd(return_30_fw,na.rm=TRUE), N_30=sum(Nna_return_30_fw),
mean_return_35=mean(return_35_fw,na.rm=TRUE),sd_35=sd(return_35_fw,na.rm=TRUE), N_35=sum(Nna_return_35_fw),
mean_return_40=mean(return_40_fw,na.rm=TRUE),sd_40=sd(return_40_fw,na.rm=TRUE), N_40=sum(Nna_return_40_fw),
mean_return_45=mean(return_45_fw,na.rm=TRUE),sd_45=sd(return_45_fw,na.rm=TRUE), N_45=sum(Nna_return_45_fw),
mean_return_50=mean(return_50_fw,na.rm=TRUE),sd_50=sd(return_50_fw,na.rm=TRUE), N_50=sum(Nna_return_50_fw),
mean_return_55=mean(return_55_fw,na.rm=TRUE),sd_55=sd(return_55_fw,na.rm=TRUE), N_55=sum(Nna_return_55_fw),
mean_return_60=mean(return_60_fw,na.rm=TRUE),sd_60=sd(return_60_fw,na.rm=TRUE), N_60=sum(Nna_return_60_fw),
mean_return_65=mean(return_65_fw,na.rm=TRUE),sd_65=sd(return_65_fw,na.rm=TRUE), N_65=sum(Nna_return_65_fw),
mean_return_70=mean(return_70_fw,na.rm=TRUE),sd_70=sd(return_70_fw,na.rm=TRUE), N_70=sum(Nna_return_70_fw),
mean_return_75=mean(return_75_fw,na.rm=TRUE),sd_75=sd(return_75_fw,na.rm=TRUE), N_75=sum(Nna_return_75_fw),
mean_return_80=mean(return_80_fw,na.rm=TRUE),sd_80=sd(return_80_fw,na.rm=TRUE), N_80=sum(Nna_return_80_fw),
mean_return_85=mean(return_85_fw,na.rm=TRUE),sd_85=sd(return_85_fw,na.rm=TRUE), N_85=sum(Nna_return_85_fw),
mean_return_90=mean(return_90_fw,na.rm=TRUE),sd_90=sd(return_90_fw,na.rm=TRUE), N_90=sum(Nna_return_90_fw),
mean_return_95=mean(return_95_fw,na.rm=TRUE),sd_95=sd(return_95_fw,na.rm=TRUE), N_95=sum(Nna_return_95_fw),
mean_return_100=mean(return_100_fw,na.rm=TRUE),sd_100=sd(return_100_fw,na.rm=TRUE), N_100=sum(Nna_return_100_fw),
mean_return_105=mean(return_105_fw,na.rm=TRUE),sd_105=sd(return_105_fw,na.rm=TRUE), N_105=sum(Nna_return_105_fw),
mean_return_110=mean(return_110_fw,na.rm=TRUE),sd_110=sd(return_110_fw,na.rm=TRUE), N_110=sum(Nna_return_110_fw),
mean_return_115=mean(return_115_fw,na.rm=TRUE),sd_115=sd(return_115_fw,na.rm=TRUE), N_115=sum(Nna_return_115_fw),
mean_return_120=mean(return_120_fw,na.rm=TRUE),sd_120=sd(return_120_fw,na.rm=TRUE), N_120=sum(Nna_return_120_fw),
mean_return_125=mean(return_125_fw,na.rm=TRUE),sd_125=sd(return_125_fw,na.rm=TRUE), N_125=sum(Nna_return_125_fw),
mean_return_130=mean(return_130_fw,na.rm=TRUE),sd_130=sd(return_130_fw,na.rm=TRUE), N_130=sum(Nna_return_130_fw),
mean_return_135=mean(return_135_fw,na.rm=TRUE),sd_135=sd(return_135_fw,na.rm=TRUE), N_135=sum(Nna_return_135_fw),
mean_return_140=mean(return_140_fw,na.rm=TRUE),sd_140=sd(return_140_fw,na.rm=TRUE), N_140=sum(Nna_return_140_fw),
mean_return_145=mean(return_145_fw,na.rm=TRUE),sd_145=sd(return_145_fw,na.rm=TRUE), N_145=sum(Nna_return_145_fw),
mean_return_150=mean(return_150_fw,na.rm=TRUE),sd_150=sd(return_150_fw,na.rm=TRUE), N_150=sum(Nna_return_150_fw),
mean_return_155=mean(return_155_fw,na.rm=TRUE),sd_155=sd(return_155_fw,na.rm=TRUE), N_155=sum(Nna_return_155_fw),
mean_return_160=mean(return_160_fw,na.rm=TRUE),sd_160=sd(return_160_fw,na.rm=TRUE), N_160=sum(Nna_return_160_fw),
mean_return_165=mean(return_165_fw,na.rm=TRUE),sd_165=sd(return_165_fw,na.rm=TRUE), N_165=sum(Nna_return_165_fw),
mean_return_170=mean(return_170_fw,na.rm=TRUE),sd_170=sd(return_170_fw,na.rm=TRUE), N_170=sum(Nna_return_170_fw),
mean_return_175=mean(return_175_fw,na.rm=TRUE),sd_175=sd(return_175_fw,na.rm=TRUE), N_175=sum(Nna_return_175_fw),
mean_return_180=mean(return_180_fw,na.rm=TRUE),sd_180=sd(return_180_fw,na.rm=TRUE), N_180=sum(Nna_return_180_fw),
mean_return_185=mean(return_185_fw,na.rm=TRUE),sd_185=sd(return_185_fw,na.rm=TRUE), N_185=sum(Nna_return_185_fw),
mean_return_190=mean(return_190_fw,na.rm=TRUE),sd_190=sd(return_190_fw,na.rm=TRUE), N_190=sum(Nna_return_190_fw),
mean_return_195=mean(return_195_fw,na.rm=TRUE),sd_195=sd(return_195_fw,na.rm=TRUE), N_195=sum(Nna_return_195_fw),
mean_return_200=mean(return_200_fw,na.rm=TRUE),sd_200=sd(return_200_fw,na.rm=TRUE), N_200=sum(Nna_return_200_fw)
), by=c("order","wp_group")]

check_for_run_fw_plot_b <- melt(check_for_run_fw_plot, id.vars=c("order","wp_group"))

check_for_run_fw_plot_b_1 <- check_for_run_fw_plot_b[grepl("sd",variable)]
check_for_run_fw_plot_b_1[,days:=rep(seq(0,200,5),each=12)]
check_for_run_fw_plot_b_2 <- check_for_run_fw_plot_b[grepl("mean",variable)]
check_for_run_fw_plot_b_2[,days:=rep(seq(0,200,5),each=12)]
check_for_run_fw_plot_b_3 <- check_for_run_fw_plot_b[grepl("N",variable)]
check_for_run_fw_plot_b_3[,days:=rep(seq(0,200,5),each=12)]
check_for_run_fw_plot_b <- merge(check_for_run_fw_plot_b_1, check_for_run_fw_plot_b_2, by=c("order","days","wp_group"), all.x=TRUE)
setnames(check_for_run_fw_plot_b, c("value.x","value.y"), c("sd","mean"))
check_for_run_fw_plot_b <- merge(check_for_run_fw_plot_b, check_for_run_fw_plot_b_3, by=c("order","days","wp_group"), all.x=TRUE)
setnames(check_for_run_fw_plot_b, "value", "N")
check_for_run_fw_plot_b[,upper_ci:=mean+1.96*sd/sqrt(N)]
check_for_run_fw_plot_b[,lower_ci:=mean-1.96*sd/sqrt(N)]
check_for_run_fw_plot_b[,Category:="Purchase - invested stock"]
check_for_run_fw_plot_b[order==1,Category:="New purchase - invested industry"]
check_for_run_fw_plot_b[order==2,Category:="New purchase - new industry"]
check_for_run_fw_plot_b$Category <- factor(check_for_run_fw_plot_b$Category, levels = c("Purchase - invested stock", "New purchase - invested industry", "New purchase - new industry"))
#check_for_run_fw_plot[,type2:=paste(type,wp_group)]

# check_for_run_fw_plot$type2 <- factor(check_for_run_fw_plot$type2, levels = c("top up after positive rsp","top up after negative rsp", "new buy-invested industry after positive rsp", "new buy-invested industry after negative rsp", "new buy-new industry after positive rsp", "new buy-new industry after negative rsp"))

pd <- position_dodge(0.03) # move them .05 to the left and right



(g5 <- ggplot(check_for_run_fw_plot_b,aes(x=days,y=mean,color=Category))+
       geom_errorbar(aes(ymin=lower_ci, ymax=upper_ci), width=.05, position=pd) +
       geom_line(position=pd) + facet_wrap(vars(wp_group)) +
       geom_point(position=pd,size = 0.1)  + xlab("Number of Working Days After the Purchase") + ylab("Return Since Purchase") )

ggsave(g5, file="G:/rank/new_ind/codes/codes with more anon dataset/returnafterbuy2.png",width = 7.29, height = 4.5)
```


# plot: forward rsp, break by order2, and further by winprop
```{r}
# forward rsp, break by order2, and further by winprop

check_for_run_fw_plot <- check_for_run_fw[,.(
mean_return_0=0,sd_0=0, N_0=1,
mean_return_5=mean(return_5_fw,na.rm=TRUE),sd_5=sd(return_5_fw,na.rm=TRUE), N_5=sum(Nna_return_5_fw),
mean_return_10=mean(return_10_fw,na.rm=TRUE),sd_10=sd(return_10_fw,na.rm=TRUE), N_10=sum(Nna_return_10_fw),
mean_return_15=mean(return_15_fw,na.rm=TRUE),sd_15=sd(return_15_fw,na.rm=TRUE), N_15=sum(Nna_return_15_fw),
mean_return_20=mean(return_20_fw,na.rm=TRUE),sd_20=sd(return_20_fw,na.rm=TRUE), N_20=sum(Nna_return_20_fw),
mean_return_25=mean(return_25_fw,na.rm=TRUE),sd_25=sd(return_25_fw,na.rm=TRUE), N_25=sum(Nna_return_25_fw),
mean_return_30=mean(return_30_fw,na.rm=TRUE),sd_30=sd(return_30_fw,na.rm=TRUE), N_30=sum(Nna_return_30_fw),
mean_return_35=mean(return_35_fw,na.rm=TRUE),sd_35=sd(return_35_fw,na.rm=TRUE), N_35=sum(Nna_return_35_fw),
mean_return_40=mean(return_40_fw,na.rm=TRUE),sd_40=sd(return_40_fw,na.rm=TRUE), N_40=sum(Nna_return_40_fw),
mean_return_45=mean(return_45_fw,na.rm=TRUE),sd_45=sd(return_45_fw,na.rm=TRUE), N_45=sum(Nna_return_45_fw),
mean_return_50=mean(return_50_fw,na.rm=TRUE),sd_50=sd(return_50_fw,na.rm=TRUE), N_50=sum(Nna_return_50_fw),
mean_return_55=mean(return_55_fw,na.rm=TRUE),sd_55=sd(return_55_fw,na.rm=TRUE), N_55=sum(Nna_return_55_fw),
mean_return_60=mean(return_60_fw,na.rm=TRUE),sd_60=sd(return_60_fw,na.rm=TRUE), N_60=sum(Nna_return_60_fw),
mean_return_65=mean(return_65_fw,na.rm=TRUE),sd_65=sd(return_65_fw,na.rm=TRUE), N_65=sum(Nna_return_65_fw),
mean_return_70=mean(return_70_fw,na.rm=TRUE),sd_70=sd(return_70_fw,na.rm=TRUE), N_70=sum(Nna_return_70_fw),
mean_return_75=mean(return_75_fw,na.rm=TRUE),sd_75=sd(return_75_fw,na.rm=TRUE), N_75=sum(Nna_return_75_fw),
mean_return_80=mean(return_80_fw,na.rm=TRUE),sd_80=sd(return_80_fw,na.rm=TRUE), N_80=sum(Nna_return_80_fw),
mean_return_85=mean(return_85_fw,na.rm=TRUE),sd_85=sd(return_85_fw,na.rm=TRUE), N_85=sum(Nna_return_85_fw),
mean_return_90=mean(return_90_fw,na.rm=TRUE),sd_90=sd(return_90_fw,na.rm=TRUE), N_90=sum(Nna_return_90_fw),
mean_return_95=mean(return_95_fw,na.rm=TRUE),sd_95=sd(return_95_fw,na.rm=TRUE), N_95=sum(Nna_return_95_fw),
mean_return_100=mean(return_100_fw,na.rm=TRUE),sd_100=sd(return_100_fw,na.rm=TRUE), N_100=sum(Nna_return_100_fw),
mean_return_105=mean(return_105_fw,na.rm=TRUE),sd_105=sd(return_105_fw,na.rm=TRUE), N_105=sum(Nna_return_105_fw),
mean_return_110=mean(return_110_fw,na.rm=TRUE),sd_110=sd(return_110_fw,na.rm=TRUE), N_110=sum(Nna_return_110_fw),
mean_return_115=mean(return_115_fw,na.rm=TRUE),sd_115=sd(return_115_fw,na.rm=TRUE), N_115=sum(Nna_return_115_fw),
mean_return_120=mean(return_120_fw,na.rm=TRUE),sd_120=sd(return_120_fw,na.rm=TRUE), N_120=sum(Nna_return_120_fw),
mean_return_125=mean(return_125_fw,na.rm=TRUE),sd_125=sd(return_125_fw,na.rm=TRUE), N_125=sum(Nna_return_125_fw),
mean_return_130=mean(return_130_fw,na.rm=TRUE),sd_130=sd(return_130_fw,na.rm=TRUE), N_130=sum(Nna_return_130_fw),
mean_return_135=mean(return_135_fw,na.rm=TRUE),sd_135=sd(return_135_fw,na.rm=TRUE), N_135=sum(Nna_return_135_fw),
mean_return_140=mean(return_140_fw,na.rm=TRUE),sd_140=sd(return_140_fw,na.rm=TRUE), N_140=sum(Nna_return_140_fw),
mean_return_145=mean(return_145_fw,na.rm=TRUE),sd_145=sd(return_145_fw,na.rm=TRUE), N_145=sum(Nna_return_145_fw),
mean_return_150=mean(return_150_fw,na.rm=TRUE),sd_150=sd(return_150_fw,na.rm=TRUE), N_150=sum(Nna_return_150_fw),
mean_return_155=mean(return_155_fw,na.rm=TRUE),sd_155=sd(return_155_fw,na.rm=TRUE), N_155=sum(Nna_return_155_fw),
mean_return_160=mean(return_160_fw,na.rm=TRUE),sd_160=sd(return_160_fw,na.rm=TRUE), N_160=sum(Nna_return_160_fw),
mean_return_165=mean(return_165_fw,na.rm=TRUE),sd_165=sd(return_165_fw,na.rm=TRUE), N_165=sum(Nna_return_165_fw),
mean_return_170=mean(return_170_fw,na.rm=TRUE),sd_170=sd(return_170_fw,na.rm=TRUE), N_170=sum(Nna_return_170_fw),
mean_return_175=mean(return_175_fw,na.rm=TRUE),sd_175=sd(return_175_fw,na.rm=TRUE), N_175=sum(Nna_return_175_fw),
mean_return_180=mean(return_180_fw,na.rm=TRUE),sd_180=sd(return_180_fw,na.rm=TRUE), N_180=sum(Nna_return_180_fw),
mean_return_185=mean(return_185_fw,na.rm=TRUE),sd_185=sd(return_185_fw,na.rm=TRUE), N_185=sum(Nna_return_185_fw),
mean_return_190=mean(return_190_fw,na.rm=TRUE),sd_190=sd(return_190_fw,na.rm=TRUE), N_190=sum(Nna_return_190_fw),
mean_return_195=mean(return_195_fw,na.rm=TRUE),sd_195=sd(return_195_fw,na.rm=TRUE), N_195=sum(Nna_return_195_fw),
mean_return_200=mean(return_200_fw,na.rm=TRUE),sd_200=sd(return_200_fw,na.rm=TRUE), N_200=sum(Nna_return_200_fw)
), by=c("order2","wp_group")]

check_for_run_fw_plot_a <- copy(check_for_run_fw_plot)
check_for_run_fw_plot_a[,wp_group:=NULL]
check_for_run_fw_plot_a <- melt(check_for_run_fw_plot_a, id.vars="order2")
check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a[grepl("sd",variable)]
check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a_1[,.(sd=mean(value,na.rm=TRUE)),by=c("order2", "variable")]
check_for_run_fw_plot_a_1[,days:=rep(seq(0,200,5),each=3)]
check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a[grepl("mean",variable)]
check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a_2[,.(mean=mean(value,na.rm=TRUE)),by=c("order2", "variable")]
check_for_run_fw_plot_a_2[,days:=rep(seq(0,200,5),each=3)]
check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a[grepl("N",variable)]
check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a_3[,.(N=min(value,na.rm=TRUE)),by=c("order2", "variable")]
check_for_run_fw_plot_a_3[,days:=rep(seq(0,200,5),each=3)]
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a_1, check_for_run_fw_plot_a_2, by=c("order2","days"), all.x=TRUE)
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a, check_for_run_fw_plot_a_3, by=c("order2","days"), all.x=TRUE)
check_for_run_fw_plot_a[,upper_ci:=mean+1.96*sd/sqrt(N)]
check_for_run_fw_plot_a[,lower_ci:=mean-1.96*sd/sqrt(N)]
check_for_run_fw_plot_a[,Category:="Purchase - top up"]
check_for_run_fw_plot_a[order2==1,Category:="Purchase - invested but 0 holding"]
check_for_run_fw_plot_a[order2==2,Category:="New purchase"]
check_for_run_fw_plot_a$Category <- factor(check_for_run_fw_plot_a$Category, levels = c("Purchase - top up", "Purchase - invested but 0 holding", "New purchase"))
#check_for_run_fw_plot[,type2:=paste(type,wp_group)]

# check_for_run_fw_plot$type2 <- factor(check_for_run_fw_plot$type2, levels = c("top up after positive rsp","top up after negative rsp", "new buy-invested industry after positive rsp", "new buy-invested industry after negative rsp", "new buy-new industry after positive rsp", "new buy-new industry after negative rsp"))

pd <- position_dodge(0.09) # move them .05 to the left and right



(g6 <- ggplot(check_for_run_fw_plot_a,aes(x=days,y=mean,color=Category))+
       geom_errorbar(aes(ymin=lower_ci, ymax=upper_ci), width=.05, position=pd) +
       geom_line(position=pd) + 
       geom_point(position=pd,size = 0.1)  + xlab("Number of Working Days After the Purchase") + ylab("Return Since Purchase") )
#ggsave(g4, file="G:/rank/new_ind/codes/codes with more anon dataset/returnafterbuy.png",width = 7.29, height = 4.5)
```


```{R}

check_for_run_fw_plot_b <- melt(check_for_run_fw_plot, id.vars=c("order2","wp_group"))

check_for_run_fw_plot_b_1 <- check_for_run_fw_plot_b[grepl("sd",variable)]
check_for_run_fw_plot_b_1[,days:=rep(seq(0,200,5),each=12)]
check_for_run_fw_plot_b_2 <- check_for_run_fw_plot_b[grepl("mean",variable)]
check_for_run_fw_plot_b_2[,days:=rep(seq(0,200,5),each=12)]
check_for_run_fw_plot_b_3 <- check_for_run_fw_plot_b[grepl("N",variable)]
check_for_run_fw_plot_b_3[,days:=rep(seq(0,200,5),each=12)]
check_for_run_fw_plot_b <- merge(check_for_run_fw_plot_b_1, check_for_run_fw_plot_b_2, by=c("order2","days","wp_group"), all.x=TRUE)
setnames(check_for_run_fw_plot_b, c("value.x","value.y"), c("sd","mean"))
check_for_run_fw_plot_b <- merge(check_for_run_fw_plot_b, check_for_run_fw_plot_b_3, by=c("order2","days","wp_group"), all.x=TRUE)
setnames(check_for_run_fw_plot_b, "value", "N")
check_for_run_fw_plot_b[,upper_ci:=mean+1.96*sd/sqrt(N)]
check_for_run_fw_plot_b[,lower_ci:=mean-1.96*sd/sqrt(N)]
check_for_run_fw_plot_b[,Category:="Purchase - top up"]
check_for_run_fw_plot_b[order2==1,Category:="Purchase - invested but 0 holding"]
check_for_run_fw_plot_b[order2==2,Category:="New purchase"]
check_for_run_fw_plot_b$Category <- factor(check_for_run_fw_plot_b$Category, levels = c("Purchase - top up", "Purchase - invested but 0 holding", "New purchase"))
#check_for_run_fw_plot[,type2:=paste(type,wp_group)]

# check_for_run_fw_plot$type2 <- factor(check_for_run_fw_plot$type2, levels = c("top up after positive rsp","top up after negative rsp", "new buy-invested industry after positive rsp", "new buy-invested industry after negative rsp", "new buy-new industry after positive rsp", "new buy-new industry after negative rsp"))

pd <- position_dodge(0.03) # move them .05 to the left and right



(g7 <- ggplot(check_for_run_fw_plot_b,aes(x=days,y=mean,color=Category))+
       geom_errorbar(aes(ymin=lower_ci, ymax=upper_ci), width=.05, position=pd) +
       geom_line(position=pd) + facet_wrap(vars(wp_group)) +
       geom_point(position=pd,size = 0.1)  + xlab("Number of Working Days After the Purchase") + ylab("Return Since Purchase") )

#ggsave(g7, file="G:/rank/new_ind/codes/codes with more anon dataset/returnafterbuy2.png",width = 7.29, height = 4.5)
```


# plot: forward rsp, break by new_stock, and further by winprop
```{r}
# plot: forward rsp, break by new_stock, and further by winprop
check_for_run_fw_plot_2 <- check_for_run_fw[,.(
mean_return_0=0,sd_0=0, N_0=1,
mean_return_5=mean(return_5_fw,na.rm=TRUE),sd_5=sd(return_5_fw,na.rm=TRUE), N_5=sum(Nna_return_5_fw),
mean_return_10=mean(return_10_fw,na.rm=TRUE),sd_10=sd(return_10_fw,na.rm=TRUE), N_10=sum(Nna_return_10_fw),
mean_return_15=mean(return_15_fw,na.rm=TRUE),sd_15=sd(return_15_fw,na.rm=TRUE), N_15=sum(Nna_return_15_fw),
mean_return_20=mean(return_20_fw,na.rm=TRUE),sd_20=sd(return_20_fw,na.rm=TRUE), N_20=sum(Nna_return_20_fw),
mean_return_25=mean(return_25_fw,na.rm=TRUE),sd_25=sd(return_25_fw,na.rm=TRUE), N_25=sum(Nna_return_25_fw),
mean_return_30=mean(return_30_fw,na.rm=TRUE),sd_30=sd(return_30_fw,na.rm=TRUE), N_30=sum(Nna_return_30_fw),
mean_return_35=mean(return_35_fw,na.rm=TRUE),sd_35=sd(return_35_fw,na.rm=TRUE), N_35=sum(Nna_return_35_fw),
mean_return_40=mean(return_40_fw,na.rm=TRUE),sd_40=sd(return_40_fw,na.rm=TRUE), N_40=sum(Nna_return_40_fw),
mean_return_45=mean(return_45_fw,na.rm=TRUE),sd_45=sd(return_45_fw,na.rm=TRUE), N_45=sum(Nna_return_45_fw),
mean_return_50=mean(return_50_fw,na.rm=TRUE),sd_50=sd(return_50_fw,na.rm=TRUE), N_50=sum(Nna_return_50_fw),
mean_return_55=mean(return_55_fw,na.rm=TRUE),sd_55=sd(return_55_fw,na.rm=TRUE), N_55=sum(Nna_return_55_fw),
mean_return_60=mean(return_60_fw,na.rm=TRUE),sd_60=sd(return_60_fw,na.rm=TRUE), N_60=sum(Nna_return_60_fw),
mean_return_65=mean(return_65_fw,na.rm=TRUE),sd_65=sd(return_65_fw,na.rm=TRUE), N_65=sum(Nna_return_65_fw),
mean_return_70=mean(return_70_fw,na.rm=TRUE),sd_70=sd(return_70_fw,na.rm=TRUE), N_70=sum(Nna_return_70_fw),
mean_return_75=mean(return_75_fw,na.rm=TRUE),sd_75=sd(return_75_fw,na.rm=TRUE), N_75=sum(Nna_return_75_fw),
mean_return_80=mean(return_80_fw,na.rm=TRUE),sd_80=sd(return_80_fw,na.rm=TRUE), N_80=sum(Nna_return_80_fw),
mean_return_85=mean(return_85_fw,na.rm=TRUE),sd_85=sd(return_85_fw,na.rm=TRUE), N_85=sum(Nna_return_85_fw),
mean_return_90=mean(return_90_fw,na.rm=TRUE),sd_90=sd(return_90_fw,na.rm=TRUE), N_90=sum(Nna_return_90_fw),
mean_return_95=mean(return_95_fw,na.rm=TRUE),sd_95=sd(return_95_fw,na.rm=TRUE), N_95=sum(Nna_return_95_fw),
mean_return_100=mean(return_100_fw,na.rm=TRUE),sd_100=sd(return_100_fw,na.rm=TRUE), N_100=sum(Nna_return_100_fw),
mean_return_105=mean(return_105_fw,na.rm=TRUE),sd_105=sd(return_105_fw,na.rm=TRUE), N_105=sum(Nna_return_105_fw),
mean_return_110=mean(return_110_fw,na.rm=TRUE),sd_110=sd(return_110_fw,na.rm=TRUE), N_110=sum(Nna_return_110_fw),
mean_return_115=mean(return_115_fw,na.rm=TRUE),sd_115=sd(return_115_fw,na.rm=TRUE), N_115=sum(Nna_return_115_fw),
mean_return_120=mean(return_120_fw,na.rm=TRUE),sd_120=sd(return_120_fw,na.rm=TRUE), N_120=sum(Nna_return_120_fw),
mean_return_125=mean(return_125_fw,na.rm=TRUE),sd_125=sd(return_125_fw,na.rm=TRUE), N_125=sum(Nna_return_125_fw),
mean_return_130=mean(return_130_fw,na.rm=TRUE),sd_130=sd(return_130_fw,na.rm=TRUE), N_130=sum(Nna_return_130_fw),
mean_return_135=mean(return_135_fw,na.rm=TRUE),sd_135=sd(return_135_fw,na.rm=TRUE), N_135=sum(Nna_return_135_fw),
mean_return_140=mean(return_140_fw,na.rm=TRUE),sd_140=sd(return_140_fw,na.rm=TRUE), N_140=sum(Nna_return_140_fw),
mean_return_145=mean(return_145_fw,na.rm=TRUE),sd_145=sd(return_145_fw,na.rm=TRUE), N_145=sum(Nna_return_145_fw),
mean_return_150=mean(return_150_fw,na.rm=TRUE),sd_150=sd(return_150_fw,na.rm=TRUE), N_150=sum(Nna_return_150_fw),
mean_return_155=mean(return_155_fw,na.rm=TRUE),sd_155=sd(return_155_fw,na.rm=TRUE), N_155=sum(Nna_return_155_fw),
mean_return_160=mean(return_160_fw,na.rm=TRUE),sd_160=sd(return_160_fw,na.rm=TRUE), N_160=sum(Nna_return_160_fw),
mean_return_165=mean(return_165_fw,na.rm=TRUE),sd_165=sd(return_165_fw,na.rm=TRUE), N_165=sum(Nna_return_165_fw),
mean_return_170=mean(return_170_fw,na.rm=TRUE),sd_170=sd(return_170_fw,na.rm=TRUE), N_170=sum(Nna_return_170_fw),
mean_return_175=mean(return_175_fw,na.rm=TRUE),sd_175=sd(return_175_fw,na.rm=TRUE), N_175=sum(Nna_return_175_fw),
mean_return_180=mean(return_180_fw,na.rm=TRUE),sd_180=sd(return_180_fw,na.rm=TRUE), N_180=sum(Nna_return_180_fw),
mean_return_185=mean(return_185_fw,na.rm=TRUE),sd_185=sd(return_185_fw,na.rm=TRUE), N_185=sum(Nna_return_185_fw),
mean_return_190=mean(return_190_fw,na.rm=TRUE),sd_190=sd(return_190_fw,na.rm=TRUE), N_190=sum(Nna_return_190_fw),
mean_return_195=mean(return_195_fw,na.rm=TRUE),sd_195=sd(return_195_fw,na.rm=TRUE), N_195=sum(Nna_return_195_fw),
mean_return_200=mean(return_200_fw,na.rm=TRUE),sd_200=sd(return_200_fw,na.rm=TRUE), N_200=sum(Nna_return_200_fw)
), by=c("new_stock","wp_group")]

check_for_run_fw_plot_a <- copy(check_for_run_fw_plot_2)
check_for_run_fw_plot_a[,wp_group:=NULL]
check_for_run_fw_plot_a <- melt(check_for_run_fw_plot_a, id.vars="new_stock")
check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a[grepl("sd",variable)]
check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a_1[,.(sd=mean(value,na.rm=TRUE)),by=c("new_stock", "variable")]
check_for_run_fw_plot_a_1[,days:=rep(seq(0,200,5),each=2)]
check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a[grepl("mean",variable)]
check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a_2[,.(mean=mean(value,na.rm=TRUE)),by=c("new_stock", "variable")]
check_for_run_fw_plot_a_2[,days:=rep(seq(0,200,5),each=2)]
check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a[grepl("N",variable)]
check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a_3[,.(N=min(value,na.rm=TRUE)),by=c("new_stock", "variable")]
check_for_run_fw_plot_a_3[,days:=rep(seq(0,200,5),each=2)]
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a_1, check_for_run_fw_plot_a_2, by=c("new_stock","days"), all.x=TRUE)
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a, check_for_run_fw_plot_a_3, by=c("new_stock","days"), all.x=TRUE)
check_for_run_fw_plot_a[,upper_ci:=mean+1.96*sd/sqrt(N)]
check_for_run_fw_plot_a[,lower_ci:=mean-1.96*sd/sqrt(N)]
check_for_run_fw_plot_a[,Category:="Purchase - invested stock"]
check_for_run_fw_plot_a[new_stock==1,Category:="New purchase"]
check_for_run_fw_plot_a$Category <- factor(check_for_run_fw_plot_a$Category, levels = c("Purchase - invested stock", "New purchase"))
#check_for_run_fw_plot[,type2:=paste(type,wp_group)]

# check_for_run_fw_plot$type2 <- factor(check_for_run_fw_plot$type2, levels = c("top up after positive rsp","top up after negative rsp", "new buy-invested industry after positive rsp", "new buy-invested industry after negative rsp", "new buy-new industry after positive rsp", "new buy-new industry after negative rsp"))

pd <- position_dodge(0.03) # move them .05 to the left and right



(g6 <- ggplot(check_for_run_fw_plot_a,aes(x=days,y=mean,color=Category))+
       geom_errorbar(aes(ymin=lower_ci, ymax=upper_ci), width=.05, position=pd) +
       geom_line(position=pd) + 
       geom_point(position=pd,size = 0.1)  + xlab("Number of Working Days After the Purchase") + ylab("Return Since Purchase") )
ggsave(g6, file="G:/rank/new_ind/codes/codes with more anon dataset/returnafterbuy3.png",width = 7.29, height = 4.5)


check_for_run_fw_plot_b <- melt(check_for_run_fw_plot_2, id.vars=c("new_stock","wp_group"))

check_for_run_fw_plot_b_1 <- check_for_run_fw_plot_b[grepl("sd",variable)]
check_for_run_fw_plot_b_1[,days:=rep(seq(0,200,5),each=8)]
check_for_run_fw_plot_b_2 <- check_for_run_fw_plot_b[grepl("mean",variable)]
check_for_run_fw_plot_b_2[,days:=rep(seq(0,200,5),each=8)]
check_for_run_fw_plot_b_3 <- check_for_run_fw_plot_b[grepl("N",variable)]
check_for_run_fw_plot_b_3[,days:=rep(seq(0,200,5),each=8)]
check_for_run_fw_plot_b <- merge(check_for_run_fw_plot_b_1, check_for_run_fw_plot_b_2, by=c("new_stock","days","wp_group"), all.x=TRUE)
setnames(check_for_run_fw_plot_b, c("value.x","value.y"), c("sd","mean"))
check_for_run_fw_plot_b <- merge(check_for_run_fw_plot_b, check_for_run_fw_plot_b_3, by=c("new_stock","days","wp_group"), all.x=TRUE)
setnames(check_for_run_fw_plot_b, "value", "N")
check_for_run_fw_plot_b[,upper_ci:=mean+1.96*sd/sqrt(N)]
check_for_run_fw_plot_b[,lower_ci:=mean-1.96*sd/sqrt(N)]
check_for_run_fw_plot_b[,Category:="Purchase - invested stock"]
check_for_run_fw_plot_b[new_stock==1,Category:="New purchase"]
check_for_run_fw_plot_b$Category <- factor(check_for_run_fw_plot_b$Category, levels = c("Purchase - invested stock", "New purchase"))
#check_for_run_fw_plot[,type2:=paste(type,wp_group)]

# check_for_run_fw_plot$type2 <- factor(check_for_run_fw_plot$type2, levels = c("top up after positive rsp","top up after negative rsp", "new buy-invested industry after positive rsp", "new buy-invested industry after negative rsp", "new buy-new industry after positive rsp", "new buy-new industry after negative rsp"))

pd <- position_dodge(0.03) # move them .05 to the left and right



(g7 <- ggplot(check_for_run_fw_plot_b,aes(x=days,y=mean,color=Category))+
       geom_errorbar(aes(ymin=lower_ci, ymax=upper_ci), width=.05, position=pd) +
       geom_line(position=pd) + facet_wrap(vars(wp_group)) +
       geom_point(position=pd,size = 0.1)  + xlab("Number of Working Days After the Purchase") + ylab("Return Since Purchase") )

ggsave(g7, file="G:/rank/new_ind/codes/codes with more anon dataset/returnafterbuy4.png",width = 7.29, height = 4.5)
```


# plot: 1-week return, break by order, and further by winprop
```{r}

for (j in 1:ncol(check_for_run_fw)) set(check_for_run_fw, which(is.infinite(check_for_run_fw[[j]])), j, NA)
# plot: 1-week return, break by order, and further by winprop
check_for_run_fw_plot_3 <- check_for_run_fw[,.(
bmean_return_5=mean(return_5_lag_p,na.rm=TRUE),bsd_5=sd(return_5_lag_p,na.rm=TRUE), bN_5=sum(Nna_return_5_lag_p),
bmean_return_10=mean(return_10_lag_p,na.rm=TRUE),bsd_10=sd(return_10_lag_p,na.rm=TRUE), bN_10=sum(Nna_return_10_lag_p),
bmean_return_15=mean(return_15_lag_p,na.rm=TRUE),bsd_15=sd(return_15_lag_p,na.rm=TRUE), bN_15=sum(Nna_return_15_lag_p),
bmean_return_20=mean(return_20_lag_p,na.rm=TRUE),bsd_20=sd(return_20_lag_p,na.rm=TRUE), bN_20=sum(Nna_return_20_lag_p),
bmean_return_25=mean(return_25_lag_p,na.rm=TRUE),bsd_25=sd(return_25_lag_p,na.rm=TRUE), bN_25=sum(Nna_return_25_lag_p),
bmean_return_30=mean(return_30_lag_p,na.rm=TRUE),bsd_30=sd(return_30_lag_p,na.rm=TRUE), bN_30=sum(Nna_return_30_lag_p),
bmean_return_35=mean(return_35_lag_p,na.rm=TRUE),bsd_35=sd(return_35_lag_p,na.rm=TRUE), bN_35=sum(Nna_return_35_lag_p),
bmean_return_40=mean(return_40_lag_p,na.rm=TRUE),bsd_40=sd(return_40_lag_p,na.rm=TRUE), bN_40=sum(Nna_return_40_lag_p),
bmean_return_45=mean(return_45_lag_p,na.rm=TRUE),bsd_45=sd(return_45_lag_p,na.rm=TRUE), bN_45=sum(Nna_return_45_lag_p),
bmean_return_50=mean(return_50_lag_p,na.rm=TRUE),bsd_50=sd(return_50_lag_p,na.rm=TRUE), bN_50=sum(Nna_return_50_lag_p),
bmean_return_55=mean(return_55_lag_p,na.rm=TRUE),bsd_55=sd(return_55_lag_p,na.rm=TRUE), bN_55=sum(Nna_return_55_lag_p),
bmean_return_60=mean(return_60_lag_p,na.rm=TRUE),bsd_60=sd(return_60_lag_p,na.rm=TRUE), bN_60=sum(Nna_return_60_lag_p),
bmean_return_65=mean(return_65_lag_p,na.rm=TRUE),bsd_65=sd(return_65_lag_p,na.rm=TRUE), bN_65=sum(Nna_return_65_lag_p),
bmean_return_70=mean(return_70_lag_p,na.rm=TRUE),bsd_70=sd(return_70_lag_p,na.rm=TRUE), bN_70=sum(Nna_return_70_lag_p),
bmean_return_75=mean(return_75_lag_p,na.rm=TRUE),bsd_75=sd(return_75_lag_p,na.rm=TRUE), bN_75=sum(Nna_return_75_lag_p),
bmean_return_80=mean(return_80_lag_p,na.rm=TRUE),bsd_80=sd(return_80_lag_p,na.rm=TRUE), bN_80=sum(Nna_return_80_lag_p),
bmean_return_85=mean(return_85_lag_p,na.rm=TRUE),bsd_85=sd(return_85_lag_p,na.rm=TRUE), bN_85=sum(Nna_return_85_lag_p),
bmean_return_90=mean(return_90_lag_p,na.rm=TRUE),bsd_90=sd(return_90_lag_p,na.rm=TRUE), bN_90=sum(Nna_return_90_lag_p),
bmean_return_95=mean(return_95_lag_p,na.rm=TRUE),bsd_95=sd(return_95_lag_p,na.rm=TRUE), bN_95=sum(Nna_return_95_lag_p),
bmean_return_100=mean(return_100_lag_p,na.rm=TRUE),bsd_100=sd(return_100_lag_p,na.rm=TRUE), bN_100=sum(Nna_return_100_lag_p),
bmean_return_105=mean(return_105_lag_p,na.rm=TRUE),bsd_105=sd(return_105_lag_p,na.rm=TRUE), bN_105=sum(Nna_return_105_lag_p),
bmean_return_110=mean(return_110_lag_p,na.rm=TRUE),bsd_110=sd(return_110_lag_p,na.rm=TRUE), bN_110=sum(Nna_return_110_lag_p),
bmean_return_115=mean(return_115_lag_p,na.rm=TRUE),bsd_115=sd(return_115_lag_p,na.rm=TRUE), bN_115=sum(Nna_return_115_lag_p),
bmean_return_120=mean(return_120_lag_p,na.rm=TRUE),bsd_120=sd(return_120_lag_p,na.rm=TRUE), bN_120=sum(Nna_return_120_lag_p),
mean_return_0=0,sd_0=0, N_0=1,
mean_return_5=mean(return_5_fw_p,na.rm=TRUE),sd_5=sd(return_5_fw_p,na.rm=TRUE), N_5=sum(Nna_return_5_fw_p),
mean_return_10=mean(return_10_fw_p,na.rm=TRUE),sd_10=sd(return_10_fw_p,na.rm=TRUE), N_10=sum(Nna_return_10_fw_p),
mean_return_15=mean(return_15_fw_p,na.rm=TRUE),sd_15=sd(return_15_fw_p,na.rm=TRUE), N_15=sum(Nna_return_15_fw_p),
mean_return_20=mean(return_20_fw_p,na.rm=TRUE),sd_20=sd(return_20_fw_p,na.rm=TRUE), N_20=sum(Nna_return_20_fw_p),
mean_return_25=mean(return_25_fw_p,na.rm=TRUE),sd_25=sd(return_25_fw_p,na.rm=TRUE), N_25=sum(Nna_return_25_fw_p),
mean_return_30=mean(return_30_fw_p,na.rm=TRUE),sd_30=sd(return_30_fw_p,na.rm=TRUE), N_30=sum(Nna_return_30_fw_p),
mean_return_35=mean(return_35_fw_p,na.rm=TRUE),sd_35=sd(return_35_fw_p,na.rm=TRUE), N_35=sum(Nna_return_35_fw_p),
mean_return_40=mean(return_40_fw_p,na.rm=TRUE),sd_40=sd(return_40_fw_p,na.rm=TRUE), N_40=sum(Nna_return_40_fw_p),
mean_return_45=mean(return_45_fw_p,na.rm=TRUE),sd_45=sd(return_45_fw_p,na.rm=TRUE), N_45=sum(Nna_return_45_fw_p),
mean_return_50=mean(return_50_fw_p,na.rm=TRUE),sd_50=sd(return_50_fw_p,na.rm=TRUE), N_50=sum(Nna_return_50_fw_p),
mean_return_55=mean(return_55_fw_p,na.rm=TRUE),sd_55=sd(return_55_fw_p,na.rm=TRUE), N_55=sum(Nna_return_55_fw_p),
mean_return_60=mean(return_60_fw_p,na.rm=TRUE),sd_60=sd(return_60_fw_p,na.rm=TRUE), N_60=sum(Nna_return_60_fw_p),
mean_return_65=mean(return_65_fw_p,na.rm=TRUE),sd_65=sd(return_65_fw_p,na.rm=TRUE), N_65=sum(Nna_return_65_fw_p),
mean_return_70=mean(return_70_fw_p,na.rm=TRUE),sd_70=sd(return_70_fw_p,na.rm=TRUE), N_70=sum(Nna_return_70_fw_p),
mean_return_75=mean(return_75_fw_p,na.rm=TRUE),sd_75=sd(return_75_fw_p,na.rm=TRUE), N_75=sum(Nna_return_75_fw_p),
mean_return_80=mean(return_80_fw_p,na.rm=TRUE),sd_80=sd(return_80_fw_p,na.rm=TRUE), N_80=sum(Nna_return_80_fw_p),
mean_return_85=mean(return_85_fw_p,na.rm=TRUE),sd_85=sd(return_85_fw_p,na.rm=TRUE), N_85=sum(Nna_return_85_fw_p),
mean_return_90=mean(return_90_fw_p,na.rm=TRUE),sd_90=sd(return_90_fw_p,na.rm=TRUE), N_90=sum(Nna_return_90_fw_p),
mean_return_95=mean(return_95_fw_p,na.rm=TRUE),sd_95=sd(return_95_fw_p,na.rm=TRUE), N_95=sum(Nna_return_95_fw_p),
mean_return_100=mean(return_100_fw_p,na.rm=TRUE),sd_100=sd(return_100_fw_p,na.rm=TRUE), N_100=sum(Nna_return_100_fw_p),
mean_return_105=mean(return_105_fw_p,na.rm=TRUE),sd_105=sd(return_105_fw_p,na.rm=TRUE), N_105=sum(Nna_return_105_fw_p),
mean_return_110=mean(return_110_fw_p,na.rm=TRUE),sd_110=sd(return_110_fw_p,na.rm=TRUE), N_110=sum(Nna_return_110_fw_p),
mean_return_115=mean(return_115_fw_p,na.rm=TRUE),sd_115=sd(return_115_fw_p,na.rm=TRUE), N_115=sum(Nna_return_115_fw_p),
mean_return_120=mean(return_120_fw_p,na.rm=TRUE),sd_120=sd(return_120_fw_p,na.rm=TRUE), N_120=sum(Nna_return_120_fw_p),
mean_return_125=mean(return_125_fw_p,na.rm=TRUE),sd_125=sd(return_125_fw_p,na.rm=TRUE), N_125=sum(Nna_return_125_fw_p),
mean_return_130=mean(return_130_fw_p,na.rm=TRUE),sd_130=sd(return_130_fw_p,na.rm=TRUE), N_130=sum(Nna_return_130_fw_p),
mean_return_135=mean(return_135_fw_p,na.rm=TRUE),sd_135=sd(return_135_fw_p,na.rm=TRUE), N_135=sum(Nna_return_135_fw_p),
mean_return_140=mean(return_140_fw_p,na.rm=TRUE),sd_140=sd(return_140_fw_p,na.rm=TRUE), N_140=sum(Nna_return_140_fw_p),
mean_return_145=mean(return_145_fw_p,na.rm=TRUE),sd_145=sd(return_145_fw_p,na.rm=TRUE), N_145=sum(Nna_return_145_fw_p),
mean_return_150=mean(return_150_fw_p,na.rm=TRUE),sd_150=sd(return_150_fw_p,na.rm=TRUE), N_150=sum(Nna_return_150_fw_p),
mean_return_155=mean(return_155_fw_p,na.rm=TRUE),sd_155=sd(return_155_fw_p,na.rm=TRUE), N_155=sum(Nna_return_155_fw_p),
mean_return_160=mean(return_160_fw_p,na.rm=TRUE),sd_160=sd(return_160_fw_p,na.rm=TRUE), N_160=sum(Nna_return_160_fw_p),
mean_return_165=mean(return_165_fw_p,na.rm=TRUE),sd_165=sd(return_165_fw_p,na.rm=TRUE), N_165=sum(Nna_return_165_fw_p),
mean_return_170=mean(return_170_fw_p,na.rm=TRUE),sd_170=sd(return_170_fw_p,na.rm=TRUE), N_170=sum(Nna_return_170_fw_p),
mean_return_175=mean(return_175_fw_p,na.rm=TRUE),sd_175=sd(return_175_fw_p,na.rm=TRUE), N_175=sum(Nna_return_175_fw_p),
mean_return_180=mean(return_180_fw_p,na.rm=TRUE),sd_180=sd(return_180_fw_p,na.rm=TRUE), N_180=sum(Nna_return_180_fw_p),
mean_return_185=mean(return_185_fw_p,na.rm=TRUE),sd_185=sd(return_185_fw_p,na.rm=TRUE), N_185=sum(Nna_return_185_fw_p),
mean_return_190=mean(return_190_fw_p,na.rm=TRUE),sd_190=sd(return_190_fw_p,na.rm=TRUE), N_190=sum(Nna_return_190_fw_p),
mean_return_195=mean(return_195_fw_p,na.rm=TRUE),sd_195=sd(return_195_fw_p,na.rm=TRUE), N_195=sum(Nna_return_195_fw_p),
mean_return_200=mean(return_200_fw_p,na.rm=TRUE),sd_200=sd(return_200_fw_p,na.rm=TRUE), N_200=sum(Nna_return_200_fw_p)
), by=c("order","wp_group")]

check_for_run_fw_plot_a <- copy(check_for_run_fw_plot_3)
check_for_run_fw_plot_a[,wp_group:=NULL]
check_for_run_fw_plot_a <- melt(check_for_run_fw_plot_a, id.vars="order")
check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a[grepl("sd",variable)]
check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a_1[,.(sd=mean(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_1[,days:=rep(c(seq(-5,-120,-5),seq(0,200,5)),each=3)]
check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a[grepl("mean",variable)]
check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a_2[,.(mean=mean(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_2[,days:=rep(c(seq(-5,-120,-5),seq(0,200,5)),each=3)]
check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a[grepl("N",variable)]
check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a_3[,.(N=min(value,na.rm=TRUE)),by=c("order", "variable")]
check_for_run_fw_plot_a_3[,days:=rep(c(seq(-5,-120,-5),seq(0,200,5)),each=3)]
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a_1, check_for_run_fw_plot_a_2, by=c("order","days"), all.x=TRUE)
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a, check_for_run_fw_plot_a_3, by=c("order","days"), all.x=TRUE)
check_for_run_fw_plot_a[,upper_ci:=mean+1.96*sd/sqrt(N)]
check_for_run_fw_plot_a[,lower_ci:=mean-1.96*sd/sqrt(N)]
check_for_run_fw_plot_a[,Category:="Purchase - invested stock"]
check_for_run_fw_plot_a[order==1,Category:="New purchase - invested industry"]
check_for_run_fw_plot_a[order==2,Category:="New purchase - new industry"]
check_for_run_fw_plot_a$Category <- factor(check_for_run_fw_plot_a$Category, levels = c("Purchase - invested stock", "New purchase - invested industry", "New purchase - new industry"))
#check_for_run_fw_plot[,type2:=paste(type,wp_group)]

# check_for_run_fw_plot$type2 <- factor(check_for_run_fw_plot$type2, levels = c("top up after positive rsp","top up after negative rsp", "new buy-invested industry after positive rsp", "new buy-invested industry after negative rsp", "new buy-new industry after positive rsp", "new buy-new industry after negative rsp"))

pd <- position_dodge(1) # move them .05 to the left and right



(g8 <- ggplot(check_for_run_fw_plot_a,aes(x=days,y=mean,color=Category))+
       geom_errorbar(aes(ymin=lower_ci, ymax=upper_ci), width=.05, position=pd) +
       geom_line(position=pd) + 
       geom_point(position=pd,size = 0.1)  + xlab("Number of Working Days After the Purchase") + ylab("1-Week Return") )

#ggsave(g8, file="G:/rank/new_ind/codes/codes with more anon dataset/returnaroundbuy.png",width = 7.29, height = 4.5)

check_for_run_fw_plot_b <- melt(check_for_run_fw_plot_3, id.vars=c("order","wp_group"))

check_for_run_fw_plot_b_1 <- check_for_run_fw_plot_b[grepl("sd",variable)]
check_for_run_fw_plot_b_1[,days:=rep(c(seq(-5,-120,-5),seq(0,200,5)),each=12)]
check_for_run_fw_plot_b_2 <- check_for_run_fw_plot_b[grepl("mean",variable)]
check_for_run_fw_plot_b_2[,days:=rep(c(seq(-5,-120,-5),seq(0,200,5)),each=12)]
check_for_run_fw_plot_b_3 <- check_for_run_fw_plot_b[grepl("N",variable)]
check_for_run_fw_plot_b_3[,days:=rep(c(seq(-5,-120,-5),seq(0,200,5)),each=12)]
check_for_run_fw_plot_b <- merge(check_for_run_fw_plot_b_1, check_for_run_fw_plot_b_2, by=c("order","days","wp_group"), all.x=TRUE)
setnames(check_for_run_fw_plot_b, c("value.x","value.y"), c("sd","mean"))
check_for_run_fw_plot_b <- merge(check_for_run_fw_plot_b, check_for_run_fw_plot_b_3, by=c("order","days","wp_group"), all.x=TRUE)
setnames(check_for_run_fw_plot_b, "value", "N")
check_for_run_fw_plot_b[,upper_ci:=mean+1.96*sd/sqrt(N)]
check_for_run_fw_plot_b[,lower_ci:=mean-1.96*sd/sqrt(N)]
check_for_run_fw_plot_b[,Category:="Purchase - invested stock"]
check_for_run_fw_plot_b[order==1,Category:="New purchase - invested industry"]
check_for_run_fw_plot_b[order==2,Category:="New purchase - new industry"]
check_for_run_fw_plot_b$Category <- factor(check_for_run_fw_plot_b$Category, levels = c("Purchase - invested stock", "New purchase - invested industry", "New purchase - new industry"))


pd <- position_dodge(0.03) # move them .05 to the left and right



(g9 <- ggplot(check_for_run_fw_plot_b,aes(x=days,y=mean,color=Category))+
       geom_errorbar(aes(ymin=lower_ci, ymax=upper_ci), width=.05, position=pd) +
       geom_line(position=pd) + facet_wrap(vars(wp_group)) +
       geom_point(position=pd,size = 0.1)  + xlab("Number of Working Days After the Purchase") + ylab("1-Week Return") )

#ggsave(g9, file="G:/rank/new_ind/codes/codes with more anon dataset/returnaroundbuy2.png",width = 7.29, height = 4.5)
```


# plot: 1-week return, break by order2, and further by winprop
```{r}
# plot: 1-week return, break by order, and further by winprop

for (j in 1:ncol(check_for_run_fw)) set(check_for_run_fw, which(is.infinite(check_for_run_fw[[j]])), j, NA)

check_for_run_fw_plot_3 <- check_for_run_fw[,.(
bmean_return_5=mean(return_5_lag_p,na.rm=TRUE),bsd_5=sd(return_5_lag_p,na.rm=TRUE), bN_5=sum(Nna_return_5_lag_p),
bmean_return_10=mean(return_10_lag_p,na.rm=TRUE),bsd_10=sd(return_10_lag_p,na.rm=TRUE), bN_10=sum(Nna_return_10_lag_p),
bmean_return_15=mean(return_15_lag_p,na.rm=TRUE),bsd_15=sd(return_15_lag_p,na.rm=TRUE), bN_15=sum(Nna_return_15_lag_p),
bmean_return_20=mean(return_20_lag_p,na.rm=TRUE),bsd_20=sd(return_20_lag_p,na.rm=TRUE), bN_20=sum(Nna_return_20_lag_p),
bmean_return_25=mean(return_25_lag_p,na.rm=TRUE),bsd_25=sd(return_25_lag_p,na.rm=TRUE), bN_25=sum(Nna_return_25_lag_p),
bmean_return_30=mean(return_30_lag_p,na.rm=TRUE),bsd_30=sd(return_30_lag_p,na.rm=TRUE), bN_30=sum(Nna_return_30_lag_p),
bmean_return_35=mean(return_35_lag_p,na.rm=TRUE),bsd_35=sd(return_35_lag_p,na.rm=TRUE), bN_35=sum(Nna_return_35_lag_p),
bmean_return_40=mean(return_40_lag_p,na.rm=TRUE),bsd_40=sd(return_40_lag_p,na.rm=TRUE), bN_40=sum(Nna_return_40_lag_p),
bmean_return_45=mean(return_45_lag_p,na.rm=TRUE),bsd_45=sd(return_45_lag_p,na.rm=TRUE), bN_45=sum(Nna_return_45_lag_p),
bmean_return_50=mean(return_50_lag_p,na.rm=TRUE),bsd_50=sd(return_50_lag_p,na.rm=TRUE), bN_50=sum(Nna_return_50_lag_p),
bmean_return_55=mean(return_55_lag_p,na.rm=TRUE),bsd_55=sd(return_55_lag_p,na.rm=TRUE), bN_55=sum(Nna_return_55_lag_p),
bmean_return_60=mean(return_60_lag_p,na.rm=TRUE),bsd_60=sd(return_60_lag_p,na.rm=TRUE), bN_60=sum(Nna_return_60_lag_p),
bmean_return_65=mean(return_65_lag_p,na.rm=TRUE),bsd_65=sd(return_65_lag_p,na.rm=TRUE), bN_65=sum(Nna_return_65_lag_p),
bmean_return_70=mean(return_70_lag_p,na.rm=TRUE),bsd_70=sd(return_70_lag_p,na.rm=TRUE), bN_70=sum(Nna_return_70_lag_p),
bmean_return_75=mean(return_75_lag_p,na.rm=TRUE),bsd_75=sd(return_75_lag_p,na.rm=TRUE), bN_75=sum(Nna_return_75_lag_p),
bmean_return_80=mean(return_80_lag_p,na.rm=TRUE),bsd_80=sd(return_80_lag_p,na.rm=TRUE), bN_80=sum(Nna_return_80_lag_p),
bmean_return_85=mean(return_85_lag_p,na.rm=TRUE),bsd_85=sd(return_85_lag_p,na.rm=TRUE), bN_85=sum(Nna_return_85_lag_p),
bmean_return_90=mean(return_90_lag_p,na.rm=TRUE),bsd_90=sd(return_90_lag_p,na.rm=TRUE), bN_90=sum(Nna_return_90_lag_p),
bmean_return_95=mean(return_95_lag_p,na.rm=TRUE),bsd_95=sd(return_95_lag_p,na.rm=TRUE), bN_95=sum(Nna_return_95_lag_p),
bmean_return_100=mean(return_100_lag_p,na.rm=TRUE),bsd_100=sd(return_100_lag_p,na.rm=TRUE), bN_100=sum(Nna_return_100_lag_p),
bmean_return_105=mean(return_105_lag_p,na.rm=TRUE),bsd_105=sd(return_105_lag_p,na.rm=TRUE), bN_105=sum(Nna_return_105_lag_p),
bmean_return_110=mean(return_110_lag_p,na.rm=TRUE),bsd_110=sd(return_110_lag_p,na.rm=TRUE), bN_110=sum(Nna_return_110_lag_p),
bmean_return_115=mean(return_115_lag_p,na.rm=TRUE),bsd_115=sd(return_115_lag_p,na.rm=TRUE), bN_115=sum(Nna_return_115_lag_p),
bmean_return_120=mean(return_120_lag_p,na.rm=TRUE),bsd_120=sd(return_120_lag_p,na.rm=TRUE), bN_120=sum(Nna_return_120_lag_p),
mean_return_0=0,sd_0=0, N_0=1,
mean_return_5=mean(return_5_fw_p,na.rm=TRUE),sd_5=sd(return_5_fw_p,na.rm=TRUE), N_5=sum(Nna_return_5_fw_p),
mean_return_10=mean(return_10_fw_p,na.rm=TRUE),sd_10=sd(return_10_fw_p,na.rm=TRUE), N_10=sum(Nna_return_10_fw_p),
mean_return_15=mean(return_15_fw_p,na.rm=TRUE),sd_15=sd(return_15_fw_p,na.rm=TRUE), N_15=sum(Nna_return_15_fw_p),
mean_return_20=mean(return_20_fw_p,na.rm=TRUE),sd_20=sd(return_20_fw_p,na.rm=TRUE), N_20=sum(Nna_return_20_fw_p),
mean_return_25=mean(return_25_fw_p,na.rm=TRUE),sd_25=sd(return_25_fw_p,na.rm=TRUE), N_25=sum(Nna_return_25_fw_p),
mean_return_30=mean(return_30_fw_p,na.rm=TRUE),sd_30=sd(return_30_fw_p,na.rm=TRUE), N_30=sum(Nna_return_30_fw_p),
mean_return_35=mean(return_35_fw_p,na.rm=TRUE),sd_35=sd(return_35_fw_p,na.rm=TRUE), N_35=sum(Nna_return_35_fw_p),
mean_return_40=mean(return_40_fw_p,na.rm=TRUE),sd_40=sd(return_40_fw_p,na.rm=TRUE), N_40=sum(Nna_return_40_fw_p),
mean_return_45=mean(return_45_fw_p,na.rm=TRUE),sd_45=sd(return_45_fw_p,na.rm=TRUE), N_45=sum(Nna_return_45_fw_p),
mean_return_50=mean(return_50_fw_p,na.rm=TRUE),sd_50=sd(return_50_fw_p,na.rm=TRUE), N_50=sum(Nna_return_50_fw_p),
mean_return_55=mean(return_55_fw_p,na.rm=TRUE),sd_55=sd(return_55_fw_p,na.rm=TRUE), N_55=sum(Nna_return_55_fw_p),
mean_return_60=mean(return_60_fw_p,na.rm=TRUE),sd_60=sd(return_60_fw_p,na.rm=TRUE), N_60=sum(Nna_return_60_fw_p),
mean_return_65=mean(return_65_fw_p,na.rm=TRUE),sd_65=sd(return_65_fw_p,na.rm=TRUE), N_65=sum(Nna_return_65_fw_p),
mean_return_70=mean(return_70_fw_p,na.rm=TRUE),sd_70=sd(return_70_fw_p,na.rm=TRUE), N_70=sum(Nna_return_70_fw_p),
mean_return_75=mean(return_75_fw_p,na.rm=TRUE),sd_75=sd(return_75_fw_p,na.rm=TRUE), N_75=sum(Nna_return_75_fw_p),
mean_return_80=mean(return_80_fw_p,na.rm=TRUE),sd_80=sd(return_80_fw_p,na.rm=TRUE), N_80=sum(Nna_return_80_fw_p),
mean_return_85=mean(return_85_fw_p,na.rm=TRUE),sd_85=sd(return_85_fw_p,na.rm=TRUE), N_85=sum(Nna_return_85_fw_p),
mean_return_90=mean(return_90_fw_p,na.rm=TRUE),sd_90=sd(return_90_fw_p,na.rm=TRUE), N_90=sum(Nna_return_90_fw_p),
mean_return_95=mean(return_95_fw_p,na.rm=TRUE),sd_95=sd(return_95_fw_p,na.rm=TRUE), N_95=sum(Nna_return_95_fw_p),
mean_return_100=mean(return_100_fw_p,na.rm=TRUE),sd_100=sd(return_100_fw_p,na.rm=TRUE), N_100=sum(Nna_return_100_fw_p),
mean_return_105=mean(return_105_fw_p,na.rm=TRUE),sd_105=sd(return_105_fw_p,na.rm=TRUE), N_105=sum(Nna_return_105_fw_p),
mean_return_110=mean(return_110_fw_p,na.rm=TRUE),sd_110=sd(return_110_fw_p,na.rm=TRUE), N_110=sum(Nna_return_110_fw_p),
mean_return_115=mean(return_115_fw_p,na.rm=TRUE),sd_115=sd(return_115_fw_p,na.rm=TRUE), N_115=sum(Nna_return_115_fw_p),
mean_return_120=mean(return_120_fw_p,na.rm=TRUE),sd_120=sd(return_120_fw_p,na.rm=TRUE), N_120=sum(Nna_return_120_fw_p),
mean_return_125=mean(return_125_fw_p,na.rm=TRUE),sd_125=sd(return_125_fw_p,na.rm=TRUE), N_125=sum(Nna_return_125_fw_p),
mean_return_130=mean(return_130_fw_p,na.rm=TRUE),sd_130=sd(return_130_fw_p,na.rm=TRUE), N_130=sum(Nna_return_130_fw_p),
mean_return_135=mean(return_135_fw_p,na.rm=TRUE),sd_135=sd(return_135_fw_p,na.rm=TRUE), N_135=sum(Nna_return_135_fw_p),
mean_return_140=mean(return_140_fw_p,na.rm=TRUE),sd_140=sd(return_140_fw_p,na.rm=TRUE), N_140=sum(Nna_return_140_fw_p),
mean_return_145=mean(return_145_fw_p,na.rm=TRUE),sd_145=sd(return_145_fw_p,na.rm=TRUE), N_145=sum(Nna_return_145_fw_p),
mean_return_150=mean(return_150_fw_p,na.rm=TRUE),sd_150=sd(return_150_fw_p,na.rm=TRUE), N_150=sum(Nna_return_150_fw_p),
mean_return_155=mean(return_155_fw_p,na.rm=TRUE),sd_155=sd(return_155_fw_p,na.rm=TRUE), N_155=sum(Nna_return_155_fw_p),
mean_return_160=mean(return_160_fw_p,na.rm=TRUE),sd_160=sd(return_160_fw_p,na.rm=TRUE), N_160=sum(Nna_return_160_fw_p),
mean_return_165=mean(return_165_fw_p,na.rm=TRUE),sd_165=sd(return_165_fw_p,na.rm=TRUE), N_165=sum(Nna_return_165_fw_p),
mean_return_170=mean(return_170_fw_p,na.rm=TRUE),sd_170=sd(return_170_fw_p,na.rm=TRUE), N_170=sum(Nna_return_170_fw_p),
mean_return_175=mean(return_175_fw_p,na.rm=TRUE),sd_175=sd(return_175_fw_p,na.rm=TRUE), N_175=sum(Nna_return_175_fw_p),
mean_return_180=mean(return_180_fw_p,na.rm=TRUE),sd_180=sd(return_180_fw_p,na.rm=TRUE), N_180=sum(Nna_return_180_fw_p),
mean_return_185=mean(return_185_fw_p,na.rm=TRUE),sd_185=sd(return_185_fw_p,na.rm=TRUE), N_185=sum(Nna_return_185_fw_p),
mean_return_190=mean(return_190_fw_p,na.rm=TRUE),sd_190=sd(return_190_fw_p,na.rm=TRUE), N_190=sum(Nna_return_190_fw_p),
mean_return_195=mean(return_195_fw_p,na.rm=TRUE),sd_195=sd(return_195_fw_p,na.rm=TRUE), N_195=sum(Nna_return_195_fw_p),
mean_return_200=mean(return_200_fw_p,na.rm=TRUE),sd_200=sd(return_200_fw_p,na.rm=TRUE), N_200=sum(Nna_return_200_fw_p)
), by=c("order2","wp_group")]

check_for_run_fw_plot_a <- copy(check_for_run_fw_plot_3)
check_for_run_fw_plot_a[,wp_group:=NULL]
check_for_run_fw_plot_a <- melt(check_for_run_fw_plot_a, id.vars="order2")
check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a[grepl("sd",variable)]
check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a_1[,.(sd=mean(value,na.rm=TRUE)),by=c("order2", "variable")]
check_for_run_fw_plot_a_1[,days:=rep(c(seq(-5,-120,-5),seq(0,200,5)),each=3)]
check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a[grepl("mean",variable)]
check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a_2[,.(mean=mean(value,na.rm=TRUE)),by=c("order2", "variable")]
check_for_run_fw_plot_a_2[,days:=rep(c(seq(-5,-120,-5),seq(0,200,5)),each=3)]
check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a[grepl("N",variable)]
check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a_3[,.(N=min(value,na.rm=TRUE)),by=c("order2", "variable")]
check_for_run_fw_plot_a_3[,days:=rep(c(seq(-5,-120,-5),seq(0,200,5)),each=3)]
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a_1, check_for_run_fw_plot_a_2, by=c("order2","days"), all.x=TRUE)
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a, check_for_run_fw_plot_a_3, by=c("order2","days"), all.x=TRUE)
check_for_run_fw_plot_a[,upper_ci:=mean+1.96*sd/sqrt(N)]
check_for_run_fw_plot_a[,lower_ci:=mean-1.96*sd/sqrt(N)]
check_for_run_fw_plot_a[,Category:="Purchase - topup"]
check_for_run_fw_plot_a[order2==1,Category:="Purchase - 0 holding"]
check_for_run_fw_plot_a[order2==2,Category:="New purchase"]
check_for_run_fw_plot_a$Category <- factor(check_for_run_fw_plot_a$Category, levels = c("Purchase - topup", "Purchase - 0 holding", "New purchase"))
#check_for_run_fw_plot[,type2:=paste(type,wp_group)]

# check_for_run_fw_plot$type2 <- factor(check_for_run_fw_plot$type2, levels = c("top up after positive rsp","top up after negative rsp", "new buy-invested industry after positive rsp", "new buy-invested industry after negative rsp", "new buy-new industry after positive rsp", "new buy-new industry after negative rsp"))

pd <- position_dodge(1) # move them .05 to the left and right



(g8 <- ggplot(check_for_run_fw_plot_a,aes(x=days,y=mean,color=Category))+
       geom_errorbar(aes(ymin=lower_ci, ymax=upper_ci), width=.05, position=pd) +
       geom_line(position=pd) + 
       geom_point(position=pd,size = 0.1)  + xlab("Number of Working Days After the Purchase") + ylab("1-Week Return") )

#ggsave(g8, file="G:/rank/new_ind/codes/codes with more anon dataset/returnaroundbuy.png",width = 7.29, height = 4.5)

check_for_run_fw_plot_b <- melt(check_for_run_fw_plot_3, id.vars=c("order2","wp_group"))

check_for_run_fw_plot_b_1 <- check_for_run_fw_plot_b[grepl("sd",variable)]
check_for_run_fw_plot_b_1[,days:=rep(c(seq(-5,-120,-5),seq(0,200,5)),each=12)]
check_for_run_fw_plot_b_2 <- check_for_run_fw_plot_b[grepl("mean",variable)]
check_for_run_fw_plot_b_2[,days:=rep(c(seq(-5,-120,-5),seq(0,200,5)),each=12)]
check_for_run_fw_plot_b_3 <- check_for_run_fw_plot_b[grepl("N",variable)]
check_for_run_fw_plot_b_3[,days:=rep(c(seq(-5,-120,-5),seq(0,200,5)),each=12)]
check_for_run_fw_plot_b <- merge(check_for_run_fw_plot_b_1, check_for_run_fw_plot_b_2, by=c("order2","days","wp_group"), all.x=TRUE)
setnames(check_for_run_fw_plot_b, c("value.x","value.y"), c("sd","mean"))
check_for_run_fw_plot_b <- merge(check_for_run_fw_plot_b, check_for_run_fw_plot_b_3, by=c("order2","days","wp_group"), all.x=TRUE)
setnames(check_for_run_fw_plot_b, "value", "N")
check_for_run_fw_plot_b[,upper_ci:=mean+1.96*sd/sqrt(N)]
check_for_run_fw_plot_b[,lower_ci:=mean-1.96*sd/sqrt(N)]
check_for_run_fw_plot_b[,Category:="Purchase - topup"]
check_for_run_fw_plot_b[order2==1,Category:="Purchase - 0 holding"]
check_for_run_fw_plot_b[order2==2,Category:="New purchase"]
check_for_run_fw_plot_b$Category <- factor(check_for_run_fw_plot_b$Category, levels = c("Purchase - topup", "Purchase - 0 holding", "New purchase"))


pd <- position_dodge(0.03) # move them .05 to the left and right



(g9 <- ggplot(check_for_run_fw_plot_b,aes(x=days,y=mean,color=Category))+
       geom_errorbar(aes(ymin=lower_ci, ymax=upper_ci), width=.05, position=pd) +
       geom_line(position=pd) + facet_wrap(vars(wp_group)) +
       geom_point(position=pd,size = 0.1)  + xlab("Number of Working Days After the Purchase") + ylab("1-Week Return") )

#ggsave(g9, file="G:/rank/new_ind/codes/codes with more anon dataset/returnaroundbuy2.png",width = 7.29, height = 4.5)
```

# plot: 1-week return, break by new_stock, and further by winprop
```{r}
# plot: 1-week return, break by new_stock, and further by winprop

for (j in 1:ncol(check_for_run_fw)) set(check_for_run_fw, which(is.infinite(check_for_run_fw[[j]])), j, NA)

check_for_run_fw_plot_4 <- check_for_run_fw[,.(
bmean_return_5=mean(return_5_lag_p,na.rm=TRUE),bsd_5=sd(return_5_lag_p,na.rm=TRUE), bN_5=sum(Nna_return_5_lag_p),
bmean_return_10=mean(return_10_lag_p,na.rm=TRUE),bsd_10=sd(return_10_lag_p,na.rm=TRUE), bN_10=sum(Nna_return_10_lag_p),
bmean_return_15=mean(return_15_lag_p,na.rm=TRUE),bsd_15=sd(return_15_lag_p,na.rm=TRUE), bN_15=sum(Nna_return_15_lag_p),
bmean_return_20=mean(return_20_lag_p,na.rm=TRUE),bsd_20=sd(return_20_lag_p,na.rm=TRUE), bN_20=sum(Nna_return_20_lag_p),
bmean_return_25=mean(return_25_lag_p,na.rm=TRUE),bsd_25=sd(return_25_lag_p,na.rm=TRUE), bN_25=sum(Nna_return_25_lag_p),
bmean_return_30=mean(return_30_lag_p,na.rm=TRUE),bsd_30=sd(return_30_lag_p,na.rm=TRUE), bN_30=sum(Nna_return_30_lag_p),
bmean_return_35=mean(return_35_lag_p,na.rm=TRUE),bsd_35=sd(return_35_lag_p,na.rm=TRUE), bN_35=sum(Nna_return_35_lag_p),
bmean_return_40=mean(return_40_lag_p,na.rm=TRUE),bsd_40=sd(return_40_lag_p,na.rm=TRUE), bN_40=sum(Nna_return_40_lag_p),
bmean_return_45=mean(return_45_lag_p,na.rm=TRUE),bsd_45=sd(return_45_lag_p,na.rm=TRUE), bN_45=sum(Nna_return_45_lag_p),
bmean_return_50=mean(return_50_lag_p,na.rm=TRUE),bsd_50=sd(return_50_lag_p,na.rm=TRUE), bN_50=sum(Nna_return_50_lag_p),
bmean_return_55=mean(return_55_lag_p,na.rm=TRUE),bsd_55=sd(return_55_lag_p,na.rm=TRUE), bN_55=sum(Nna_return_55_lag_p),
bmean_return_60=mean(return_60_lag_p,na.rm=TRUE),bsd_60=sd(return_60_lag_p,na.rm=TRUE), bN_60=sum(Nna_return_60_lag_p),
bmean_return_65=mean(return_65_lag_p,na.rm=TRUE),bsd_65=sd(return_65_lag_p,na.rm=TRUE), bN_65=sum(Nna_return_65_lag_p),
bmean_return_70=mean(return_70_lag_p,na.rm=TRUE),bsd_70=sd(return_70_lag_p,na.rm=TRUE), bN_70=sum(Nna_return_70_lag_p),
bmean_return_75=mean(return_75_lag_p,na.rm=TRUE),bsd_75=sd(return_75_lag_p,na.rm=TRUE), bN_75=sum(Nna_return_75_lag_p),
bmean_return_80=mean(return_80_lag_p,na.rm=TRUE),bsd_80=sd(return_80_lag_p,na.rm=TRUE), bN_80=sum(Nna_return_80_lag_p),
bmean_return_85=mean(return_85_lag_p,na.rm=TRUE),bsd_85=sd(return_85_lag_p,na.rm=TRUE), bN_85=sum(Nna_return_85_lag_p),
bmean_return_90=mean(return_90_lag_p,na.rm=TRUE),bsd_90=sd(return_90_lag_p,na.rm=TRUE), bN_90=sum(Nna_return_90_lag_p),
bmean_return_95=mean(return_95_lag_p,na.rm=TRUE),bsd_95=sd(return_95_lag_p,na.rm=TRUE), bN_95=sum(Nna_return_95_lag_p),
bmean_return_100=mean(return_100_lag_p,na.rm=TRUE),bsd_100=sd(return_100_lag_p,na.rm=TRUE), bN_100=sum(Nna_return_100_lag_p),
bmean_return_105=mean(return_105_lag_p,na.rm=TRUE),bsd_105=sd(return_105_lag_p,na.rm=TRUE), bN_105=sum(Nna_return_105_lag_p),
bmean_return_110=mean(return_110_lag_p,na.rm=TRUE),bsd_110=sd(return_110_lag_p,na.rm=TRUE), bN_110=sum(Nna_return_110_lag_p),
bmean_return_115=mean(return_115_lag_p,na.rm=TRUE),bsd_115=sd(return_115_lag_p,na.rm=TRUE), bN_115=sum(Nna_return_115_lag_p),
bmean_return_120=mean(return_120_lag_p,na.rm=TRUE),bsd_120=sd(return_120_lag_p,na.rm=TRUE), bN_120=sum(Nna_return_120_lag_p),
mean_return_0=0,sd_0=0, N_0=1,
mean_return_5=mean(return_5_fw_p,na.rm=TRUE),sd_5=sd(return_5_fw_p,na.rm=TRUE), N_5=sum(Nna_return_5_fw_p),
mean_return_10=mean(return_10_fw_p,na.rm=TRUE),sd_10=sd(return_10_fw_p,na.rm=TRUE), N_10=sum(Nna_return_10_fw_p),
mean_return_15=mean(return_15_fw_p,na.rm=TRUE),sd_15=sd(return_15_fw_p,na.rm=TRUE), N_15=sum(Nna_return_15_fw_p),
mean_return_20=mean(return_20_fw_p,na.rm=TRUE),sd_20=sd(return_20_fw_p,na.rm=TRUE), N_20=sum(Nna_return_20_fw_p),
mean_return_25=mean(return_25_fw_p,na.rm=TRUE),sd_25=sd(return_25_fw_p,na.rm=TRUE), N_25=sum(Nna_return_25_fw_p),
mean_return_30=mean(return_30_fw_p,na.rm=TRUE),sd_30=sd(return_30_fw_p,na.rm=TRUE), N_30=sum(Nna_return_30_fw_p),
mean_return_35=mean(return_35_fw_p,na.rm=TRUE),sd_35=sd(return_35_fw_p,na.rm=TRUE), N_35=sum(Nna_return_35_fw_p),
mean_return_40=mean(return_40_fw_p,na.rm=TRUE),sd_40=sd(return_40_fw_p,na.rm=TRUE), N_40=sum(Nna_return_40_fw_p),
mean_return_45=mean(return_45_fw_p,na.rm=TRUE),sd_45=sd(return_45_fw_p,na.rm=TRUE), N_45=sum(Nna_return_45_fw_p),
mean_return_50=mean(return_50_fw_p,na.rm=TRUE),sd_50=sd(return_50_fw_p,na.rm=TRUE), N_50=sum(Nna_return_50_fw_p),
mean_return_55=mean(return_55_fw_p,na.rm=TRUE),sd_55=sd(return_55_fw_p,na.rm=TRUE), N_55=sum(Nna_return_55_fw_p),
mean_return_60=mean(return_60_fw_p,na.rm=TRUE),sd_60=sd(return_60_fw_p,na.rm=TRUE), N_60=sum(Nna_return_60_fw_p),
mean_return_65=mean(return_65_fw_p,na.rm=TRUE),sd_65=sd(return_65_fw_p,na.rm=TRUE), N_65=sum(Nna_return_65_fw_p),
mean_return_70=mean(return_70_fw_p,na.rm=TRUE),sd_70=sd(return_70_fw_p,na.rm=TRUE), N_70=sum(Nna_return_70_fw_p),
mean_return_75=mean(return_75_fw_p,na.rm=TRUE),sd_75=sd(return_75_fw_p,na.rm=TRUE), N_75=sum(Nna_return_75_fw_p),
mean_return_80=mean(return_80_fw_p,na.rm=TRUE),sd_80=sd(return_80_fw_p,na.rm=TRUE), N_80=sum(Nna_return_80_fw_p),
mean_return_85=mean(return_85_fw_p,na.rm=TRUE),sd_85=sd(return_85_fw_p,na.rm=TRUE), N_85=sum(Nna_return_85_fw_p),
mean_return_90=mean(return_90_fw_p,na.rm=TRUE),sd_90=sd(return_90_fw_p,na.rm=TRUE), N_90=sum(Nna_return_90_fw_p),
mean_return_95=mean(return_95_fw_p,na.rm=TRUE),sd_95=sd(return_95_fw_p,na.rm=TRUE), N_95=sum(Nna_return_95_fw_p),
mean_return_100=mean(return_100_fw_p,na.rm=TRUE),sd_100=sd(return_100_fw_p,na.rm=TRUE), N_100=sum(Nna_return_100_fw_p),
mean_return_105=mean(return_105_fw_p,na.rm=TRUE),sd_105=sd(return_105_fw_p,na.rm=TRUE), N_105=sum(Nna_return_105_fw_p),
mean_return_110=mean(return_110_fw_p,na.rm=TRUE),sd_110=sd(return_110_fw_p,na.rm=TRUE), N_110=sum(Nna_return_110_fw_p),
mean_return_115=mean(return_115_fw_p,na.rm=TRUE),sd_115=sd(return_115_fw_p,na.rm=TRUE), N_115=sum(Nna_return_115_fw_p),
mean_return_120=mean(return_120_fw_p,na.rm=TRUE),sd_120=sd(return_120_fw_p,na.rm=TRUE), N_120=sum(Nna_return_120_fw_p),
mean_return_125=mean(return_125_fw_p,na.rm=TRUE),sd_125=sd(return_125_fw_p,na.rm=TRUE), N_125=sum(Nna_return_125_fw_p),
mean_return_130=mean(return_130_fw_p,na.rm=TRUE),sd_130=sd(return_130_fw_p,na.rm=TRUE), N_130=sum(Nna_return_130_fw_p),
mean_return_135=mean(return_135_fw_p,na.rm=TRUE),sd_135=sd(return_135_fw_p,na.rm=TRUE), N_135=sum(Nna_return_135_fw_p),
mean_return_140=mean(return_140_fw_p,na.rm=TRUE),sd_140=sd(return_140_fw_p,na.rm=TRUE), N_140=sum(Nna_return_140_fw_p),
mean_return_145=mean(return_145_fw_p,na.rm=TRUE),sd_145=sd(return_145_fw_p,na.rm=TRUE), N_145=sum(Nna_return_145_fw_p),
mean_return_150=mean(return_150_fw_p,na.rm=TRUE),sd_150=sd(return_150_fw_p,na.rm=TRUE), N_150=sum(Nna_return_150_fw_p),
mean_return_155=mean(return_155_fw_p,na.rm=TRUE),sd_155=sd(return_155_fw_p,na.rm=TRUE), N_155=sum(Nna_return_155_fw_p),
mean_return_160=mean(return_160_fw_p,na.rm=TRUE),sd_160=sd(return_160_fw_p,na.rm=TRUE), N_160=sum(Nna_return_160_fw_p),
mean_return_165=mean(return_165_fw_p,na.rm=TRUE),sd_165=sd(return_165_fw_p,na.rm=TRUE), N_165=sum(Nna_return_165_fw_p),
mean_return_170=mean(return_170_fw_p,na.rm=TRUE),sd_170=sd(return_170_fw_p,na.rm=TRUE), N_170=sum(Nna_return_170_fw_p),
mean_return_175=mean(return_175_fw_p,na.rm=TRUE),sd_175=sd(return_175_fw_p,na.rm=TRUE), N_175=sum(Nna_return_175_fw_p),
mean_return_180=mean(return_180_fw_p,na.rm=TRUE),sd_180=sd(return_180_fw_p,na.rm=TRUE), N_180=sum(Nna_return_180_fw_p),
mean_return_185=mean(return_185_fw_p,na.rm=TRUE),sd_185=sd(return_185_fw_p,na.rm=TRUE), N_185=sum(Nna_return_185_fw_p),
mean_return_190=mean(return_190_fw_p,na.rm=TRUE),sd_190=sd(return_190_fw_p,na.rm=TRUE), N_190=sum(Nna_return_190_fw_p),
mean_return_195=mean(return_195_fw_p,na.rm=TRUE),sd_195=sd(return_195_fw_p,na.rm=TRUE), N_195=sum(Nna_return_195_fw_p),
mean_return_200=mean(return_200_fw_p,na.rm=TRUE),sd_200=sd(return_200_fw_p,na.rm=TRUE), N_200=sum(Nna_return_200_fw_p)
), by=c("new_stock","wp_group")]

check_for_run_fw_plot_a <- copy(check_for_run_fw_plot_4)
check_for_run_fw_plot_a[,wp_group:=NULL]
check_for_run_fw_plot_a <- melt(check_for_run_fw_plot_a, id.vars="new_stock")
check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a[grepl("sd",variable)]
check_for_run_fw_plot_a_1 <- check_for_run_fw_plot_a_1[,.(sd=mean(value,na.rm=TRUE)),by=c("new_stock", "variable")]
check_for_run_fw_plot_a_1[,days:=rep(c(seq(-5,-120,-5),seq(0,200,5)),each=2)]
check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a[grepl("mean",variable)]
check_for_run_fw_plot_a_2 <- check_for_run_fw_plot_a_2[,.(mean=mean(value,na.rm=TRUE)),by=c("new_stock", "variable")]
check_for_run_fw_plot_a_2[,days:=rep(c(seq(-5,-120,-5),seq(0,200,5)),each=2)]
check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a[grepl("N",variable)]
check_for_run_fw_plot_a_3 <- check_for_run_fw_plot_a_3[,.(N=min(value,na.rm=TRUE)),by=c("new_stock", "variable")]
check_for_run_fw_plot_a_3[,days:=rep(c(seq(-5,-120,-5),seq(0,200,5)),each=2)]
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a_1, check_for_run_fw_plot_a_2, by=c("new_stock","days"), all.x=TRUE)
check_for_run_fw_plot_a <- merge(check_for_run_fw_plot_a, check_for_run_fw_plot_a_3, by=c("new_stock","days"), all.x=TRUE)
check_for_run_fw_plot_a[,upper_ci:=mean+1.96*sd/sqrt(N)]
check_for_run_fw_plot_a[,lower_ci:=mean-1.96*sd/sqrt(N)]
check_for_run_fw_plot_a[,Category:="Purchase - invested stock"]
check_for_run_fw_plot_a[new_stock==1,Category:="New purchase"]

check_for_run_fw_plot_a$Category <- factor(check_for_run_fw_plot_a$Category, levels = c("Purchase - invested stock", "New purchase"))
#check_for_run_fw_plot[,type2:=paste(type,wp_group)]

# check_for_run_fw_plot$type2 <- factor(check_for_run_fw_plot$type2, levels = c("top up after positive rsp","top up after negative rsp", "new buy-invested industry after positive rsp", "new buy-invested industry after negative rsp", "new buy-new industry after positive rsp", "new buy-new industry after negative rsp"))

pd <- position_dodge(0.03) # move them .05 to the left and right



(g10 <- ggplot(check_for_run_fw_plot_a[days<=0],aes(x=days,y=mean,color=Category))+
       geom_errorbar(aes(ymin=lower_ci, ymax=upper_ci), width=.05, position=pd) +
       geom_line(position=pd) + 
       geom_point(position=pd,size = 0.1)  + xlab("Number of Working Days After the Purchase") + ylab("1-Week Return") )

ggsave(g10, file="G:/rank/new_ind/codes/codes with more anon dataset/returnbeforebuy1.png",width = 7.29, height = 4.5)

check_for_run_fw_plot_b <- melt(check_for_run_fw_plot_4, id.vars=c("new_stock","wp_group"))

check_for_run_fw_plot_b_1 <- check_for_run_fw_plot_b[grepl("sd",variable)]
check_for_run_fw_plot_b_1[,days:=rep(c(seq(-5,-120,-5),seq(0,200,5)),each=8)]
check_for_run_fw_plot_b_2 <- check_for_run_fw_plot_b[grepl("mean",variable)]
check_for_run_fw_plot_b_2[,days:=rep(c(seq(-5,-120,-5),seq(0,200,5)),each=8)]
check_for_run_fw_plot_b_3 <- check_for_run_fw_plot_b[grepl("N",variable)]
check_for_run_fw_plot_b_3[,days:=rep(c(seq(-5,-120,-5),seq(0,200,5)),each=8)]
check_for_run_fw_plot_b <- merge(check_for_run_fw_plot_b_1, check_for_run_fw_plot_b_2, by=c("new_stock","days","wp_group"), all.x=TRUE)
setnames(check_for_run_fw_plot_b, c("value.x","value.y"), c("sd","mean"))
check_for_run_fw_plot_b <- merge(check_for_run_fw_plot_b, check_for_run_fw_plot_b_3, by=c("new_stock","days","wp_group"), all.x=TRUE)
setnames(check_for_run_fw_plot_b, "value", "N")
check_for_run_fw_plot_b[,upper_ci:=mean+1.96*sd/sqrt(N)]
check_for_run_fw_plot_b[,lower_ci:=mean-1.96*sd/sqrt(N)]
check_for_run_fw_plot_b[,Category:="Purchase - invested stock"]
check_for_run_fw_plot_b[new_stock==1,Category:="New purchase"]
check_for_run_fw_plot_b$Category <- factor(check_for_run_fw_plot_b$Category, levels = c("Purchase - invested stock", "New purchase"))


pd <- position_dodge(0.03) # move them .05 to the left and right



(g11 <- ggplot(check_for_run_fw_plot_b[days<=0],aes(x=days,y=mean,color=Category))+
       geom_errorbar(aes(ymin=lower_ci, ymax=upper_ci), width=.05, position=pd) +
       geom_line(position=pd) + facet_wrap(vars(wp_group)) +
       geom_point(position=pd,size = 0.1)  + xlab("Number of Working Days After the Purchase") + ylab("1-Week Return") )

ggsave(g11, file="G:/rank/new_ind/codes/codes with more anon dataset/returnbeforebuy2.png",width = 7.29, height = 4.5)

check_for_run_fw[,return_1week_lag:=Winsorize(return_1week_lag, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_1month_lag:=Winsorize(return_1month_lag, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_3month_lag:=Winsorize(return_3month_lag, probs = c(0.01,0.99),na.rm=TRUE)]
check_for_run_fw[,return_6month_lag:=Winsorize(return_6month_lag, probs = c(0.01,0.99),na.rm=TRUE)]

a1 <- t.test(check_for_run_fw[new_stock==0]$return_1week_lag, check_for_run_fw[new_stock==1]$return_1week_lag)
a2 <- t.test(check_for_run_fw[new_stock==0]$return_1month_lag, check_for_run_fw[new_stock==1]$return_1month_lag)
a3 <- t.test(check_for_run_fw[new_stock==0]$return_3month_lag, check_for_run_fw[new_stock==1]$return_3month_lag)
a4 <- t.test(check_for_run_fw[new_stock==0]$return_6month_lag, check_for_run_fw[new_stock==1]$return_6month_lag)

comparison <- as.data.table(rbind(c(a1$estimate,a1$p.value,a1$conf.int),
                    c(a2$estimate,a2$p.value,a2$conf.int), 
                    c(a3$estimate,a3$p.value,a3$conf.int),
                    c(a4$estimate,a4$p.value,a4$conf.int)))
comparison[,return:=c("return_1week_lag","return_1month_lag","return_3month_lag","return_6month_lag")]
comparison[,dif:=`mean of x`-`mean of y`]

# for WinProp [0, 0.25]

a1 <- t.test(check_for_run_fw[new_stock==0 & wp_group=="[0,0.25]" ]$return_1week_lag, check_for_run_fw[new_stock==1 & wp_group=="[0,0.25]"]$return_1week_lag)
a2 <- t.test(check_for_run_fw[new_stock==0 & wp_group=="[0,0.25]"]$return_1month_lag, check_for_run_fw[new_stock==1 & wp_group=="[0,0.25]"]$return_1month_lag)
a3 <- t.test(check_for_run_fw[new_stock==0 & wp_group=="[0,0.25]"]$return_3month_lag, check_for_run_fw[new_stock==1 & wp_group=="[0,0.25]"]$return_3month_lag)
a4 <- t.test(check_for_run_fw[new_stock==0& wp_group=="[0,0.25]"]$return_6month_lag, check_for_run_fw[new_stock==1]$return_6month_lag)

comparison1 <- as.data.table(rbind(c(a1$estimate,a1$p.value,a1$conf.int),
                    c(a2$estimate,a2$p.value,a2$conf.int), 
                    c(a3$estimate,a3$p.value,a3$conf.int),
                    c(a4$estimate,a4$p.value,a4$conf.int)))
comparison1[,return:=c("return_1week_lag","return_1month_lag","return_3month_lag","return_6month_lag")]
comparison1[,dif:=`mean of x`-`mean of y`]

# for WinProp (0.25, 0.5]

a1 <- t.test(check_for_run_fw[new_stock==0 & wp_group=="(0.25,0.5]" ]$return_1week_lag, check_for_run_fw[new_stock==1 & wp_group=="(0.25,0.5]"]$return_1week_lag)
a2 <- t.test(check_for_run_fw[new_stock==0 & wp_group=="(0.25,0.5]"]$return_1month_lag, check_for_run_fw[new_stock==1 & wp_group=="(0.25,0.5]"]$return_1month_lag)
a3 <- t.test(check_for_run_fw[new_stock==0 & wp_group=="(0.25,0.5]"]$return_3month_lag, check_for_run_fw[new_stock==1 & wp_group=="(0.25,0.5]"]$return_3month_lag)
a4 <- t.test(check_for_run_fw[new_stock==0& wp_group=="(0.25,0.5]"]$return_6month_lag, check_for_run_fw[new_stock==1]$return_6month_lag)

comparison2 <- as.data.table(rbind(c(a1$estimate,a1$p.value,a1$conf.int),
                    c(a2$estimate,a2$p.value,a2$conf.int), 
                    c(a3$estimate,a3$p.value,a3$conf.int),
                    c(a4$estimate,a4$p.value,a4$conf.int)))
comparison2[,return:=c("return_1week_lag","return_1month_lag","return_3month_lag","return_6month_lag")]
comparison2[,dif:=`mean of x`-`mean of y`]

# for WinProp (0.5,0.75]

a1 <- t.test(check_for_run_fw[new_stock==0 & wp_group=="(0.5,0.75]" ]$return_1week_lag, check_for_run_fw[new_stock==1 & wp_group=="(0.5,0.75]"]$return_1week_lag)
a2 <- t.test(check_for_run_fw[new_stock==0 & wp_group=="(0.5,0.75]"]$return_1month_lag, check_for_run_fw[new_stock==1 & wp_group=="(0.5,0.75]"]$return_1month_lag)
a3 <- t.test(check_for_run_fw[new_stock==0 & wp_group=="(0.5,0.75]"]$return_3month_lag, check_for_run_fw[new_stock==1 & wp_group=="(0.5,0.75]"]$return_3month_lag)
a4 <- t.test(check_for_run_fw[new_stock==0 & wp_group=="(0.5,0.75]"]$return_6month_lag, check_for_run_fw[new_stock==1]$return_6month_lag)

comparison3 <- as.data.table(rbind(c(a1$estimate,a1$p.value,a1$conf.int),
                    c(a2$estimate,a2$p.value,a2$conf.int), 
                    c(a3$estimate,a3$p.value,a3$conf.int),
                    c(a4$estimate,a4$p.value,a4$conf.int)))
comparison3[,return:=c("return_1week_lag","return_1month_lag","return_3month_lag","return_6month_lag")]
comparison3[,dif:=`mean of x`-`mean of y`]

# for WinProp (0.75,1]

a1 <- t.test(check_for_run_fw[new_stock==0 & wp_group=="(0.75,1]" ]$return_1week_lag, check_for_run_fw[new_stock==1 & wp_group=="(0.75,1]"]$return_1week_lag)
a2 <- t.test(check_for_run_fw[new_stock==0 & wp_group=="(0.75,1]"]$return_1month_lag, check_for_run_fw[new_stock==1 & wp_group=="(0.75,1]"]$return_1month_lag)
a3 <- t.test(check_for_run_fw[new_stock==0 & wp_group=="(0.75,1]"]$return_3month_lag, check_for_run_fw[new_stock==1 & wp_group=="(0.75,1]"]$return_3month_lag)
a4 <- t.test(check_for_run_fw[new_stock==0 & wp_group=="(0.75,1]"]$return_6month_lag, check_for_run_fw[new_stock==1]$return_6month_lag)

comparison4 <- as.data.table(rbind(c(a1$estimate,a1$p.value,a1$conf.int),
                    c(a2$estimate,a2$p.value,a2$conf.int), 
                    c(a3$estimate,a3$p.value,a3$conf.int),
                    c(a4$estimate,a4$p.value,a4$conf.int)))
comparison4[,return:=c("return_1week_lag","return_1month_lag","return_3month_lag","return_6month_lag")]
comparison4[,dif:=`mean of x`-`mean of y`]



a1 <- t.test(check_for_run_fw[order2==0]$return_1week_lag, check_for_run_fw[order2==1]$return_1week_lag)
a2 <- t.test(check_for_run_fw[order2==0]$return_1week_lag, check_for_run_fw[order2==2]$return_1week_lag)
a3 <- t.test(check_for_run_fw[order2==1]$return_1week_lag, check_for_run_fw[order2==2]$return_1week_lag)
a4 <- t.test(check_for_run_fw[order2==0]$return_1month_lag, check_for_run_fw[order2==1]$return_1month_lag)
a5 <- t.test(check_for_run_fw[order2==0]$return_1month_lag, check_for_run_fw[order2==2]$return_1month_lag)
a6 <- t.test(check_for_run_fw[order2==1]$return_1month_lag, check_for_run_fw[order2==2]$return_1month_lag)
a7 <- t.test(check_for_run_fw[order2==0]$return_3month_lag, check_for_run_fw[order2==1]$return_3month_lag)
a8 <- t.test(check_for_run_fw[order2==0]$return_3month_lag, check_for_run_fw[order2==2]$return_3month_lag)
a9 <- t.test(check_for_run_fw[order2==1]$return_3month_lag, check_for_run_fw[order2==2]$return_3month_lag)
a10 <- t.test(check_for_run_fw[order2==0]$return_6month_lag, check_for_run_fw[order2==1]$return_6month_lag)
a11 <- t.test(check_for_run_fw[order2==0]$return_6month_lag, check_for_run_fw[order2==2]$return_6month_lag)
a12 <- t.test(check_for_run_fw[order2==1]$return_6month_lag, check_for_run_fw[order2==2]$return_6month_lag)
comparison <- as.data.table(rbind(c(a1$estimate,a1$p.value,a1$conf.int),
                    c(a2$estimate,a2$p.value,a2$conf.int), 
                    c(a3$estimate,a3$p.value,a3$conf.int),
                    c(a4$estimate,a4$p.value,a4$conf.int),
                    c(a5$estimate,a5$p.value,a5$conf.int),
                    c(a6$estimate,a6$p.value,a6$conf.int),
                    c(a7$estimate,a7$p.value,a7$conf.int),
                    c(a8$estimate,a8$p.value,a8$conf.int),
                    c(a9$estimate,a9$p.value,a9$conf.int),
                    c(a10$estimate,a3$p.value,a10$conf.int),
                    c(a11$estimate,a3$p.value,a11$conf.int),
                    c(a12$estimate,a3$p.value,a3$conf.int)))
comparison[,return:=c(rep("return_1week_lag",3),rep("return_1month_lag",3), rep("return_3month_lag",3),  rep("return_6month_lag",3))]
comparison[,pair:=rep(c("topup vs invested", "topup vs new", "invested vs new"),4)]
comparison[,dif:=`mean of x`-`mean of y`]



#(g4.1 <- ggplot(check_for_run_fw_plot[type2=="top up after positive rsp"|type2=="top up after negative rsp"],aes(x=days,y=mean,color=type2))+
#       geom_errorbar(aes(ymin=lower_ci, ymax=upper_ci), width=.05, position=pd) +
#       geom_line(position=pd) +
#       geom_point(position=pd,size = 0.1) + xlab("Number of Working Days After the Purchase") + ylab("Return Since Purchase") )

#(g4.2 <- ggplot(check_for_run_fw_plot[type2=="new buy-invested industry after positive rsp" |type2=="new buy-invested industry after negative rsp"],aes(x=days,y=mean,color=type2))+
#       geom_errorbar(aes(ymin=lower_ci, ymax=upper_ci), width=.05, position=pd) +
#       geom_line(position=pd) +
#       geom_point(position=pd,size = 0.1) + xlab("Number of Working Days After the Purchase") + ylab("Return Since Purchase") )

#(g4.3 <- ggplot(check_for_run_fw_plot[type2=="new buy-new industry after positive rsp"  |type2=="new buy-new industry after negative rsp"],aes(x=days,y=mean,color=type2))+
#       geom_errorbar(aes(ymin=lower_ci, ymax=upper_ci), width=.05, position=pd) +
 #      geom_line(position=pd) +
#       geom_point(position=pd,size = 0.1) + xlab("Number of Working Days After the Purchase") + ylab("Return Since Purchase") )

#ggsave(g3, file="G:/rank/new_ind/codes/codes with more anon dataset/returnafterbuy.png",width = 7.29, height = 4.5)


#ggplot(income_2019, aes(x=monthly_income, y=..density..)) + geom_histogram(binwidth=100) + geom_density()+xlim(0,10000)
#ggplot(check_for_run_fw,aes(x=return_200_fw,y=..density..,color=order)) + geom_histogram(binwidth=0.01)


t.test(check_for_run_fw[new_stock==0]$return_1week_fw, check_for_run_fw[new_stock==1]$return_1week_fw)
t.test(check_for_run_fw[new_stock==0]$return_2week_fw, check_for_run_fw[new_stock==1]$return_2week_fw)
t.test(check_for_run_fw[new_stock==0]$return_3week_fw, check_for_run_fw[new_stock==1]$return_3week_fw)
t.test(check_for_run_fw[new_stock==0]$return_1month_fw, check_for_run_fw[new_stock==1]$return_1month_fw)

t.test(check_for_run_fw[new_stock==0]$return_1week_fw, check_for_run_fw[new_stock==1 & new_icb_industry!=1]$return_1week_fw)
t.test(check_for_run_fw[new_stock==0]$return_2week_fw, check_for_run_fw[new_stock==1 & new_icb_industry!=1]$return_2week_fw)
t.test(check_for_run_fw[new_stock==0]$return_3week_fw, check_for_run_fw[new_stock==1 & new_icb_industry!=1]$return_3week_fw)
t.test(check_for_run_fw[new_stock==0]$return_1month_fw, check_for_run_fw[new_stock==1 & new_icb_industry!=1]$return_1month_fw)

t.test(check_for_run_fw[new_stock==0]$return_1week_fw, check_for_run_fw[new_stock==1 & new_icb_industry==1]$return_1week_fw)
t.test(check_for_run_fw[new_stock==0]$return_2week_fw, check_for_run_fw[new_stock==1 & new_icb_industry==1]$return_2week_fw)
t.test(check_for_run_fw[new_stock==0]$return_3week_fw, check_for_run_fw[new_stock==1 & new_icb_industry==1]$return_3week_fw)
t.test(check_for_run_fw[new_stock==0]$return_1month_fw, check_for_run_fw[new_stock==1 & new_icb_industry==1]$return_1month_fw)

t.test(check_for_run_fw[new_stock==1 & new_icb_industry!=1]$return_1week_fw, check_for_run_fw[new_stock==1 & new_icb_industry==1]$return_1week_fw)
t.test(check_for_run_fw[new_stock==1 & new_icb_industry!=1]$return_2week_fw, check_for_run_fw[new_stock==1 & new_icb_industry==1]$return_2week_fw)
t.test(check_for_run_fw[new_stock==1 & new_icb_industry!=1]$return_3week_fw, check_for_run_fw[new_stock==1 & new_icb_industry==1]$return_3week_fw)
t.test(check_for_run_fw[new_stock==1 & new_icb_industry!=1]$return_1month_fw, check_for_run_fw[new_stock==1 & new_icb_industry==1]$return_1month_fw)

```














# contrarian measure

```{r}

load("G:/rank/new_ind/codes/codes with more anon dataset/contrarian.RData")
quantile(contrarian[!(is.na(con_measure))]$con_measure,c(0,0.01,0.05,seq(0.1,0.9,0.1),0.95,0.99,1))
check_for_run_con <- merge(check_for_run, contrarian, by="anon", all.x=TRUE)
check_for_run_con[, con_measure_win:=Winsorize(con_measure, probs = c(0.01,0.99),na.rm = TRUE)]
check_for_run_con[, momentum:=ifelse(con_measure>0,1,0)]
check_for_run_con[is.na(momentum), momentum:=1]


r1.5.1 <- felm(new_stock~ postcode + winning_prop+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + con_measure_win |sedol+date_formated   |0|anon_date,data =check_for_run_con)
r1.5.2 <- felm(new_stock~ postcode + winning_prop+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + momentum |sedol+date_formated   |0|anon_date,data =check_for_run_con)

rcon <- felm(new_stock~ postcode + winning_prop*momentum+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender  |sedol+date_formated   |0|anon_date,data =check_for_run_con)
rcon2 <- felm(new_stock~ postcode + rsp_portf_size_win*momentum+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender  |sedol+date_formated   |0|anon_date,data =check_for_run_con)

load("G:/rank/new_ind/codes/codes with more anon dataset/contrarian_quarterlyport.RData")
quantile(contrarian[!is.na(con_measure)]$con_measure,c(0,0.01,0.05,0.1,0.2,0.3,0.36,0.37,0.4,0.43,0.44,0.45,0.47,0.5,0.6,0.7,0.8,0.9,0.95,0.99,1))
check_for_run_con <- merge(check_for_run, contrarian, by="anon", all.x=TRUE)
check_for_run_con[, con_measure_win:=Winsorize(con_measure, probs = c(0.01,0.99),na.rm = TRUE)]
check_for_run_con[, momentum:=ifelse(con_measure>0,1,0)]
check_for_run_con[is.na(momentum), momentum:=1]

r1.5.3 <- felm(new_stock~ postcode + winning_prop+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + con_measure_win |sedol+date_formated   |0|anon_date,data =check_for_run_con)
r1.5.4 <- felm(new_stock~ postcode + winning_prop+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + momentum |sedol+date_formated   |0|anon_date,data =check_for_run_con)

rcon3 <- felm(new_stock~ postcode + winning_prop*momentum+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender  |sedol+date_formated   |0|anon_date,data =check_for_run_con)
rcon4 <- felm(new_stock~ postcode + rsp_portf_size_win*momentum+ no.in.portfolio + cum_new_buy_win+ log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender  |sedol+date_formated   |0|anon_date,data =check_for_run_con)



```




```{r}

#check_for_run <- transaction_buy_run[no.in.portfolio>=0 & !(is.na(winning1day_prop)) ]

#quantile(check_for_run$no.in.portfolio,seq(0,1,0.1))
#check_for_run[,no.in.portfolio.group:=as.character(no.in.portfolio)]
#check_for_run[no.in.portfolio>=5,no.in.portfolio.group:=">=5"]
#check_for_run[,no.in.portfolio.group:=factor(no.in.portfolio.group, levels= c("1", "2", "3", "4",">=5"))]

r7.1 <- felm(new_stock~ winning1day_prop +no.in.portfolio + log_age + log_initial_value + log_portfolio_value + log_ntrades_freq_win+ gender + postcode|date_formated+sedol  |0|anon_date,data =check_for_run)
r7.2 <- felm(new_stock~ winning1day_prop*no.in.portfolio.group + log_age + log_initial_value + log_portfolio_value + log_ntrades_freq_win+ gender + postcode|date_formated+sedol  |0|anon_date,data =check_for_run)

check_for_run <- transaction_buy_run_sub[no.in.portfolio>=0 & !(is.na(winning1day_prop)) ]

quantile(check_for_run$no.in.portfolio,seq(0,1,0.1))
check_for_run[,no.in.portfolio.group:=as.character(no.in.portfolio)]
check_for_run[no.in.portfolio>=5,no.in.portfolio.group:=">=5"]
check_for_run[,no.in.portfolio.group:=factor(no.in.portfolio.group, levels= c("1", "2", "3", "4",">=5"))]

r7.3 <- felm(new_stock~ winning1day_prop + no.in.portfolio  |anon+sedol+date_formated   |0|anon+date_formated+sedol,data =check_for_run)
r7.4 <- felm(new_stock~ winning1day_prop*no.in.portfolio.group  |anon+sedol+date_formated   |0|anon+date_formated+sedol,data =check_for_run)

stargazer(r7.1,r7.2, type="latex",  omit="postcode"  ,star.cutoffs = c(0.05, 0.01, 0.005),out="check.tex")

```

# socio-economic factors 

```{r}

check_for_run <- transaction_buy_run_sub[no.in.portfolio>=0 & !(is.na(winning_prop)) & !(is.na(rsp_portf_size)) & !(is.na(portf_return_1day_weight)) & !(is.na(portf_return_3day_weight))& !(is.na(portf_return_1week_weight))  & !(is.na(portf_return_2week_weight)) & !(is.na(port_value_change_last_buy))]

anon <- fread("D:/raw_data_September_2016/warwick_version--portfolios_201204-201604--id_mapping--with_customer_level_attributes_v2.csv")
anon <- anon[anon_id %in% unique(check_for_run$anon)]
anon[,open_date:=as.Date(open_date)]
anon[close_date=="",close_date:="2016-08-31"]
anon[,close_date:=as.Date(close_date)]
anon[,account_length:=as.numeric(close_date-open_date)]
anon <- anon[order(anon_id,-account_length)]
anon <- anon[,.SD[1],by=anon_id]
anon[,age:=2012-dob]
# anon_buy_rate <- buydaydt1[,.(selling.rate=mean(sells)),by="anon"]
# setnames(anon_selling_rate,"anon","anon_id")
# anon <- merge(anon,anon_selling_rate,by="anon_id")
# smry <- anon[,.(age,selling.rate)]

area_code <- fread("G:/rank/socio-economic/NSPL_AUG_2011.csv")
setnames(area_code,c("PCD","PCD2","PCDS","DOINTR","DOTERM","USERTYPE","OSEAST1M","OSNRTH1M","OSGRDIND","OACODE","CTY","LAUA","WARD","HLTHAU", "HRO", "CTRY", "GOR", "PCON", "EER", "TECLEC", "TTWA", "PCT", "NUTS", "PARK", "SOA1", "SOA2","DZONE1","DZONE2","SOA1NI", "URINDEW", "URINDSC", "URINDNI", "OAC"))
area_code[, postcode:=substring(PCD,1,2)]

# median house price

house_price <- fread("G:/rank/socio-economic/median_house_price.csv",header = TRUE)
house_price <- house_price[,.(LAUA, Mar_2011, Jun_2011, Sep_2011, Dec_2011)]
area_code <- merge(area_code,house_price,by="LAUA",all.x=TRUE)

area_code_house_price <- area_code[!is.na(Dec_2011)]
area_code_house_price <- area_code_house_price[,.(mean_house_price=mean(Dec_2011),
                                                  median_house_price=median(Dec_2011)),
                                               by=postcode]


#weekly_pay
pay <- fread("G:/rank/socio-economic/weekly_pay.csv",header = TRUE)
pay[,median_pay:=as.numeric(median_pay)]
area_code <- merge(area_code,pay,by="LAUA",all.x=TRUE)

area_code_pay <- area_code[!is.na(median_pay)]
area_code_pay <- area_code_pay[,.(mean_weeklypay=mean(median_pay),
                                  median_weeklypay=median(median_pay)),
                               by=postcode]


anon <- merge(anon,area_code_house_price,by="postcode",all.x=TRUE)
anon <- merge(anon,area_code_pay,by="postcode",all.x=TRUE)


median(anon$median_house_price,na.rm = TRUE)
# 205000
anon_low_houseprice <- anon[median_house_price<205000]$anon_id
anon_high_houseprice <- anon[median_house_price>=205000]$anon_id

median(anon$median_weeklypay,na.rm = TRUE)
# 408.8
anon_low_weeklypay <- anon[median_weeklypay<408.8]$anon_id
anon_high_weeklypay <- anon[median_weeklypay>=408.8]$anon_id

buy_times <- transaction_buy[,.N,by=anon]
setnames(buy_times,"N","num.buys")
transaction_sell <- transaction[net_cost<0]
sell_times <- transaction_sell[,.N,by=anon]
setnames(sell_times,"N","num.sells")

setnames(anon,"anon_id","anon")
anon <- merge(anon, buy_times, by="anon",all.x=TRUE)
anon <- merge(anon, sell_times, by="anon",all.x=TRUE)
anon[is.na(num.sells), num.sells:=0]
anon[,trade_freq:=(num.buys+num.sells)*30/account_length]

# calculate log-in frequency for each person

log_in <- fread("D:/wa/merged_logins.csv")
log_in[,date:=substring(V1,1,10)]
log_in[,date:=as.Date(date,format="%d/%m/%Y")]
log_in[,anon_inter:=substring(V3,6,nchar(V3))]
log_in[,anon:=substring(anon_inter,1,(nchar(anon_inter)-4))]
log_in[,anon:=as.numeric(anon)]

setnames(log_in, c("V2","date"), c("log_in_times","port_date"))
log_in_freq <- log_in[,.(log_in_freq=sum(log_in_times)),by=anon]
log_in_days <- log_in[,.(log_in_days=.N),by=anon]
anon <- merge(anon, log_in_freq, by="anon",all.x=TRUE)
anon <- merge(anon, log_in_days, by="anon",all.x=TRUE)
anon[,login_freq:=log_in_days*30/account_length]
# merge in portfolio value

load("G:/rank/intermdiate_data/dt_portfolio_moreanon/portfolio_value.RData")
anon <- merge(anon, portfolio_value_1, by="anon", all.x=TRUE)

check_for_run <- transaction_buy_run_sub[no.in.portfolio>=0 & !(is.na(winning_prop)) & !(is.na(rsp_portf_size)) & !(is.na(portf_return_1day_weight)) & !(is.na(portf_return_3day_weight))& !(is.na(portf_return_1week_weight))  & !(is.na(portf_return_2week_weight)) & !(is.na(port_value_change_last_buy))]

quantile(check_for_run$no.in.portfolio,seq(0,1,0.1))
check_for_run[,no.in.portfolio.group:=as.character(no.in.portfolio)]
check_for_run[no.in.portfolio>=5,no.in.portfolio.group:=">=5"]
check_for_run[,no.in.portfolio.group:=factor(no.in.portfolio.group, levels= c("1", "2", "3", "4",">=5"))]


check_for_run <- merge(check_for_run, anon, by="anon", all.x=TRUE)

check_for_run[,rsp_portf_size_win:=Winsorize(rsp_portf_size, probs = c(0.01,0.99),na.rm = TRUE)]
check_for_run[,portf_return_1week_weight_win:=Winsorize(portf_return_1week_weight, probs = c(0.01,0.99),na.rm = TRUE)]
check_for_run[,portf_return_2week_weight_win:=Winsorize(portf_return_2week_weight, probs = c(0.01,0.99),na.rm = TRUE)]
check_for_run[,portf_return_1month_weight_win:=Winsorize(portf_return_1month_weight, probs = c(0.01,0.99),na.rm = TRUE)]
check_for_run[,portf_return_1day_weight_win:=Winsorize(portf_return_1day_weight, probs = c(0.01,0.99),na.rm = TRUE)]  
check_for_run[,portf_return_3day_weight_win:=Winsorize(portf_return_3day_weight, probs = c(0.01,0.99),na.rm = TRUE)] 
check_for_run[,portf_return_2_4days_weight_win:=Winsorize(portf_return_2_4days_weight, probs = c(0.01,0.99),na.rm = TRUE)] 
check_for_run[,portf_return_4_6days_weight_win:=Winsorize(portf_return_4_6days_weight, probs = c(0.01,0.99),na.rm = TRUE)]
check_for_run[,portf_return_6_11days_weight_win:=Winsorize(portf_return_6_11days_weight, probs = c(0.01,0.99),na.rm = TRUE)]
check_for_run[,portf_return_11_16days_weight_win:=Winsorize(portf_return_11_16days_weight, probs = c(0.01,0.99),na.rm = TRUE)]
check_for_run[,portf_return_16_21days_weight_win:=Winsorize(portf_return_16_21days_weight, probs = c(0.01,0.99),na.rm = TRUE)]
check_for_run[,log_age:=log(age)]
check_for_run[,log_initial_value:=log(initial_portfolio_value_2)]
check_for_run[,log_portfolio_value:=log(portfolio_value)]
check_for_run[,ntrades2:=min(ntrades),by=c("anon","date_formated")]
check_for_run[,length_account:=as.numeric(date_formated-open_date)]
check_for_run[,ntrades_freq:=((ntrades2-1)/length_account)*30]
check_for_run[,log_median_house_price:=log(median_house_price)]
check_for_run[,log_median_weeklypay:=log(median_weeklypay)]
check_for_run[,log_age_win:=Winsorize(log_age,probs = c(0.01,0.99),na.rm = TRUE)]
check_for_run[,log_initial_value_win:=Winsorize(log_initial_value,probs = c(0.01,0.99))]
check_for_run[,log_portfolio_value_win:=Winsorize(log_portfolio_value,probs = c(0.01,0.99))]
check_for_run[,log_ntrades_freq_win:=Winsorize(log_ntrades_freq,probs = c(0.01,0.99))]
check_for_run[,log_median_house_price_win:=Winsorize(log_median_house_price,probs = c(0.01,0.99))]
check_for_run[,log_median_weeklypay_win:=Winsorize(log_median_weeklypay,probs = c(0.01,0.99))]
check_for_run[,anon_date:=paste0(anon, date_formated)]

# weekly pay
median(anon$median_weeklypay,na.rm = TRUE) # 408.8
anon_low_weeklypay <- anon[median_weeklypay<408.8]$anon
anon_high_weeklypay <- anon[median_weeklypay>=408.8]$anon
nrow(check_for_run[anon %in% anon_high_weeklypay]) # 52563
nrow(check_for_run[anon %in% anon_low_weeklypay]) # 50562
check_for_run_weeklypay <- check_for_run[!(is.na(median_weeklypay))]
check_for_run_weeklypay[,high_weeklypay:=ifelse(median_weeklypay>=408.8, 1, 0)]

r10.1.1 <- felm(new_stock~  winning_prop + high_weeklypay*winning_prop + no.in.portfolio + cum_new_buy_win + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender |sedol+date_formated   |0|anon_date,data =check_for_run_weeklypay)
# r10.1.2 <- felm(new_stock~ winning_prop*no.in.portfolio.group + high_weeklypay:winning_prop +high_weeklypay:no.in.portfolio.group +  high_weeklypay:winning_prop:no.in.portfolio.group  |anon+sedol+date_formated   |0|anon+date_formated+sedol,data =check_for_run_weeklypay)


# house_price
median(anon$median_house_price,na.rm = TRUE) # 205000
anon_low_house_price <- anon[median_house_price<205000]$anon
anon_high_house_price <- anon[median_house_price>=205000]$anon
nrow(check_for_run[anon %in% anon_high_house_price]) # 50763
nrow(check_for_run[anon %in% anon_low_house_price]) # 52362
check_for_run_house_price <- check_for_run[!(is.na(median_house_price))]
check_for_run_house_price[,high_house_price:=ifelse(median_house_price>=205000, 1, 0)]

r10.2.1 <- felm(new_stock~ winning_prop + winning_prop*high_house_price+ no.in.portfolio + cum_new_buy_win + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender |sedol+date_formated   |0|anon_date,data =check_for_run_house_price)
# r10.2.2 <- felm(new_stock~ winning_prop*no.in.portfolio.group + high_house_price:winning_prop +high_house_price:no.in.portfolio.group +  high_house_price:winning_prop:no.in.portfolio.group  |anon+sedol+date_formated   |0|anon+date_formated+sedol,data =check_for_run_house_price)

# age
median(anon$age,na.rm = TRUE) # 42
anon_low_age <- anon[age<42]$anon
anon_high_age <- anon[age>=42]$anon
nrow(check_for_run[anon %in% anon_high_age]) # 73229
nrow(check_for_run[anon %in% anon_low_age]) # 29896
check_for_run_age <- check_for_run[!(is.na(age))]
check_for_run_age[,high_age:=ifelse(age>=42, 1, 0)]

r10.3.1 <- felm(new_stock~ winning_prop + winning_prop*high_age+ no.in.portfolio + cum_new_buy_win + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode |sedol+date_formated   |0|anon_date,data =check_for_run_age)
# r10.3.2 <- felm(new_stock~ winning_prop*no.in.portfolio.group + high_age:winning_prop +high_age:no.in.portfolio.group +  high_age:winning_prop:no.in.portfolio.group  |anon+sedol+date_formated   |0|anon+date_formated+sedol,data =check_for_run_age)

# initial portfolio value
median(anon$initial_portfolio_value_2,na.rm = TRUE) # 3356.71
anon_low_inivalue <- anon[initial_portfolio_value_1<3356.71]$anon
anon_high_inivalue <- anon[initial_portfolio_value_1>=3356.71]$anon
nrow(check_for_run[anon %in% anon_high_inivalue]) # 54595
nrow(check_for_run[anon %in% anon_low_inivalue]) # 48336
check_for_run_inivalue <- check_for_run[!(is.na(initial_portfolio_value_2))]
check_for_run_inivalue[,high_inivalue:=ifelse(initial_portfolio_value_1>=3356.71, 1, 0)]

r10.4.1 <- felm(new_stock~ postcode+ winning_prop + winning_prop*high_inivalue+ no.in.portfolio + cum_new_buy_win + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender  |sedol+date_formated   |0|anon_date,data =check_for_run_inivalue)
# r10.4.2 <- felm(new_stock~ winning_prop*no.in.portfolio.group + high_inivalue:winning_prop +high_inivalue:no.in.portfolio.group +  high_inivalue:winning_prop:no.in.portfolio.group  |anon+sedol+date_formated   |0|anon+date_formated+sedol,data =check_for_run_inivalue)

# median portfolio value
median(anon$median_portfolio_value,na.rm = TRUE) # 9902.939
anon_low_medvalue <- anon[median_portfolio_value<9902.939]$anon
anon_high_medvalue <- anon[median_portfolio_value>=9902.939]$anon
nrow(check_for_run[anon %in% anon_high_medvalue]) # 64492
nrow(check_for_run[anon %in% anon_low_medvalue]) # 38633
check_for_run_medvalue <- check_for_run[!(is.na(median_portfolio_value))]
check_for_run_medvalue[,high_medvalue:=ifelse(median_portfolio_value>=9902.939, 1, 0)]

r10.5.1 <- felm(new_stock~ postcode + winning_prop + winning_prop*high_medvalue+ no.in.portfolio + cum_new_buy_win + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender |sedol+date_formated   |0|anon_date,data =check_for_run_medvalue)
# r10.5.2 <- felm(new_stock~ winning_prop*no.in.portfolio.group + high_medvalue:winning_prop +high_medvalue:no.in.portfolio.group +  high_medvalue:winning_prop:no.in.portfolio.group  |anon+sedol+date_formated   |0|anon+date_formated+sedol,data =check_for_run_medvalue)

# trading frequency
median(anon$trade_freq,na.rm = TRUE) # 0.4026846
anon_low_trade_freq <- anon[trade_freq<0.4026846]$anon
anon_high_trade_freq <- anon[trade_freq>=0.4026846]$anon
nrow(check_for_run[anon %in% anon_high_trade_freq]) # 79189
nrow(check_for_run[anon %in% anon_low_trade_freq]) # 23936
check_for_run_trade_freq <- check_for_run[!(is.na(trade_freq))]
median(check_for_run_trade_freq$trade_freq) # 0.9640103
check_for_run_trade_freq[,high_trade_freq:=ifelse(trade_freq>=0.4026846, 1, 0)]

r10.6.1 <- felm(new_stock~ winning_prop + winning_prop*high_trade_freq+ no.in.portfolio + cum_new_buy_win + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender + postcode |sedol+date_formated   |0|anon_date,data =check_for_run_trade_freq)
# r10.6.2 <- felm(new_stock~ winning_prop*no.in.portfolio.group + high_trade_freq:winning_prop +high_trade_freq:no.in.portfolio.group +  high_trade_freq:winning_prop:no.in.portfolio.group  |anon+sedol+date_formated   |0|anon+date_formated+sedol,data =check_for_run_trade_freq)

# trading frequency
median(anon$login_freq,na.rm = TRUE) # 3.461328
anon_low_login_freq <- anon[login_freq<3.461328]$anon
anon_high_login_freq <- anon[login_freq>=3.461328]$anon
nrow(check_for_run[anon %in% anon_high_login_freq]) # 68228
nrow(check_for_run[anon %in% anon_low_login_freq]) # 32132
check_for_run_login_freq <- check_for_run[!(is.na(login_freq))]
median(check_for_run_login_freq$login_freq) # 6.201876
quantile(check_for_run_login_freq$login_freq,c(0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9))
check_for_run_login_freq[,high_login_freq:=ifelse(login_freq>=1.051893, 1, 0)]

r10.7.1 <- felm(new_stock~  postcode + winning_prop + winning_prop*high_login_freq + no.in.portfolio + cum_new_buy_win + log_age_win + log_initial_value_win + log_portfolio_value_win + log_ntrades_freq_win + gender  |sedol+date_formated   |0|anon_date,data =check_for_run_login_freq)
summary(r10.7.1)
# r10.7.2 <- felm(new_stock~ winning_prop*no.in.portfolio.group + high_login_freq:winning_prop +high_login_freq:no.in.portfolio.group +  high_login_freq:winning_prop:no.in.portfolio.group  |anon+sedol+date_formated   |0|anon+date_formated+sedol,data =check_for_run_login_freq)

stargazer(r10.3.1, r10.1.1, r10.2.1, r10.4.1, r10.5.1, r10.6.1, r10.7.1,  type="latex",   omit = "postcode",  dep.var.labels=c("New Stock"), add.lines = list(c("Account FE", c("Yes","Yes","Yes","Yes","Yes","Yes","Yes")),c("Stock FE",  c("Yes","Yes","Yes","Yes","Yes","Yes","Yes")), c("Date FE",  c("Yes","Yes","Yes","Yes","Yes","Yes","Yes"))),star.cutoffs = c(0.05, 0.01, 0.005),out="check.tex")
```























# bond purchase

```{r}
bond <-fread("F:/stock split/merged_from_python.csv")

setnames(bond, c("V1","V2","V3","V4","V5","V6","V7","V8","V9","V10"),
         c("date","transaction_time","transaction_type","narative","sedol",
           "cost","quantity","unit_price","commission","account"))

split <- fread("F:/stock split/intermediate_data/split.csv")

bond[,date:=as.Date(date)]

split$datadate <- as.Date(split$datadate) # split data from compustat


static <- fread("F:/stock split/intermediate_data/260118_isins_sedols_recovered_static.csv")
static <- static[,c("Barclays_SEDOL","DS_STOCK_TYPE","DS_CURRENCY_CODE")] #ds_static_data



setnames(bond,"sedol","Barclays_SEDOL")
bond <- merge(bond, static,by="Barclays_SEDOL",all.x = TRUE)
extract_anon_id <- function(x)
{
  unlist(strsplit(unlist(strsplit(x, split="_"))[2] , split=".c"))[1]
}

bond[,anon:=unlist(lapply(account, extract_anon_id))]
bond[,anon:=as.numeric(anon)]
bond <- bond[order(account,date,transaction_time)]
bond[,ntrades:=seq_len(.N), by = account]

#Hiro's way to identify automatic trading (for buying)
bond_buy <- bond[narative=="BUY"] # all buy stransactions
bond_buy <- bond_buy[DS_STOCK_TYPE == "BD"]
bond_buy <- bond_buy[DS_CURRENCY_CODE == "GBP"]

#Hiro's way to identify automatic trading (for selling)
bond_sell <- bond[narative=="SELL"] # all buy stransactions
bond_sell <- bond_sell[DS_STOCK_TYPE == "BD"]
bond_sell <- bond_sell[DS_CURRENCY_CODE == "GBP"]

rm(bond)
bond <- rbind(bond_buy, bond_sell)


setnames(bond,"date","port_date")

bond[,c("account", "DS_STOCK_TYPE", "DS_CURRENCY_CODE"):=NULL]
#filter out multiple transactions on the same stock on the same day from the same anon
check <- bond[,.N,by=c("Barclays_SEDOL","port_date","anon")]
bond <- merge(bond, check, by=c("Barclays_SEDOL","port_date","anon"), all.x=TRUE)
multiple <- bond[N>1]
bond <- bond[N==1]
bond[,N:=NULL]
bond[,net_cost:=quantity*unit_price]
bond[transaction_type=="S",quantity:=-quantity]
bond[transaction_type=="S",net_cost:=-net_cost]
multiple[transaction_type=="S",quantity:=-quantity]
multiple[,quantity_daily:=sum(quantity), by=c("Barclays_SEDOL","port_date","anon")]
multiple[,net_cost:=quantity*unit_price]
multiple[,net_cost_daily:=sum(net_cost), by=c("Barclays_SEDOL","port_date","anon")]
multiple[,c("N","quantity","net_cost"):=NULL]
multiple <- multiple[,.SD[.N], by=c("Barclays_SEDOL","port_date","anon")]
setnames(multiple, c("quantity_daily","net_cost_daily"), c("quantity","net_cost"))
multiple[quantity>0,transaction_type:="B"]
multiple[quantity<0,transaction_type:="S"]
bond <- rbind(bond,multiple)
bond[,c("transaction_type", "narative", "cost"):=NULL]
bond_buy <- bond[net_cost>0]
```

```{r}
setnames(bond,"Barclays_SEDOL","sedol")
setnames(bond,"port_date","date_formated")
bond <- merge(bond, portfolios_return, by=c("anon", "date_formated"), all.x=TRUE)
bond <- merge(bond, portfolio_stock_composition, by=c("sedol", "anon", "date_formated"), all.x=TRUE)

```
















































































```{r}

return_indicator <- "portf_return_1week_weight"

r5 <- three_fes(1,0,"winning_prop","winning proportion")
three_fes <- function(sub, least.holding, return_indicator, return_indicator_2){
 if (sub==1){check_for_run <- transaction_buy_run_sub[no.in.portfolio>=least.holding & !(is.na(get(return_indicator)))]
   }else{check_for_run <- transaction_buy_run[no.in.portfolio>=least.holding & !(is.na(get(return_indicator)))] }
   setnames(check_for_run,return_indicator,"gain_size")
   # plot 2, 3: break by each quantile
check_for_run[,sedol_date:=paste0(sedol,date_formated)]
check_for_run[,no.in.portfolio.group:=as.character(no.in.portfolio)]
check_for_run[no.in.portfolio>=5,no.in.portfolio.group:=">=5"]
check_for_run[,no.in.portfolio.group:=factor(no.in.portfolio.group, levels= c("1", "2", "3", "4",">=5"))]

interval <- quantile(check_for_run$gain_size,c(0.01,0.99))
a <- interval[1]
b <- interval[2]
name_1 <- paste0("return size (",return_indicator_2,")")
name_middle <- ifelse(sub==1,"sub","all")
name_2 <- paste0("G:/rank/new_ind/codes/codes with more anon dataset/plots/", return_indicator_2,"_descriptive_",name_middle,least.holding,".png")
(g2 <- ggplot(check_for_run,aes(x=gain_size,y=new_stock,group=no.in.portfolio.group)) + geom_smooth() +  ylab("Probability of buying a new stock") + xlab(name_1) + xlim(a,b))

ggsave(g2, file=name_2, width = 7.29, height = 4.5)

#r4 <- felm(new_ind_adj~gain_size|0|0|anon+date_formated,data =check_for_run)

check_for_run[,gain_size_win:=Winsorize(gain_size, probs = c(0.01,0.99))]
check_for_run[,gain_size_win_sqr:=gain_size_win^2]
#check_for_run[,rsp_portf_size_win:=Winsorize(rsp_portf_size, probs = c(0.01,0.99))]
#check_for_run[,portf_return_1week_weight_win:=Winsorize(portf_return_1week_weight, probs = c(0.01,0.99),na.rm = TRUE)]
#check_for_run[,portf_return_1month_weight_win:=Winsorize(portf_return_1month_weight, probs = c(0.01,0.99),na.rm = TRUE)] 
#+no.in.portfolio    

#r5 <- felm(new_stock~ gain_size_win + no.in.portfolio |anon+sedol+date_formated  |0|anon+date_formated+sedol,data =check_for_run)
r5 <- felm(new_stock~ gain_size_win * no.in.portfolio.group + gain_size_win_sqr * no.in.portfolio.group|anon |0|anon+date_formated+sedol,data =check_for_run)

fe <- as.data.table(getfe(r5))
fe_anon <- fe[fe=="anon",.(effect, idx)]
fe_anon[,idx:=as.numeric(levels(idx))[idx]]
setnames(fe_anon,"idx","anon")
#fe_sedol <- fe[fe=="sedol",.(effect, idx)]
#fe_sedol[,idx:=as.character(levels(idx))[idx]]
#setnames(fe_sedol,"idx","sedol")
#fe_date <- fe[fe=="date_formated",.(effect, idx)]
#fe_date[,idx:=as.character(levels(idx))[idx]]
#setnames(fe_date,"idx","date_formated")
#fe_date[,date_formated:=as.Date(date_formated)]
#fe_no <- fe[fe=="no.in.portfolio",.(effect, idx)]
#fe_no[,idx:=as.character(levels(idx))[idx]]
#setnames(fe_no,c("idx","effect"),c("no.in.portfolio","effect_no"))
#fe_no[,no.in.portfolio:=as.numeric(no.in.portfolio)]

check_for_run <- merge(check_for_run,fe_anon,by="anon",all.x=TRUE)
#check_for_run <- merge(check_for_run,fe_sedol,by="sedol",all.x=TRUE)
#check_for_run <- merge(check_for_run,fe_date,by="date_formated",all.x=TRUE)
#check_for_run <- merge(check_for_run,fe_no,by="no.in.portfolio",all.x=TRUE)

check_for_run[,mean_y:=mean(new_stock)]
#check_for_run[,adj_new_stock:=new_stock-effect.x-effect.y-effect-effect_no]
#check_for_run[,adj_new_stock:=new_stock-effect.x-effect.y-effect]
check_for_run[,adj_new_stock:=new_stock-effect]


r5_check <- lm(adj_new_stock~ gain_size_win + no.in.portfolio -1,data =check_for_run)


# \nand number of stocks 
name_1 <- paste0("return size (",return_indicator_2,")")
name_middle <- ifelse(sub==1,"sub","all")
name_2 <- paste0("G:/rank/new_ind/codes/codes with more anon dataset/plots/", return_indicator_2,"_rega_",name_middle,least.holding,".png")
(g3 <- ggplot(check_for_run,aes(x=gain_size_win,y=adj_new_stock,color=no.in.portfolio.group)) + geom_smooth() +  ylab("Probability of buying a new stock \n(Adjusted by account, sedol, dateFEs)") + xlab(name_1) + xlim(a,b))
ggsave(g3, file=name_2,width = 7.29, height = 4.5)

return(r5)
   }


```


```{r}


four_fes <- function(sub, least.holding, return_indicator, return_indicator_2){
  if (sub==1){check_for_run <- transaction_buy_run_sub[no.in.portfolio>=least.holding & !(is.na(get(return_indicator)))]
   }else{check_for_run <- transaction_buy_run[no.in.portfolio>=0 & !(is.na(get(return_indicator)))] }
   setnames(check_for_run,return_indicator,"gain_size")
# plot 2, 3: break by each quantile
check_for_run[,sedol_date:=paste0(sedol,date_formated)]

interval <- quantile(check_for_run$gain_size,c(0.01,0.99))
a <- interval[1]
b <- interval[2]

#(g3 <- ggplot(check_for_run,aes(x=gain_size,y=new_stock)) + geom_smooth() +  ylab("Probability of buying a new stock") + xlab("return size (rsp)") + xlim(a,b))
#ggsave(g2, file="G:/rank/new_ind/codes/codes with more anon dataset/rspdescriptive_all_5.png",width = 7.29, height = 4.5)
#r4 <- felm(new_ind_adj~gain_size|0|0|anon+date_formated,data =check_for_run)

check_for_run[,gain_size_win:=Winsorize(gain_size, probs = c(0.01,0.99))]
#check_for_run[,rsp_portf_size_win:=Winsorize(rsp_portf_size, probs = c(0.01,0.99))]
#check_for_run[,portf_return_1week_weight_win:=Winsorize(portf_return_1week_weight, probs = c(0.01,0.99),na.rm = TRUE)]
#check_for_run[,portf_return_1month_weight_win:=Winsorize(portf_return_1month_weight, probs = c(0.01,0.99),na.rm = TRUE)]     
r2 <- felm(new_stock~ gain_size_win |anon+sedol+date_formated +no.in.portfolio |0|anon+date_formated+sedol,data =check_for_run)

fe <- as.data.table(getfe(r2))
fe_anon <- fe[fe=="anon",.(effect, idx)]
fe_anon[,idx:=as.numeric(levels(idx))[idx]]
setnames(fe_anon,"idx","anon")
fe_sedol <- fe[fe=="sedol",.(effect, idx)]
fe_sedol[,idx:=as.character(levels(idx))[idx]]
setnames(fe_sedol,"idx","sedol")
fe_date <- fe[fe=="date_formated",.(effect, idx)]
fe_date[,idx:=as.character(levels(idx))[idx]]
setnames(fe_date,"idx","date_formated")
fe_date[,date_formated:=as.Date(date_formated)]
fe_no <- fe[fe=="no.in.portfolio",.(effect, idx)]
fe_no[,idx:=as.character(levels(idx))[idx]]
setnames(fe_no,c("idx","effect"),c("no.in.portfolio","effect_no"))
fe_no[,no.in.portfolio:=as.numeric(no.in.portfolio)]

check_for_run <- merge(check_for_run,fe_anon,by="anon",all.x=TRUE)
check_for_run <- merge(check_for_run,fe_sedol,by="sedol",all.x=TRUE)
check_for_run <- merge(check_for_run,fe_date,by="date_formated",all.x=TRUE)
check_for_run <- merge(check_for_run,fe_no,by="no.in.portfolio",all.x=TRUE)

check_for_run[,mean_y:=mean(new_stock)]
check_for_run[,adj_new_stock:=new_stock-effect.x-effect.y-effect-effect_no]
#check_for_run[,adj_new_stock:=new_stock-effect.x-effect.y-effect]


r2_check <- lm(adj_new_stock~ gain_size_win -1,data =check_for_run)

name_1 <- paste0("return size (", return_indicator_2," return)")
name_middle <- ifelse(sub==1,"sub","all")
name_2 <- paste0("G:/rank/new_ind/codes/codes with more anon dataset/plots/", return_indicator_2,"_reg2_",name_middle,least.holding,".png")
# \nand number of stocks 
(g3 <- ggplot(check_for_run,aes(x=gain_size_win,y=adj_new_stock)) + geom_smooth() +  ylab("Probability of buying a new stock \n(Adjusted by account, sedol, date\nand number of stocks  FEs)") + xlab(name_1) + xlim(a,b))

ggsave(g3, file=name_2,width = 7.29, height = 4.5)

return(r2)

}






```


```{r}
# three_fes <- function(sub, least.holding, return_indicator, return_indicator_2)
# four_fes <- function(sub,least.holding,  return_indicator, return_indicator_2)

# winning prop
r1 <- three_fes(1,1,"winning_prop","winning proportion")
r2 <- four_fes(1,1,"winning_prop","winning proportion")
r3 <- three_fes(0,5,"winning_prop","winning proportion")
r4 <- four_fes(0,5,"winning_prop","winning proportion")
r5 <- three_fes(1,0,"winning_prop","winning proportion")
r6 <- four_fes(1,0,"winning_prop","winning proportion")
r7 <- three_fes(1,5,"winning_prop","winning proportion")
r8 <- four_fes(1,5,"winning_prop","winning proportion")

# rsp
r1 <- three_fes(0,0,"rsp_portf_size","rsp")
r2 <- four_fes(0,0,"rsp_portf_size","rsp")
r3 <- three_fes(0,5,"rsp_portf_size","rsp")
r4 <- four_fes(0,5,"rsp_portf_size","rsp")
r5 <- three_fes(1,0,"rsp_portf_size","rsp")
r6 <- four_fes(1,0,"rsp_portf_size","rsp")
r7 <- three_fes(1,5,"rsp_portf_size","rsp")
r8 <- four_fes(1,5,"rsp_portf_size","rsp")

# portf_return_1day_weight
r1 <- three_fes(0,0,"portf_return_1day_weight","day")
r2 <- four_fes(0,0,"portf_return_1day_weight","day")
r3 <- three_fes(0,5,"portf_return_1day_weight","day")
r4 <- four_fes(0,5,"portf_return_1day_weight","day")
r5 <- three_fes(1,0,"portf_return_1day_weight","day")
r6 <- four_fes(1,0,"portf_return_1day_weight","day")
r7 <- three_fes(1,5,"portf_return_1day_weight","day")
r8 <- four_fes(1,5,"portf_return_1day_weight","day")

# portf_return_1week_weight
r1 <- three_fes(0,0,"portf_return_1week_weight","week")
r2 <- four_fes(0,0,"portf_return_1week_weight","week")
r3 <- three_fes(0,5,"portf_return_1week_weight","week")
r4 <- four_fes(0,5,"portf_return_1week_weight","week")
r5 <- three_fes(1,0,"portf_return_1week_weight","week")
r6 <- four_fes(1,0,"portf_return_1week_weight","week")
r7 <- three_fes(1,5,"portf_return_1week_weight","week")
r8 <- four_fes(1,5,"portf_return_1week_weight","week")

# portf_return_1month_weight
r1 <- three_fes(0,0,"portf_return_1month_weight","month")
r2 <- four_fes(0,0,"portf_return_1month_weight","month")
r3 <- three_fes(0,5,"portf_return_1month_weight","month")
r4 <- four_fes(0,5,"portf_return_1month_weight","month")
r5 <- three_fes(1,0,"portf_return_1month_weight","month")
r6 <- four_fes(1,0,"portf_return_1month_weight","month")
r7 <- three_fes(1,5,"portf_return_1month_weight","month")
r8 <- four_fes(1,5,"portf_return_1month_weight","month")
```

